<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 MVVM | å‰ç«¯é¢è¯•æŒ‡å—</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/FE-Interview-Questions/logo.png">
    <link rel="manifest" href="/FE-Interview-Questions/manifest.json">
    <link rel="apple-touch-icon" href="/FE-Interview-Questions/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/FE-Interview-Questions/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="webå‰ç«¯é¢è¯•é¢˜æ€»ç»“ï¼Œé¢è¯•æŒ‡å—ï¼Œå‰ç«¯é¢è¯•é¢˜æ•´ç†ï¼Œwebé¢è¯•å®å…¸ï¼Œåˆ·é¢˜ç¥å™¨ï¼ŒæŒ‰æ¨¡å—åˆ†ç±»æ•´ç†æ€»ç»“ï¼Œæ‰“é€ æœ€å…¨é¢çš„å‰ç«¯é¢è¯•é¢˜">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/FE-Interview-Questions/assets/css/0.styles.b867a2f8.css" as="style"><link rel="preload" href="/FE-Interview-Questions/assets/js/app.c2f48845.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/5.90e753a8.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/4.5ac63c44.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/69.e6d07708.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/11.6ecd37f3.js" as="script"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/1.90e7df67.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/10.36ef20ea.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/100.aca4e15c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/101.0b93fb0e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/102.e7cb3ef3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/103.10d0f7cb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/104.4e1bd7fb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/105.f9408f15.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/106.38081b6a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/107.11bb4c90.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/108.8f69a38b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/109.c91bbe2a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/110.2672bb60.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/111.7f3ac51b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/112.e9e54a73.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/113.5b6e3b69.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/114.6788282d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/115.92b5418d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/116.2aab07db.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/117.994736dd.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/118.ee5fc166.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/119.a9d6e42f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/12.5c403d51.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/120.30f40853.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/121.cf11f49c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/122.9b92828e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/123.e232f2e0.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/124.a7ebf655.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/125.7b3b0adb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/126.7e9bd5fd.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/127.11cbd4b4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/128.ef7d186f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/129.173431c5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/13.c8cbdf8d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/130.4c4321af.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/131.919b024f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/132.0d4e5ca1.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/133.b26c3bf9.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/134.192fed73.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/135.ae45ad84.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/136.0562a861.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/137.bb217dfe.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/138.055fd92d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/139.29025c6d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/14.d3497f51.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/140.dd7fbf32.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/141.be8ea0f9.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/142.71d998fe.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/143.2ba16235.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/144.776907b5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/145.20f09094.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/146.d9735771.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/147.151f82da.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/148.26a1a272.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/149.f2f0cb8a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/15.4e38b6b8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/150.727d7f8d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/151.2a0f472d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/16.03e0a04b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/17.9254a84e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/18.fc9ba56b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/19.1709b72e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/20.d5e476a0.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/21.e824e3b0.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/22.74b2f260.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/23.e2f24d6c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/24.dd97a7a5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/25.8452b537.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/26.740b8cf0.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/27.a224a0ad.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/28.67cb2bd9.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/29.4dba64ce.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/3.ddaef9c3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/30.d3ad2096.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/31.48eeeb15.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/32.1fb0a801.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/33.6897de58.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/34.cd60ddbe.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/35.eb2c210f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/36.12d28bd5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/37.2e80e520.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/38.5307919f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/39.27b1bc0a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/40.12c88b79.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/41.81bc4856.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/42.bae90031.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/43.65cffc22.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/44.eda920c9.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/45.ad7fc545.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/46.c67d3f8a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/47.e2a85c12.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/48.f7fd6d5c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/49.85e7e274.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/50.8064c586.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/51.ed90ba8e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/52.bd5ea0c9.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/53.69df0f27.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/54.ec7608b4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/55.351e037f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/56.7b4840e8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/57.b5f4c71e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/58.d2e80c5c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/59.7334c3ab.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/6.c87bfe1b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/60.08b03dea.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/61.a3426e15.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/62.190b676a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/63.fccbc2c7.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/64.bb50f7ea.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/65.44ec9e71.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/66.83b0bfd7.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/67.897eb5b2.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/68.a3dc31b5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/7.804f8893.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/70.94364ecb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/71.a6b06ccf.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/72.a6681bbb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/73.70ef3f98.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/74.07ba0fd0.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/75.245f5825.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/76.6380845e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/77.7a8e7d8e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/78.dda3df1a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/79.9f04d67f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/8.c3be176d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/80.53ca110e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/81.63c592a3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/82.127dec31.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/83.67cf3513.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/84.72160b0e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/85.4e2b383a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/86.d28be0fe.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/87.e1397d98.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/88.239892e5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/89.28c7de31.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/9.a0bcf0dc.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/90.b6b720e8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/91.9b3fa3f8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/92.d55364b7.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/93.5ccc61cf.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/94.571ae826.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/95.fff31d21.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/96.973a7716.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/97.d2ec076d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/98.84fcd5b3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/99.a93dab9c.js">
    <link rel="stylesheet" href="/FE-Interview-Questions/assets/css/0.styles.b867a2f8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/FE-Interview-Questions/" class="home-link router-link-active"><img src="/FE-Interview-Questions/logo.png" alt="å‰ç«¯é¢è¯•æŒ‡å—" class="logo"> <span class="site-name can-hide">å‰ç«¯é¢è¯•æŒ‡å—</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="login-modal"><div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="å¾®ä¿¡æ‰«ç å…³æ³¨ã€ å‰ç«¯è¿›é˜¶ä¹‹æ—… ã€ç™»å½•" class="el-dialog" style="margin-top:15vh;width:32%;"><div class="el-dialog__header"><span class="el-dialog__title">å¾®ä¿¡æ‰«ç å…³æ³¨ã€ å‰ç«¯è¿›é˜¶ä¹‹æ—… ã€ç™»å½•</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div></div></div> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ç²¾é€‰æ¨¡å—</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/excellent-docs/1-HTMLæ¨¡å—.html" class="sidebar-link">1 HTMLæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/2-CSSæ¨¡å—.html" class="sidebar-link">2 CSSæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/3-JSæ¨¡å—.html" class="sidebar-link">3 JSæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/4-ES6æ¨¡å—.html" class="sidebar-link">4 ES6æ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/5-æµè§ˆå™¨æ¨¡å—.html" class="sidebar-link">5 æµè§ˆå™¨æ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/6-React.html" class="sidebar-link">6 Reactæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/7-Vue.html" class="sidebar-link">7 Vueæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/8-Nodeæ¨¡å—.html" class="sidebar-link">8 Nodeæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/9-å‰ç«¯å·¥ç¨‹æ¨¡å—.html" class="sidebar-link">9 å‰ç«¯å·¥ç¨‹ç›¸å…³</a></li><li><a href="/FE-Interview-Questions/excellent-docs/10-ç§»åŠ¨å¤šç«¯å¼€å‘.html" class="sidebar-link">10 ç§»åŠ¨å¤šç«¯å¼€å‘</a></li><li><a href="/FE-Interview-Questions/excellent-docs/11-å°ç¨‹åºæ¨¡å—.html" class="sidebar-link">11 å°ç¨‹åºæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/12-å‰ç«¯å®‰å…¨æ¨¡å—.html" class="sidebar-link">12 å‰ç«¯å®‰å…¨æ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/13-æ€§èƒ½ä¼˜åŒ–æ¨¡å—.html" class="sidebar-link">13 æ€§èƒ½ä¼˜åŒ–ç›¸å…³</a></li><li><a href="/FE-Interview-Questions/excellent-docs/14-HTTPæ¨¡å—.html" class="sidebar-link">14 HTTPæ¨¡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/15-è®¾è®¡æ¨¡å¼.html" class="sidebar-link">15 å¸¸ç”¨è®¾è®¡æ¨¡å¼</a></li><li><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html" class="active sidebar-link">16 æ¡†æ¶é€šè¯†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html#_1-mvvm" class="sidebar-link">1 MVVM</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html#_2-è·¯ç”±åŸç†" class="sidebar-link">2 è·¯ç”±åŸç†</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html#_3-virtual-dom" class="sidebar-link">3 Virtual Dom</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html#_4-diffç®—æ³•" class="sidebar-link">4 Diffç®—æ³•</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html#_4-1-react-diff" class="sidebar-link">4.1 React-Diff</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html#_4-2-vue2-x-diff-åŒç«¯æ¯”è¾ƒ" class="sidebar-link">4.2 Vue2.X Diff â€”â€” åŒç«¯æ¯”è¾ƒ</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/excellent-docs/16-æ¡†æ¶é€šè¯†.html#_4-3-vue3-diff-æœ€é•¿é€’å¢å­åºåˆ—" class="sidebar-link">4.3 Vue3 Diff â€”â€” æœ€é•¿é€’å¢å­åºåˆ—</a></li></ul></li></ul></li><li><a href="/FE-Interview-Questions/excellent-docs/17-æ’åºç®—æ³•.html" class="sidebar-link">17 æ’åºç®—æ³•</a></li><li><a href="/FE-Interview-Questions/excellent-docs/18-è®¡ç®—æœºé€šè¯†.html" class="sidebar-link">18 è®¡ç®—æœºé€šè¯†</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ğŸ”¥é«˜é¢‘æ¨¡å—</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/excellent-docs/é«˜é¢‘æ¨¡å—.html" class="sidebar-link">1ã€é«˜é¢‘è€ƒç‚¹</a></li><li><a href="/FE-Interview-Questions/excellent-docs/é¢è¯•æŒ‡å—.html" class="sidebar-link">2ã€é¢è¯•æŒ‡å—</a></li><li><a href="/FE-Interview-Questions/excellent-docs/æ€§èƒ½ä¼˜åŒ–.html" class="sidebar-link">3ã€æ€§èƒ½ä¼˜åŒ–</a></li></ul></section></li></ul> </aside> <main class="page"> <div id="container" class="theme-default-content lock"><div class="content__default"><h2 id="_1-mvvm"><a href="#_1-mvvm" class="header-anchor">#</a> 1 MVVM</h2> <blockquote><p><code>MVVM</code> ç”±ä»¥ä¸‹ä¸‰ä¸ªå†…å®¹ç»„æˆ</p></blockquote> <ul><li><code>View</code>ï¼šç•Œé¢</li> <li><code>Model</code>ï¼šæ•°æ®æ¨¡å‹</li> <li><code>ViewModel</code>ï¼šä½œä¸ºæ¡¥æ¢è´Ÿè´£æ²Ÿé€š <code>View</code> å’Œ <code>Model</code></li></ul> <blockquote><p>åœ¨ <code>JQuery</code> æ—¶æœŸï¼Œå¦‚æœéœ€è¦åˆ·æ–° <code>UI</code> æ—¶ï¼Œéœ€è¦å…ˆå–åˆ°å¯¹åº”çš„ <code>DOM</code> å†æ›´æ–° <code>UI</code>ï¼Œè¿™æ ·æ•°æ®å’Œä¸šåŠ¡çš„é€»è¾‘å°±å’Œé¡µé¢æœ‰å¼ºè€¦åˆã€‚</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">MVVM</p> <p>åœ¨ <code>MVVM</code> ä¸­ï¼Œ<code>UI</code> æ˜¯é€šè¿‡æ•°æ®é©±åŠ¨çš„ï¼Œæ•°æ®ä¸€æ—¦æ”¹å˜å°±ä¼šç›¸åº”çš„åˆ·æ–°å¯¹åº”çš„ <code>UI</code>ï¼Œ<code>UI</code> å¦‚æœæ”¹å˜ï¼Œä¹Ÿä¼šæ”¹å˜å¯¹åº”çš„æ•°æ®ã€‚è¿™ç§æ–¹å¼å°±å¯ä»¥åœ¨ä¸šåŠ¡å¤„ç†ä¸­åªå…³å¿ƒæ•°æ®çš„æµè½¬ï¼Œè€Œæ— éœ€ç›´æ¥å’Œé¡µé¢æ‰“äº¤é“ã€‚<code>ViewModel</code> åªå…³å¿ƒæ•°æ®å’Œä¸šåŠ¡çš„å¤„ç†ï¼Œä¸å…³å¿ƒ <code>View</code> å¦‚ä½•å¤„ç†æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>View</code> å’Œ <code>Model</code> éƒ½å¯ä»¥ç‹¬ç«‹å‡ºæ¥ï¼Œä»»ä½•ä¸€æ–¹æ”¹å˜äº†ä¹Ÿä¸ä¸€å®šéœ€è¦æ”¹å˜å¦ä¸€æ–¹ï¼Œå¹¶ä¸”å¯ä»¥å°†ä¸€äº›å¯å¤ç”¨çš„é€»è¾‘æ”¾åœ¨ä¸€ä¸ª <code>ViewModel</code> ä¸­ï¼Œè®©å¤šä¸ª <code>View</code>å¤ç”¨è¿™ä¸ª <code>ViewModel</code>ã€‚</p></div> <ul><li>åœ¨ <code>MVVM</code> ä¸­ï¼Œæœ€æ ¸å¿ƒçš„ä¹Ÿå°±æ˜¯æ•°æ®åŒå‘ç»‘å®šï¼Œä¾‹å¦‚ <code>Angluar</code> çš„è„æ•°æ®æ£€æµ‹ï¼Œ<code>Vue</code> ä¸­çš„æ•°æ®åŠ«æŒã€‚</li></ul> <p><strong>è„æ•°æ®æ£€æµ‹</strong></p> <blockquote><p>å½“è§¦å‘äº†æŒ‡å®šäº‹ä»¶åä¼šè¿›å…¥è„æ•°æ®æ£€æµ‹ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ <code>$digest</code> å¾ªç¯éå†æ‰€æœ‰çš„æ•°æ®è§‚å¯Ÿè€…ï¼Œåˆ¤æ–­å½“å‰å€¼æ˜¯å¦å’Œå…ˆå‰çš„å€¼æœ‰åŒºåˆ«ï¼Œå¦‚æœæ£€æµ‹åˆ°å˜åŒ–çš„è¯ï¼Œä¼šè°ƒç”¨ <code>$watch</code> å‡½æ•°ï¼Œç„¶åå†æ¬¡è°ƒç”¨ <code>$digest</code> å¾ªç¯ç›´åˆ°å‘ç°æ²¡æœ‰å˜åŒ–ã€‚å¾ªç¯è‡³å°‘ä¸ºäºŒæ¬¡ ï¼Œè‡³å¤šä¸ºåæ¬¡ã€‚</p></blockquote> <blockquote><p>è„æ•°æ®æ£€æµ‹è™½ç„¶å­˜åœ¨ä½æ•ˆçš„é—®é¢˜ï¼Œä½†æ˜¯ä¸å…³å¿ƒæ•°æ®æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼æ”¹å˜çš„ï¼Œéƒ½å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œä½†æ˜¯è¿™åœ¨ <code>Vue</code> ä¸­çš„åŒå‘ç»‘å®šæ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚å¹¶ä¸”è„æ•°æ®æ£€æµ‹å¯ä»¥å®ç°æ‰¹é‡æ£€æµ‹å‡ºæ›´æ–°çš„å€¼ï¼Œå†å»ç»Ÿä¸€æ›´æ–° <code>UI</code>ï¼Œå¤§å¤§å‡å°‘äº†æ“ä½œ <code>DOM</code> çš„æ¬¡æ•°ã€‚æ‰€ä»¥ä½æ•ˆä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œè¿™å°±ä»è€…è§ä»æ™ºè€…è§æ™ºäº†ã€‚</p></blockquote> <p><strong>æ•°æ®åŠ«æŒ</strong></p> <blockquote><p><code>Vue</code> å†…éƒ¨ä½¿ç”¨äº† <code>Object.defineProperty()</code> æ¥å®ç°åŒå‘ç»‘å®šï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥ç›‘å¬åˆ° <code>set</code> å’Œ <code>get</code> çš„äº‹ä»¶ã€‚</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'yck'</span> <span class="token punctuation">}</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> data<span class="token punctuation">.</span>name <span class="token comment">// -&gt; get value</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'yyy'</span> <span class="token comment">// -&gt; change value</span>

<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ç±»å‹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj <span class="token operator">||</span> <span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€’å½’å­å±æ€§</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get value'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change value'</span><span class="token punctuation">)</span>
      val <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ä»¥ä¸Šä»£ç ç®€å•çš„å®ç°äº†å¦‚ä½•ç›‘å¬æ•°æ®çš„ <code>set</code> å’Œ <code>get</code> çš„äº‹ä»¶ï¼Œä½†æ˜¯ä»…ä»…å¦‚æ­¤æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦åœ¨é€‚å½“çš„æ—¶å€™ç»™å±æ€§æ·»åŠ å‘å¸ƒè®¢é˜…</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {{name}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><p>åœ¨è§£æå¦‚ä¸Šæ¨¡æ¿ä»£ç æ—¶ï¼Œé‡åˆ° <code>{name}</code> å°±ä¼šç»™å±æ€§ <code>name</code> æ·»åŠ å‘å¸ƒè®¢é˜…ã€‚</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// é€šè¿‡ Dep è§£è€¦</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// sub æ˜¯ Watcher å®ä¾‹</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// å…¨å±€å±æ€§ï¼Œé€šè¿‡è¯¥å±æ€§é…ç½® Watcher</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°† Dep.target æŒ‡å‘è‡ªå·±</span>
    <span class="token comment">// ç„¶åè§¦å‘å±æ€§çš„ getter æ·»åŠ ç›‘å¬</span>
    <span class="token comment">// æœ€åå°† Dep.target ç½®ç©º</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å¾—æ–°å€¼</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">]</span>
    <span class="token comment">// è°ƒç”¨ update æ–¹æ³•æ›´æ–° Dom</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'yck'</span> <span class="token punctuation">}</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token comment">// æ¨¡æ‹Ÿè§£æåˆ° `{{name}}` è§¦å‘çš„æ“ä½œ</span>
<span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> update<span class="token punctuation">)</span>
<span class="token comment">// update Dom innerText</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'yyy'</span>
</code></pre></div><blockquote><p>æ¥ä¸‹æ¥,å¯¹ <code>defineReactive</code> å‡½æ•°è¿›è¡Œæ”¹é€ </p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€’å½’å­å±æ€§</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token keyword">let</span> dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get value'</span><span class="token punctuation">)</span>
      <span class="token comment">// å°† Watcher æ·»åŠ åˆ°è®¢é˜…</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dp<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change value'</span><span class="token punctuation">)</span>
      val <span class="token operator">=</span> newVal
      <span class="token comment">// æ‰§è¡Œ watcher çš„ update æ–¹æ³•</span>
      dp<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ä»¥ä¸Šå®ç°äº†ä¸€ä¸ªç®€æ˜“çš„åŒå‘ç»‘å®šï¼Œæ ¸å¿ƒæ€è·¯å°±æ˜¯æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å±æ€§çš„ <code>getter</code> æ¥å®ç°å‘å¸ƒè®¢é˜…çš„æ·»åŠ </p></blockquote> <p><strong>Proxy ä¸ Object.defineProperty å¯¹æ¯”</strong></p> <blockquote><p><code>Object.defineProperty</code> è™½ç„¶å·²ç»èƒ½å¤Ÿå®ç°åŒå‘ç»‘å®šäº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯æœ‰ç¼ºé™·çš„ã€‚</p></blockquote> <ul><li>åªèƒ½å¯¹å±æ€§è¿›è¡Œæ•°æ®åŠ«æŒï¼Œæ‰€ä»¥éœ€è¦æ·±åº¦éå†æ•´ä¸ªå¯¹è±¡
å¯¹äºæ•°ç»„ä¸èƒ½ç›‘å¬åˆ°æ•°æ®çš„å˜åŒ–</li> <li>è™½ç„¶ <code>Vue</code> ä¸­ç¡®å®èƒ½æ£€æµ‹åˆ°æ•°ç»„æ•°æ®çš„å˜åŒ–ï¼Œä½†æ˜¯å…¶å®æ˜¯ä½¿ç”¨äº† <code>hack</code>çš„åŠæ³•ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯æœ‰ç¼ºé™·çš„ã€‚</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>
<span class="token comment">// hack ä»¥ä¸‹å‡ ä¸ªå‡½æ•°</span>
<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å¾—åŸç”Ÿå‡½æ•°</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨åŸç”Ÿå‡½æ•°</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token comment">// è§¦å‘æ›´æ–°</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>åè§‚ <code>Proxy</code>å°±æ²¡ä»¥ä¸Šçš„é—®é¢˜ï¼ŒåŸç”Ÿæ”¯æŒç›‘å¬æ•°ç»„å˜åŒ–ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥å¯¹æ•´ä¸ªå¯¹è±¡è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥ <code>Vue</code> ä¹Ÿå°†åœ¨ä¸‹ä¸ªå¤§ç‰ˆæœ¬ä¸­ä½¿ç”¨ <code>Proxy</code> æ›¿æ¢ <code>Object.defineProperty</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">onWatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> setBind<span class="token punctuation">,</span> getLogger</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getLogger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">)</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setBind</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> value
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">onWatch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> v
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Get '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>property<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// bind `value` to `2`</span>
p<span class="token punctuation">.</span>a <span class="token comment">// -&gt; Get 'a' = 2</span>
</code></pre></div><h2 id="_2-è·¯ç”±åŸç†"><a href="#_2-è·¯ç”±åŸç†" class="header-anchor">#</a> 2 è·¯ç”±åŸç†</h2> <blockquote><p>å‰ç«¯è·¯ç”±å®ç°èµ·æ¥å…¶å®å¾ˆç®€å•ï¼Œæœ¬è´¨å°±æ˜¯ç›‘å¬ <code>URL</code> çš„å˜åŒ–ï¼Œç„¶ååŒ¹é…è·¯ç”±è§„åˆ™ï¼Œæ˜¾ç¤ºç›¸åº”çš„é¡µé¢ï¼Œå¹¶ä¸”æ— é¡»åˆ·æ–°ã€‚ç›®å‰å•é¡µé¢ä½¿ç”¨çš„è·¯ç”±å°±åªæœ‰ä¸¤ç§å®ç°æ–¹å¼</p></blockquote> <ul><li><code>hash</code> æ¨¡å¼</li> <li><code>history</code> æ¨¡å¼</li></ul> <blockquote><p><code>www.test.com/##/</code> å°±æ˜¯ <code>Hash URL</code>ï¼Œå½“ <code>##</code> åé¢çš„å“ˆå¸Œå€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä¼šå‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œå¯ä»¥é€šè¿‡
<code>hashchange</code> äº‹ä»¶æ¥ç›‘å¬åˆ° <code>URL</code> çš„å˜åŒ–ï¼Œä»è€Œè¿›è¡Œè·³è½¬é¡µé¢ã€‚</p></blockquote> <p><img src="https://poetries1.gitee.io/img-repo/2020/09/99.png" alt=""></p> <blockquote><p><code>History</code>æ¨¡å¼æ˜¯ <code>HTML5</code> æ–°æ¨å‡ºçš„åŠŸèƒ½ï¼Œæ¯”ä¹‹ <code>Hash URL</code> æ›´åŠ ç¾è§‚</p></blockquote> <p><img src="https://poetries1.gitee.io/img-repo/2020/09/100.png" alt=""></p> <h2 id="_3-virtual-dom"><a href="#_3-virtual-dom" class="header-anchor">#</a> 3 Virtual Dom</h2> <p><strong>ä¸ºä»€ä¹ˆéœ€è¦ Virtual Dom</strong></p> <blockquote><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œæ“ä½œ <code>DOM</code> æ˜¯å¾ˆè€—è´¹æ€§èƒ½çš„ä¸€ä»¶äº‹æƒ…ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘é€šè¿‡ <code>JS</code> å¯¹è±¡æ¥æ¨¡æ‹Ÿ <code>DOM</code> å¯¹è±¡ï¼Œæ¯•ç«Ÿæ“ä½œ <code>JS</code> å¯¹è±¡æ¯”æ“ä½œ <code>DOM</code> çœæ—¶çš„å¤š</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å‡è®¾è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ª ulï¼Œå…¶ä¸­åŒ…å«äº† 5 ä¸ª li</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
<span class="token comment">// è¿™é‡Œæ›¿æ¢ä¸Šé¢çš„ li</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>ä»ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸€çœ¼å°±å¯ä»¥çœ‹å‡ºå…ˆå‰çš„ <code>ul</code> ä¸­çš„ç¬¬ä¸‰ä¸ª <code>li</code> è¢«ç§»é™¤äº†ï¼Œå››äº”æ›¿æ¢äº†ä½ç½®ã€‚</p></blockquote> <ul><li>å¦‚æœä»¥ä¸Šæ“ä½œå¯¹åº”åˆ° <code>DOM</code> ä¸­ï¼Œé‚£ä¹ˆå°±æ˜¯ä»¥ä¸‹ä»£ç </li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åˆ é™¤ç¬¬ä¸‰ä¸ª li</span>
ul<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// å°†ç¬¬å››ä¸ª li å’Œç¬¬äº”ä¸ªäº¤æ¢ä½ç½®</span>
<span class="token keyword">let</span> fromNode <span class="token operator">=</span> ul<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> toNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> cloneFromNode <span class="token operator">=</span> fromNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> cloenToNode <span class="token operator">=</span> toNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloneFromNode<span class="token punctuation">,</span> toNode<span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloenToNode<span class="token punctuation">,</span> fromNode<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>å½“ç„¶åœ¨å®é™…æ“ä½œä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»™æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªæ ‡è¯†ï¼Œä½œä¸ºåˆ¤æ–­æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹çš„ä¾æ®ã€‚æ‰€ä»¥è¿™ä¹Ÿæ˜¯ <code>Vue</code> å’Œ <code>React</code> ä¸­å®˜æ–¹æ¨èåˆ—è¡¨é‡Œçš„èŠ‚ç‚¹ä½¿ç”¨å”¯ä¸€çš„ <code>key</code> æ¥ä¿è¯æ€§èƒ½ã€‚</p></blockquote> <ul><li>é‚£ä¹ˆæ—¢ç„¶ <code>DOM</code> å¯¹è±¡å¯ä»¥é€šè¿‡ <code>JS</code> å¯¹è±¡æ¥æ¨¡æ‹Ÿï¼Œåä¹‹ä¹Ÿå¯ä»¥é€šè¿‡ <code>JS</code> å¯¹è±¡æ¥æ¸²æŸ“å‡ºå¯¹åº”çš„ <code>DOM</code></li> <li>ä»¥ä¸‹æ˜¯ä¸€ä¸ª <code>JS</code> å¯¹è±¡æ¨¡æ‹Ÿ <code>DOM</code> å¯¹è±¡çš„ç®€å•å®ç°</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @param {String} tag 'div'
   * @param {Object} props { class: 'item' }
   * @param {Array} children [ Element1, 'text']
   * @param {String} key option
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> children
      <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
  <span class="token punctuation">}</span>
  <span class="token comment">// æ¸²æŸ“</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>key
    <span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token keyword">return</span> root
  <span class="token punctuation">}</span>
  <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºèŠ‚ç‚¹</span>
  <span class="token function">_createElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> child<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡ tag åˆ›å»ºèŠ‚ç‚¹</span>
    <span class="token keyword">let</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®èŠ‚ç‚¹å±æ€§</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é€’å½’æ·»åŠ å­èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      child<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> child
        <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          child <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createElement</span><span class="token punctuation">(</span>
            element<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
            element<span class="token punctuation">.</span>key
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          child <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> el
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Virtual Dom ç®—æ³•ç®€è¿°</strong></p> <ul><li>æ—¢ç„¶æˆ‘ä»¬å·²ç»é€šè¿‡ <code>JS</code> æ¥æ¨¡æ‹Ÿå®ç°äº† <code>DOM</code>ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„éš¾ç‚¹å°±åœ¨äºå¦‚ä½•åˆ¤æ–­æ—§çš„å¯¹è±¡å’Œæ–°çš„å¯¹è±¡ä¹‹é—´çš„å·®å¼‚ã€‚</li> <li><code>DOM</code> æ˜¯å¤šå‰æ ‘çš„ç»“æ„ï¼Œå¦‚æœéœ€è¦å®Œæ•´çš„å¯¹æ¯”ä¸¤é¢—æ ‘çš„å·®å¼‚ï¼Œé‚£ä¹ˆéœ€è¦çš„æ—¶é—´å¤æ‚åº¦ä¼šæ˜¯ <code>O(n ^ 3)</code>ï¼Œè¿™ä¸ªå¤æ‚åº¦è‚¯å®šæ˜¯ä¸èƒ½æ¥å—çš„ã€‚äºæ˜¯ <code>React</code>å›¢é˜Ÿä¼˜åŒ–äº†ç®—æ³•ï¼Œå®ç°äº† <code>O(n)</code> çš„å¤æ‚åº¦æ¥å¯¹æ¯”å·®å¼‚ã€‚</li> <li>å®ç°<code>O(n)</code> å¤æ‚åº¦çš„å…³é”®å°±æ˜¯åªå¯¹æ¯”åŒå±‚çš„èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯è·¨å±‚å¯¹æ¯”ï¼Œè¿™ä¹Ÿæ˜¯è€ƒè™‘åˆ°åœ¨å®é™…ä¸šåŠ¡ä¸­å¾ˆå°‘ä¼šå»è·¨å±‚çš„ç§»åŠ¨ <code>DOM</code> å…ƒç´ </li></ul> <blockquote><p>æ‰€ä»¥åˆ¤æ–­å·®å¼‚çš„ç®—æ³•å°±åˆ†ä¸ºäº†ä¸¤æ­¥</p></blockquote> <ul><li>é¦–å…ˆä»ä¸Šè‡³ä¸‹ï¼Œä»å·¦å¾€å³éå†å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ ‘çš„æ·±åº¦éå†ï¼Œè¿™ä¸€æ­¥ä¸­ä¼šç»™æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ç´¢å¼•ï¼Œä¾¿äºæœ€åæ¸²æŸ“å·®å¼‚</li> <li>ä¸€æ—¦èŠ‚ç‚¹æœ‰å­å…ƒç´ ï¼Œå°±å»åˆ¤æ–­å­å…ƒç´ æ˜¯å¦æœ‰ä¸åŒ</li></ul> <p><strong>Virtual Dom ç®—æ³•å®ç°</strong></p> <p><strong>æ ‘çš„é€’å½’</strong></p> <ul><li>é¦–å…ˆæˆ‘ä»¬æ¥å®ç°æ ‘çš„é€’å½’ç®—æ³•ï¼Œåœ¨å®ç°è¯¥ç®—æ³•å‰ï¼Œå…ˆæ¥è€ƒè™‘ä¸‹ä¸¤ä¸ªèŠ‚ç‚¹å¯¹æ¯”ä¼šæœ‰å‡ ç§æƒ…å†µ</li> <li>æ–°çš„èŠ‚ç‚¹çš„ <code>tagName</code> æˆ–è€… <code>key</code> å’Œæ—§çš„ä¸åŒï¼Œè¿™ç§æƒ…å†µä»£è¡¨éœ€è¦æ›¿æ¢æ—§çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¹Ÿä¸å†éœ€è¦éå†æ–°æ—§èŠ‚ç‚¹çš„å­å…ƒç´ äº†ï¼Œå› ä¸ºæ•´ä¸ªæ—§èŠ‚ç‚¹éƒ½è¢«åˆ æ‰äº†</li> <li>æ–°çš„èŠ‚ç‚¹çš„ <code>tagName</code> å’Œ <code>key</code>ï¼ˆå¯èƒ½éƒ½æ²¡æœ‰ï¼‰å’Œæ—§çš„ç›¸åŒï¼Œå¼€å§‹éå†å­æ ‘</li> <li>æ²¡æœ‰æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åš</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> StateEnums<span class="token punctuation">,</span> isString<span class="token punctuation">,</span> move <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span>
<span class="token keyword">import</span> Element <span class="token keyword">from</span> <span class="token string">'./element'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">oldDomTree<span class="token punctuation">,</span> newDomTree</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç”¨äºè®°å½•å·®å¼‚</span>
  <span class="token keyword">let</span> pathchs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ä¸€å¼€å§‹çš„ç´¢å¼•ä¸º 0</span>
  <span class="token function">dfs</span><span class="token punctuation">(</span>oldDomTree<span class="token punctuation">,</span> newDomTree<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pathchs<span class="token punctuation">)</span>
  <span class="token keyword">return</span> pathchs
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç”¨äºä¿å­˜å­æ ‘çš„æ›´æ”¹</span>
  <span class="token keyword">let</span> curPatches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// éœ€è¦åˆ¤æ–­ä¸‰ç§æƒ…å†µ</span>
  <span class="token comment">// 1.æ²¡æœ‰æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åš</span>
  <span class="token comment">// 2.æ–°çš„èŠ‚ç‚¹çš„ tagName å’Œ `key` å’Œæ—§çš„ä¸åŒï¼Œå°±æ›¿æ¢</span>
  <span class="token comment">// 3.æ–°çš„èŠ‚ç‚¹çš„ tagName å’Œ keyï¼ˆå¯èƒ½éƒ½æ²¡æœ‰ï¼‰ å’Œæ—§çš„ç›¸åŒï¼Œå¼€å§‹éå†å­æ ‘</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newNode<span class="token punctuation">.</span>tag <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span> newNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å±æ€§æ˜¯å¦å˜æ›´</span>
    <span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token function">diffProps</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>length<span class="token punctuation">)</span> curPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token punctuation">,</span> props <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// éå†å­æ ‘</span>
    <span class="token function">diffChildren</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// èŠ‚ç‚¹ä¸åŒï¼Œéœ€è¦æ›¿æ¢</span>
    curPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token punctuation">,</span> node<span class="token operator">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>curPatches<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>curPatches<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> curPatches
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>åˆ¤æ–­å±æ€§çš„æ›´æ”¹</strong></p> <blockquote><p>åˆ¤æ–­å±æ€§çš„æ›´æ”¹ä¹Ÿåˆ†ä¸‰ä¸ªæ­¥éª¤</p></blockquote> <ul><li>éå†æ—§çš„å±æ€§åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ¯ä¸ªå±æ€§æ˜¯å¦è¿˜å­˜åœ¨äºæ–°çš„å±æ€§åˆ—è¡¨ä¸­</li> <li>éå†æ–°çš„å±æ€§åˆ—è¡¨ï¼Œåˆ¤æ–­ä¸¤ä¸ªåˆ—è¡¨ä¸­éƒ½å­˜åœ¨çš„å±æ€§çš„å€¼æ˜¯å¦æœ‰å˜åŒ–</li> <li>åœ¨ç¬¬äºŒæ­¥ä¸­åŒæ—¶æŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§ä¸å­˜åœ¨ä¸æ—§çš„å±æ€§åˆ—åˆ—è¡¨ä¸­</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ Props åˆ†ä»¥ä¸‹ä¸‰æ­¥éª¤</span>
  <span class="token comment">// å…ˆéå† oldProps æŸ¥çœ‹æ˜¯å¦å­˜åœ¨åˆ é™¤çš„å±æ€§</span>
  <span class="token comment">// ç„¶åéå† newProps æŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§å€¼è¢«ä¿®æ”¹</span>
  <span class="token comment">// æœ€åæŸ¥çœ‹æ˜¯å¦æœ‰å±æ€§æ–°å¢</span>
  <span class="token keyword">let</span> change <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        prop<span class="token operator">:</span> key
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> prop <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          prop<span class="token operator">:</span> key<span class="token punctuation">,</span>
          value<span class="token operator">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          prop<span class="token operator">:</span> key<span class="token punctuation">,</span>
          value<span class="token operator">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> change
<span class="token punctuation">}</span>
</code></pre></div><p><strong>åˆ¤æ–­åˆ—è¡¨å·®å¼‚ç®—æ³•å®ç°</strong></p> <blockquote><p>è¿™ä¸ªç®—æ³•æ˜¯æ•´ä¸ª <code>Virtual Dom</code> ä¸­æœ€æ ¸å¿ƒçš„ç®—æ³•ï¼Œä¸”è®©æˆ‘ä¸€ä¸€ä¸ºä½ é“æ¥ã€‚ è¿™é‡Œçš„ä¸»è¦æ­¥éª¤å…¶å®å’Œåˆ¤æ–­å±æ€§å·®å¼‚æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸‰æ­¥</p></blockquote> <ul><li>éå†æ—§çš„èŠ‚ç‚¹åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦è¿˜å­˜åœ¨äºæ–°çš„èŠ‚ç‚¹åˆ—è¡¨ä¸­</li> <li>éå†æ–°çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„èŠ‚ç‚¹</li> <li>åœ¨ç¬¬äºŒæ­¥ä¸­åŒæ—¶åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æœ‰ç§»åŠ¨</li></ul> <blockquote><p>PSï¼šè¯¥ç®—æ³•åªå¯¹æœ‰ <code>key</code> çš„èŠ‚ç‚¹åšå¤„ç†</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">listDiff</span><span class="token punctuation">(</span><span class="token parameter">oldList<span class="token punctuation">,</span> newList<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸ºäº†éå†æ–¹ä¾¿ï¼Œå…ˆå–å‡ºä¸¤ä¸ª list çš„æ‰€æœ‰ keys</span>
  <span class="token keyword">let</span> oldKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>oldList<span class="token punctuation">)</span>
  <span class="token keyword">let</span> newKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>newList<span class="token punctuation">)</span>
  <span class="token keyword">let</span> changes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// ç”¨äºä¿å­˜å˜æ›´åçš„èŠ‚ç‚¹æ•°æ®</span>
  <span class="token comment">// ä½¿ç”¨è¯¥æ•°ç»„ä¿å­˜æœ‰ä»¥ä¸‹å¥½å¤„</span>
  <span class="token comment">// 1.å¯ä»¥æ­£ç¡®è·å¾—è¢«åˆ é™¤èŠ‚ç‚¹ç´¢å¼•</span>
  <span class="token comment">// 2.äº¤æ¢èŠ‚ç‚¹ä½ç½®åªéœ€è¦æ“ä½œä¸€é DOM</span>
  <span class="token comment">// 3.ç”¨äº `diffChildren` å‡½æ•°ä¸­çš„åˆ¤æ–­ï¼Œåªéœ€è¦éå†</span>
  <span class="token comment">// ä¸¤ä¸ªæ ‘ä¸­éƒ½å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œè€Œå¯¹äºæ–°å¢æˆ–è€…åˆ é™¤çš„èŠ‚ç‚¹æ¥è¯´ï¼Œå®Œå…¨æ²¡å¿…è¦</span>
  <span class="token comment">// å†å»åˆ¤æ–­ä¸€é</span>
  <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  oldList <span class="token operator">&amp;&amp;</span>
    oldList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item
      <span class="token punctuation">}</span>
      <span class="token comment">// å¯»æ‰¾æ–°çš„ children ä¸­æ˜¯å¦å«æœ‰å½“å‰èŠ‚ç‚¹</span>
      <span class="token comment">// æ²¡æœ‰çš„è¯éœ€è¦åˆ é™¤</span>
      <span class="token keyword">let</span> index <span class="token operator">=</span> newKeys<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// éå†å˜æ›´åçš„æ•°ç»„</span>
  <span class="token keyword">let</span> length <span class="token operator">=</span> list<span class="token punctuation">.</span>length
  <span class="token comment">// å› ä¸ºåˆ é™¤æ•°ç»„å…ƒç´ æ˜¯ä¼šæ›´æ”¹ç´¢å¼•çš„</span>
  <span class="token comment">// æ‰€æœ‰ä»åå¾€å‰åˆ å¯ä»¥ä¿è¯ç´¢å¼•ä¸å˜</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¡¨ç¤ºéœ€è¦åˆ é™¤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token punctuation">,</span>
        index<span class="token operator">:</span> i
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// éå†æ–°çš„ listï¼Œåˆ¤æ–­æ˜¯å¦æœ‰èŠ‚ç‚¹æ–°å¢æˆ–ç§»åŠ¨</span>
  <span class="token comment">// åŒæ—¶ä¹Ÿå¯¹ `list` åšèŠ‚ç‚¹æ–°å¢å’Œç§»åŠ¨èŠ‚ç‚¹çš„æ“ä½œ</span>
  newList <span class="token operator">&amp;&amp;</span>
    newList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item
      <span class="token punctuation">}</span>
      <span class="token comment">// å¯»æ‰¾æ—§çš„ children ä¸­æ˜¯å¦å«æœ‰å½“å‰èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> index <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token comment">// æ²¡æ‰¾åˆ°ä»£è¡¨æ–°èŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          type<span class="token operator">:</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token punctuation">,</span>
          node<span class="token operator">:</span> item<span class="token punctuation">,</span>
          index<span class="token operator">:</span> i
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰¾åˆ°äº†ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span> StateEnums<span class="token punctuation">.</span>Move<span class="token punctuation">,</span>
            from<span class="token operator">:</span> index<span class="token punctuation">,</span>
            to<span class="token operator">:</span> i
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token function">move</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> index<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> text
  list <span class="token operator">&amp;&amp;</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
      <span class="token punctuation">}</span>
      keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> keys
<span class="token punctuation">}</span>
</code></pre></div><p><strong>éå†å­å…ƒç´ æ‰“æ ‡è¯†</strong></p> <blockquote><p>å¯¹äºè¿™ä¸ªå‡½æ•°æ¥è¯´ï¼Œä¸»è¦åŠŸèƒ½å°±ä¸¤ä¸ª</p></blockquote> <ul><li>åˆ¤æ–­ä¸¤ä¸ªåˆ—è¡¨å·®å¼‚
<ul><li>ç»™èŠ‚ç‚¹æ‰“ä¸Šæ ‡è®°</li> <li>æ€»ä½“æ¥è¯´ï¼Œè¯¥å‡½æ•°å®ç°çš„åŠŸèƒ½å¾ˆç®€å•</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">listDiff</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>changes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> changes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è®°å½•ä¸Šä¸€ä¸ªéå†è¿‡çš„èŠ‚ç‚¹</span>
  <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
  oldChild <span class="token operator">&amp;&amp;</span>
    oldChild<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> item <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>children
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index <span class="token operator">=</span>
          last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">let</span> keyIndex <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        <span class="token keyword">let</span> node <span class="token operator">=</span> newChild<span class="token punctuation">[</span>keyIndex<span class="token punctuation">]</span>
        <span class="token comment">// åªéå†æ–°æ—§ä¸­éƒ½å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œå…¶ä»–æ–°å¢æˆ–è€…åˆ é™¤çš„æ²¡å¿…è¦éå†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">dfs</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> node<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> index <span class="token operator">+=</span> <span class="token number">1</span>
      last <span class="token operator">=</span> item
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>æ¸²æŸ“å·®å¼‚</strong></p> <blockquote><p>é€šè¿‡ä¹‹å‰çš„ç®—æ³•ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å¾—å‡ºä¸¤ä¸ªæ ‘çš„å·®å¼‚äº†ã€‚æ—¢ç„¶çŸ¥é“äº†å·®å¼‚ï¼Œå°±éœ€è¦å±€éƒ¨å»æ›´æ–° <code>DOM</code> äº†ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>Virtual Dom</code> ç®—æ³•çš„æœ€åä¸€æ­¥éª¤</p></blockquote> <p><strong>è¿™ä¸ªå‡½æ•°ä¸»è¦ä¸¤ä¸ªåŠŸèƒ½</strong></p> <ul><li>æ·±åº¦éå†æ ‘ï¼Œå°†éœ€è¦åšå˜æ›´æ“ä½œçš„å–å‡ºæ¥</li> <li>å±€éƒ¨æ›´æ–° <code>DOM</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patchs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> changes <span class="token operator">=</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
  <span class="token keyword">let</span> childNodes <span class="token operator">=</span> node <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes
  <span class="token comment">// è¿™é‡Œçš„æ·±åº¦éå†å’Œ diff ä¸­æ˜¯ä¸€æ ·çš„</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childNodes<span class="token punctuation">)</span> index <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">&amp;&amp;</span> changes<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">changeDom</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> changes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childNodes <span class="token operator">&amp;&amp;</span> childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      index <span class="token operator">=</span>
        last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> patchs<span class="token punctuation">)</span>
      last <span class="token operator">=</span> item
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">changeDom</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> changes<span class="token punctuation">,</span> noChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  changes <span class="token operator">&amp;&amp;</span>
    changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> change
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token operator">:</span>
          <span class="token keyword">let</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> change
          props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">,</span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token operator">:</span>
          node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token operator">:</span>
          <span class="token keyword">let</span> dom
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dom <span class="token operator">=</span> change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token operator">:</span>
          node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Move<span class="token operator">:</span>
          <span class="token keyword">let</span> fromNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>from<span class="token punctuation">]</span>
          <span class="token keyword">let</span> toNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>to<span class="token punctuation">]</span>
          <span class="token keyword">let</span> cloneFromNode <span class="token operator">=</span> fromNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token keyword">let</span> cloenToNode <span class="token operator">=</span> toNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloneFromNode<span class="token punctuation">,</span> toNode<span class="token punctuation">)</span>
          node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloenToNode<span class="token punctuation">,</span> fromNode<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Virtual Dom ç®—æ³•çš„å®ç°ä¹Ÿå°±æ˜¯ä»¥ä¸‹ä¸‰æ­¥</strong></p> <ul><li>é€šè¿‡ <code>JS</code> æ¥æ¨¡æ‹Ÿåˆ›å»º <code>DOM</code> å¯¹è±¡</li> <li>åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡çš„å·®å¼‚</li> <li>æ¸²æŸ“å·®å¼‚</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> test4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test4'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> test5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test5'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> test1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'my-div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>test4<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> test2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">'11'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>test5<span class="token punctuation">,</span> test4<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> root <span class="token operator">=</span> test1<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> pathchs <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>test1<span class="token punctuation">,</span> test2<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pathchs<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'å¼€å§‹æ›´æ–°'</span><span class="token punctuation">)</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> pathchs<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ç»“æŸæ›´æ–°'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_4-diffç®—æ³•"><a href="#_4-diffç®—æ³•" class="header-anchor">#</a> 4 Diffç®—æ³•</h2> <h3 id="_4-1-react-diff"><a href="#_4-1-react-diff" class="header-anchor">#</a> 4.1 React-Diff</h3> <p>Reactçš„æ€è·¯æ˜¯é€’å¢æ³•ã€‚é€šè¿‡å¯¹æ¯”æ–°çš„åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œåœ¨åŸæœ¬çš„åˆ—è¡¨ä¸­çš„ä½ç½®æ˜¯å¦æ˜¯é€’å¢ï¼Œæ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨ã€‚</p> <p><strong>1. å®ç°åŸç†</strong></p> <p>æ¥çœ‹è¿™æ ·ä¸€ä¸ªä¾‹å­ã€‚</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7cc8e69cb5b04387b7b259622a91bbe6~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p><code>nextList</code>ä¸ºæ–°çš„åˆ—è¡¨ï¼Œ<code>prevList</code>ä¸ºæ—§åˆ—è¡¨ã€‚è¿™ä¸ªä¾‹å­æˆ‘ä»¬ä¸€çœ¼èƒ½çœ‹å‡ºæ¥ï¼Œæ–°åˆ—è¡¨æ˜¯ä¸éœ€è¦è¿›è¡Œç§»åŠ¨çš„ã€‚ä¸‹é¢æˆ‘ç”¨<code>react</code>çš„é€’å¢æ€æƒ³ï¼Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆæ–°åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨ã€‚</p> <p>æˆ‘ä»¬é¦–å…ˆéå†<code>nextList</code>ï¼Œå¹¶ä¸”æ‰¾åˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåœ¨<code>prevList</code>ä¸­çš„ä½ç½®ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">prevList<span class="token punctuation">,</span> nextList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextItem <span class="token operator">=</span> nextList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> prevList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> prevItem <span class="token operator">=</span> prevList<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextItem <span class="token operator">===</span> prevItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰¾åˆ°ä½ç½®ä»¥åï¼Œä¸ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœå½“å‰çš„ä½ç½®å¤§äºä¸Šä¸€ä¸ªä½ç½®ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨ã€‚å› æ­¤æˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ª<code>lastIndex</code>æ¥è®°å½•ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">prevList<span class="token punctuation">,</span> nextList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextItem <span class="token operator">=</span> nextList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> prevList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> prevItem <span class="token operator">=</span> prevList<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextItem <span class="token operator">===</span> prevItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// éœ€è¦ç§»åŠ¨èŠ‚ç‚¹</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œè®°å½•å½“å‰ä½ç½®ï¼Œä¸ä¹‹åçš„èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>nextList</code>æ¯ä¸ªèŠ‚ç‚¹åœ¨<code>prevList</code>çš„ä½ç½®ä¸º<code>0 1 2 3</code>ã€‚æ¯ä¸€é¡¹éƒ½è¦æ¯”å‰ä¸€é¡¹è¦å¤§ï¼Œæ‰€ä»¥ä¸éœ€è¦ç§»åŠ¨ï¼Œè¿™å°±æ˜¯<code>react</code>çš„<code>diff</code>ç®—æ³•çš„åŸç†ã€‚</p> <p><strong>2. æ‰¾åˆ°éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹</strong></p> <p>åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡å¯¹æ¯”å€¼æ˜¯å¦ç›¸ç­‰ï¼ŒæŸ¥æ‰¾çš„å¯¹åº”ä½ç½®ã€‚ä½†æ˜¯åœ¨vdomä¸­ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªvNodeï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¿›è¡Œåˆ¤æ–­å‘¢ï¼Ÿ</p> <p>ç­”æ¡ˆå°±æ˜¯<code>key</code>ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹æ¯ä¸ªèŠ‚ç‚¹çš„<code>key</code>è¿›è¡Œèµ‹å€¼ï¼Œå¹¶ä¸”è®©å¤„äºåŒä¸€<code>children</code>æ•°ç»„ä¸‹çš„<code>vnode</code>çš„<code>key</code>éƒ½ä¸ç›¸åŒï¼Œä»¥æ­¤æ¥ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹çš„å”¯ä¸€æ€§ï¼Œå¹¶è¿›è¡Œæ–°æ—§åˆ—è¡¨çš„å¯¹æ¯”ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reactDiff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextChild <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> prevChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> prevChild <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">===</span> prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// éœ€è¦ç§»åŠ¨èŠ‚ç‚¹</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œè®°å½•å½“å‰ä½ç½®ï¼Œä¸ä¹‹åçš„èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>3. ç§»åŠ¨èŠ‚ç‚¹</strong></p> <p>é¦–å…ˆæˆ‘ä»¬å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œç§»åŠ¨èŠ‚ç‚¹æ‰€æŒ‡çš„èŠ‚ç‚¹æ˜¯<code>DOM</code>èŠ‚ç‚¹ã€‚<code>vnode.el</code>æŒ‡å‘è¯¥èŠ‚ç‚¹å¯¹åº”çš„çœŸå®<code>DOM</code>èŠ‚ç‚¹ã€‚<code>patch</code>æ–¹æ³•ä¼šå°†æ›´æ–°è¿‡åçš„<code>DOM</code>èŠ‚ç‚¹ï¼Œèµ‹å€¼ç»™<strong>æ–°çš„</strong><code>vnode</code>çš„<code>el</code>å±æ€§ã€‚</p> <blockquote><p>ä¸ºäº†ç”»å›¾æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç”¨<code>key</code>çš„å€¼æ¥è¡¨ç¤º<code>vnode</code>èŠ‚ç‚¹ã€‚ä¸ºäº†è¡Œæ–‡æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠ<code>key</code>å€¼ä¸º<code>a</code>çš„<code>vnode</code>ç®€å†™ä¸º<code>vnode-a</code>ï¼Œ<code>vnode-a</code>å¯¹åº”çš„çœŸå®DOMèŠ‚ç‚¹ä¸º<code>DOM-A</code></p></blockquote> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab3a37a997a84b95af9f39326bf2a24f~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æˆ‘ä»¬æ¥å°†ä¸Šå›¾çš„ä¾‹å­ä»£å…¥<code>reactDiff</code>ä¸­æ‰§è¡Œã€‚æˆ‘ä»¬éå†<strong>æ–°åˆ—è¡¨</strong>ï¼Œå¹¶æŸ¥æ‰¾<code>vnode</code>åœ¨<strong>æ—§åˆ—è¡¨</strong>ä¸­çš„ä½ç½®ã€‚å½“éå†åˆ°<code>vnode-d</code>æ—¶ï¼Œä¹‹å‰éå†åœ¨<strong>æ—§åˆ—è¡¨</strong>çš„ä½ç½®ä¸º<code>0 &lt; 2 &lt; 3</code>ï¼Œè¯´æ˜<code>A C D</code>è¿™ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸éœ€è¦ç§»åŠ¨çš„ã€‚æ­¤æ—¶<code>lastIndex = 3</code>, å¹¶è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå‘ç°<code>vnode-b</code>åœ¨<strong>æ—§åˆ—è¡¨</strong>çš„<code>index</code>ä¸º<code>1</code>ï¼Œ<code>1 &lt; 3</code>ï¼Œè¯´æ˜<code>DOM-B</code>è¦ç§»åŠ¨ã€‚</p> <p>é€šè¿‡è§‚å¯Ÿæˆ‘ä»¬èƒ½å‘ç°ï¼Œåªéœ€è¦æŠŠ<code>DOM-B</code>ç§»åŠ¨åˆ°<code>DOM-D</code>ä¹‹åå°±å¯ä»¥äº†ã€‚ä¹Ÿå°±æ˜¯<strong>æ‰¾åˆ°éœ€è¦ç§»åŠ¨çš„VNodeï¼Œæˆ‘ä»¬ç§°è¯¥VNodeä¸ºÎ±ï¼Œå°†Î±å¯¹åº”çš„çœŸå®çš„DOMèŠ‚ç‚¹ç§»åŠ¨åˆ°ï¼ŒÎ±åœ¨<code>æ–°åˆ—è¡¨</code>ä¸­çš„å‰ä¸€ä¸ªVNodeå¯¹åº”çš„çœŸå®DOMçš„åé¢ã€‚</strong></p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e757d546440478b83e938f3824f9364~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯å°†<code>vnode-b</code>å¯¹åº”çš„çœŸå®DOMèŠ‚ç‚¹<code>DOM-B</code>, ç§»åŠ¨åˆ°<code>vnode-b</code>åœ¨æ–°åˆ—è¡¨ä¸­çš„å‰ä¸€ä¸ª<code>VNode</code>â€”â€”<code>vnode-d</code>å¯¹åº”çš„çœŸå®DOMèŠ‚ç‚¹<code>DOM-D</code>çš„åé¢</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reactDiff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextChild <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> prevChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> prevChild <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">===</span> prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ç§»åŠ¨åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åé¢</span>
                    <span class="token keyword">let</span> refNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span>
                    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>el<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œè®°å½•å½“å‰ä½ç½®ï¼Œä¸ä¹‹åçš„èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ç§»åŠ¨çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬åˆ—è¡¨æ˜¯<code>ä»å¤´åˆ°å°¾</code>éå†çš„ã€‚è¿™å°±æ„å‘³ç€å¯¹äºå½“å‰<code>VNode</code>èŠ‚ç‚¹æ¥è¯´ï¼Œè¯¥èŠ‚ç‚¹ä¹‹å‰çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯æ’å¥½åºçš„ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨ï¼Œé‚£ä¹ˆåªéœ€è¦å°†DOMèŠ‚ç‚¹ç§»åŠ¨åˆ°å‰ä¸€ä¸ª<code>vnode</code>èŠ‚ç‚¹ä¹‹åå°±å¯ä»¥ï¼Œå› ä¸ºåœ¨<strong>æ–°åˆ—è¡¨</strong>ä¸­<code>vnode</code>çš„é¡ºåºå°±æ˜¯è¿™æ ·çš„ã€‚</p> <p><strong>4. æ·»åŠ èŠ‚ç‚¹</strong></p> <p>ä¸Šä¸€å°èŠ‚æˆ‘ä»¬åªè®²äº†å¦‚ä½•ç§»åŠ¨èŠ‚ç‚¹ï¼Œä½†æ˜¯å¿½ç•¥äº†å¦å¤–ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯åœ¨<strong>æ–°åˆ—è¡¨</strong>ä¸­æœ‰å…¨æ–°çš„<code>VNode</code>èŠ‚ç‚¹ï¼Œåœ¨<strong>æ—§åˆ—è¡¨</strong>ä¸­æ‰¾ä¸åˆ°ã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ–°çš„<code>VNode</code>èŠ‚ç‚¹ç”Ÿæˆ<code>DOM</code>èŠ‚ç‚¹ï¼Œå¹¶æ’å…¥<code>DOM</code>æ ‘ä¸­ã€‚</p> <p>è‡³æ­¤ï¼Œæˆ‘ä»¬é¢ä¸´ä¸¤ä¸ªé—®é¢˜ï¼š1.å¦‚ä½•å‘ç°å…¨æ–°çš„èŠ‚ç‚¹ã€2. ç”Ÿæˆçš„<code>DOM</code>èŠ‚ç‚¹æ’å…¥åˆ°å“ªé‡Œ</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7f3ae4ecace400a801b35c156e2edfc~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ‰¾èŠ‚ç‚¹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª<code>find</code>å˜é‡å€¼ä¸º<code>false</code>ã€‚å¦‚æœåœ¨<strong>æ—§åˆ—è¡¨</strong>æ‰¾åˆ°äº†<code>key</code> ç›¸åŒçš„<code>vnode</code>ï¼Œå°±å°†<code>find</code>çš„å€¼æ”¹ä¸º<code>true</code>ã€‚å½“éå†ç»“æŸååˆ¤æ–­<code>find</code>å€¼ï¼Œå¦‚æœä¸º<code>false</code>ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reactDiff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextChild <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            find <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> prevChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> prevChild <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">===</span> prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                find <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ç§»åŠ¨åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åé¢</span>
                    <span class="token keyword">let</span> refNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span>
                    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>el<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œè®°å½•å½“å‰ä½ç½®ï¼Œä¸ä¹‹åçš„èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>find<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ’å…¥æ–°èŠ‚ç‚¹</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰¾åˆ°æ–°èŠ‚ç‚¹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æ’å…¥åˆ°å“ªé‡Œäº†ï¼Œè¿™é‡Œçš„é€»è¾‘å…¶å®æ˜¯å’Œç§»åŠ¨èŠ‚ç‚¹çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬è§‚å¯Ÿä¸Šå›¾å¯ä»¥å‘ç°ï¼Œæ–°çš„<code>vnode-c</code>æ˜¯ç´§è·Ÿåœ¨<code>vnode-b</code>åé¢çš„ï¼Œå¹¶ä¸”<code>vnode-b</code>çš„DOMèŠ‚ç‚¹â€”â€”<code>DOM-B</code>æ˜¯å·²ç»æ’å¥½åºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†<code>vnode-c</code>ç”Ÿæˆçš„DOMèŠ‚ç‚¹æ’å…¥åˆ°<code>DOM-B</code>ä¹‹åå°±å¯ä»¥äº†ã€‚</p> <p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µéœ€è¦æ³¨æ„ï¼Œå°±æ˜¯æ–°çš„èŠ‚ç‚¹ä½äº<strong>æ–°åˆ—è¡¨</strong>çš„ç¬¬ä¸€ä¸ªï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰¾åˆ°<strong>æ—§åˆ—è¡¨</strong>ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°åŸæ¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¹‹å‰å°±å¯ä»¥äº†ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reactDiff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextChild <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            find <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> prevChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> prevChild <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">===</span> prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                find <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ç§»åŠ¨åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åé¢</span>
                    <span class="token keyword">let</span> refNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span>
                    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>el<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œè®°å½•å½“å‰ä½ç½®ï¼Œä¸ä¹‹åçš„èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>find<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ’å…¥æ–°èŠ‚ç‚¹</span>
            <span class="token keyword">let</span> refNode <span class="token operator">=</span> i <span class="token operator">&lt;=</span> <span class="token number">0</span>
                            <span class="token operator">?</span> prevChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el
                            <span class="token operator">:</span> nextChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
            <span class="token function">mount</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>5. ç§»é™¤èŠ‚ç‚¹</strong></p> <p>æœ‰å¢å°±æœ‰å‡ï¼Œå½“æ—§çš„èŠ‚ç‚¹ä¸åœ¨<strong>æ–°åˆ—è¡¨</strong>ä¸­æ—¶ï¼Œæˆ‘ä»¬å°±å°†å…¶å¯¹åº”çš„DOMèŠ‚ç‚¹ç§»é™¤ã€‚</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9cf836312b6345d98b4ea8c9efe80a9a~tplv-k3u1fbpfcp-watermark.image?imageslim" alt="img"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reactDiff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextChild <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            find <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> prevChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> prevChild <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">===</span> prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                find <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ç§»åŠ¨åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åé¢</span>
                    <span class="token keyword">let</span> refNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span>
                    parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>el<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œè®°å½•å½“å‰ä½ç½®ï¼Œä¸ä¹‹åçš„èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</span>
                    lastIndex <span class="token operator">=</span> j
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>find<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ’å…¥æ–°èŠ‚ç‚¹</span>
            <span class="token keyword">let</span> refNode <span class="token operator">=</span> i <span class="token operator">&lt;=</span> <span class="token number">0</span>
                            <span class="token operator">?</span> prevChildren<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el
                            <span class="token operator">:</span> nextChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
            <span class="token function">mount</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> prevChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> prevChild <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> prevChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
            has <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>has<span class="token punctuation">)</span> parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>6. ä¼˜åŒ–ä¸ä¸è¶³</strong></p> <p>ä»¥ä¸Šå°±æ˜¯Reactçš„diffç®—æ³•çš„æ€è·¯ã€‚</p> <p>ç›®å‰çš„<code>reactDiff</code>çš„æ—¶é—´å¤æ‚åº¦ä¸º<code>O(m*n)</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç©ºé—´æ¢æ—¶é—´ï¼ŒæŠŠ<code>key</code>ä¸<code>index</code>çš„å…³ç³»ç»´æŠ¤æˆä¸€ä¸ª<code>Map</code>ï¼Œä»è€Œå°†æ—¶é—´å¤æ‚åº¦é™ä½ä¸º<code>O(n)</code>ï¼Œå…·ä½“çš„ä»£ç å¯ä»¥<a href="https://github.com/sunyanzhe/virtual-dom/blob/master/src/diff/react-diff.js" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹æ­¤é¡¹ç›®<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹è¿™æ ·ä¸€ä¸ªä¾‹å­</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aed2a562a9674f5293e4e51a1b8b9005~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æ ¹æ®<code>reactDiff</code>çš„æ€è·¯ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°†<code>DOM-A</code>ç§»åŠ¨åˆ°<code>DOM-C</code>ä¹‹åï¼Œç„¶åå†å°†<code>DOM-B</code>ç§»åŠ¨åˆ°<code>DOM-A</code>ä¹‹åï¼Œå®Œæˆ<code>Diff</code>ã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œåªè¦å°†<code>DOM-C</code>ç§»åŠ¨åˆ°<code>DOM-A</code>ä¹‹å‰å°±å¯ä»¥å®Œæˆ<code>Diff</code>ã€‚</p> <p>è¿™é‡Œæ˜¯æœ‰å¯ä¼˜åŒ–çš„ç©ºé—´çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»<code>vue2.x</code>ä¸­çš„<code>diff</code>ç®—æ³•â€”â€”<code>åŒç«¯æ¯”è¾ƒ</code>ï¼Œè¯¥ç®—æ³•è§£å†³äº†ä¸Šè¿°çš„é—®é¢˜</p> <h3 id="_4-2-vue2-x-diff-åŒç«¯æ¯”è¾ƒ"><a href="#_4-2-vue2-x-diff-åŒç«¯æ¯”è¾ƒ" class="header-anchor">#</a> 4.2 Vue2.X Diff â€”â€” åŒç«¯æ¯”è¾ƒ</h3> <p>æ‰€è°“<code>åŒç«¯æ¯”è¾ƒ</code>å°±æ˜¯<strong>æ–°åˆ—è¡¨</strong>å’Œ<strong>æ—§åˆ—è¡¨</strong>ä¸¤ä¸ªåˆ—è¡¨çš„å¤´ä¸å°¾äº’ç›¸å¯¹æ¯”ï¼Œï¼Œåœ¨å¯¹æ¯”çš„è¿‡ç¨‹ä¸­æŒ‡é’ˆä¼šé€æ¸å‘å†…é æ‹¢ï¼Œç›´åˆ°æŸä¸€ä¸ªåˆ—è¡¨çš„èŠ‚ç‚¹å…¨éƒ¨éå†è¿‡ï¼Œå¯¹æ¯”åœæ­¢ã€‚</p> <p><strong>1. å®ç°åŸç†</strong></p> <p>æˆ‘ä»¬å…ˆç”¨å››ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸¤ä¸ªåˆ—è¡¨çš„å¤´å°¾</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    oldEndIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    newEndIndex <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>nextStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>nextEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬æ ¹æ®å››ä¸ªæŒ‡é’ˆæ‰¾åˆ°å››ä¸ªèŠ‚ç‚¹ï¼Œç„¶åè¿›è¡Œå¯¹æ¯”ï¼Œé‚£ä¹ˆå¦‚ä½•å¯¹æ¯”å‘¢ï¼Ÿæˆ‘ä»¬æŒ‰ç…§ä»¥ä¸‹å››ä¸ªæ­¥éª¤è¿›è¡Œå¯¹æ¯”</p> <ol><li>ä½¿ç”¨<strong>æ—§åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>oldStartNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>newStartNode</code>å¯¹æ¯”</li> <li>ä½¿ç”¨<strong>æ—§åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>oldEndNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>newEndNode</code>å¯¹æ¯”</li> <li>ä½¿ç”¨<strong>æ—§åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>oldStartNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>newEndNode</code>å¯¹æ¯”</li> <li>ä½¿ç”¨<strong>æ—§åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>oldEndNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>newStartNode</code>å¯¹æ¯”</li></ol> <p>ä½¿ç”¨ä»¥ä¸Šå››æ­¥è¿›è¡Œå¯¹æ¯”ï¼Œå»å¯»æ‰¾<code>key</code>ç›¸åŒçš„å¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œå½“åœ¨æŸä¸€æ­¥ä¸­æ‰¾åˆ°äº†åˆ™åœæ­¢åé¢çš„å¯»æ‰¾ã€‚å…·ä½“å¯¹æ¯”é¡ºåºå¦‚ä¸‹å›¾</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/847306f303ab4177891b56cccff1ebd3~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>å¯¹æ¯”é¡ºåºä»£ç ç»“æ„å¦‚ä¸‹:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    oldEndIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    newEndIndex <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“å¯¹æ¯”æ—¶æ‰¾åˆ°äº†å¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆ<code>patch</code>ç»™å…ƒç´ æ‰“è¡¥ä¸ï¼Œç„¶åå°†æŒ‡é’ˆè¿›è¡Œ<code>å‰/åç§»</code>ä¸€ä½æŒ‡é’ˆã€‚æ ¹æ®å¯¹æ¯”èŠ‚ç‚¹çš„ä¸åŒï¼Œæˆ‘ä»¬ç§»åŠ¨çš„<strong>æŒ‡é’ˆ</strong>å’Œ<strong>æ–¹å‘</strong>ä¹Ÿä¸åŒï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p> <ol><li>å½“<strong>æ—§åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>oldStartNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>newStartNode</code>å¯¹æ¯”æ—¶<code>key</code>ç›¸åŒã€‚é‚£ä¹ˆ<strong>æ—§åˆ—è¡¨</strong>çš„å¤´æŒ‡é’ˆ<code>oldStartIndex</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„å¤´æŒ‡é’ˆ<code>newStartIndex</code>åŒæ—¶å‘<strong>å</strong>ç§»åŠ¨ä¸€ä½ã€‚</li> <li>å½“<strong>æ—§åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>oldEndNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>newEndNode</code>å¯¹æ¯”æ—¶<code>key</code>ç›¸åŒã€‚é‚£ä¹ˆ<strong>æ—§åˆ—è¡¨</strong>çš„å°¾æŒ‡é’ˆ<code>oldEndIndex</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„å°¾æŒ‡é’ˆ<code>newEndIndex</code>åŒæ—¶å‘<strong>å‰</strong>ç§»åŠ¨ä¸€ä½ã€‚</li> <li>å½“<strong>æ—§åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>oldStartNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>newEndNode</code>å¯¹æ¯”æ—¶<code>key</code>ç›¸åŒã€‚é‚£ä¹ˆ<strong>æ—§åˆ—è¡¨</strong>çš„å¤´æŒ‡é’ˆ<code>oldStartIndex</code>å‘<strong>å</strong>ç§»åŠ¨ä¸€ä½ï¼›<strong>æ–°åˆ—è¡¨</strong>çš„å°¾æŒ‡é’ˆ<code>newEndIndex</code>å‘<strong>å‰</strong>ç§»åŠ¨ä¸€ä½ã€‚</li> <li>å½“<strong>æ—§åˆ—è¡¨</strong>çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹<code>oldEndNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹<code>newStartNode</code>å¯¹æ¯”æ—¶<code>key</code>ç›¸åŒã€‚é‚£ä¹ˆ<strong>æ—§åˆ—è¡¨</strong>çš„å°¾æŒ‡é’ˆ<code>oldEndIndex</code>å‘<strong>å‰</strong>ç§»åŠ¨ä¸€ä½ï¼›<strong>æ–°åˆ—è¡¨</strong>çš„å¤´æŒ‡é’ˆ<code>newStartIndex</code>å‘<strong>å</strong>ç§»åŠ¨ä¸€ä½ã€‚</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    oldEndIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    newEndIndex <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>oldvStartNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

    oldStartIndex<span class="token operator">++</span>
    newStartIndex<span class="token operator">++</span>
    oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
    newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">,</span> newEndNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

    oldEndIndex<span class="token operator">--</span>
    newEndIndex<span class="token operator">--</span>
    oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span>
    newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>oldStartNode<span class="token punctuation">,</span> newEndNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

    oldStartIndex<span class="token operator">++</span>
    newEndIndex<span class="token operator">--</span>
    oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
    newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

    oldEndIndex<span class="token operator">--</span>
    nextStartIndex<span class="token operator">++</span>
    oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span>
    newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨å°èŠ‚çš„å¼€å¤´ï¼Œæåˆ°äº†è¦è®©æŒ‡é’ˆå‘å†…é æ‹¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¾ªç¯ã€‚å¾ªç¯åœæ­¢çš„æ¡ä»¶æ˜¯å½“å…¶ä¸­ä¸€ä¸ªåˆ—è¡¨çš„èŠ‚ç‚¹å…¨éƒ¨éå†å®Œæˆï¼Œä»£ç å¦‚ä¸‹</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    oldEndIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    newEndIndex <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldStartNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

      oldStartIndex<span class="token operator">++</span>
      newStartIndex<span class="token operator">++</span>
      oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">,</span> newEndNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

      oldEndIndex<span class="token operator">--</span>
      newndIndex<span class="token operator">--</span>
      oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span>
      newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldvStartNode<span class="token punctuation">,</span> newEndNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

      oldStartIndex<span class="token operator">++</span>
      newEndIndex<span class="token operator">--</span>
      oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
      newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

      oldEndIndex<span class="token operator">--</span>
      newStartIndex<span class="token operator">++</span>
      oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è‡³æ­¤æ•´ä½“çš„å¾ªç¯æˆ‘ä»¬å°±å…¨éƒ¨å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬éœ€è¦è€ƒè™‘è¿™æ ·ä¸¤ä¸ªé—®é¢˜ï¼š</p> <ul><li>ä»€ä¹ˆæƒ…å†µä¸‹<code>DOM</code>èŠ‚ç‚¹éœ€è¦ç§»åŠ¨</li> <li><code>DOM</code>èŠ‚ç‚¹å¦‚ä½•ç§»åŠ¨</li></ul> <p>æˆ‘ä»¬æ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š<strong>ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ç§»åŠ¨</strong>ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸Šå›¾ä¸ºä¾‹ã€‚</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8c96a75e48346aea2c7de1d8bfa6f67~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>å½“æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªå¾ªç¯æ—¶ï¼Œåœ¨<code>ç¬¬å››æ­¥</code>å‘ç°<strong>æ—§åˆ—è¡¨çš„å°¾èŠ‚ç‚¹</strong><code>oldEndNode</code>ä¸<strong>æ–°åˆ—è¡¨çš„å¤´èŠ‚ç‚¹</strong><code>newStartNode</code>çš„<code>key</code>ç›¸åŒï¼Œæ˜¯å¯å¤ç”¨çš„<code>DOM</code>èŠ‚ç‚¹ã€‚é€šè¿‡è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<strong>åŸæœ¬åœ¨æ—§åˆ—è¡¨æœ«å°¾çš„èŠ‚ç‚¹ï¼Œå´æ˜¯æ–°åˆ—è¡¨ä¸­çš„å¼€å¤´èŠ‚ç‚¹ï¼Œæ²¡æœ‰äººæ¯”ä»–æ›´é å‰ï¼Œå› ä¸ºä»–æ˜¯ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠå½“å‰çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°åŸæœ¬æ—§åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¹‹å‰ï¼Œè®©å®ƒæˆä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³å¯</strong>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
      <span class="token comment">// ç§»åŠ¨åˆ°æ—§åˆ—è¡¨å¤´èŠ‚ç‚¹ä¹‹å‰</span>
      parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
      
      oldEndIndex<span class="token operator">--</span>
      newStartIndex<span class="token operator">++</span>
      oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7f3368a5a5744bcb2b356d7424093a6~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>ç„¶åæˆ‘ä»¬è¿›å…¥ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œæˆ‘ä»¬åœ¨<code>ç¬¬äºŒæ­¥</code>å‘ç°ï¼Œ<strong>æ—§åˆ—è¡¨çš„å°¾èŠ‚ç‚¹</strong><code>oldEndNode</code>å’Œ<strong>æ–°åˆ—è¡¨çš„å°¾èŠ‚ç‚¹</strong><code>newEndNode</code>ä¸ºå¤ç”¨èŠ‚ç‚¹ã€‚<strong>åŸæœ¬åœ¨æ—§åˆ—è¡¨ä¸­å°±æ˜¯å°¾èŠ‚ç‚¹ï¼Œåœ¨æ–°åˆ—è¡¨ä¸­ä¹Ÿæ˜¯å°¾èŠ‚ç‚¹ï¼Œè¯´æ˜è¯¥èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸éœ€è¦åšã€‚</p> <p>åŒç†ï¼Œå¦‚æœæ˜¯<strong>æ—§åˆ—è¡¨çš„å¤´èŠ‚ç‚¹</strong><code>oldStartNode</code>å’Œ<strong>æ–°åˆ—è¡¨çš„å¤´èŠ‚ç‚¹</strong><code>newStartNode</code>ä¸ºå¤ç”¨èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¹Ÿä»€ä¹ˆéƒ½ä¸éœ€è¦åšã€‚</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2520c8511aad44589947be3616f7f50b~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>è¿›å…¥ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼Œæˆ‘ä»¬åœ¨<code>ç¬¬ä¸‰éƒ¨</code>å‘ç°ï¼Œ<strong>æ—§åˆ—è¡¨çš„å¤´èŠ‚ç‚¹</strong><code>oldStartNode</code>å’Œ<strong>æ–°åˆ—è¡¨çš„å°¾èŠ‚ç‚¹</strong><code>newEndNode</code>ä¸ºå¤ç”¨èŠ‚ç‚¹ã€‚åˆ°è¿™ä¸€æ­¥èªæ˜å¦‚ä½ è‚¯å®šå°±ä¸€çœ¼å¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œæˆ‘ä»¬åªè¦å°†<code>DOM-A</code>ç§»åŠ¨åˆ°<code>DOM-B</code>åé¢å°±å¯ä»¥äº†ã€‚</p> <p>ä¾ç…§æƒ¯ä¾‹æˆ‘ä»¬è¿˜æ˜¯è§£é‡Šä¸€ä¸‹ï¼Œ<strong>åŸæœ¬æ—§åˆ—è¡¨ä¸­æ˜¯å¤´èŠ‚ç‚¹ï¼Œç„¶ååœ¨æ–°åˆ—è¡¨ä¸­æ˜¯å°¾èŠ‚ç‚¹ã€‚é‚£ä¹ˆåªè¦åœ¨æ—§åˆ—è¡¨ä¸­æŠŠå½“å‰çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°åŸæœ¬å°¾èŠ‚ç‚¹çš„åé¢ï¼Œå°±å¯ä»¥äº†</strong>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldStartNode<span class="token punctuation">,</span> newEndNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
      parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldEndNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span>

      oldStartIndex<span class="token operator">++</span>
      newEndIndex<span class="token operator">--</span>
      oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
      newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d0a744cac8045fc9ae4f593a153cc72~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>OKï¼Œè¿›å…¥æœ€åä¸€ä¸ªå¾ªç¯ã€‚åœ¨<code>ç¬¬ä¸€æ­¥</code><strong>æ—§åˆ—è¡¨</strong>å¤´èŠ‚ç‚¹<code>oldStartNode</code>ä¸<strong>æ–°åˆ—è¡¨</strong>å¤´èŠ‚ç‚¹<code>newStartNode</code>ä½ç½®ç›¸åŒï¼Œæ‰€ä»¥å•¥ä¹Ÿä¸ç”¨åšã€‚ç„¶åç»“æŸå¾ªç¯ï¼Œè¿™å°±æ˜¯<code>Vue2 åŒç«¯æ¯”è¾ƒ</code>çš„åŸç†ã€‚</p> <p><strong>2. éç†æƒ³æƒ…å†µ</strong></p> <p>ä¸Šä¸€å°èŠ‚ï¼Œæˆ‘ä»¬è®²äº†<code>åŒç«¯æ¯”è¾ƒ</code>çš„åŸç†ï¼Œä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå½“å››æ¬¡å¯¹æ¯”éƒ½<strong>æ²¡æ‰¾åˆ°</strong>å¤ç”¨èŠ‚ç‚¹æ—¶ï¼Œæˆ‘ä»¬åªèƒ½æ‹¿<strong>æ–°åˆ—è¡¨</strong>çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å»<strong>æ—§åˆ—è¡¨</strong>ä¸­æ‰¾ä¸å…¶<code>key</code>ç›¸åŒçš„èŠ‚ç‚¹ã€‚</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2dea77f7267b406ca0dc8600096c4dc1~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åœ¨æ—§åˆ—è¡¨ä¸­æ‰¾åˆ° å’Œæ–°åˆ—è¡¨å¤´èŠ‚ç‚¹key ç›¸åŒçš„èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
        oldIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> child<span class="token punctuation">.</span>key <span class="token operator">===</span> newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰¾èŠ‚ç‚¹çš„æ—¶å€™å…¶å®ä¼šæœ‰ä¸¤ç§æƒ…å†µï¼šä¸€ç§åœ¨<strong>æ—§åˆ—è¡¨</strong>ä¸­æ‰¾åˆ°äº†ï¼Œå¦ä¸€ç§æƒ…å†µæ˜¯æ²¡æ‰¾åˆ°ã€‚æˆ‘ä»¬å…ˆä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œè¯´ä¸€ä¸‹æ‰¾åˆ°çš„æƒ…å†µã€‚</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a74e61a47abb4e3ca85ffee65410340d~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>å½“æˆ‘ä»¬åœ¨æ—§åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„<code>VNode</code>ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æ‰¾åˆ°çš„èŠ‚ç‚¹çš„<code>DOM</code>å…ƒç´ ï¼Œç§»åŠ¨åˆ°å¼€å¤´å°±å¯ä»¥äº†ã€‚è¿™é‡Œçš„é€»è¾‘å…¶å®å’Œ<code>ç¬¬å››æ­¥</code>çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡<code>ç¬¬å››æ­¥</code>æ˜¯ç§»åŠ¨çš„å°¾èŠ‚ç‚¹ï¼Œè¿™é‡Œæ˜¯ç§»åŠ¨æ‰¾åˆ°çš„èŠ‚ç‚¹ã€‚<code>DOM</code>ç§»åŠ¨åï¼Œç”±æˆ‘ä»¬å°†<strong>æ—§åˆ—è¡¨</strong>ä¸­çš„èŠ‚ç‚¹æ”¹ä¸º<code>undefined</code>ï¼Œè¿™æ˜¯<strong>è‡³å…³é‡è¦</strong>çš„ä¸€æ­¥ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åšäº†èŠ‚ç‚¹çš„ç§»åŠ¨äº†æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è¿›è¡Œå†æ¬¡çš„å¯¹æ¯”äº†ã€‚æœ€åæˆ‘ä»¬å°†å¤´æŒ‡é’ˆ<code>newStartIndex</code>å‘åç§»ä¸€ä½ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åœ¨æ—§åˆ—è¡¨ä¸­æ‰¾åˆ° å’Œæ–°åˆ—è¡¨å¤´èŠ‚ç‚¹key ç›¸åŒçš„èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> newtKey <span class="token operator">=</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
        oldIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> child<span class="token punctuation">.</span>key <span class="token operator">===</span> newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> oldNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
        parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        prevChildren<span class="token punctuation">[</span>oldIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
      <span class="token punctuation">}</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœåœ¨<strong>æ—§åˆ—è¡¨</strong>ä¸­æ²¡æœ‰æ‰¾åˆ°å¤ç”¨èŠ‚ç‚¹å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ”¾åˆ°æœ€å‰é¢å°±å¯ä»¥äº†ï¼Œç„¶ååç§»å¤´æŒ‡é’ˆ<code>newStartIndex</code>ã€‚</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4bbefb16b2bf4d52bb9b2a5f5ea86ec1~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åœ¨æ—§åˆ—è¡¨ä¸­æ‰¾åˆ° å’Œæ–°åˆ—è¡¨å¤´èŠ‚ç‚¹key ç›¸åŒçš„èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> newtKey <span class="token operator">=</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
        oldIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> child<span class="token punctuation">.</span>key <span class="token operator">===</span> newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> oldNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
        parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        prevChildren<span class="token punctuation">[</span>oldIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      	<span class="token function">mount</span><span class="token punctuation">(</span>newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ€åå½“<strong>æ—§åˆ—è¡¨</strong>éå†åˆ°<code>undefind</code>æ—¶å°±è·³è¿‡å½“å‰èŠ‚ç‚¹ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode <span class="token operator">===</span> undefind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode <span class="token operator">===</span> undefind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>3. æ·»åŠ èŠ‚ç‚¹</strong></p> <p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85517a9eb0a34165832394b9d4e7627d~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>è¿™ä¸ªä¾‹å­éå¸¸ç®€å•ï¼Œå‡ æ¬¡å¾ªç¯éƒ½æ˜¯å°¾èŠ‚ç‚¹ç›¸åŒï¼Œå°¾æŒ‡é’ˆä¸€ç›´å‘å‰ç§»åŠ¨ï¼Œç›´åˆ°å¾ªç¯ç»“æŸï¼Œå¦‚ä¸‹å›¾</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/668208458312440cae49139534fd6d59~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æ­¤æ—¶<code>oldEndIndex</code>ä»¥åŠå°äºäº†<code>oldStartIndex</code>ï¼Œä½†æ˜¯<strong>æ–°åˆ—è¡¨</strong>ä¸­è¿˜æœ‰å‰©ä½™çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å‰©ä½™çš„èŠ‚ç‚¹ä¾æ¬¡æ’å…¥åˆ°<code>oldStartNode</code>çš„<code>DOM</code>ä¹‹å‰å°±å¯ä»¥äº†ã€‚ä¸ºä»€ä¹ˆæ˜¯æ’å…¥<code>oldStartNode</code>ä¹‹å‰å‘¢ï¼ŸåŸå› æ˜¯å‰©ä½™çš„èŠ‚ç‚¹åœ¨<strong>æ–°åˆ—è¡¨</strong>çš„ä½ç½®æ˜¯ä½äº<code>oldStartNode</code>ä¹‹å‰çš„ï¼Œå¦‚æœå‰©ä½™èŠ‚ç‚¹æ˜¯åœ¨<code>oldStartNode</code>ä¹‹åï¼Œ<code>oldStartNode</code>å°±ä¼šå…ˆè¡Œå¯¹æ¯”ï¼Œè¿™ä¸ªéœ€è¦æ€è€ƒä¸€ä¸‹ï¼Œå…¶å®è¿˜æ˜¯ä¸<code>ç¬¬å››æ­¥</code>çš„æ€è·¯ä¸€æ ·ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndIndex <span class="token operator">&lt;</span> oldStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mount</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prevStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>4. ç§»é™¤èŠ‚ç‚¹</strong></p> <p>ä¸ä¸Šä¸€å°èŠ‚çš„æƒ…å†µç›¸åï¼Œå½“<strong>æ–°åˆ—è¡¨</strong>çš„<code>newEndIndex</code>å°äº<code>newStartIndex</code>æ—¶ï¼Œæˆ‘ä»¬å°†<strong>æ—§åˆ—è¡¨</strong>å‰©ä½™çš„èŠ‚ç‚¹åˆ é™¤å³å¯ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œ<strong>æ—§åˆ—è¡¨</strong>çš„<code>undefind</code>ã€‚åœ¨ç¬¬äºŒå°èŠ‚ä¸­æˆ‘ä»¬æåˆ°è¿‡ï¼Œå½“å¤´å°¾èŠ‚ç‚¹éƒ½ä¸ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šå»<strong>æ—§åˆ—è¡¨</strong>ä¸­æ‰¾<strong>æ–°åˆ—è¡¨</strong>çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç§»åŠ¨å®ŒDOMèŠ‚ç‚¹åï¼Œå°†<strong>æ—§åˆ—è¡¨</strong>çš„é‚£ä¸ªèŠ‚ç‚¹æ”¹ä¸º<code>undefind</code>ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨æœ€åçš„åˆ é™¤æ—¶ï¼Œéœ€è¦æ³¨æ„è¿™äº›<code>undefind</code>ï¼Œé‡åˆ°çš„è¯è·³è¿‡å½“å‰å¾ªç¯å³å¯ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndIndex <span class="token operator">&lt;</span> oldStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mount</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prevStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndIndex <span class="token operator">&lt;</span> newStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        partent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>5. å°ç»“</strong></p> <p>è‡³æ­¤<code>åŒç«¯æ¯”è¾ƒ</code>å…¨éƒ¨å®Œæˆï¼Œä»¥ä¸‹æ˜¯å…¨éƒ¨ä»£ç ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue2diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    oldStartIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    newStartIndex <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldStartIndex <span class="token operator">&amp;&amp;</span> newStartIndex <span class="token operator">&lt;=</span> newStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldStartNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

      oldStartIndex<span class="token operator">++</span>
      newStartIndex<span class="token operator">++</span>
      oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">,</span> newEndNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

      oldStartIndex<span class="token operator">--</span>
      newStartIndex<span class="token operator">--</span>
      oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
      newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldStartNode<span class="token punctuation">,</span> newEndNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
      parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldEndNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span>
      oldStartIndex<span class="token operator">++</span>
      newStartIndex<span class="token operator">--</span>
      oldStartNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
      newEndNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
      parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldEndNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
      oldStartIndex<span class="token operator">--</span>
      newStartIndex<span class="token operator">++</span>
      oldEndNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newStartNode<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
        oldIndex <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> child <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>key <span class="token operator">===</span> newKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>oldIndex<span class="token punctuation">]</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">,</span> newStartNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
        parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        prevChildren<span class="token punctuation">[</span>oldIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
      <span class="token punctuation">}</span>
      newStartIndex<span class="token operator">++</span>
      newStartNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIndex <span class="token operator">&gt;</span> newStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&lt;=</span> oldStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartIndex<span class="token operator">++</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">[</span>oldStartIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIndex <span class="token operator">&gt;</span> oldStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>newStartIndex <span class="token operator">&lt;=</span> newStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mount</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">[</span>newStartIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> oldStartNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-3-vue3-diff-æœ€é•¿é€’å¢å­åºåˆ—"><a href="#_4-3-vue3-diff-æœ€é•¿é€’å¢å­åºåˆ—" class="header-anchor">#</a> 4.3 Vue3 Diff â€”â€” æœ€é•¿é€’å¢å­åºåˆ—</h3> <p><code>vue3</code>çš„<code>diff</code>å€Ÿé‰´äº<a href="https://github.com/infernojs/inferno" target="_blank" rel="noopener noreferrer">inferno<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œè¯¥ç®—æ³•å…¶ä¸­æœ‰ä¸¤ä¸ªç†å¿µã€‚ç¬¬ä¸€ä¸ªæ˜¯ç›¸åŒçš„å‰ç½®ä¸åç½®å…ƒç´ çš„é¢„å¤„ç†ï¼›ç¬¬äºŒä¸ªåˆ™æ˜¯æœ€é•¿é€’å¢å­åºåˆ—ï¼Œæ­¤æ€æƒ³ä¸<code>React</code>çš„<code>diff</code>ç±»ä¼¼åˆä¸å°½ç›¸åŒã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€ä»‹ç»ã€‚</p> <p><strong>1. å‰ç½®ä¸åç½®çš„é¢„å¤„ç†</strong></p> <p>æˆ‘ä»¬çœ‹è¿™ä¸¤æ®µæ–‡å­—</p> <div class="language- extra-class"><pre class="language-text"><code>Hello World
Hey World
</code></pre></div><p>å…¶å®å°±ç®€å•çš„çœ‹ä¸€çœ¼æˆ‘ä»¬å°±èƒ½å‘ç°ï¼Œè¿™ä¸¤æ®µæ–‡å­—æ˜¯æœ‰ä¸€éƒ¨åˆ†æ˜¯ç›¸åŒçš„ï¼Œ<strong>è¿™äº›æ–‡å­—æ˜¯ä¸éœ€è¦ä¿®æ”¹ä¹Ÿä¸éœ€è¦ç§»åŠ¨çš„</strong>ï¼ŒçœŸæ­£éœ€è¦è¿›è¡Œä¿®æ”¹ä¸­é—´çš„å‡ ä¸ªå­—æ¯ï¼Œæ‰€ä»¥<code>diff</code>å°±å˜æˆä»¥ä¸‹éƒ¨åˆ†</p> <div class="language- extra-class"><pre class="language-text"><code>text1: 'llo'
text2: 'y'
</code></pre></div><p>æ¥ä¸‹æ¥æ¢æˆ<code>vnode</code>ï¼Œæˆ‘ä»¬ä»¥ä¸‹å›¾ä¸ºä¾‹ã€‚</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90a27b4fa05b434889d99ae6fe832b4d~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>å›¾ä¸­çš„è¢«ç»¿è‰²æ¡†èµ·æ¥çš„èŠ‚ç‚¹ï¼Œä»–ä»¬æ˜¯ä¸éœ€è¦ç§»åŠ¨çš„ï¼Œåªéœ€è¦è¿›è¡Œæ‰“è¡¥ä¸<code>patch</code>å°±å¯ä»¥äº†ã€‚æˆ‘ä»¬æŠŠè¯¥é€»è¾‘å†™æˆä»£ç ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    prevEnd <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    nextEnd <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>
    nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>prevNode<span class="token punctuation">.</span>key <span class="token operator">===</span> nextNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">,</span> nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
    j<span class="token operator">++</span>
    prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
    nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  
  prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>prevEnd<span class="token punctuation">]</span>
  nextNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>nextEnd<span class="token punctuation">]</span>
  
  <span class="token keyword">while</span> <span class="token punctuation">(</span>prevNode<span class="token punctuation">.</span>key <span class="token operator">===</span> nextNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">,</span> nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
    prevEnd<span class="token operator">--</span>
    nextEnd<span class="token operator">--</span>
    prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>prevEnd<span class="token punctuation">]</span>
    nextNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>nextEnd<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦è€ƒè™‘è¾¹ç•Œæƒ…å†µäº†ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µã€‚ä¸€ç§æ˜¯<code>j &gt; prevEnd</code>ï¼›å¦ä¸€ç§æ˜¯<code>j &gt; nextEnd</code>ã€‚</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52779ed5f26a451d8098e945709132cf~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æˆ‘ä»¬ä»¥è¿™å¼ å›¾ä¸ºä¾‹ï¼Œæ­¤æ—¶<code>j &gt; prevEnd</code>ä¸”<code>j &lt;= nextEnd</code>ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ<strong>æ–°åˆ—è¡¨</strong>ä¸­<code>j</code>åˆ°<code>nextEnd</code>ä¹‹é—´å‰©ä¸‹çš„èŠ‚ç‚¹<strong>æ’å…¥</strong>è¿›å»å°±å¯ä»¥äº†ã€‚ç›¸åï¼Œ å¦‚æœ<code>j &gt; nextEnd</code>æ—¶ï¼Œæˆ‘ä»¬æŠŠ<strong>æ—§åˆ—è¡¨</strong>ä¸­<code>j</code>åˆ°<code>prevEnd</code>ä¹‹é—´çš„èŠ‚ç‚¹<strong>åˆ é™¤</strong>å°±å¯ä»¥äº†ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> prevEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> nextpos <span class="token operator">=</span> nextEnd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      refNode <span class="token operator">=</span> nextpos <span class="token operator">&gt;=</span> nextChildren<span class="token punctuation">.</span>length
                <span class="token operator">?</span> <span class="token keyword">null</span>
                <span class="token operator">:</span> nextChildren<span class="token punctuation">[</span>nextpos<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">)</span> <span class="token function">mount</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
    
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> nextEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">)</span> parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å†ç»§ç»­æ€è€ƒï¼Œåœ¨æˆ‘ä»¬<code>while</code>å¾ªç¯æ—¶ï¼ŒæŒ‡é’ˆæ˜¯ä»ä¸¤ç«¯å‘å†…é€æ¸é æ‹¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨å¾ªç¯ä¸­å°±åº”è¯¥å»åˆ¤æ–­è¾¹ç•Œæƒ…å†µï¼Œæˆ‘ä»¬ä½¿ç”¨<code>label</code>è¯­æ³•ï¼Œå½“æˆ‘ä»¬è§¦å‘è¾¹ç•Œæƒ…å†µæ—¶ï¼Œé€€å‡ºå…¨éƒ¨çš„å¾ªç¯ï¼Œç›´æ¥è¿›å…¥åˆ¤æ–­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    prevEnd <span class="token operator">=</span> prevChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    nextEnd <span class="token operator">=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>
    nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// labelè¯­æ³•</span>
  outer<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>prevNode<span class="token punctuation">.</span>key <span class="token operator">===</span> nextNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">,</span> nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
      j<span class="token operator">++</span>
      <span class="token comment">// å¾ªç¯ä¸­å¦‚æœè§¦å‘è¾¹ç•Œæƒ…å†µï¼Œç›´æ¥breakï¼Œæ‰§è¡Œouterä¹‹åçš„åˆ¤æ–­</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> prevEnd <span class="token operator">||</span> j <span class="token operator">&gt;</span> nextEnd<span class="token punctuation">)</span> <span class="token keyword">break</span> outer
      prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
      nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>prevEnd<span class="token punctuation">]</span>
    nextNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>nextEnd<span class="token punctuation">]</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>prevNode<span class="token punctuation">.</span>key <span class="token operator">===</span> nextNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">,</span> nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
      prevEnd<span class="token operator">--</span>
      nextEnd<span class="token operator">--</span>
      <span class="token comment">// å¾ªç¯ä¸­å¦‚æœè§¦å‘è¾¹ç•Œæƒ…å†µï¼Œç›´æ¥breakï¼Œæ‰§è¡Œouterä¹‹åçš„åˆ¤æ–­</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> prevEnd <span class="token operator">||</span> j <span class="token operator">&gt;</span> nextEnd<span class="token punctuation">)</span> <span class="token keyword">break</span> outer
      prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>prevEnd<span class="token punctuation">]</span>
      nextNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>nextEnd<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> prevEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> nextpos <span class="token operator">=</span> nextEnd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      refNode <span class="token operator">=</span> nextpos <span class="token operator">&gt;=</span> nextChildren<span class="token punctuation">.</span>length
                <span class="token operator">?</span> <span class="token keyword">null</span>
                <span class="token operator">:</span> nextChildren<span class="token punctuation">[</span>nextpos<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">)</span> <span class="token function">mount</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
    
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> nextEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">)</span> parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>2. åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨</strong></p> <p>å…¶å®å‡ ä¸ªç®—æ³•çœ‹ä¸‹æ¥ï¼Œå¥—è·¯å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œå°±æ˜¯æ‰¾åˆ°ç§»åŠ¨çš„èŠ‚ç‚¹ï¼Œç„¶åç»™ä»–ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®ã€‚æŠŠè¯¥åŠ çš„æ–°èŠ‚ç‚¹æ·»åŠ å¥½ï¼ŒæŠŠè¯¥åˆ çš„æ—§èŠ‚ç‚¹åˆ äº†ï¼Œæ•´ä¸ªç®—æ³•å°±ç»“æŸäº†ã€‚è¿™ä¸ªç®—æ³•ä¹Ÿä¸ä¾‹å¤–ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•åšçš„ã€‚</p> <p>å½“<code>å‰/åç½®</code>çš„é¢„å¤„ç†ç»“æŸåï¼Œæˆ‘ä»¬è¿›å…¥çœŸæ­£çš„<code>diff</code>ç¯èŠ‚ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ ¹æ®<strong>æ–°åˆ—è¡¨</strong>å‰©ä½™çš„èŠ‚ç‚¹æ•°é‡ï¼Œåˆ›å»ºä¸€ä¸ª<code>source</code>æ•°ç»„ï¼Œå¹¶å°†æ•°ç»„å¡«æ»¡<code>-1</code>ã€‚</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75944ec3b6a245989a0eaf7e474ef174~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æˆ‘ä»¬å…ˆå†™è¿™å—é€»è¾‘ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  outer<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> prevEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> nextEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> prevStart <span class="token operator">=</span> j<span class="token punctuation">,</span>
      nextStart <span class="token operator">=</span> j<span class="token punctuation">,</span>
      nextLeft <span class="token operator">=</span> nextEnd <span class="token operator">-</span> nextStart <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>     <span class="token comment">// æ–°åˆ—è¡¨ä¸­å‰©ä½™çš„èŠ‚ç‚¹é•¿åº¦</span>
      source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>nextLeft<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// åˆ›å»ºæ•°ç»„ï¼Œå¡«æ»¡-1</span>
     
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é‚£ä¹ˆè¿™ä¸ª<code>source</code>æ•°ç»„ï¼Œæ˜¯è¦åšä»€ä¹ˆçš„å‘¢ï¼Ÿä»–å°±æ˜¯æ¥åšæ–°æ—§èŠ‚ç‚¹çš„å¯¹åº”å…³ç³»çš„ï¼Œæˆ‘ä»¬å°†<strong>æ–°èŠ‚ç‚¹</strong>åœ¨<strong>æ—§åˆ—è¡¨</strong>çš„ä½ç½®å­˜å‚¨åœ¨è¯¥æ•°ç»„ä¸­ï¼Œæˆ‘ä»¬åœ¨æ ¹æ®<code>source</code>è®¡ç®—å‡ºå®ƒçš„<code>æœ€é•¿é€’å¢å­åºåˆ—</code>ç”¨äºç§»åŠ¨DOMèŠ‚ç‚¹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å…ˆå»ºç«‹ä¸€ä¸ªå¯¹è±¡å­˜å‚¨å½“å‰<strong>æ–°åˆ—è¡¨</strong>ä¸­çš„<code>èŠ‚ç‚¹</code>ä¸<code>index</code>çš„å…³ç³»ï¼Œå†å»<strong>æ—§åˆ—è¡¨</strong>ä¸­å»æ‰¾ä½ç½®ã€‚</p> <p>åœ¨æ‰¾èŠ‚ç‚¹æ—¶è¦æ³¨æ„ï¼Œ<strong>å¦‚æœæ—§èŠ‚ç‚¹åœ¨æ–°åˆ—è¡¨ä¸­æ²¡æœ‰çš„è¯ï¼Œç›´æ¥åˆ é™¤å°±å¥½</strong>ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ•°é‡è¡¨ç¤ºè®°å½•æˆ‘ä»¬å·²ç»<code>patch</code>è¿‡çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ•°é‡å·²ç»ä¸<strong>æ–°åˆ—è¡¨</strong>å‰©ä½™çš„èŠ‚ç‚¹æ•°é‡ä¸€æ ·ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„<code>æ—§èŠ‚ç‚¹</code>æˆ‘ä»¬å°±ç›´æ¥åˆ é™¤äº†å°±å¯ä»¥äº†</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  outer<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> prevEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> nextEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> prevStart <span class="token operator">=</span> j<span class="token punctuation">,</span>
      nextStart <span class="token operator">=</span> j<span class="token punctuation">,</span>
      nextLeft <span class="token operator">=</span> nextEnd <span class="token operator">-</span> nextStart <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>     <span class="token comment">// æ–°åˆ—è¡¨ä¸­å‰©ä½™çš„èŠ‚ç‚¹é•¿åº¦</span>
      source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>nextLeft<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// åˆ›å»ºæ•°ç»„ï¼Œå¡«æ»¡-1</span>
      nextIndexMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                      <span class="token comment">// æ–°åˆ—è¡¨èŠ‚ç‚¹ä¸indexçš„æ˜ å°„</span>
      patched <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            <span class="token comment">// å·²æ›´æ–°è¿‡çš„èŠ‚ç‚¹çš„æ•°é‡</span>
      
    <span class="token comment">// ä¿å­˜æ˜ å°„å…³ç³»  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> nextStart<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key
      nextIndexMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i
    <span class="token punctuation">}</span> 
    
    <span class="token comment">// å»æ—§åˆ—è¡¨æ‰¾ä½ç½®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> prevStart<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
      	prevKey <span class="token operator">=</span> prevNode<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
        nextIndex <span class="token operator">=</span> nextIndexMap<span class="token punctuation">[</span>prevKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// æ–°åˆ—è¡¨ä¸­æ²¡æœ‰è¯¥èŠ‚ç‚¹ æˆ–è€… å·²ç»æ›´æ–°äº†å…¨éƒ¨çš„æ–°èŠ‚ç‚¹ï¼Œç›´æ¥åˆ é™¤æ—§èŠ‚ç‚¹</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">===</span> undefind <span class="token operator">||</span> patched <span class="token operator">&gt;=</span> nextLeft<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">,</span> nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ç»™sourceèµ‹å€¼</span>
      source<span class="token punctuation">[</span>nextIndex <span class="token operator">-</span> nextStart<span class="token punctuation">]</span> <span class="token operator">=</span> i
      patched<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/01f5d145e4a84e3f922b4d39f80bcb6a~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æ‰¾åˆ°ä½ç½®åï¼Œæˆ‘ä»¬è§‚å¯Ÿè¿™ä¸ªé‡æ–°èµ‹å€¼åçš„<code>source</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ˜¯å…¨æ–°çš„èŠ‚ç‚¹çš„è¯ï¼Œå…¶åœ¨<code>source</code>æ•°ç»„ä¸­å¯¹åº”çš„å€¼å°±æ˜¯åˆå§‹çš„<code>-1</code>ï¼Œé€šè¿‡è¿™ä¸€æ­¥æˆ‘ä»¬å¯ä»¥åŒºåˆ†å‡ºæ¥å“ªä¸ªä¸ºå…¨æ–°çš„èŠ‚ç‚¹ï¼Œå“ªä¸ªæ˜¯å¯å¤ç”¨çš„ã€‚</p> <p>å…¶æ¬¡ï¼Œæˆ‘ä»¬è¦åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨ã€‚é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ç§»åŠ¨å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå’Œ<code>React</code>ä¸€æ ·æˆ‘ä»¬ç”¨é€’å¢æ³•ï¼Œå¦‚æœæˆ‘ä»¬æ‰¾åˆ°çš„<code>index</code>æ˜¯ä¸€ç›´é€’å¢çš„ï¼Œè¯´æ˜ä¸éœ€è¦ç§»åŠ¨ä»»ä½•èŠ‚ç‚¹ã€‚æˆ‘ä»¬é€šè¿‡è®¾ç½®ä¸€ä¸ªå˜é‡æ¥ä¿å­˜æ˜¯å¦éœ€è¦ç§»åŠ¨çš„çŠ¶æ€ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  outer<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> prevEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> nextEnd <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> prevStart <span class="token operator">=</span> j<span class="token punctuation">,</span>
      nextStart <span class="token operator">=</span> j<span class="token punctuation">,</span>
      nextLeft <span class="token operator">=</span> nextEnd <span class="token operator">-</span> nextStart <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>     <span class="token comment">// æ–°åˆ—è¡¨ä¸­å‰©ä½™çš„èŠ‚ç‚¹é•¿åº¦</span>
      source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>nextLeft<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// åˆ›å»ºæ•°ç»„ï¼Œå¡«æ»¡-1</span>
      nextIndexMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                      <span class="token comment">// æ–°åˆ—è¡¨èŠ‚ç‚¹ä¸indexçš„æ˜ å°„</span>
      patched <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      move <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                           <span class="token comment">// æ˜¯å¦ç§»åŠ¨</span>
      lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                          <span class="token comment">// è®°å½•ä¸Šä¸€æ¬¡çš„ä½ç½®</span>
      
    <span class="token comment">// ä¿å­˜æ˜ å°„å…³ç³»  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> nextStart<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> nextEnd<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key
      nextIndexMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i
    <span class="token punctuation">}</span> 
    
    <span class="token comment">// å»æ—§åˆ—è¡¨æ‰¾ä½ç½®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> prevStart<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> prevEnd<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> prevNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
      	prevKey <span class="token operator">=</span> prevNode<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
        nextIndex <span class="token operator">=</span> nextIndexMap<span class="token punctuation">[</span>prevKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// æ–°åˆ—è¡¨ä¸­æ²¡æœ‰è¯¥èŠ‚ç‚¹ æˆ–è€… å·²ç»æ›´æ–°äº†å…¨éƒ¨çš„æ–°èŠ‚ç‚¹ï¼Œç›´æ¥åˆ é™¤æ—§èŠ‚ç‚¹</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">===</span> undefind <span class="token operator">||</span> patched <span class="token operator">&gt;=</span> nextLeft<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹</span>
      <span class="token keyword">let</span> nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">,</span> nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ç»™sourceèµ‹å€¼</span>
      source<span class="token punctuation">[</span>nextIndex <span class="token operator">-</span> nextStart<span class="token punctuation">]</span> <span class="token operator">=</span> i
      patched<span class="token operator">++</span>
      
      <span class="token comment">// é€’å¢æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	move <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      	lastIndex <span class="token operator">=</span> nextIndex
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>move<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// éœ€è¦ç§»åŠ¨</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	
    <span class="token comment">//ä¸éœ€è¦ç§»åŠ¨</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>3. DOMå¦‚ä½•ç§»åŠ¨</strong></p> <p>åˆ¤æ–­å®Œæ˜¯å¦éœ€è¦ç§»åŠ¨åï¼Œæˆ‘ä»¬å°±éœ€è¦è€ƒè™‘å¦‚ä½•ç§»åŠ¨äº†ã€‚ä¸€æ—¦éœ€è¦è¿›è¡ŒDOMç§»åŠ¨ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åšçš„å°±æ˜¯æ‰¾åˆ°<code>source</code>çš„<strong>æœ€é•¿é€’å¢å­åºåˆ—</strong>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>move<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> seq <span class="token operator">=</span> <span class="token function">lis</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [0, 1]</span>
  <span class="token comment">// éœ€è¦ç§»åŠ¨</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

  <span class="token comment">//ä¸éœ€è¦ç§»åŠ¨</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ä»€ä¹ˆæ˜¯æœ€é•¿é€’å¢å­åºåˆ—ï¼šç»™å®šä¸€ä¸ªæ•°å€¼åºåˆ—ï¼Œæ‰¾åˆ°å®ƒçš„ä¸€ä¸ªå­åºåˆ—ï¼Œå¹¶ä¸”å­åºåˆ—ä¸­çš„å€¼æ˜¯é€’å¢çš„ï¼Œå­åºåˆ—ä¸­çš„å…ƒç´ åœ¨åŸåºåˆ—ä¸­ä¸ä¸€å®šè¿ç»­ã€‚</p> <p>ä¾‹å¦‚ç»™å®šæ•°å€¼åºåˆ—ä¸ºï¼š[ 0, 8, 4, 12 ]ã€‚</p> <p>é‚£ä¹ˆå®ƒçš„æœ€é•¿é€’å¢å­åºåˆ—å°±æ˜¯ï¼š[0, 8, 12]ã€‚</p> <p>å½“ç„¶ç­”æ¡ˆå¯èƒ½æœ‰å¤šç§æƒ…å†µï¼Œä¾‹å¦‚ï¼š[0, 4, 12] ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p></blockquote> <p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨<code>lis</code> å‡½æ•°æ±‚å‡ºæ•°ç»„<code>source</code>çš„æœ€é•¿é€’å¢å­åºåˆ—ä¸º<code>[ 0, 1 ]</code>ã€‚æˆ‘ä»¬çŸ¥é“ source æ•°ç»„çš„å€¼ä¸º <code>[2, 3, 1, -1]</code>ï¼Œå¾ˆæ˜¾ç„¶æœ€é•¿é€’å¢å­åºåˆ—åº”è¯¥æ˜¯<code>[ 2, 3 ]</code>ï¼Œä½†ä¸ºä»€ä¹ˆè®¡ç®—å‡ºçš„ç»“æœæ˜¯<code>[ 0, 1 ]</code>å‘¢ï¼Ÿå…¶å®<code>[ 0, 1 ]</code>ä»£è¡¨çš„æ˜¯æœ€é•¿é€’å¢å­åºåˆ—ä¸­çš„å„ä¸ªå…ƒç´ åœ¨<code>source</code>æ•°ç»„ä¸­çš„ä½ç½®ç´¢å¼•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81c80851ea784e03b3c995234c70e9a3~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æˆ‘ä»¬æ ¹æ®<code>source</code>ï¼Œå¯¹<strong>æ–°åˆ—è¡¨</strong>è¿›è¡Œé‡æ–°ç¼–å·ï¼Œå¹¶æ‰¾å‡ºäº†<code>æœ€é•¿é€’å¢å­åºåˆ—</code>ã€‚</p> <p>æˆ‘ä»¬ä»åå‘å‰è¿›è¡Œéå†<code>source</code>æ¯ä¸€é¡¹ã€‚æ­¤æ—¶ä¼šå‡ºç°ä¸‰ç§æƒ…å†µï¼š</p> <ol><li>å½“å‰çš„å€¼ä¸º<code>-1</code>ï¼Œè¿™è¯´æ˜è¯¥èŠ‚ç‚¹æ˜¯å…¨æ–°çš„èŠ‚ç‚¹ï¼Œåˆç”±äºæˆ‘ä»¬æ˜¯<strong>ä»åå‘å‰</strong>éå†ï¼Œæˆ‘ä»¬ç›´æ¥åˆ›å»ºå¥½DOMèŠ‚ç‚¹æ’å…¥åˆ°é˜Ÿå°¾å°±å¯ä»¥äº†ã€‚</li> <li>å½“å‰çš„ç´¢å¼•ä¸º<code>æœ€é•¿é€’å¢å­åºåˆ—</code>ä¸­çš„å€¼ï¼Œä¹Ÿå°±æ˜¯<code>i === seq[j]</code>ï¼Œè¿™è¯´è¯´æ˜è¯¥èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨</li> <li>å½“å‰çš„ç´¢å¼•ä¸æ˜¯<code>æœ€é•¿é€’å¢å­åºåˆ—</code>ä¸­çš„å€¼ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥DOMèŠ‚ç‚¹éœ€è¦ç§»åŠ¨ï¼Œè¿™é‡Œä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç›´æ¥å°†DOMèŠ‚ç‚¹æ’å…¥åˆ°é˜Ÿå°¾å°±å¯ä»¥äº†ï¼Œå› ä¸ºé˜Ÿå°¾æ˜¯æ’å¥½åºçš„</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>move<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// éœ€è¦ç§»åŠ¨</span>
	<span class="token keyword">const</span> seq <span class="token operator">=</span> <span class="token function">lis</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [0, 1]</span>
    <span class="token keyword">let</span> j <span class="token operator">=</span> seq<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// æœ€é•¿å­åºåˆ—çš„æŒ‡é’ˆ</span>
    <span class="token comment">// ä»åå‘å‰éå†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> nextLeft <span class="token operator">-</span> <span class="token number">1</span>ï¼› i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> pos <span class="token operator">=</span> nextStart <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token comment">// å¯¹åº”æ–°åˆ—è¡¨çš„index</span>
        nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// æ‰¾åˆ°vnode</span>
      	nextPos <span class="token operator">=</span> pos <span class="token operator">+</span> <span class="token number">1</span>ï¼Œ    <span class="token comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œç”¨äºç§»åŠ¨DOM</span>
        refNode <span class="token operator">=</span> nextPos <span class="token operator">&gt;=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> nextChildren<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token comment">//DOMèŠ‚ç‚¹</span>
        cur <span class="token operator">=</span> source<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// å½“å‰sourceçš„å€¼ï¼Œç”¨æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æƒ…å†µ1ï¼Œè¯¥èŠ‚ç‚¹æ˜¯å…¨æ–°èŠ‚ç‚¹</span>
      	<span class="token function">mount</span><span class="token punctuation">(</span>nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">===</span> seq<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æƒ…å†µ2ï¼Œæ˜¯é€’å¢å­åºåˆ—ï¼Œè¯¥èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨</span>
        <span class="token comment">// è®©jæŒ‡å‘ä¸‹ä¸€ä¸ª</span>
        j<span class="token operator">--</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æƒ…å†µ3ï¼Œä¸æ˜¯é€’å¢å­åºåˆ—ï¼Œè¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨</span>
        parent<span class="token punctuation">.</span><span class="token function">insetBefore</span><span class="token punctuation">(</span>nextNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">//ä¸éœ€è¦ç§»åŠ¨</span>
  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¯´å®Œäº†éœ€è¦ç§»åŠ¨çš„æƒ…å†µï¼Œå†è¯´è¯´ä¸éœ€è¦ç§»åŠ¨çš„æƒ…å†µã€‚å¦‚æœä¸éœ€è¦ç§»åŠ¨çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰å…¨æ–°çš„èŠ‚ç‚¹ç»™ä»–æ·»åŠ è¿›å»å°±å¯ä»¥äº†ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">vue3Diff</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>move<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> seq <span class="token operator">=</span> <span class="token function">lis</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [0, 1]</span>
    <span class="token keyword">let</span> j <span class="token operator">=</span> seq<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// æœ€é•¿å­åºåˆ—çš„æŒ‡é’ˆ</span>
    <span class="token comment">// ä»åå‘å‰éå†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> nextLeft <span class="token operator">-</span> <span class="token number">1</span>ï¼› i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> pos <span class="token operator">=</span> nextStart <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token comment">// å¯¹åº”æ–°åˆ—è¡¨çš„index</span>
        nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// æ‰¾åˆ°vnode</span>
      	nextPos <span class="token operator">=</span> pos <span class="token operator">+</span> <span class="token number">1</span>ï¼Œ    <span class="token comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œç”¨äºç§»åŠ¨DOM</span>
        refNode <span class="token operator">=</span> nextPos <span class="token operator">&gt;=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> nextChildren<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token comment">//DOMèŠ‚ç‚¹</span>
        cur <span class="token operator">=</span> source<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// å½“å‰sourceçš„å€¼ï¼Œç”¨æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æƒ…å†µ1ï¼Œè¯¥èŠ‚ç‚¹æ˜¯å…¨æ–°èŠ‚ç‚¹</span>
      	<span class="token function">mount</span><span class="token punctuation">(</span>nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">===</span> seq<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æƒ…å†µ2ï¼Œæ˜¯é€’å¢å­åºåˆ—ï¼Œè¯¥èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨</span>
        <span class="token comment">// è®©jæŒ‡å‘ä¸‹ä¸€ä¸ª</span>
        j<span class="token operator">--</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æƒ…å†µ3ï¼Œä¸æ˜¯é€’å¢å­åºåˆ—ï¼Œè¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨</span>
        parent<span class="token punctuation">.</span><span class="token function">insetBefore</span><span class="token punctuation">(</span>nextNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//ä¸éœ€è¦ç§»åŠ¨</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> nextLeft <span class="token operator">-</span> <span class="token number">1</span>ï¼› i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> cur <span class="token operator">=</span> source<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// å½“å‰sourceçš„å€¼ï¼Œç”¨æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">let</span> pos <span class="token operator">=</span> nextStart <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token comment">// å¯¹åº”æ–°åˆ—è¡¨çš„index</span>
          nextNode <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// æ‰¾åˆ°vnode</span>
          nextPos <span class="token operator">=</span> pos <span class="token operator">+</span> <span class="token number">1</span>ï¼Œ    <span class="token comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œç”¨äºç§»åŠ¨DOM</span>
          refNode <span class="token operator">=</span> nextPos <span class="token operator">&gt;=</span> nextChildren<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> nextChildren<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token comment">//DOMèŠ‚ç‚¹</span>
      	<span class="token function">mount</span><span class="token punctuation">(</span>nextNode<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> refNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è‡³æ­¤<code>vue3.0</code>çš„diffå®Œæˆã€‚</p> <p><strong>4. æœ€é•¿é€’å¢å­åºåˆ—</strong></p> <p>æˆ‘ä»¬ä»¥è¯¥æ•°ç»„ä¸ºä¾‹</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">]</span>
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„æ€æƒ³è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚åŠ¨æ€è§„åˆ’çš„æ€æƒ³æ˜¯å°†ä¸€ä¸ªå¤§çš„é—®é¢˜åˆ†è§£æˆå¤šä¸ªå°çš„å­é—®é¢˜ï¼Œå¹¶å°è¯•å¾—åˆ°è¿™äº›å­é—®é¢˜çš„æœ€ä¼˜è§£ï¼Œå­é—®é¢˜çš„æœ€ä¼˜è§£æœ‰å¯èƒ½ä¼šåœ¨æ›´å¤§çš„é—®é¢˜ä¸­è¢«åˆ©ç”¨ï¼Œè¿™æ ·é€šè¿‡å°é—®é¢˜çš„æœ€ä¼˜è§£æœ€ç»ˆæ±‚å¾—å¤§é—®é¢˜çš„æœ€ä¼˜è§£ã€‚</p> <p>æˆ‘ä»¬å…ˆå‡è®¾åªæœ‰ä¸€ä¸ªå€¼çš„æ•°ç»„<code>[13]</code>ï¼Œé‚£ä¹ˆè¯¥æ•°ç»„çš„æœ€é•¿é€’å¢å­åºåˆ—å°±æ˜¯<code>[13]</code>è‡ªå·±æœ¬èº«ï¼Œå…¶é•¿åº¦ä¸º<code>1</code>ã€‚<strong>é‚£ä¹ˆæˆ‘ä»¬è®¤ä¸ºæ¯ä¸€é¡¹çš„é€’å¢åºåˆ—çš„é•¿åº¦å€¼å‡ä¸º1</strong></p> <p>é‚£ä¹ˆæˆ‘ä»¬è¿™æ¬¡ç»™æ•°ç»„å¢åŠ ä¸€ä¸ªå€¼<code>[7, 13]</code>, ç”±äº<code>7 &lt; 13</code>ï¼Œæ‰€ä»¥è¯¥æ•°ç»„çš„æœ€é•¿é€’å¢å­åºåˆ—æ˜¯<code>[7, 13]</code>ï¼Œé‚£ä¹ˆè¯¥é•¿åº¦ä¸º<code>2</code>ã€‚<strong>é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¤ä¸ºï¼Œå½“<code>[7]</code>å°äº<code>[13]</code>æ—¶ï¼Œä»¥<code>[7]</code>ä¸ºå¤´çš„é€’å¢åºåˆ—çš„é•¿åº¦æ˜¯ï¼Œ<code>[7]</code>çš„é•¿åº¦å’Œ<code>[13]</code>çš„é•¿åº¦çš„å’Œ</strong>ï¼Œå³<code>1 + 1 = 2</code>ã€‚</p> <p>okï¼Œæˆ‘ä»¬åŸºäºè¿™ç§æ€æƒ³æ¥ç»™è®¡ç®—ä¸€ä¸‹è¯¥æ•°ç»„ã€‚æˆ‘ä»¬å…ˆå°†æ¯ä¸ªå€¼çš„åˆå§‹èµ‹å€¼ä¸º<code>1</code></p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b62114779ce647db906d73ab1a737298~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>é¦–å…ˆ <code>7 &lt; 13</code> é‚£ä¹ˆ<code>7</code>å¯¹åº”çš„é•¿åº¦å°±æ˜¯<code>13</code>çš„é•¿åº¦å†åŠ 1ï¼Œ<code>1 + 1 = 2</code></p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/80dc121621324857ab806f8220f264b4~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>ç»§ç»­ï¼Œæˆ‘ä»¬å¯¹æ¯”<code>8</code>ã€‚æˆ‘ä»¬é¦–å…ˆå’Œ<code>7</code>æ¯”ï¼Œå‘ç°ä¸æ»¡è¶³é€’å¢ï¼Œä½†æ˜¯æ²¡å…³ç³»æˆ‘ä»¬è¿˜å¯ä»¥ç»§ç»­å’Œ<code>13</code>æ¯”ï¼Œ<code>8 &lt; 13</code>æ»¡è¶³é€’å¢ï¼Œé‚£ä¹ˆ<code>8</code>çš„é•¿åº¦ä¹Ÿæ˜¯<code>13</code>çš„é•¿åº¦åœ¨åŠ ä¸€ï¼Œé•¿åº¦ä¸º<code>2</code></p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2782096530ba4f76ae05d4eece27298f~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>æˆ‘ä»¬å†å¯¹æ¯”<code>3</code>ï¼Œæˆ‘ä»¬å…ˆè®©å…¶ä¸<code>8</code>è¿›è¡Œå¯¹æ¯”ï¼Œ<code>3 &lt; 8</code>ï¼Œé‚£ä¹ˆ<code>3</code>çš„é•¿åº¦æ˜¯<code>8</code>çš„é•¿åº¦åŠ ä¸€ï¼Œæ­¤æ—¶<code>3</code>çš„é•¿åº¦ä¸º<code>3</code>ã€‚ä½†æ˜¯è¿˜æ²¡ç»“æŸï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®©<code>3</code>ä¸<code>7</code>å¯¹æ¯”ã€‚åŒæ ·<code>3 &lt; 7</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦åœ¨è®¡ç®—å‡ºä¸€ä¸ªé•¿åº¦æ˜¯<code>7</code>çš„é•¿åº¦åŠ ä¸€åŒæ ·æ˜¯<code>3</code>ï¼Œæˆ‘ä»¬å¯¹æ¯”ä¸¤ä¸ªé•¿åº¦ï¼Œ<strong>å¦‚æœåŸæœ¬çš„é•¿åº¦æ²¡æœ‰æœ¬æ¬¡è®¡ç®—å‡ºçš„é•¿åº¦å€¼å¤§çš„è¯ï¼Œæˆ‘ä»¬è¿›è¡Œæ›¿æ¢ï¼Œåä¹‹åˆ™æˆ‘ä»¬ä¿ç•™åŸæœ¬çš„å€¼</strong>ã€‚ç”±äº<code>3 === 3</code>ï¼Œæˆ‘ä»¬é€‰æ‹©ä¸æ›¿æ¢ã€‚æœ€åï¼Œæˆ‘ä»¬è®©<code>3</code>ä¸<code>13</code>è¿›è¡Œå¯¹æ¯”ï¼ŒåŒæ ·çš„<code>3 &lt; 13</code>ï¼Œæ­¤æ—¶è®¡ç®—å‡ºçš„é•¿åº¦ä¸º<code>2</code>ï¼Œæ¯”åŸæœ¬çš„é•¿åº¦<code>3</code>è¦å°ï¼Œæˆ‘ä»¬é€‰æ‹©ä¿ç•™åŸæœ¬çš„å€¼ã€‚</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cca21599c47c429ab0067c093c9e8bd0~tplv-k3u1fbpfcp-watermark.image" alt="img"></p> <p>ä¹‹åçš„è®¡ç®—ä¾æ¬¡ç±»æ¨ï¼Œæœ€åçš„ç»“æœæ˜¯è¿™æ ·çš„</p> <p><img src="http://img-repo.poetries.top/images/image-20210220201751694.png" alt="image-20210220201751694"></p> <p>æˆ‘ä»¬ä»ä¸­å–æœ€å¤§çš„å€¼<code>4</code>ï¼Œè¯¥å€¼ä»£è¡¨çš„<strong>æœ€é•¿é€’å¢å­åºåˆ—çš„ä¸ªæ•°</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">lis</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç”¨äºä¿å­˜é•¿åº¦</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cur <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> next <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
      <span class="token comment">// å¦‚æœæ˜¯é€’å¢ å–æ›´å¤§çš„é•¿åº¦å€¼</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> next<span class="token punctuation">)</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>dp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è‡³æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬è®²å®Œäº†åŸºç¡€çš„æœ€é•¿é€’å¢å­åºåˆ—ã€‚ç„¶è€Œåœ¨<code>vue3.0</code>ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯æœ€é•¿é€’å¢å­åºåˆ—åœ¨åŸæœ¬æ•°ç»„ä¸­çš„ç´¢å¼•ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨åˆ›å»ºä¸€ä¸ªæ•°ç»„ç”¨äºä¿å­˜æ¯ä¸ªå€¼çš„æœ€é•¿å­åºåˆ—æ‰€å¯¹åº”åœ¨æ•°ç»„ä¸­çš„<code>index</code>ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">lis</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å­˜é»˜è®¤index</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cur <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
      nextIndex <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœä¸º-1 ç›´æ¥è·³è¿‡ï¼Œå› ä¸º-1ä»£è¡¨çš„æ˜¯æ–°èŠ‚ç‚¹ï¼Œä¸éœ€è¦è¿›è¡Œæ’åº</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> next <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
      <span class="token comment">// æ»¡è¶³é€’å¢æ¡ä»¶</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> max <span class="token operator">=</span> dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment">// å½“å‰é•¿åº¦æ˜¯å¦æ¯”åŸæœ¬çš„é•¿åº¦è¦å¤§</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>max <span class="token operator">&gt;</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> max
          nextIndex <span class="token operator">=</span> j
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®°å½•æ»¡è¶³æ¡ä»¶çš„å€¼ï¼Œå¯¹åº”åœ¨æ•°ç»„ä¸­çš„index</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> res<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>res<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> dp<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> i<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> cur <span class="token operator">&gt;</span> arr<span class="token punctuation">[</span>prev<span class="token punctuation">]</span> <span class="token operator">?</span> i <span class="token operator">:</span> prev<span class="token punctuation">,</span> dp<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token comment">// è¿”å›æœ€é•¿çš„é€’å¢å­åºåˆ—çš„index</span>
  <span class="token keyword">return</span> result<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <!----> <div class="readMore-wrapper"><span class="readMore">é˜…è¯»å…¨æ–‡</span></div></div> <div class="right-bar"><div class="item"><span class="title">å‰ç«¯è¿›é˜¶å…¬ä¼—å·</span> <span class="desc">æ¯å¤©åˆ†äº«å‰ç«¯å¹²è´§æ–‡ç« </span> <img width="100%" alt="å…¬ä¼—å·ã€Œå‰ç«¯è¿›é˜¶ä¹‹æ—…ã€" src="http://img-repo.poetries.top/images/20211001080240.png"></div> <div class="item"><span class="desc">æ‰«ä¸€æ‰«ï¼ŒåŠ VX</span> <img alt="å¾®ä¿¡poetries4070" width="100%" src="http://img-repo.poetries.top/images/20211017123306.png"></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/FE-Interview-Questions/excellent-docs/15-è®¾è®¡æ¨¡å¼.html" class="prev">15 å¸¸ç”¨è®¾è®¡æ¨¡å¼</a></span> <span class="next"><a href="/FE-Interview-Questions/excellent-docs/17-æ’åºç®—æ³•.html">17 æ’åºç®—æ³•</a>
      â†’
    </span></p></div>  <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="è¯·å…ˆé˜…è¯»è´­ä¹°åè®®" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">è¯·å…ˆé˜…è¯»è´­ä¹°åè®®</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><div class="el-dialog__footer"><span class="dialog-footer"><button disabled="disabled" type="button" class="el-button el-button--danger is-disabled" style="width:100%;"><!----><!----><span>æˆ‘å·²é˜…è¯»ï¼ˆ8sï¼‰</span></button></span></div></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="ä»˜è´¹é˜…è¯»" class="el-dialog" style="margin-top:15vh;width:32%;"><div class="el-dialog__header"><span class="el-dialog__title">ä»˜è´¹é˜…è¯»</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><div class="el-dialog__footer"><span class="dialog-footer"><button disabled="disabled" type="button" class="el-button el-button--danger is-disabled" style="width:100%;"><!----><!----><span>ç¡® å®š</span></button></span></div></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="dialog" class="el-dialog" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title"></span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAU9ElEQVR4Xu1da5Ac1XX+TnfPa1crrQQiMY9YGGHAD6SdEWUjIdjVPiQgNhJa4VRBAgSIXZRRodgJOPED7DiACxts4yoHu0BKVaiYnVkJAkKPfQkBDgnSSmUIhKeEISSW0AO0O6/ue1K3R/uY2Xl0z3TPY3fuH6l2zj3n3HO+vn373nPPIdSbZQtEfnb4BmbxPRAtADAkDN5wzYbT9llmUIWEVIU6VaVKmx84usBQ9XcylBvqXj+/rSoVtqhUHQAWDdXz80OtxBjMJO9eP7+mbVjTylv0nSNkOQBwsHv9fPk6qNlW9QDg4e6rIHCEQuHdlbZyz08PbSHCVWN6EOjGtetP3VhpvUqRX5UA4Dcu9+GjxhsAbADhPAhxOi3p/aCUgTrVV84EkpemawfWbJh7wCm+leJTVQDgV9ecgqiyHky3gnCqaRTGHgqFl1TKQNNdblUAgPevOw8GfxOM60DwZxj9uxQM/2C6O6JS46soAHh4dTOE+iMQbgYouy4aXUgX9vyuUgaa7nIrBgDe030jAOn81FSftfEBCkbOnu5OqOT4yg4A3rvuM4D4FUBLCw6c8SCFwhsK0tUJirZAWQHAe6++F1DusK6tuIyCvc9ap69T2rVAWQBgru5Hlc0gWm5DQYGWsIcIwkafOqlNC7gOAN67ZhGgPAXQmbZ0Y36ZQpHP2+pTJ7ZtAVcBwHuv/nOA5PveZ1sz8GMUjFxrv1+9hx0LuAIA5lYNe0/9KQi32lEmg/ZOCobvK6F/vasFCzgOgJTz524Dqe0W5OcmIb6SWiJbS+JR71zQAo4CgN9p9esfND6v+QPBgpILEajiLFrU+14hsvrvpVnAMQDIA5zE+/yKd3bjOUCpbPkYBSNzSxtavbcVC5TqKVOGfPLjB72ve2fNOosUxYrcQjT7KBhuKURU/710C5QMAH7h4kAsNusdb2PgjxSPt3SNUhy2UTB8uVPM6nzyLLVKMQ4z1Nhg50HV6znD09BQCquMvryJghEZD1BvLlugpBkgvqvrtyz4i745cxxWU9xHwd47HWZaZ5fFAkUDIL571T1GPHlnoHkO4Mx7f0I9xt9TKPyPdY+5b4GiABAb6vqSSOhPepsaofqK2OQrPK5vUjD848JkxVPw3rUylu8qgJrBvBGKsYFathwrnmNt9rQNgNHdy/4Ecf9biqJqvubZbo16PQXDP3eLOe/pvh2EB9L4MzZQKPygWzKrla9tAEQHOt5nQ5zumzMbiqa5My7G1ygU/id3mAOpp5+uz+D/BAXDq92SWS18j3bf3AoiRjJ5cO6WjQdsASC2q+uXIqF/VfV64G1qcnNM7s4Ae7uHAFyWMYBdFAybEb/TtX247qZ9AC0aGx8LXmMZAMnnu1YkR/R+2dk/bw5IUd2zE+FvqCV8v1sCeAYCQD75gqbcbNpnGQCxgc4TwjAaNb8PnsZGt3yT4sv8bQpFfuiWkJkIgMNrb1pNCm3OsOlxSwCID3U+YiQNGcSJwLxmgBzZ7s3jX/EDCvZ+tw4A5yxwdN0tiwV4eDJHZjxREAD87PJPROOe9wFQWZ7+1BTwEAUjtzk3/HROM3EGkBY4vO4vbyCmu0D0Sel8leiuggCIDXXuFknjEvPd3zwHpLr47p/wUy8Fw2udAEBiR+tiHSTjEccvcfpmN0HxeNLYi2QS8Y8+nvgb8wENvMbbNeTY/f/L73vrdgJ/D0AzM4ZIUTds/duzHeNfjL3yAiCxe+UiPZY0FZSffPLTryyN+UUKRb7ohKzRnW1bABq/0Cl5WgJAai1yoKFr0JF7CavueWeBohhp+QUkCJ65c2FF8wvkBUBssOtVoevnS1t4Gxuh+l3Z9cvm5/cpGLYXRJoDLaM7V3DmT5YBAKChc6DgLGkFqKvueaNVUWhKfoGtdyx0hL8VHbLR5BSe3L2yIxlN7hyL7QicIuMzyqirFp1HFz59tNiBjfUb2dG2j2ji29fODMDA8cbOgeZSdZD9cwDg4NY7FlY0v0BOj8YGut4Uhn6OVF7u93tnufzpl2llRaygxb1Tnhi7zhjpa11NrKR9/lidAYhxY6BrwLH7/1fc++YWTMovAIEbt35roWP87dpG0mcFQHxXxwVGwvivsZ+zGawYYbb6OLg3Hx1sXQAdE4vAufMeJEUZ3xEzX/dC7I8fPXL7uI4aDgTahhy//y9ngpQM7cC2b53tOH9bNs4FgNhg14DQdXNxIkO8/HMdmQXt6ca8kUIRc+/B6TZTPwMtrQF4sNUf1dURgM3dHk9jAJo/4LQPCvNjHqZQpPTo4iyS6gCYMMqUV0Di2ZU/1uPJvx4j8c91ed8/NxQSaAkH3LgbWAdAHgDEBjqOCkOk5nwiBOZVMDpbNT5Piza/XHi6sEdRB0AOACSfv7wrORrfPvZzGY5983uO+TYKRR6y597C1Ly3e0sqGiitTfvj4IJrgNhg13NC15eNEXoaAtACFXj/j2vKfRSMdBZ2qT0K3tN9FwhyS3ZymxEBIZmWSlsDRPvbR1nwuMd9c5qgaOl75vZMXSI1wwDTKbSk53iJnNK683B3KzKzfhLaqCUsA0VmVBsHQLyv/UKDef/E6BmBU06pvDFIXEstvY85rQgPr14AoaXuHij6RmrZUvFvcqfHaIXfBAAGOh8xjNSZv2kTTYXz8f5WVMqgYX6cQpGvFNGz3sWCBcYBEB3oeI8NccZYn/Kd/RfQknkUPmUufa4nYWE8dRKbFjABwC+FGqJH5oxM3hg2Y/69ZTv9y682G5dTaPM2m2Ork1uwgAmAxLMrb9HjyYcn05cx+MOCmvwIBSM3WSCsk9i0gAmA+K6VTxiJ5Jcn9y378W8hxUV8Pi35t8OFyOq/27OACYDYYMebQhfm0a/ZSAZ/zrPHyW1qxt0UCt/ltpiZxt8EQOb3P2kq/I7f+C3ZtEfQNHI6nftMvGROdQYTz7pM8BAdCYxOtoni1eBrKlP8nx1nsPgqhXrT1ip2utc6rRngSsr1AC8G85aAB5uobaikC60U7busjVkdmGwc1eeFd9as6rMX89sIRhYSYUqcX/Up66xGPNjaPKrTOyRvM59szLypsWuwpEQaFBvsvF/oxjcmq6v5vfA0ViEApJKML1Eo/JSz5q1+btGdra0MJS1EjsHHGjsHSzqupdhQ13aR1LvSABDww9mUL44aeEae2mUDgLRqqVHLcgYYFrqxuIYAIOP1V1EoMn5s7Si8qpSZawCIDnS+zYaRdvnB0+CHFnAy6ZPTVuX3MF/5NJ3VE3Was1V+rcObmwPMZmBplGj/UMuakhZjheS6CICO/2NDnDZZgeoHgLkY+AkFI2lrl0JGdOr3VcObFzDEMAHmgoyBYwSlZVvLGtdOFN0DQH/7xyw4bcWnVfcaIOVHGSugGYvdCBkrBJRVwxG5IZUZUHL3tpa1rm1UuQaA0Z0rkjJIvWa+AiYrytiDIH2BqMco5DQnf181HJ6SYobBT2xv6XYsxYwZrwDtejDMewRscDMLPW2tJv+ueDwTQSzMx6BgE7VEZMibpUajO1Zw5vUQ1euFt6lKPwMzh+XgBRJLFgOwcjhyOyE9yRQDG7a3rHUkyZRZTY214q/FkX621QAXynZ5suLBoFY9kXoXxKEpF5W7tNzK4fCDxGQ+8Uy8ZXtL98StIlv6TyXm4atvACuPFs3GxrkJje5s48wbYopHg292FW4F57II410wXeh07GDRDiixIw+vXQ2eks7FOlcbs6KcAeT7My3nS9WEg1kfslwU7qBQeKWdLtVMy3u6j4FQXA5eO6+AaF97gpnTQ38VQmBuSTuMFbItf5+CkczVeYV0KU1sqqqqGbRqfmoKXV8gksnM3IYybP/ulCSWyZuOQaEt1NJjOesIRfvaTzDzlLvf5o2gHNVcSxuam72ZAe6iYG+fm1Iqwdu9z8D+9sMQPCX+2zd7FhzM/18+mzGOg/UQLdnyVvmEui/JNQBE+9rfZeazMofgaWyA5s8s5O3+QJ2RwAeg8vLpVHPINQDEBjr2CENMuYat+XzwlDsriDPeP8lleoHATQBEhCGuzrR9zX0KZgXP9AGBawCIDnX+kJPG3021HyEVGVzrbXqAQKa5YV1JSzMH5l0NXYMlJbim+K6Oa4yE+E02N9fsQnDKYKYHCDJzHjKJNY0dQ5b3/bP5mLIi6ySlvBour4hPi8b8FthYWetfB9JfwsDiBhVDpQaESr+aYeHZTgTl32tyRzAfWhkfAbh2JsYU5jLLyXsBHa+zEOdOJeLUBZGa2xDKiwJ59nEvWsLfdiP/UK3NlqmrYf2djxrCyBpeLBNEulQYqrK2YgygwbiGLtj8YWUVqaz01NWwXW1XiAQ9nU2Vqr0j4Ijd+D2wsppCPXscYVeDTFLXw+XtoBOB0ax5QyudKcxtozKSINyPuYe/T2cPxdwWV238xxNEjPa3H4LgU7MpOG1fA5MHy/x7ALfMtHDzcQDEBjufErpxZTYATLuvgfxfCptBia9T8Mn/qban1Q19xgGQ3N3RmoyJnNm5qythhBumSOMps6XchcX0QLkDTl0fWYaA9DRxfR0nmEXWvPC1fzhUjGn5VRDuo5bIpmJ610KfNADEdnVtEQk9M4NmahwyaYSMEppWewKWXSRfBz+DoF9Ol7jDsZGnASAxdNlFelL9j1xm8QQC0KbL1rBl36cRngD4kdStpN6DxbGorl5TsoVH+zqOM4scIcEyefScMtQNrC4jZdWGeTcIYajiX2nR5j9Uu8b8yrp5iOmLKbQ5LRfEFADEBzo2GYb4i1wDmplrgbzuFQA/B0YPNPF4NYGB9375dMAry+9dDcZyKPgatYR/PXk0UwDA25eeFlX8/5uvQpSsICIridRbNgvwswAiUNBPiyOvlNNGvH/NadDVS0AsE34vB+iicfmMwxQKz8/UJ2vNoOhg57+zbnwhl/LTe3vYUZfJyiv7wPSfIAxDNfY6cZmVX143C0kshOBPQcGnwCxD+pYC9Mmc2ueox5y9aFRf+2cMFq/kKxPnb54NUtPulDpquWnLjBEDZFJuOg5CDMwxEKIATfyfKQ7CLMAM128EqBEydJ9oLpjPAZG9LN5Spp/OoM/2HLE0A0iiWH/ny0IYn83liKrNJDZtkVPCwJh/QaHI17NxyFk3MLq7o5Xz7AxKZhWvJ1CCTWZQVwGVFtKinvR4wpMGyFsKNNrf8QYLsTCXsVIl5eT1tTJWFJ1BnnNmqByhYKQ7pw/zCUnsbgvpUXopn3/rC0Jn3OQKF2YdmvI5WtTz30UBQHaKDna9wLp+cT4Fqyq1vCuWrFmm/0DB8HfyaV9w7rayLyAF1PcGqgwkzG9TKDKRADyHegUBYH4RDLb/Suh8c14kqSrkp2F9PVAlQLBYBMsSAE6Wk/0Q4LzJA6umzEyV+KByavBjFIxca0W+JQBIRqN9rd1gpacQU+/sWVA93kJk9d9dswAfQ0AstBrtbBkA5qugf0VECEy5SJo2FoKZX0jR6ruErvk4L2O+iYKRR6zKtgWA1KtAeRfAlEOFTBDIghOkqlb1qNM5YQHm31Ao8md2WNkCgGQc39VxgZEw5DlB/r5E8M+R5wV1ENhxSNG0zMOYPXqx3YoqtgFgrgcGO+6ELu4pqGwdBAVN5BDBIQixiJb0fmCXX1EAkEKi/Sv6WKC9oEATBE31k8OChiqSQOZMVmkpLe7JGcqX9/O9SLFmscnYseZhZv50YR4Ef3MdBIXtVAQF820UijxURE+zS9EzgOws69hEhfI7CJxZUIH666CgiWwTFLHoy5RREgBMEMgQMq3hNQhROJ8MEXxNjbWZfs62d9ztYCQTL6pJdNIlT35ciqSSAWAuCrdfehapnteY8+8UjimaCiyVm4qOiC9l/LXXl4FkLPqah/RltHT7lAgfuwNyzAOxXZeey7pnDwtusqKE/Dz0zW6qB5daMdZJGhYCydGRd71GPERtQ46U0XUMABOvg8B+CP5jq+OSdQlkfYJ6y28BI5FEcnT0iF/TzqdLnznklL0cBYAJgueWNcXi/t+y4JzxhJnKyzL13qb6KyGrU1kgcWIUwjA+9FPyfKee/DFZjgNgjHG0r2OQWVjOYSfDy+S6oH6QNAEDoSeR+HgEikd73XfptvOceuon83ENAMyg6ED74xCcMx4t24DkIZJMSDGzt5AZyZFR6NE4tAbfv3gveeY6N5wveboGgDGFYwPt64WOn4DY1qGAGWvY0ADMsBtIRjyO5GgUzGxoAc/N3mXbNrrl/LIAQAqJ7bj0XKF4BsF8ht3BmCXsAoGCZ092+VYbvZFMIDkSBRsGSFMPKz5a7lu64zW39XR9BhgbAL8U8sQ+mvsoG8a1ticeuT5oCEDuH0y3ZiTkEx8zHS+b6vf2+pZvkxc6y9LKBoCx0cQH2q4SQn2MWdivTaso0Lxes44BqTV8OZUF9HjCnOohi5yksrIeU31qt2fptv6yeP6kkLIDQMqVgSUJ8vyzkTTWFTtYuUiUMYiaz1sz+QrkRo4+GoUej08aNrPi8f7a37r9r4q1RSn9KgKAMYUTz3cuFnH0CMPIefuo8ODYPFuQYDA/ISs6oqnayk85I6FDJBMQ+uQCpwzyaC/5VV5Ly/tklFVFWlWYKz60ap1hJB6GSFXIKqXJz0jF44HqUaFonjIvHhkiqZuOFskkjKSeKi2d0RSP9nvVo13nWbZV5hKoaKsKAIxZIDbQtV6w8Z1cCSuLsZR8VaiaCsXrMQNVSbH1NZpHJMvdObB0tq6bzh5byOXqRKp2SPVpd3iXbS2+KmgxRsjTp6oAMKZnfLDrK8x0nzCSuRMelGQIAilkzg4kQxvH/5X/VfLMGpxyuHS8EJY1UDR1P0Hc5WvrL6m4g2WBNgirEgDja4QXr1giRo17ha4vB7imToyIKK54tIiXlNudPLyx4VtLpFUNgMkjiO1u/1MY2jfkRVVmrsoNAVLUjxRVeUFV+Rfa8h1PWfJAhYlqBgBjdpJnDImhrquY+FaRFMsKXVdz2b5Mmvo+KbQVuv4jf/tAzRWrrDkAZDpUbjMzeS+GSlcCfBELcSYY6bWQHUIBESVIUQ4pqvqaIPG0L4qHaeWOEYfYV4RNzQMgm9VknGJc84dIURaBcYEgkpm0PsECTTI2Fcw+BlQwT76/ppNCMXmISQqNEHACjD8A/CYxDXlZ7KCO/mlXXeT/AQOtWhTnoNDfAAAAAElFTkSuQmCC" class="theme-float-btn"> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="ç«™ç‚¹è¿ç§»é€šçŸ¥" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">ç«™ç‚¹è¿ç§»é€šçŸ¥</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/FE-Interview-Questions/assets/js/app.c2f48845.js" defer></script><script src="/FE-Interview-Questions/assets/js/5.90e753a8.js" defer></script><script src="/FE-Interview-Questions/assets/js/4.5ac63c44.js" defer></script><script src="/FE-Interview-Questions/assets/js/69.e6d07708.js" defer></script><script src="/FE-Interview-Questions/assets/js/11.6ecd37f3.js" defer></script>
  </body>
</html>
