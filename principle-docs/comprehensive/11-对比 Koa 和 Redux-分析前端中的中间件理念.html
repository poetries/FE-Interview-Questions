<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>以 Koa 为代表的 Node.js 中间件化设计 | 前端面试指南</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/FE-Interview-Questions/logo.png">
    <link rel="manifest" href="/FE-Interview-Questions/manifest.json">
    <link rel="apple-touch-icon" href="/FE-Interview-Questions/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/FE-Interview-Questions/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="web前端面试题总结，面试指南，前端面试题整理，web面试宝典，刷题神器，按模块分类整理总结，打造最全面的前端面试题">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/FE-Interview-Questions/assets/css/0.styles.9b3e12eb.css" as="style"><link rel="preload" href="/FE-Interview-Questions/assets/js/app.7f99e7e3.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/5.9e4f5919.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/4.b1f3b250.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/95.de10668f.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/11.f521c2b2.js" as="script"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/1.5bf19c21.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/10.4abf69c3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/100.23d1ea74.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/101.173c3402.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/102.72f4750a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/103.61b776c0.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/104.55cfbd88.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/105.f91e7fdf.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/106.ea4a09a3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/107.f93ccb7a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/108.35c81f9a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/109.3422f772.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/110.a9b0fb78.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/111.f18e0551.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/112.52de8377.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/113.2c1da2d6.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/114.7e2bc92b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/115.c2a82ae7.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/116.786e3ced.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/117.dfd873bd.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/118.9fc706a4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/119.bed4508f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/12.a1bbc257.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/120.1700835b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/121.d51d46a4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/122.3ce793fb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/123.00c0e527.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/124.860c2b31.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/125.29fd1060.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/126.e975b31c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/127.c586dc5e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/128.ea5f67b9.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/129.da6b67a8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/13.c4c85381.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/130.bc0450b3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/131.dde06157.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/132.4779160f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/133.4b0fdbee.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/134.ad419fd4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/135.4af1da7d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/136.4ccb2a36.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/137.88cdb933.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/138.c3cfda1f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/139.6f0c3367.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/14.3693528f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/140.6a80c003.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/141.84c80266.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/142.222b0f62.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/143.b3755a20.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/144.80a0cb05.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/145.5403a2bb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/146.49a9df52.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/147.b56517c4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/148.15b526b2.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/149.f7481b1d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/15.69e321da.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/150.72b4dc30.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/151.301302e1.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/16.a56226f3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/17.4b433a93.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/18.d6317438.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/19.c2a4106c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/20.3c7fcfa7.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/21.bbe4aea7.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/22.c94b2591.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/23.c516150f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/24.781a07ba.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/25.b753ebfa.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/26.f8ab9935.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/27.a551705f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/28.c14b4511.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/29.528f99af.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/3.949fef9b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/30.da1afbc8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/31.f8c8d63a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/32.5b5972eb.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/33.8127ada1.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/34.507e33fc.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/35.11157a86.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/36.86c17a8c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/37.177668ac.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/38.6b7d030f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/39.0340bd38.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/40.c3b63339.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/41.f5b8bd34.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/42.d63f4c0a.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/43.8e0e5e0e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/44.becef13b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/45.9ff502d8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/46.ccecba40.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/47.342c645b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/48.3e12b662.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/49.f5188857.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/50.0833878b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/51.521b5144.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/52.d7efe70d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/53.4dfe3ef5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/54.5fd790c6.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/55.43684b84.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/56.c5c6b4a1.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/57.798efa87.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/58.7d83d155.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/59.07483dc4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/6.cffbdd35.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/60.179ec568.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/61.3a915ef1.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/62.d3d980a4.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/63.e6bf441d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/64.079f3047.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/65.194e1c27.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/66.6bb74b7b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/67.456c369b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/68.2e118370.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/69.f7cbdc9c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/7.5e1cbb24.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/70.0445d9f7.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/71.6364f25d.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/72.1c73ce4e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/73.5a7d955c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/74.afdcaf8b.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/75.a884d302.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/76.9e5a527e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/77.8924da2e.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/78.9c78a58f.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/79.876fae90.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/8.f75cd855.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/80.b7b91d43.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/81.b98025b5.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/82.26223c26.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/83.556ad5fe.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/84.366ea325.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/85.4722b3dd.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/86.9bdcd954.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/87.174203fa.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/88.8d2a69a8.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/89.3b28fa5c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/9.475e0f39.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/90.99bd14cd.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/91.a8479ead.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/92.c3ff9bb3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/93.95d2f88c.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/94.f22a07bf.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/96.fbd82001.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/97.c99f9cc0.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/98.84fcd5b3.js"><link rel="prefetch" href="/FE-Interview-Questions/assets/js/99.3644099c.js">
    <link rel="stylesheet" href="/FE-Interview-Questions/assets/css/0.styles.9b3e12eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/FE-Interview-Questions/" class="home-link router-link-active"><img src="/FE-Interview-Questions/logo.png" alt="前端面试指南" class="logo"> <span class="site-name can-hide">前端面试指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/principle-docs/vue/01-从源码解读Vue生命周期.html" class="sidebar-link">从源码解读Vue生命周期</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/02-组件的本质.html" class="sidebar-link">组件的本质</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/03-有状态组件的设计.html" class="sidebar-link">有状态组件的设计</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/04-设计 VNode.html" class="sidebar-link">设计 VNode</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/05-辅助创建 VNode 的 h 函数.html" class="sidebar-link">辅助创建 VNode 的 h 函数</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/06-自定义渲染器和异步渲染.html" class="sidebar-link">自定义渲染器和异步渲染</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/07-渲染器之挂载.html" class="sidebar-link">渲染器之挂载</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/08-渲染器的核心 Diff 算法.html" class="sidebar-link">渲染器的核心 Diff 算法</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/09-渲染器之patch.html" class="sidebar-link">渲染器之patch</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/10-图解 Vue 响应式原理.html" class="sidebar-link">图解 Vue 响应式原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/11-图解 Vue 异步更新.html" class="sidebar-link">图解 Vue 异步更新</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/12-剖析 Vue 内部运行机制.html" class="sidebar-link">剖析 Vue 内部运行机制</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/13-vue响应式原理模拟.html" class="sidebar-link">vue响应式原理模拟</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/14-vue状态管理之vuex.html" class="sidebar-link">vue状态管理之vuex</a></li><li><a href="/FE-Interview-Questions/principle-docs/vue/15-理解Vue的设计思想及实现Vue.html" class="sidebar-link">理解Vue的设计思想及实现Vue</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/principle-docs/react/01-React router原理.html" class="sidebar-link">React router原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/02-Dva总结.html" class="sidebar-link">Dva总结</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/03-MobX总结.html" class="sidebar-link">MobX总结</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/04-浅析redux saga中间件及用法.html" class="sidebar-link">浅析redux saga中间件及用法</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/05-Redux之浅析中间件.html" class="sidebar-link">Redux之浅析中间件</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/06-Redux之源码分析.html" class="sidebar-link">Redux之源码分析</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/07-Redux之异步Action及操作.html" class="sidebar-link">Redux之异步Action及操作</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/08-浅析中间件.html" class="sidebar-link">浅析中间件</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/09-react结合redux实战.html" class="sidebar-link">react结合redux实战</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/10-Immutable总结.html" class="sidebar-link">Immutable总结</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/11-React16为什么要更改生命周期上.html" class="sidebar-link">React16为什么要更改生命周期上</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/12-React16为什么要更改生命周期下.html" class="sidebar-link">React16为什么要更改生命周期下</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/13-React Hooks 设计动机与工作模式.html" class="sidebar-link">React Hooks 设计动机与工作模式</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/14-深入 React Hooks 工作机制.html" class="sidebar-link">深入 React Hooks 工作机制</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/15-真正理解虚拟DOM.html" class="sidebar-link">真正理解虚拟DOM</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/16-React 中的“栈调和” Stack Reconciler 过程是怎样的.html" class="sidebar-link">React 中的“栈调和” Stack Reconciler 过程是怎样的</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/17-setState 到底是同步的，还是异步的.html" class="sidebar-link">setState 到底是同步的，还是异步的</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/18-如何理解 Fiber 架构的迭代动机与设计思想.html" class="sidebar-link">如何理解 Fiber 架构的迭代动机与设计思想</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/19-ReactDOM.render 是如何串联渲染链路的.html" class="sidebar-link">ReactDOM.render 是如何串联渲染链路的</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/20-剖析 Fiber 架构下 Concurrent 模式的实现原理.html" class="sidebar-link">剖析 Fiber 架构下 Concurrent 模式的实现原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/21-React 事件与 DOM 事件有何不同.html" class="sidebar-link">React 事件与 DOM 事件有何不同</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/22-揭秘 Redux 设计思想与工作原理.html" class="sidebar-link">揭秘 Redux 设计思想与工作原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/23-从 Redux 中间件实现原理切入，理解“面向切面编程”.html" class="sidebar-link">从 Redux 中间件实现原理切入，理解“面向切面编程”</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/24-如何打造高性能的 React 应用.html" class="sidebar-link">如何打造高性能的 React 应用</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/25-跟 React 学设计模式.html" class="sidebar-link">跟 React 学设计模式</a></li><li><a href="/FE-Interview-Questions/principle-docs/react/26-React全部api解读.html" class="sidebar-link">React全部api解读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/principle-docs/webpack/01-Webpack4打包机制原理解析.html" class="sidebar-link">Webpack4打包机制原理解析</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/02-webpack中的HMR热更新原理剖析.html" class="sidebar-link">webpack中的HMR热更新原理剖析</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/03-从源码窥探Webpack4.x原理.html" class="sidebar-link">从源码窥探Webpack4.x原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/04-实现webpack小型打包工具.html" class="sidebar-link">实现webpack小型打包工具</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/05-Babel原理及其使用.html" class="sidebar-link">Babel原理及其使用</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/06-Webpack 与 Rollup 二者之间该如何选择.html" class="sidebar-link">Webpack 与 Rollup 二者之间该如何选择</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/07-前端构建新玩法 Vite 上手与思考.html" class="sidebar-link">前端构建新玩法 Vite 上手与思考</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/08-利用 Webpack CodeSplitting 完成复杂应用拆包.html" class="sidebar-link">利用 Webpack CodeSplitting 完成复杂应用拆包</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/09-玩转 Webpack 的 TreeShaking 与 sideEffects 特性.html" class="sidebar-link">玩转 Webpack 的 TreeShaking 与 sideEffects 特性</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/10-如何配置 Webpack SourceMap 的最佳实践.html" class="sidebar-link">如何配置 Webpack SourceMap 的最佳实践</a></li><li><a href="/FE-Interview-Questions/principle-docs/webpack/11-Webpack 运行机制与核心工作原理.html" class="sidebar-link">Webpack 运行机制与核心工作原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/principle-docs/node/01-Node事件循环机制原理.html" class="sidebar-link">Node事件循环机制原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/node/02-express详细使用.html" class="sidebar-link">express详细使用</a></li><li><a href="/FE-Interview-Questions/principle-docs/node/03-koa基本用法.html" class="sidebar-link">koa基本用法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>综合</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/01-虚拟DOM原理分析.html" class="sidebar-link">虚拟DOM原理分析</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/02-setTimeout实现原理和使用注意.html" class="sidebar-link">setTimeout实现原理和使用注意</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/03-浅析Promise原理.html" class="sidebar-link">浅析Promise原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/04-浏览器渲染原理.html" class="sidebar-link">浏览器渲染原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/05-前端面试之MVVM浅析.html" class="sidebar-link">前端面试之MVVM浅析</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/06-前端面试之组件化.html" class="sidebar-link">前端面试之组件化</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/07-虚拟DOM（一）.html" class="sidebar-link">虚拟DOM（一）</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/08-虚拟DOM（二）.html" class="sidebar-link">虚拟DOM（二）</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/09-前端性能之Performance.html" class="sidebar-link">前端性能之Performance</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/10-小程序开发实践.html" class="sidebar-link">小程序开发实践</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/11-对比 Koa 和 Redux-分析前端中的中间件理念.html" class="active sidebar-link">对比 Koa 和 Redux</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/11-对比 Koa 和 Redux-分析前端中的中间件理念.html#以-koa-为代表的-node-js-中间件化设计" class="sidebar-link">以 Koa 为代表的 Node.js 中间件化设计</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/11-对比 Koa 和 Redux-分析前端中的中间件理念.html#对比-express-再谈-koa-中间件" class="sidebar-link">对比 Express，再谈 Koa 中间件</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/11-对比 Koa 和 Redux-分析前端中的中间件理念.html#redux-中间件设计和实现" class="sidebar-link">Redux 中间件设计和实现</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/11-对比 Koa 和 Redux-分析前端中的中间件理念.html#利用中间件思想-实现一个中间件化的-fetch-库" class="sidebar-link">利用中间件思想，实现一个中间件化的 Fetch 库</a></li></ul></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/12-正则完整篇.html" class="sidebar-link">正则完整篇</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html" class="sidebar-link">打造前端监控系统</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/14-浏览器渲染机制.html" class="sidebar-link">浏览器渲染机制</a></li></ul></section></li></ul> </aside> <main class="page"> <div id="container" class="theme-default-content lock"><div class="content__default"><h2 id="以-koa-为代表的-node-js-中间件化设计"><a href="#以-koa-为代表的-node-js-中间件化设计" class="header-anchor">#</a> 以 Koa 为代表的 Node.js 中间件化设计</h2> <p>说到中间件，很多开发者都会想到 Koa.js，其中间件设计无疑是前端中间件思想的典型代表之一。我们先来剖析 Koa.js 的设计和实现。</p> <p>先来看一下 Koa.js 中间件的实现和应用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 最外层中间件，可以用于兜底 Koa 全局错误</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('中间件 1 开始执行')</span>
    <span class="token comment">// 执行下一个中间件</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log('中间件 1 执行结束')</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[koa error]: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 第二层中间件，可以用于日志记录</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log('中间件 2 开始执行')</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> req <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">res is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.log('中间件 2 执行结束')</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如上代码，我们看 Koa 实例，通过use方法注册和串联中间件，其源码实现部分精简表述为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>如上代码，我们的中间件被存储进<code>this.middleware</code>数组中，那么中间件是如何被执行的呢？参考下面源码：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过 createServer 方法启动一个 Node.js 服务</span>
<span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>Koa</code> 框架通过 <code>http</code> 模块的 <code>createServer</code> 方法创建一个 Node.js 服务，并传入 <code>this.callback()</code> 方法， <code>this.callback()</code> 方法源码精简实现如下：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从 this.middleware 数组中，组合中间件</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// handleRequest 方法作为 `http` 模块的 `createServer` 方法参数，该方法通过 `createContext` 封装了 `http.createServer` 中的 `request` 和 `response`对象，并将这两个对象放到 ctx 中</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将 ctx 和组合后的中间件函数 fn 传递给 this.handleRequest 方法</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> handleRequest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> fnMiddleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleResponse</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// on-finished npm 包提供的方法，该方法在一个 HTTP 请求 closes，finishes 或者 errors 时执行</span>
    <span class="token function">onFinished</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 ctx 对象传递给中间件函数 fnMiddleware</span>
    <span class="token keyword">return</span> <span class="token function">fnMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>如上代码，<code>我们将 Koa 一个中间件组合和执行流程梳理为以下步骤</code>。</p></blockquote> <ul><li>通过<code>compose方法组合各种中间件</code>，返回一个中间件组合函数<code>fnMiddleware</code></li> <li>请求过来时，会先调用<code>handleRequest</code>方法，该方法完成
<ul><li>调用<code>createContext</code>方法，对该次请求封装出一个<code>ctx</code>对象；</li> <li>接着调用<code>this.handleRequest(ctx, fnMiddleware)</code>处理该次请求。</li></ul></li> <li>通过 <code>fnMiddleware(ctx).then(handleResponse).catch(onerror)</code> 执行中间件</li></ul> <blockquote><p>其中，<code>一个核心过程就是使用compose方法组合各种中间件</code>，其源码实现精简为：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里返回的函数，就是上文中的 fnMiddleware</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	  <span class="token comment">// </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            index <span class="token operator">=</span> i
            <span class="token comment">// 取出第 i 个中间件为 fn</span>
            <span class="token keyword">let</span> fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> middleware<span class="token punctuation">.</span>length<span class="token punctuation">)</span> fn <span class="token operator">=</span> next

            <span class="token comment">// 已经取到了最后一个中间件，直接返回一个 Promise 实例，进行串联</span>
            <span class="token comment">// 这一步的意义是保证最后一个中间件调用 next 方法时，也不会报错</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 把 ctx 和 next 方法传入到中间件 fn 中，并将执行结果使用 Promise.resolve 包装</span>
                <span class="token comment">// 这里可以发现，我们在一个中间件中调用的 next 方法，其实就是dispatch.bind(null, i + 1)，即调用下一个中间件</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>源码实现中已加入了相关注释，如果对于你来说还是晦涩难懂，不妨看一下下面这个 <code>hard coding</code> 的例子，通过下面代码，表示三个 Koa 中间件的执行情况：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>这里我们来做一个简单的总结：</strong></p> <ul><li>Koa 的中间件机制被社区形象地总结为洋葱模型；
<ul><li>所谓洋葱模型，就是指每一个 Koa 中间件都是一层洋葱圈，它即可以掌管请求进入，也可以掌管响应返回。换句话说：外层的中间件可以影响内层的请求和响应阶段，内层的中间件只能影响外层的响应阶段。</li></ul></li> <li><code>dispatch(n)</code>对应第 <code>n</code> 个中间件的执行，第 <code>n</code> 个中间件可以通过 <code>await next()</code> 来执行下一个中间件，同时在最后一个中间件执行完成后，依然有恢复执行的能力。即，通过洋葱模型，<code>await next()</code> 控制调用 “下游”中间件，直到 “下游”没有中间件且堆栈执行完毕，最终流回“上游”中间件。这种方式有个优点，特别是对于日志记录以及错误处理等需要非常友好。</li></ul> <blockquote><p>这里我们稍微做一下扩展，引申出 <code>Koa v1</code> 版本中中间件的实现，<code>Koa1</code> 的中间件实现利用了 <code>Generator 函数 + co 库</code>（一种基于 Promise 的 Generator 函数流程管理工具），来实现协程运行。本质上，Koa v1 版本中间件和 Koa v2 版本中间件思想是类似的，只不过 Koa v2 主要是用了 <code>Async/Await</code> 来替换 <code>Generator 函数 + co 库</code>，整体实现更加巧妙，代码更加优雅、简易。</p></blockquote> <h2 id="对比-express-再谈-koa-中间件"><a href="#对比-express-再谈-koa-中间件" class="header-anchor">#</a> 对比 Express，再谈 Koa 中间件</h2> <blockquote><p>说起 Node.js 框架，我们自然忘不了 Express.js。它的中间件机制同样值得我们学习、比对。Express 不同于 Koa，它继承了路由、静态服务器和模板引擎等功能，因此看上去比 Koa 更像是一个框架。通过学习 Express 源码(https://github.com/expressjs/express)，我们可以总结出它的工作机制。</p></blockquote> <ul><li>通过 <code>app.use</code> 方法注册中间件</li> <li>一个中间件可以理解为一个 Layer 对象，其中包含了当前路由匹配的正则信息以及 <code>handle</code> 方法。</li> <li>所有中间件（Layer 对象）使用<code>stack</code>数组存储起来。</li> <li>因此，每个 <code>Router</code> 对象都是通过一个<code>stack</code>数组，存储了相关中间件函数</li> <li>当一个请求过来时，会从 REQ 中获取请求 path，根据 <code>path 从stack</code>中找到匹配的 Layer，具体匹配过程由<code>router.handle</code>函数实现。</li> <li><code>router.handle</code>函数通过<code>next()</code>方法遍历每一个 <code>layer</code> 进行比对：
<ul><li><code>next()</code>方法通过闭包维持了对于 <code>Stack Index</code> 游标的引用，当调用next()方法时，就会从下一个中间件开始查找；</li> <li>如果比对结果为 <code>true</code>，则调用<code>layer.handle_request</code>方法，<code>layer.handle_request</code>方法中会调用<code>next()</code>方法 ，实现中间件的执行</li></ul></li></ul> <p>我们将上述过程总结为下图，帮助你理解：</p> <p><img src="http://img-repo.poetries.top/images/20210418222200.png" alt=""></p> <p>通过上述内容，我们可以看到，Express 的<code>next()</code>方法维护了遍历中间件列表的 <code>Index 游标</code>，中间件每次调用<code>next()</code>方法时，会通过增加 <code>Index 游标</code>的方式找到下一个中间件并执行。我们采用类似的 <code>hard coding</code> 形式帮助大家理解 Express 插件作用机制：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一个中间件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二个中间件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三个中间件 =&gt; 是一个 route 中间件，处理 /api/test1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二个中间件调用结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一个中间件调用结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>如上代码，<code>Express 中间件设计并不是一个洋葱模型，它是基于回调实现的线形模型，不利于组合，不利于互操，在设计上并不像 Koa 一样简单</code>。如果想实现一个记录请求响应的中间件，就需要：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token function-variable function">requestTime</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span>requestTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>requestTime<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> responseText <span class="token operator">=</span> 'Hello World<span class="token operator">!</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>

'
  responseText <span class="token operator">+=</span> <span class="token string">'&lt;small&gt;Requested at: '</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>requestTime <span class="token operator">+</span> <span class="token string">'&lt;/small&gt;'</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>responseText<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><p>我们可以看到，上述实现就对业务代码有一定程度的侵扰，甚至会造成不同中间件间的耦合。</p> <p>我们回退到“上帝视角”发现，毫无疑问 Koa 的洋葱模型更加先进，而Express 的线形机制不容易实现拦截处理逻辑：比如异常处理和统计响应时间——这在 Koa 里，一般只需要一个中间件就能全部搞定。</p> <blockquote><p>当然，Koa 本身只提供了 HTTP 模块和洋葱模型的最小封装，Express 是一种更高形式的抽象，其设计思路和面向目标也有不同。</p></blockquote> <h2 id="redux-中间件设计和实现"><a href="#redux-中间件设计和实现" class="header-anchor">#</a> Redux 中间件设计和实现</h2> <p>通过前文，我们了解了 Node.js 两个当红框架的中间件设计，我们再换一个角度：从 Redux 这个状态管理方案的中间件设计，了解更全面的中间件系统。</p> <blockquote><p>类似 Koa 中的 <code>koa-compose</code> 实现，<code>Redux 也实现了一个compose方法</code>，完成中间件的注册和串联：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs<span class="token operator">:</span> Function<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>compose</code>方法的执行效果如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">compose</span><span class="token punctuation">(</span><span class="token punctuation">[</span>fn1<span class="token punctuation">,</span> fn2<span class="token punctuation">,</span> fn3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span>
<span class="token operator">=&gt;</span>
<span class="token function">compose</span><span class="token punctuation">(</span>fn1<span class="token punctuation">,</span> fn2<span class="token punctuation">,</span> fn3<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token function">fn2</span><span class="token punctuation">(</span><span class="token function">fn3</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>简单来说，<code>compose</code>方法是一种高阶聚合，先执行 <code>fn3</code>，并将执行结果作为参数传给 <code>fn2</code>，以此类推。我们使用 <code>Redux</code> 创建一个 <code>store</code> 时，完成对<code>compose</code>方法的调用，<code>Redux</code> 精简源码类比为</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这是一个简单的打日志中间件</span>
<span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// next 代表下一个中间件包装过后的 dispatch 方法，action 表示当前接收到的动作</span>
    <span class="token keyword">return</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;before change&quot;</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用下一个中间件包装的 dispatch </span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;after change&quot;</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 使用 logger 中间件，创建一个增强的 store</span>
<span class="token keyword">let</span> createStoreWithMiddleware <span class="token operator">=</span> Redux<span class="token punctuation">.</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">(</span>Redux<span class="token punctuation">.</span>createStore<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// middlewares 为中间件列表，返回一个接受原始 createStore 方法（Redux.createStore）作为参数的函数</span>
  <span class="token keyword">return</span> <span class="token parameter">createStore</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建原始的 store</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token comment">// 每个中间件都会被传入 middlewareAPI 对象，作为中间件参数</span>
    <span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
      getState<span class="token operator">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
      <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 给每个中间件传入 middlewareAPI 参数</span>
    <span class="token comment">// 中间件的统一模板为 next =&gt; action =&gt; next(action) 格式</span>
    <span class="token comment">// chain 中保存的都是 next =&gt; action =&gt; {next(action)} 的方法</span>
    <span class="token keyword">const</span> chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=&gt;</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 传入最原始 store.dispatch 方法，作为 compose 二级参数，compose 方法最终返回一个增强的dispatch 方法</span>
    dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>chain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>store<span class="token punctuation">,</span>
      dispatch  <span class="token comment">// 返回一个增强版的 dispatch</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>如上代码，我们将 Redux 中间件特点总结为：</strong></p> <ul><li>Redux 中间件接收<code>getState</code>和<code>dispatch</code>两个方法组成的对象作为参数；</li> <li>Redux 中间件返回一个函数，该函数接收下一个next方法作为参数，并返回一个接收 action 的新的dispatch方法；</li> <li>Redux 中间件通过手动调用<code>next(action)</code>方法，执行下一个中间件。</li></ul> <p>我们将 Redux 的中间件作用机制总结为下图：</p> <p><img src="http://img-repo.poetries.top/images/20210418222449.png" alt=""></p> <p>看上去也像是一个洋葱圈模型，但是对于同步调用和异步调用稍有不同，以三个中间件为例。</p> <ul><li>三个中间件均是正常同步调用<code>next(action)</code>，则执行顺序为：<code>中间件 1 before next</code> → <code>中间件 2 before next</code> → <code>中间件 3 before next</code> → <code>dispatch 方法调用</code> → <code>中间件 3 after next</code> → <code>中间件 2 after next</code> → <code>中间件 1 after next</code>。</li> <li>第二个中间件没有调用<code>next(action)</code>，则执行顺序为：<code>中间件 1 befoe next</code> → <code>中间件 2 逻辑</code> → <code>中间件 1 after next</code>，注意此时中间件 3 没有被执行。</li> <li>第二个中间件异步调用<code>next(action)</code>，其他中间件均是正常同步调用<code>next(action)</code>，则执行顺序为：<code>中间件 1 before next</code> → <code>中间件 2 同步代码部分</code> → <code>中间件 1 after next</code> → <code>中间件 2 异步代码部分 before next</code> → <code>中间件 3 before next</code> → <code>dispatch 方法调用</code> → <code>中间件 3 after next</code> → <code>中间件 2 异步代码部分 after next</code>。</li></ul> <h2 id="利用中间件思想-实现一个中间件化的-fetch-库"><a href="#利用中间件思想-实现一个中间件化的-fetch-库" class="header-anchor">#</a> 利用中间件思想，实现一个中间件化的 Fetch 库</h2> <blockquote><p>我们先来思考一个中间件化的 Fetch 库有哪些优点呢？Fetch 库的核心实现请求的发送，而各种业务逻辑以中间件化的插件模式进行增强，这样一来，实现了特定业务需求和请求库的解耦，更加灵活，也是一种分层思想的体现。具体来说，一个中间件化的 Fetch 库：</p></blockquote> <ul><li>支持业务方递归扩展底层 Fetch API 能力；</li> <li>方便测试；</li> <li>一个中间件化的 Fetch 库，天然支持各类型的 Fetch 封装（比如 <code>Native Fetch、fetch-ponyfill、fetch-polyfill</code> 等）。</li></ul> <p>我们给这个中间件化的 Fetch 库取名为：fetch-wrap，借助 fetch-wrap 的实现，预期使用方式为</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fetchWrap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fetch-wrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这里可以接入自己的核心 Fetch 底层实现，比如使用原生 Fetch，或同构的 isomorphic-fetch 等</span>
<span class="token keyword">let</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'isomorphic-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 扩展 Fetch 中间件</span>
fetch <span class="token operator">=</span> <span class="token function">fetchWrap</span><span class="token punctuation">(</span>fetch<span class="token punctuation">,</span> <span class="token punctuation">[</span>
  middleware1<span class="token punctuation">,</span>
  middleware2<span class="token punctuation">,</span>
  middleware3<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 一个典型的中间件</span>
<span class="token keyword">function</span> <span class="token function">middleware1</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options<span class="token punctuation">,</span> innerFetch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
	<span class="token comment">// 业务扩展</span>
	<span class="token comment">// ...</span>
	<span class="token keyword">return</span> <span class="token function">innerFetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 一个更改 URL 的中间件</span>
<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fetch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// modify url or options</span>
	<span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(http:)?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'https:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 一个修改返回结果的中间件</span>
<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fetch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>status <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">application\/json</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	  <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 一个做错误处理的中间件</span>
<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fetch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// catch errors</span>
	<span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>核心实现也不困难，观察fetchWrap使用方式，我们实现源码为：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 接受第一个参数为基础 Fetch，第二个参数为中间件数组或单个中间件</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">fetchWrap</span><span class="token punctuation">(</span><span class="token parameter">fetch<span class="token punctuation">,</span> middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有使用中间件，则返回原生 fetch</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>middleware <span class="token operator">||</span> middleware<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fetch<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 递归调用 extend 方法，每次递归时剔除出 middleware 数组中的首项</span>
	<span class="token keyword">var</span> innerFetch <span class="token operator">=</span> middleware<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> fetch <span class="token operator">:</span> <span class="token function">fetchWrap</span><span class="token punctuation">(</span>fetch<span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">var</span> next <span class="token operator">=</span> middleware<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">extendedFetch</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
		  <span class="token comment">// 每一个 Fetch 中间件通过 Promsie 来串联</span>
		  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> innerFetch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到，每一个中间件都接收一个<code>url</code>和<code>options</code>参数，因此具有了改写<code>url和options</code>的能力；同时接收一个<code>innerFetch</code>方法，<code>innerFetch</code>为上一个中间件包装过的<code>fetch</code>方法，而每一个中间件也都返回一个包装过的<code>fetch</code>方法，将各个中间件依次调用串联。</p> <p>另外，社区上的 <code>umi-request</code> 的中间件机制也是类似的，其核心代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Onion</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 存储中间件</span>
  <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">newMiddleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 执行中间件</span>
  <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">wrapMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      index <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> middlewares<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>我们可以看到，上述源码更像 Koa 的实现了，但其实道理和上面的 fetch-wrap 大同小异。至此，相信你已经了解了中间件的思想，也能够体会洋葱模型的精妙设计</p></blockquote> <p><img src="http://img-repo.poetries.top/images/20210418222847.png" alt=""></p></div> <!----> <div class="readMore-wrapper"><span class="readMore">阅读全文</span></div></div> <div class="right-bar"><div class="item"><span class="title">前端进阶公众号</span> <span class="desc">每天分享前端干货文章</span> <img width="100%" src="http://img-repo.poetries.top/images/20211001080240.png"></div> <div class="item"><span class="desc">扫一扫，加VX</span> <img width="100%" src="http://img-repo.poetries.top/images/20211017123306.png"></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FE-Interview-Questions/principle-docs/comprehensive/10-小程序开发实践.html" class="prev">小程序开发实践</a></span> <span class="next"><a href="/FE-Interview-Questions/principle-docs/comprehensive/12-正则完整篇.html">正则完整篇</a>
      →
    </span></p></div>  <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="请先阅读购买协议" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">请先阅读购买协议</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><div class="el-dialog__footer"><span class="dialog-footer"><button disabled="disabled" type="button" class="el-button el-button--danger is-disabled" style="width:100%;"><!----><!----><span>我已阅读（8s）</span></button></span></div></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="付费阅读" class="el-dialog" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">付费阅读</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><div class="el-dialog__footer"><span class="dialog-footer"><button disabled="disabled" type="button" class="el-button el-button--danger is-disabled" style="width:100%;"><!----><!----><span>确 定</span></button></span></div></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="dialog" class="el-dialog" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title"></span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <img src="data:image/png;base64,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" class="theme-float-btn"> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="站点迁移通知" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">站点迁移通知</span><!----></div><!----><!----></div></div></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/FE-Interview-Questions/assets/js/app.7f99e7e3.js" defer></script><script src="/FE-Interview-Questions/assets/js/5.9e4f5919.js" defer></script><script src="/FE-Interview-Questions/assets/js/4.b1f3b250.js" defer></script><script src="/FE-Interview-Questions/assets/js/95.de10668f.js" defer></script><script src="/FE-Interview-Questions/assets/js/11.f521c2b2.js" defer></script>
  </body>
</html>
